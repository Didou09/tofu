<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>tofu.geom._core &mdash; tofu v1.1</title>
    
    <link rel="stylesheet" href="../../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '1.1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="tofu v1.1" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">tofu v1.1</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for tofu.geom._core</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module is the geometrical part of the ToFu general package</span>
<span class="sd">It includes all functions and object classes necessary for tomography on Tokamaks</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">datetime</span> <span class="k">as</span> <span class="nn">dtm</span>

<span class="c"># ToFu-specific</span>
<span class="kn">import</span> <span class="nn">tofu.defaults</span> <span class="k">as</span> <span class="nn">tfd</span>
<span class="kn">import</span> <span class="nn">tofu.pathfile</span> <span class="k">as</span> <span class="nn">tfpf</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">General_Geom_cy</span> <span class="k">as</span> <span class="n">_tfg_gg</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">_compute</span> <span class="k">as</span> <span class="n">_tfg_c</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">_plot</span> <span class="k">as</span> <span class="n">_tfg_p</span>

<span class="n">__author__</span> <span class="o">=</span>    <span class="s">&quot;D. Vezinet&quot;</span>
<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Ves&#39;</span><span class="p">,</span><span class="s">&#39;Struct&#39;</span><span class="p">,</span><span class="s">&#39;LOS&#39;</span><span class="p">,</span><span class="s">&#39;GLOS&#39;</span><span class="p">,</span><span class="s">&#39;Lens&#39;</span><span class="p">,</span><span class="s">&#39;Apert&#39;</span><span class="p">,</span><span class="s">&#39;Detect&#39;</span><span class="p">,</span><span class="s">&#39;GDetect&#39;</span><span class="p">]</span>




<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">###############################################################################</span>
<span class="sd">###############################################################################</span>
<span class="sd">                        Ves class and functions</span>
<span class="sd">###############################################################################</span>
<span class="sd">&quot;&quot;&quot;</span>

<div class="viewcode-block" id="Ves"><a class="viewcode-back" href="../../../Auto_tofu.geom.html#tofu.geom.Ves">[docs]</a><span class="k">class</span> <span class="nc">Ves</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; A class defining a Linear or Toroidal vaccum vessel (i.e. a 2D polygon representing a cross-section and assumed to be linearly or toroidally invariant)</span>

<span class="sd">    A Ves object is mostly defined by a close 2D polygon, which can be understood as a poloidal cross-section in (R,Z) cylindrical coordinates if Type=&#39;Tor&#39; (toroidal shape) or as a straight cross-section through a cylinder in (Y,Z) cartesian coordinates if Type=&#39;Lin&#39; (linear shape).</span>
<span class="sd">    Attributes such as the surface, the angular volume (if Type=&#39;Tor&#39;) or the center of mass are automatically computed.</span>
<span class="sd">    The instance is identified thanks to an attribute Id (which is itself a tofu.ID class object) which contains informations on the specific instance (name, Type...).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    Id :            str / tfpf.ID</span>
<span class="sd">        A name string or a pre-built tfpf.ID class to be used to identify this particular instance, if a string is provided, it is fed to tfpf.ID()</span>
<span class="sd">    Poly :          np.ndarray</span>
<span class="sd">        An array (2,N) or (N,2) defining the contour of the vacuum vessel in a cross-section, if not closed, will be closed automatically</span>
<span class="sd">    Type :          str</span>
<span class="sd">        Flag indicating whether the vessel will be a torus (&#39;Tor&#39;) or a linear device (&#39;Lin&#39;)</span>
<span class="sd">    DLong :         list / np.ndarray</span>
<span class="sd">        Array or list of len=2 indicating the limits of the linear device volume on the x axis</span>
<span class="sd">    Sino_RefPt :    None / np.ndarray</span>
<span class="sd">        Array specifying a reference point for computing the sinogram (i.e. impact parameter), if None automatically set to the (surfacic) center of mass of the cross-section</span>
<span class="sd">    Sino_NP :       int</span>
<span class="sd">        Number of points in [0,2*pi] to be used to plot the vessel sinogram envelop</span>
<span class="sd">    Clock :         bool</span>
<span class="sd">        Flag indicating whether the input polygon should be made clockwise (True) or counter-clockwise (False)</span>
<span class="sd">    arrayorder:     str</span>
<span class="sd">        Flag indicating whether the attributes of type=np.ndarray (e.g.: Poly) should be made C-contiguous (&#39;C&#39;) or Fortran-contiguous (&#39;F&#39;)</span>
<span class="sd">    Exp :           None / str</span>
<span class="sd">        Flag indicating which experiment the object corresponds to, allowed values are in [None,&#39;AUG&#39;,&#39;MISTRAL&#39;,&#39;JET&#39;,&#39;ITER&#39;,&#39;TCV&#39;,&#39;TS&#39;,&#39;Misc&#39;]</span>
<span class="sd">    shot :          None / int</span>
<span class="sd">        Shot number from which this Ves is usable (in case of change of geometry)</span>
<span class="sd">    SavePath :      None / str</span>
<span class="sd">        If provided, forces the default saving path of the object to the provided value</span>
<span class="sd">    dtime :         None / dtm.datetime</span>
<span class="sd">        A time reference to be used to identify this particular instance (used for debugging mostly)</span>
<span class="sd">    dtimeIn :       bool</span>
<span class="sd">        Flag indicating whether dtime should be included in the SaveName (used for debugging mostly)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Ves :        Ves object</span>
<span class="sd">        The created Ves object, with all necessary computed attributes and methods</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="n">Poly</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="s">&#39;Tor&#39;</span><span class="p">,</span> <span class="n">DLong</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Sino_RefPt</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Sino_NP</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">TorNP</span><span class="p">,</span> <span class="n">Clock</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">arrayorder</span><span class="o">=</span><span class="s">&#39;C&#39;</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">dtime</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">dtimeIn</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_Done</span> <span class="o">=</span> <span class="k">False</span>
        <span class="n">tfpf</span><span class="o">.</span><span class="n">_check_NotNone</span><span class="p">({</span><span class="s">&#39;Clock&#39;</span><span class="p">:</span><span class="n">Clock</span><span class="p">,</span><span class="s">&#39;arrayorder&#39;</span><span class="p">:</span><span class="n">arrayorder</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_inputs</span><span class="p">(</span><span class="n">Clock</span><span class="o">=</span><span class="n">Clock</span><span class="p">,</span> <span class="n">arrayorder</span><span class="o">=</span><span class="n">arrayorder</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_arrayorder</span> <span class="o">=</span> <span class="n">arrayorder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Clock</span> <span class="o">=</span> <span class="n">Clock</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_Id</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="n">Type</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="n">Exp</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="n">shot</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="n">SavePath</span><span class="p">,</span> <span class="n">dtime</span><span class="o">=</span><span class="n">dtime</span><span class="p">,</span> <span class="n">dtimeIn</span><span class="o">=</span><span class="n">dtimeIn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_Poly</span><span class="p">(</span><span class="n">Poly</span><span class="p">,</span> <span class="n">DLong</span><span class="o">=</span><span class="n">DLong</span><span class="p">,</span> <span class="n">Clock</span><span class="o">=</span><span class="n">Clock</span><span class="p">,</span> <span class="n">Sino_RefPt</span><span class="o">=</span><span class="n">Sino_RefPt</span><span class="p">,</span> <span class="n">Sino_NP</span><span class="o">=</span><span class="n">Sino_NP</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_arrayorder</span><span class="p">(</span><span class="n">arrayorder</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Done</span> <span class="o">=</span> <span class="k">True</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the tfpf.ID object of the vessel&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Id</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the type of vessel&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Type</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Poly</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the polygon defining the vessel cross-section&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Poly</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Vect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the polygon elementary vectors&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Vect</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Vin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the normalized vectors pointing inwards for each segment of the polygon&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Vin</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">DLong</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DLong</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Surf</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the area of the polygon defining the vessel cross-section&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Surf</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">VolLin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the angular volume of the polygon defining the vessel cross-section of Tor type&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_VolLin</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">BaryS</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the (surfacic) center of mass of the polygon defining the vessel cross-section&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_BaryS</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">BaryV</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the (volumic) center of mass of the polygon defining the vessel cross-section&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_BaryV</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Sino_RefPt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the 2D coordinates of the points used as a reference for computing the Ves polygon in projection space (where sinograms are plotted)&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Sino_RefPt</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Sino_NP</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the number of points used used for plotting the Ves polygon in projection space&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Sino_NP</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">arrayorder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the flag indicating which order is used for multi-dimensional array attributes&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_arrayorder</span>


    <span class="k">def</span> <span class="nf">_check_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Id</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Poly</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">DLong</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Sino_RefPt</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Sino_NP</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Clock</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">arrayorder</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">dtime</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">dtimeIn</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
        <span class="n">_Ves_check_inputs</span><span class="p">(</span><span class="n">Id</span><span class="o">=</span><span class="n">Id</span><span class="p">,</span> <span class="n">Poly</span><span class="o">=</span><span class="n">Poly</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="n">Type</span><span class="p">,</span> <span class="n">DLong</span><span class="o">=</span><span class="n">DLong</span><span class="p">,</span> <span class="n">Sino_RefPt</span><span class="o">=</span><span class="n">Sino_RefPt</span><span class="p">,</span> <span class="n">Sino_NP</span><span class="o">=</span><span class="n">Sino_NP</span><span class="p">,</span> <span class="n">Clock</span><span class="o">=</span><span class="n">Clock</span><span class="p">,</span> <span class="n">arrayorder</span><span class="o">=</span><span class="n">arrayorder</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="n">Exp</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="n">shot</span><span class="p">,</span> <span class="n">dtime</span><span class="o">=</span><span class="n">dtime</span><span class="p">,</span> <span class="n">dtimeIn</span><span class="o">=</span><span class="n">dtimeIn</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="n">SavePath</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_Id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Val</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">dtime</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">dtimeIn</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Done</span><span class="p">:</span>
            <span class="n">Out</span> <span class="o">=</span> <span class="n">tfpf</span><span class="o">.</span><span class="n">_get_FromItself</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="p">,{</span><span class="s">&#39;Type&#39;</span><span class="p">:</span><span class="n">Type</span><span class="p">,</span> <span class="s">&#39;Exp&#39;</span><span class="p">:</span><span class="n">Exp</span><span class="p">,</span> <span class="s">&#39;shot&#39;</span><span class="p">:</span><span class="n">shot</span><span class="p">,</span> <span class="s">&#39;dtime&#39;</span><span class="p">:</span><span class="n">dtime</span><span class="p">,</span> <span class="s">&#39;_dtimeIn&#39;</span><span class="p">:</span><span class="n">dtimeIn</span><span class="p">,</span> <span class="s">&#39;SavePath&#39;</span><span class="p">:</span><span class="n">SavePath</span><span class="p">})</span>
            <span class="n">Type</span><span class="p">,</span> <span class="n">Exp</span><span class="p">,</span> <span class="n">shot</span><span class="p">,</span> <span class="n">dtime</span><span class="p">,</span> <span class="n">dtimeIn</span><span class="p">,</span> <span class="n">SavePath</span> <span class="o">=</span> <span class="n">Out</span><span class="p">[</span><span class="s">&#39;Type&#39;</span><span class="p">],</span> <span class="n">Out</span><span class="p">[</span><span class="s">&#39;Exp&#39;</span><span class="p">],</span> <span class="n">Out</span><span class="p">[</span><span class="s">&#39;shot&#39;</span><span class="p">],</span> <span class="n">Out</span><span class="p">[</span><span class="s">&#39;dtime&#39;</span><span class="p">],</span> <span class="n">Out</span><span class="p">[</span><span class="s">&#39;dtimeIn&#39;</span><span class="p">],</span> <span class="n">Out</span><span class="p">[</span><span class="s">&#39;SavePath&#39;</span><span class="p">]</span>
        <span class="n">tfpf</span><span class="o">.</span><span class="n">_check_NotNone</span><span class="p">({</span><span class="s">&#39;Id&#39;</span><span class="p">:</span><span class="n">Val</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_inputs</span><span class="p">(</span><span class="n">Id</span><span class="o">=</span><span class="n">Val</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">Val</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">tfpf</span><span class="o">.</span><span class="n">_check_NotNone</span><span class="p">({</span><span class="s">&#39;Type&#39;</span><span class="p">:</span><span class="n">Type</span><span class="p">,</span> <span class="s">&#39;Exp&#39;</span><span class="p">:</span><span class="n">Exp</span><span class="p">,</span> <span class="s">&#39;shot&#39;</span><span class="p">:</span><span class="n">shot</span><span class="p">,</span><span class="s">&#39;dtimeIn&#39;</span><span class="p">:</span><span class="n">dtimeIn</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_inputs</span><span class="p">(</span><span class="n">Type</span><span class="o">=</span><span class="n">Type</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="n">Exp</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="n">shot</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="n">SavePath</span><span class="p">,</span> <span class="n">dtime</span><span class="o">=</span><span class="n">dtime</span><span class="p">,</span> <span class="n">dtimeIn</span><span class="o">=</span><span class="n">dtimeIn</span><span class="p">)</span>
            <span class="n">Val</span> <span class="o">=</span> <span class="n">tfpf</span><span class="o">.</span><span class="n">ID</span><span class="p">(</span><span class="s">&#39;Ves&#39;</span><span class="p">,</span> <span class="n">Val</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="n">Type</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="n">Exp</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="n">shot</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="n">SavePath</span><span class="p">,</span> <span class="n">dtime</span><span class="o">=</span><span class="n">dtime</span><span class="p">,</span> <span class="n">dtimeIn</span><span class="o">=</span><span class="n">dtimeIn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Id</span> <span class="o">=</span> <span class="n">Val</span>

    <span class="k">def</span> <span class="nf">_set_arrayorder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arrayorder</span><span class="p">):</span>
        <span class="n">tfpf</span><span class="o">.</span><span class="n">_set_arrayorder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arrayorder</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_Poly</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Poly</span><span class="p">,</span> <span class="n">DLong</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Clock</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">Sino_RefPt</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Sino_NP</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">TorNP</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Done</span><span class="p">:</span>
            <span class="n">Out</span> <span class="o">=</span> <span class="n">tfpf</span><span class="o">.</span><span class="n">_get_FromItself</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;DLong&#39;</span><span class="p">:</span><span class="n">DLong</span><span class="p">,</span> <span class="s">&#39;_Clock&#39;</span><span class="p">:</span><span class="n">Clock</span><span class="p">})</span>
            <span class="n">DLong</span><span class="p">,</span> <span class="n">Clock</span> <span class="o">=</span> <span class="n">Out</span><span class="p">[</span><span class="s">&#39;DLong&#39;</span><span class="p">],</span> <span class="n">Out</span><span class="p">[</span><span class="s">&#39;Clock&#39;</span><span class="p">]</span>
        <span class="n">tfpf</span><span class="o">.</span><span class="n">_check_NotNone</span><span class="p">({</span><span class="s">&#39;Poly&#39;</span><span class="p">:</span><span class="n">Poly</span><span class="p">,</span> <span class="s">&#39;Clock&#39;</span><span class="p">:</span><span class="n">Clock</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Poly</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_NP</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_P1Max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_P1Min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_P2Max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_P2Min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_BaryP</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_BaryL</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Surf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_BaryS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DLong</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_VolLin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_BaryV</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Vect</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Vin</span> <span class="o">=</span> <span class="n">_tfg_c</span><span class="o">.</span><span class="n">_Ves_set_Poly</span><span class="p">(</span><span class="n">Poly</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrayorder</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Type</span><span class="p">,</span> <span class="n">DLong</span><span class="o">=</span><span class="n">DLong</span><span class="p">,</span> <span class="n">Clock</span><span class="o">=</span><span class="n">Clock</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_Sino</span><span class="p">(</span><span class="n">Sino_RefPt</span><span class="p">,</span> <span class="n">NP</span><span class="o">=</span><span class="n">Sino_NP</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_Sino</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">RefPt</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">NP</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">TorNP</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Done</span><span class="p">:</span>
            <span class="n">Out</span> <span class="o">=</span> <span class="n">tfpf</span><span class="o">.</span><span class="n">_get_FromItself</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;Sino_RefPt&#39;</span><span class="p">:</span><span class="n">RefPt</span><span class="p">,</span> <span class="s">&#39;Sino_NP&#39;</span><span class="p">:</span><span class="n">NP</span><span class="p">})</span>
            <span class="n">RefPt</span><span class="p">,</span> <span class="n">NP</span> <span class="o">=</span> <span class="n">Out</span><span class="p">[</span><span class="s">&#39;Sino_RefPt&#39;</span><span class="p">],</span> <span class="n">Out</span><span class="p">[</span><span class="s">&#39;Sino_NP&#39;</span><span class="p">]</span>
            <span class="n">tfpf</span><span class="o">.</span><span class="n">_check_NotNone</span><span class="p">({</span><span class="s">&#39;Sino_NP&#39;</span><span class="p">:</span><span class="n">NP</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">RefPt</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="n">RefPt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BaryS</span>
        <span class="n">RefPt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">RefPt</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Sino_EnvTheta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Sino_EnvMinMax</span> <span class="o">=</span> <span class="n">_tfg_gg</span><span class="o">.</span><span class="n">Calc_ImpactEnv</span><span class="p">(</span><span class="n">RefPt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Poly</span><span class="p">,</span> <span class="n">NP</span><span class="o">=</span><span class="n">NP</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="k">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Sino_RefPt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Sino_NP</span> <span class="o">=</span> <span class="n">RefPt</span><span class="p">,</span> <span class="n">NP</span>

<div class="viewcode-block" id="Ves.isInside"><a class="viewcode-back" href="../../../Auto_tofu.geom.html#tofu.geom.Ves.isInside">[docs]</a>    <span class="k">def</span> <span class="nf">isInside</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Pts</span><span class="p">,</span> <span class="n">In</span><span class="o">=</span><span class="s">&#39;(X,Y,Z)&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return an array of booleans indicating whether each point lies inside the Ves volume</span>

<span class="sd">        Tests for each point whether it lies inside the Ves object.</span>
<span class="sd">        The points coordinates can be provided in 2D or 3D, just specify which coordinate system is provided using the &#39;In&#39; parameter.</span>
<span class="sd">        An array of boolean flags is returned.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        Pts :   np.ndarray</span>
<span class="sd">            (2,N) or (3,N) array with the coordinates of the points to be tested</span>
<span class="sd">        In :    str</span>
<span class="sd">            Flag indicating the coordinate system in which the points are provided, in [&#39;(X,Y,Z)&#39;,&#39;(R,Z)&#39;,&#39;&#39;]</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ind :   np.ndarray</span>
<span class="sd">            Array of booleans of shape (N,), True if a point is inside the Ves volume</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_tfg_c</span><span class="o">.</span><span class="n">_Ves_isInside</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Poly</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">DLong</span><span class="p">,</span> <span class="n">Pts</span><span class="p">,</span> <span class="n">In</span><span class="o">=</span><span class="n">In</span><span class="p">)</span></div>

<div class="viewcode-block" id="Ves.get_InsideConvexPoly"><a class="viewcode-back" href="../../../Auto_tofu.geom.html#tofu.geom.Ves.get_InsideConvexPoly">[docs]</a>    <span class="k">def</span> <span class="nf">get_InsideConvexPoly</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">RelOff</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">TorRelOff</span><span class="p">,</span> <span class="n">ZLim</span><span class="o">=</span><span class="s">&#39;Def&#39;</span><span class="p">,</span> <span class="n">Spline</span><span class="o">=</span><span class="k">True</span><span class="p">,</span> <span class="n">Splprms</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">TorSplprms</span><span class="p">,</span> <span class="n">NP</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">TorInsideNP</span><span class="p">,</span> <span class="n">Plot</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="k">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return a polygon that is a smaller and smoothed approximation of Ves.Poly, useful for excluding the divertor region in a Tokamak</span>

<span class="sd">        For some uses, it can be practical to approximate the polygon defining the Ves object (which can be non-convex, like with a divertor), by a simpler, sligthly smaller and convex polygon.</span>
<span class="sd">        This method provides a fast solution for computing such a proxy.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        RelOff :    float</span>
<span class="sd">            Fraction by which an homothetic polygon should be reduced (1.-RelOff)*(Poly-BaryS)</span>
<span class="sd">        ZLim :      None / str / tuple</span>
<span class="sd">            Flag indicating what limits shall be put to the height of the polygon (used for excluding divertor)</span>
<span class="sd">        Spline :    bool</span>
<span class="sd">            Flag indiating whether the reduced and truncated polygon shall be smoothed by 2D b-spline curves</span>
<span class="sd">        Splprms :   list</span>
<span class="sd">            List of 3 parameters to be used for the smoothing [weights,smoothness,b-spline order], fed to scipy.interpolate.splprep()</span>
<span class="sd">        NP :        int</span>
<span class="sd">            Number of points to be used to define the smoothed polygon</span>
<span class="sd">        Plot :      bool</span>
<span class="sd">            Flag indicating whether the result shall be plotted for visual inspection</span>
<span class="sd">        Test :      bool</span>
<span class="sd">            Flag indicating whether the inputs should be tested for conformity</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Poly :      np.ndarray</span>
<span class="sd">            (2,N) polygon resulting from homothetic transform, truncating and optional smoothing</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_tfg_c</span><span class="o">.</span><span class="n">_Ves_get_InsideConvexPoly</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Poly</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_P2Min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_P2Max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">BaryS</span><span class="p">,</span> <span class="n">RelOff</span><span class="o">=</span><span class="n">RelOff</span><span class="p">,</span> <span class="n">ZLim</span><span class="o">=</span><span class="n">ZLim</span><span class="p">,</span> <span class="n">Spline</span><span class="o">=</span><span class="n">Spline</span><span class="p">,</span> <span class="n">Splprms</span><span class="o">=</span><span class="n">Splprms</span><span class="p">,</span> <span class="n">NP</span><span class="o">=</span><span class="n">NP</span><span class="p">,</span> <span class="n">Plot</span><span class="o">=</span><span class="n">Plot</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="n">Test</span><span class="p">)</span></div>

<div class="viewcode-block" id="Ves.get_MeshCrossSection"><a class="viewcode-back" href="../../../Auto_tofu.geom.html#tofu.geom.Ves.get_MeshCrossSection">[docs]</a>    <span class="k">def</span> <span class="nf">get_MeshCrossSection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">CrossMesh</span><span class="o">=</span><span class="p">[</span><span class="mf">0.01</span><span class="p">,</span><span class="mf">0.01</span><span class="p">],</span> <span class="n">CrossMeshMode</span><span class="o">=</span><span class="s">&#39;abs&#39;</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="k">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return a (2,N) array of 2D points coordinates meshing the Ves cross-section using the spacing specified by CrossMesh for each direction (taken as absolute distance or relative to the total size)</span>

<span class="sd">        Method used for fast automatic meshing of the cross-section using a rectangular mesh uniform in each direction.</span>
<span class="sd">        Returns the flattened points coordinates array, as well as the two increasing vectors and number of points.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        CrossMesh :     iterable</span>
<span class="sd">            Iterable of len()==2 specifying the distance to be used between points in each direction (R or Y and Z), in absolute value or relative to the total size of the Ves in each direction</span>
<span class="sd">        CrossMeshMode : str</span>
<span class="sd">            Flag specifying whether the distances provided in CrossMesh are absolute (&#39;abs&#39;) or relative (&#39;rel&#39;)</span>
<span class="sd">        Test :          bool</span>
<span class="sd">            Flag indicating whether the inputs should be tested for conformity</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Pts :           np.ndarray</span>
<span class="sd">            Array of shape (2,N), comtaining the 2D coordinates of the N points consituting the mesh, only points lying inside the cross-section are returned</span>
<span class="sd">        X1 :            np.ndarray</span>
<span class="sd">            Flat array of the unique first coordinates of the mesh points (R or Y)</span>
<span class="sd">        X2 :            np.ndarray</span>
<span class="sd">            Flat array of the unique second coordinates of the mesh points (Z)</span>
<span class="sd">        NumX1 :         int</span>
<span class="sd">            Number of unique values in X1 (=X1.size)</span>
<span class="sd">        NumX2 :         int</span>
<span class="sd">            Number of unique values in X2 (=X2.size)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Pts</span><span class="p">,</span> <span class="n">X1</span><span class="p">,</span> <span class="n">X2</span><span class="p">,</span> <span class="n">NumX1</span><span class="p">,</span> <span class="n">NumX2</span> <span class="o">=</span> <span class="n">_tfg_c</span><span class="o">.</span><span class="n">_Ves_get_MeshCrossSection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_P1Min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_P1Max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_P2Min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_P2Max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Poly</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Type</span><span class="p">,</span> <span class="n">DLong</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">DLong</span><span class="p">,</span> <span class="n">CrossMesh</span><span class="o">=</span><span class="n">CrossMesh</span><span class="p">,</span> <span class="n">CrossMeshMode</span><span class="o">=</span><span class="n">CrossMeshMode</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="n">Test</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Pts</span><span class="p">,</span> <span class="n">X1</span><span class="p">,</span> <span class="n">X2</span><span class="p">,</span> <span class="n">NumX1</span><span class="p">,</span> <span class="n">NumX2</span></div>



<div class="viewcode-block" id="Ves.plot"><a class="viewcode-back" href="../../../Auto_tofu.geom.html#tofu.geom.Ves.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Lax</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Proj</span><span class="o">=</span><span class="s">&#39;All&#39;</span><span class="p">,</span> <span class="n">Elt</span><span class="o">=</span><span class="s">&#39;PIBsBvV&#39;</span><span class="p">,</span> <span class="n">Pdict</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Idict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">TorId</span><span class="p">,</span> <span class="n">Bsdict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">TorBsd</span><span class="p">,</span> <span class="n">Bvdict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">TorBvd</span><span class="p">,</span> <span class="n">Vdict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">TorVind</span><span class="p">,</span>
            <span class="n">IdictHor</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">TorITord</span><span class="p">,</span> <span class="n">BsdictHor</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">TorBsTord</span><span class="p">,</span> <span class="n">BvdictHor</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">TorBvTord</span><span class="p">,</span> <span class="n">Lim</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">Tor3DThetalim</span><span class="p">,</span> <span class="n">Nstep</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">TorNTheta</span><span class="p">,</span> <span class="n">LegDict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">TorLegd</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="k">True</span><span class="p">,</span> <span class="n">a4</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="k">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Plot the polygon defining the vessel, with a cross-section view, a longitudinal view or both, and optionally its reference point for plotting it in projection space</span>

<span class="sd">        Generic method for plotting the Ves object, the projections to be plotted, the elements to plot, and the dictionaries or properties to be used for plotting each elements can all be specified using keyword arguments.</span>
<span class="sd">        If an ax is not provided a default one is created.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        Lax :       list or plt.Axes</span>
<span class="sd">            The axes to be used for plotting (provide a list of 2 axes if Proj=&#39;All&#39;), if None a new figure with axes is created</span>
<span class="sd">        Proj :      str</span>
<span class="sd">            Flag specifying the kind of projection used for the plot (&#39;Cross&#39; for a cross-section, &#39;Hor&#39; for a horizontal plane, or &#39;All&#39; for the two plots)</span>
<span class="sd">        Elt  :      str</span>
<span class="sd">            Flag specifying which elements to plot, each capital letter corresponds to an element</span>
<span class="sd">                * &#39;P&#39;: polygon</span>
<span class="sd">                * &#39;I&#39;: point used as a reference for computing impact parameters</span>
<span class="sd">                * &#39;Bs&#39;: (surfacic) center of mass</span>
<span class="sd">                * &#39;Bv&#39;: (volumic) center of mass for Tor type</span>
<span class="sd">                * &#39;V&#39;: vector pointing inward perpendicular to each segment defining the polygon</span>
<span class="sd">        Pdict :     dict or None</span>
<span class="sd">            Dictionary of properties used for plotting the polygon, fed to plt.Axes.plot() or plt.plot_surface() if Proj=&#39;3d&#39;, set to ToFu_Defauts.py if None</span>
<span class="sd">        Idict :     dict</span>
<span class="sd">            Dictionary of properties used for plotting point &#39;I&#39; in Cross-section projection, fed to plt.Axes.plot()</span>
<span class="sd">        IdictHor :  dict</span>
<span class="sd">            Dictionary of properties used for plotting point &#39;I&#39; in horizontal projection, fed to plt.Axes.plot()</span>
<span class="sd">        Bsdict :    dict</span>
<span class="sd">            Dictionary of properties used for plotting point &#39;Bs&#39; in Cross-section projection, fed to plt.Axes.plot()</span>
<span class="sd">        BsdictHor : dict</span>
<span class="sd">            Dictionry of properties used for plotting point &#39;Bs&#39; in horizontal projection, fed to plt.Axes.plot()</span>
<span class="sd">        Bvdict :    dict</span>
<span class="sd">            Dictionary of properties used for plotting point &#39;Bv&#39; in Cross-section projection, fed to plt.Axes.plot()</span>
<span class="sd">        BvdictHor : dict</span>
<span class="sd">            Dictionary of properties used for plotting point &#39;Bv&#39; in horizontal projection, fed to plt.Axes.plot()</span>
<span class="sd">        Vdict :     dict</span>
<span class="sd">            Dictionary of properties used for plotting point &#39;V&#39; in cross-section projection, fed to plt.Axes.quiver()</span>
<span class="sd">        LegDict :   dict or None</span>
<span class="sd">            Dictionary of properties used for plotting the legend, fed to plt.legend(), the legend is not plotted if None</span>
<span class="sd">        Lim :       list or tuple</span>
<span class="sd">            Array of a lower and upper limit of angle (rad.) or length for plotting the &#39;3d&#39; Proj</span>
<span class="sd">        Nstep :     int</span>
<span class="sd">            Number of points for sampling in ignorable coordinate (toroidal angle or length)</span>
<span class="sd">        draw :      bool</span>
<span class="sd">            Flag indicating whether the fig.canvas.draw() shall be called automatically</span>
<span class="sd">        a4 :        bool</span>
<span class="sd">            Flag indicating whether the figure should be plotted in a4 dimensions for printing</span>
<span class="sd">        Test :      bool</span>
<span class="sd">            Flag indicating whether the inputs should be tested for conformity</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        La          list or plt.Axes    Handles of the axes used for plotting (list if several axes where used)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_tfg_p</span><span class="o">.</span><span class="n">Ves_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Lax</span><span class="o">=</span><span class="n">Lax</span><span class="p">,</span> <span class="n">Proj</span><span class="o">=</span><span class="n">Proj</span><span class="p">,</span> <span class="n">Elt</span><span class="o">=</span><span class="n">Elt</span><span class="p">,</span> <span class="n">Pdict</span><span class="o">=</span><span class="n">Pdict</span><span class="p">,</span> <span class="n">Idict</span><span class="o">=</span><span class="n">Idict</span><span class="p">,</span> <span class="n">Bsdict</span><span class="o">=</span><span class="n">Bsdict</span><span class="p">,</span> <span class="n">Bvdict</span><span class="o">=</span><span class="n">Bvdict</span><span class="p">,</span> <span class="n">Vdict</span><span class="o">=</span><span class="n">Vdict</span><span class="p">,</span>
                <span class="n">IdictHor</span><span class="o">=</span><span class="n">IdictHor</span><span class="p">,</span> <span class="n">BsdictHor</span><span class="o">=</span><span class="n">BsdictHor</span><span class="p">,</span> <span class="n">BvdictHor</span><span class="o">=</span><span class="n">BvdictHor</span><span class="p">,</span> <span class="n">Lim</span><span class="o">=</span><span class="n">Lim</span><span class="p">,</span> <span class="n">Nstep</span><span class="o">=</span><span class="n">Nstep</span><span class="p">,</span> <span class="n">LegDict</span><span class="o">=</span><span class="n">LegDict</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="n">draw</span><span class="p">,</span> <span class="n">a4</span><span class="o">=</span><span class="n">a4</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="n">Test</span><span class="p">)</span></div>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    def plot_3D_mlab(self,f=None,Tdict=Dict_3D_mlab_Tor_Def,LegDict=LegDict_Def,Test=True):</span>
<span class="sd">        f = Plot_3D_mlab_Tor(self,fig=f,Tdict=Tdict,LegDict=LegDict,Test=Test)</span>
<span class="sd">        return f</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Ves.plot_Sinogram"><a class="viewcode-back" href="../../../Auto_tofu.geom.html#tofu.geom.Ves.plot_Sinogram">[docs]</a>    <span class="k">def</span> <span class="nf">plot_Sinogram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Proj</span><span class="o">=</span><span class="s">&#39;Cross&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Ang</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">LOSImpAng</span><span class="p">,</span> <span class="n">AngUnit</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">LOSImpAngUnit</span><span class="p">,</span> <span class="n">Sketch</span><span class="o">=</span><span class="k">True</span><span class="p">,</span> <span class="n">Pdict</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">LegDict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">TorLegd</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="k">True</span><span class="p">,</span> <span class="n">a4</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="k">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Plot the sinogram of the vessel polygon, by computing its envelopp in a cross-section, can also plot a 3D version of it</span>

<span class="sd">        The envelop of the polygon is computed using self.Sino_RefPt as a reference point in projection space, and plotted using the provided dictionary of properties.</span>
<span class="sd">        Optionaly a smal sketch can be included illustrating how the angle and the impact parameters are defined (if the axes is not provided).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        Proj :      str</span>
<span class="sd">            Flag indicating whether to plot a classic sinogram (&#39;Cross&#39;) from the vessel cross-section (assuming 2D), or an extended 3D version &#39;3d&#39; of it with additional angle</span>
<span class="sd">        ax   :      None or plt.Axes</span>
<span class="sd">            The axes on which the plot should be done, if None a new figure and axes is created</span>
<span class="sd">        Ang  :      str</span>
<span class="sd">            Flag indicating which angle to use for the impact parameter, the angle of the line itself (xi) or of its impact parameter (theta)</span>
<span class="sd">        AngUnit :   str</span>
<span class="sd">            Flag for the angle units to be displayed, &#39;rad&#39; for radians or &#39;deg&#39; for degrees</span>
<span class="sd">        Sketch :    bool</span>
<span class="sd">            Flag indicating whether a small skecth showing the definitions of angles &#39;theta&#39; and &#39;xi&#39; should be included or not</span>
<span class="sd">        Pdict :     dict</span>
<span class="sd">            Dictionary of properties used for plotting the polygon envelopp, fed to plt.plot() if Proj=&#39;Cross&#39; and to plt.plot_surface() if Proj=&#39;3d&#39;</span>
<span class="sd">        LegDict :   None or dict</span>
<span class="sd">            Dictionary of properties used for plotting the legend, fed to plt.legend(), the legend is not plotted if None</span>
<span class="sd">        draw :      bool</span>
<span class="sd">            Flag indicating whether the fig.canvas.draw() shall be called automatically</span>
<span class="sd">        a4 :        bool</span>
<span class="sd">            Flag indicating whether the figure should be plotted in a4 dimensions for printing</span>
<span class="sd">        Test :      bool</span>
<span class="sd">            Flag indicating whether the inputs shall be tested for conformity</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ax :        plt.Axes</span>
<span class="sd">            The axes used to plot</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">Test</span><span class="p">:</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">Sino_RefPt</span> <span class="ow">is</span> <span class="k">None</span><span class="p">,</span> <span class="s">&#39;The impact parameters must be computed first !&#39;</span>
            <span class="k">assert</span> <span class="n">Proj</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;Cross&#39;</span><span class="p">,</span><span class="s">&#39;3d&#39;</span><span class="p">],</span> <span class="s">&quot;Arg Proj must be in [&#39;Cross&#39;,&#39;3d&#39;] !&quot;</span>
        <span class="k">if</span> <span class="n">Proj</span><span class="o">==</span><span class="s">&#39;Cross&#39;</span><span class="p">:</span>
            <span class="n">Pdict</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">TorPFilld</span> <span class="k">if</span> <span class="n">Pdict</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">else</span> <span class="n">Pdict</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">_tfg_p</span><span class="o">.</span><span class="n">Plot_Impact_PolProjPoly</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">Ang</span><span class="o">=</span><span class="n">Ang</span><span class="p">,</span> <span class="n">AngUnit</span><span class="o">=</span><span class="n">AngUnit</span><span class="p">,</span> <span class="n">Sketch</span><span class="o">=</span><span class="n">Sketch</span><span class="p">,</span> <span class="n">Leg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">NameLTX</span><span class="p">,</span> <span class="n">Pdict</span><span class="o">=</span><span class="n">Pdict</span><span class="p">,</span> <span class="n">LegDict</span><span class="o">=</span><span class="n">LegDict</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">a4</span><span class="o">=</span><span class="n">a4</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="n">Test</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Pdict</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">TorP3DFilld</span> <span class="k">if</span> <span class="n">Pdict</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">else</span> <span class="n">Pdict</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">_tfg_p</span><span class="o">.</span><span class="n">Plot_Impact_3DPoly</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">Ang</span><span class="o">=</span><span class="n">Ang</span><span class="p">,</span> <span class="n">AngUnit</span><span class="o">=</span><span class="n">AngUnit</span><span class="p">,</span> <span class="n">Pdict</span><span class="o">=</span><span class="n">Pdict</span><span class="p">,</span> <span class="n">LegDict</span><span class="o">=</span><span class="n">LegDict</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">a4</span><span class="o">=</span><span class="n">a4</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="n">Test</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">draw</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">ax</span></div>

<div class="viewcode-block" id="Ves.save"><a class="viewcode-back" href="../../../Auto_tofu.geom.html#tofu.geom.Ves.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">SaveName</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Path</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Mode</span><span class="o">=</span><span class="s">&#39;npz&#39;</span><span class="p">,</span> <span class="n">compressed</span><span class="o">=</span><span class="k">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Save the object in folder Name, under file name SaveName, using specified mode</span>

<span class="sd">        Most tofu objects can be saved automatically as numpy arrays (.npz, recommended) at the default location (recommended) by simply calling self.save()</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        SaveName :  None / str</span>
<span class="sd">            The name to be used for the saved file, if None (recommended) uses self.Id.SaveName</span>
<span class="sd">        Path :      None / str</span>
<span class="sd">            Path specifying where to save the file, if None (recommended) uses self.Id.SavePath</span>
<span class="sd">        Mode :      str</span>
<span class="sd">            Flag specifying whether to save the object as a numpy array file (&#39;.npz&#39;, recommended) or an object using cPickle (not recommended, heavier and may cause retro-compatibility issues)</span>
<span class="sd">        compressed :    bool</span>
<span class="sd">            Flag, used when Mode=&#39;npz&#39;, indicating whether to use np.savez or np.savez_compressed (slower saving and loading but smaller files)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tfpf</span><span class="o">.</span><span class="n">Save_Generic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">SaveName</span><span class="o">=</span><span class="n">SaveName</span><span class="p">,</span> <span class="n">Path</span><span class="o">=</span><span class="n">Path</span><span class="p">,</span> <span class="n">Mode</span><span class="o">=</span><span class="n">Mode</span><span class="p">,</span> <span class="n">compressed</span><span class="o">=</span><span class="n">compressed</span><span class="p">)</span></div></div>




<span class="k">def</span> <span class="nf">_Ves_check_inputs</span><span class="p">(</span><span class="n">Id</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Poly</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">DLong</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Sino_RefPt</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Sino_NP</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Clock</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">arrayorder</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">dtime</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">dtimeIn</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">Id</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">Id</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">tfpf</span><span class="o">.</span><span class="n">ID</span><span class="p">],</span> <span class="s">&quot;Arg Id must be a str or a tfpf.ID object !&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">Poly</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">Poly</span><span class="p">,</span><span class="s">&#39;__iter__&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">Poly</span><span class="p">)</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">2</span> <span class="ow">and</span> <span class="mi">2</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">Poly</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s">&quot;Arg Poly must be a dict or an iterable with 2D coordinates of cross section poly !&quot;</span>
    <span class="n">bools</span> <span class="o">=</span> <span class="p">[</span><span class="n">Clock</span><span class="p">,</span><span class="n">dtimeIn</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="ow">not</span> <span class="n">aa</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">bools</span><span class="p">]):</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">aa</span> <span class="ow">is</span> <span class="k">None</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">aa</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">bool</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">bools</span><span class="p">]),</span> <span class="s">&quot; Args [Clock,dtimeIn] must all be bool !&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">arrayorder</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">arrayorder</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;C&#39;</span><span class="p">,</span><span class="s">&#39;F&#39;</span><span class="p">],</span> <span class="s">&quot;Arg arrayorder must be in [&#39;C&#39;,&#39;F&#39;] !&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">Type</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">Type</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;Tor&#39;</span><span class="p">,</span><span class="s">&#39;Lin&#39;</span><span class="p">],</span> <span class="s">&quot;Arg Type must be in [&#39;Tor&#39;,&#39;Lin&#39;] !&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">Exp</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">Exp</span> <span class="ow">in</span> <span class="n">tfd</span><span class="o">.</span><span class="n">AllowedExp</span><span class="p">,</span> <span class="s">&quot;Ar Exp must be in &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">AllowedExp</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; !&quot;</span>
    <span class="n">strs</span> <span class="o">=</span> <span class="p">[</span><span class="n">SavePath</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="ow">not</span> <span class="n">aa</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">strs</span><span class="p">]):</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">aa</span> <span class="ow">is</span> <span class="k">None</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">aa</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">strs</span><span class="p">]),</span> <span class="s">&quot;Args [Type,Exp,SavePath] must all be str !&quot;</span>
    <span class="n">Iter2</span> <span class="o">=</span> <span class="p">[</span><span class="n">DLong</span><span class="p">,</span><span class="n">Sino_RefPt</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="ow">not</span> <span class="n">aa</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">Iter2</span><span class="p">]):</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">aa</span> <span class="ow">is</span> <span class="k">None</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">aa</span><span class="p">,</span><span class="s">&#39;__iter__&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">aa</span><span class="p">)</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">aa</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="o">==</span><span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">Iter2</span><span class="p">]),</span> <span class="s">&quot;Args [DLong,Sino_RefPt] must be an iterable with len()=2 !&quot;</span>
    <span class="n">Ints</span> <span class="o">=</span> <span class="p">[</span><span class="n">Sino_NP</span><span class="p">,</span><span class="n">shot</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="ow">not</span> <span class="n">aa</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">Ints</span><span class="p">]):</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">aa</span> <span class="ow">is</span> <span class="k">None</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">aa</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">Ints</span><span class="p">]),</span> <span class="s">&quot;Args [Sino_NP,shot] must be int !&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">dtime</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">dtime</span><span class="p">)</span> <span class="ow">is</span> <span class="n">dtm</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="s">&quot;Arg dtime must be a dtm.datetime !&quot;</span>










<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">###############################################################################</span>
<span class="sd">###############################################################################</span>
<span class="sd">                        Sruct class and functions</span>
<span class="sd">###############################################################################</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c"># A class defining a Linear or Toroidal structural element (i.e. a 2D polygon representing a cross-section and assumed to be linearly or toroidally invariant), has no physical role, just used for illustrative purposes in plots</span>


<div class="viewcode-block" id="Struct"><a class="viewcode-back" href="../../../Auto_tofu.geom.html#tofu.geom.Struct">[docs]</a><span class="k">class</span> <span class="nc">Struct</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; A class defining a Linear or Toroidal structural element (i.e. a 2D polygon representing a cross-section and assumed to be linearly or toroidally invariant), like a :class:`~tofu.geom.Ves` but with less properties.</span>

<span class="sd">    A Struct object is mostly defined by a close 2D polygon, which can be understood as a poloidal cross-section in (R,Z) cylindrical coordinates if Type=&#39;Tor&#39; (toroidal shape) or as a straight cross-section through a cylinder in (Y,Z) cartesian coordinates if Type=&#39;Lin&#39; (linear shape).</span>
<span class="sd">    Attributes such as the surface, the angular volume (if Type=&#39;Tor&#39;) or the center of mass are automatically computed.</span>
<span class="sd">    The instance is identified thanks to an attribute Id (which is itself a tofu.ID class object) which contains informations on the specific instance (name, Type...).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    Id :            str / tfpf.ID</span>
<span class="sd">        A name string or a pre-built tfpf.ID class to be used to identify this particular instance, if a string is provided, it is fed to tfpf.ID()</span>
<span class="sd">    Poly :          np.ndarray</span>
<span class="sd">        An array (2,N) or (N,2) defining the contour of the vacuum vessel in a cross-section, if not closed, will be closed automatically</span>
<span class="sd">    Type :          str</span>
<span class="sd">        Flag indicating whether the vessel will be a torus (&#39;Tor&#39;) or a linear device (&#39;Lin&#39;)</span>
<span class="sd">    DLong :         list / np.ndarray</span>
<span class="sd">        Array or list of len=2 indicating the limits of the linear device volume on the x axis</span>
<span class="sd">    Ves :           None or :class:`~tofu.geom.Ves`</span>
<span class="sd">        An optional associated vessel</span>
<span class="sd">    Clock :         bool</span>
<span class="sd">        Flag indicating whether the input polygon should be made clockwise (True) or counter-clockwise (False)</span>
<span class="sd">    arrayorder:     str</span>
<span class="sd">        Flag indicating whether the attributes of type=np.ndarray (e.g.: Poly) should be made C-contiguous (&#39;C&#39;) or Fortran-contiguous (&#39;F&#39;)</span>
<span class="sd">    Exp :           None / str</span>
<span class="sd">        Flag indicating which experiment the object corresponds to, allowed values are in [None,&#39;AUG&#39;,&#39;MISTRAL&#39;,&#39;JET&#39;,&#39;ITER&#39;,&#39;TCV&#39;,&#39;TS&#39;,&#39;Misc&#39;]</span>
<span class="sd">    shot :          None / int</span>
<span class="sd">        Shot number from which this Ves is usable (in case of change of geometry)</span>
<span class="sd">    SavePath :      None / str</span>
<span class="sd">        If provided, forces the default saving path of the object to the provided value</span>
<span class="sd">    dtime :         None / dtm.datetime</span>
<span class="sd">        A time reference to be used to identify this particular instance (used for debugging mostly)</span>
<span class="sd">    dtimeIn :       bool</span>
<span class="sd">        Flag indicating whether dtime should be included in the SaveName (used for debugging mostly)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    struct :        Struct object</span>
<span class="sd">        The created Struct object, with all necessary computed attributes and methods</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="n">Poly</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="s">&#39;Tor&#39;</span><span class="p">,</span> <span class="n">DLong</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Ves</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Clock</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">arrayorder</span><span class="o">=</span><span class="s">&#39;C&#39;</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">dtime</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">dtimeIn</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_Done</span> <span class="o">=</span> <span class="k">False</span>
        <span class="n">tfpf</span><span class="o">.</span><span class="n">_check_NotNone</span><span class="p">({</span><span class="s">&#39;Id&#39;</span><span class="p">:</span><span class="n">Id</span><span class="p">,</span> <span class="s">&#39;Poly&#39;</span><span class="p">:</span><span class="n">Poly</span><span class="p">,</span> <span class="s">&#39;Type&#39;</span><span class="p">:</span><span class="n">Type</span><span class="p">,</span> <span class="s">&#39;Clock&#39;</span><span class="p">:</span><span class="n">Clock</span><span class="p">,</span><span class="s">&#39;arrayorder&#39;</span><span class="p">:</span><span class="n">arrayorder</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_inputs</span><span class="p">(</span><span class="n">Clock</span><span class="o">=</span><span class="n">Clock</span><span class="p">,</span> <span class="n">arrayorder</span><span class="o">=</span><span class="n">arrayorder</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_arrayorder</span> <span class="o">=</span> <span class="n">arrayorder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Clock</span> <span class="o">=</span> <span class="n">Clock</span>
        <span class="n">Type</span> <span class="o">=</span> <span class="n">Type</span> <span class="k">if</span> <span class="n">Ves</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">else</span> <span class="n">Ves</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_Id</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="n">Type</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="n">Exp</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="n">shot</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="n">SavePath</span><span class="p">,</span> <span class="n">dtime</span><span class="o">=</span><span class="n">dtime</span><span class="p">,</span> <span class="n">dtimeIn</span><span class="o">=</span><span class="n">dtimeIn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_Ves</span><span class="p">(</span><span class="n">Ves</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_Poly</span><span class="p">(</span><span class="n">Poly</span><span class="p">,</span> <span class="n">DLong</span><span class="o">=</span><span class="n">DLong</span><span class="p">,</span> <span class="n">Clock</span><span class="o">=</span><span class="n">Clock</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_arrayorder</span><span class="p">(</span><span class="n">arrayorder</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Done</span> <span class="o">=</span> <span class="k">True</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the tfpf.ID object of the structure &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Id</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the type of structure &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Type</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Poly</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the polygon defining the vessel cross-section&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Poly</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Vect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the polygon elementary vectors&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Vect</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Vin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the normalized vectors pointing inwards for each segment of the polygon&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Vin</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">DLong</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the length spanned by the object in the ignorable coordinate &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DLong</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Surf</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the area of the polygon defining the vessel cross-section&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Surf</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">VolLin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the angular volume of the polygon defining the vessel cross-section of Tor type&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_VolLin</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">BaryS</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the (surfacic) center of mass of the polygon defining the vessel cross-section&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_BaryS</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">BaryV</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the (volumic) center of mass of the polygon defining the vessel cross-section&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_BaryV</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Ves</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the associated :class:`~tofu.goem.Ves` object, if any &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Ves</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">arrayorder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the flag indicating which order is used for multi-dimensional array attributes&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_arrayorder</span>


    <span class="k">def</span> <span class="nf">_check_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Id</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Poly</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">DLong</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Ves</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Clock</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">arrayorder</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">dtime</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">dtimeIn</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
        <span class="n">_Struct_check_inputs</span><span class="p">(</span><span class="n">Id</span><span class="o">=</span><span class="n">Id</span><span class="p">,</span> <span class="n">Poly</span><span class="o">=</span><span class="n">Poly</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="n">Type</span><span class="p">,</span> <span class="n">DLong</span><span class="o">=</span><span class="n">DLong</span><span class="p">,</span> <span class="n">Vess</span><span class="o">=</span><span class="n">Ves</span><span class="p">,</span> <span class="n">Clock</span><span class="o">=</span><span class="n">Clock</span><span class="p">,</span> <span class="n">arrayorder</span><span class="o">=</span><span class="n">arrayorder</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="n">Exp</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="n">shot</span><span class="p">,</span> <span class="n">dtime</span><span class="o">=</span><span class="n">dtime</span><span class="p">,</span> <span class="n">dtimeIn</span><span class="o">=</span><span class="n">dtimeIn</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="n">SavePath</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_Id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Val</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">dtime</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">dtimeIn</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Done</span><span class="p">:</span>
            <span class="n">Out</span> <span class="o">=</span> <span class="n">tfpf</span><span class="o">.</span><span class="n">_get_FromItself</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="p">,{</span><span class="s">&#39;Type&#39;</span><span class="p">:</span><span class="n">Type</span><span class="p">,</span> <span class="s">&#39;Exp&#39;</span><span class="p">:</span><span class="n">Exp</span><span class="p">,</span> <span class="s">&#39;shot&#39;</span><span class="p">:</span><span class="n">shot</span><span class="p">,</span> <span class="s">&#39;dtime&#39;</span><span class="p">:</span><span class="n">dtime</span><span class="p">,</span> <span class="s">&#39;_dtimeIn&#39;</span><span class="p">:</span><span class="n">dtimeIn</span><span class="p">,</span> <span class="s">&#39;SavePath&#39;</span><span class="p">:</span><span class="n">SavePath</span><span class="p">})</span>
            <span class="n">Type</span><span class="p">,</span> <span class="n">Exp</span><span class="p">,</span> <span class="n">shot</span><span class="p">,</span> <span class="n">dtime</span><span class="p">,</span> <span class="n">dtimeIn</span><span class="p">,</span> <span class="n">SavePath</span> <span class="o">=</span> <span class="n">Out</span><span class="p">[</span><span class="s">&#39;Type&#39;</span><span class="p">],</span> <span class="n">Out</span><span class="p">[</span><span class="s">&#39;Exp&#39;</span><span class="p">],</span> <span class="n">Out</span><span class="p">[</span><span class="s">&#39;shot&#39;</span><span class="p">],</span> <span class="n">Out</span><span class="p">[</span><span class="s">&#39;dtime&#39;</span><span class="p">],</span> <span class="n">Out</span><span class="p">[</span><span class="s">&#39;dtimeIn&#39;</span><span class="p">],</span> <span class="n">Out</span><span class="p">[</span><span class="s">&#39;SavePath&#39;</span><span class="p">]</span>
        <span class="n">tfpf</span><span class="o">.</span><span class="n">_check_NotNone</span><span class="p">({</span><span class="s">&#39;Id&#39;</span><span class="p">:</span><span class="n">Val</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_inputs</span><span class="p">(</span><span class="n">Id</span><span class="o">=</span><span class="n">Val</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">Val</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">tfpf</span><span class="o">.</span><span class="n">_check_NotNone</span><span class="p">({</span><span class="s">&#39;Type&#39;</span><span class="p">:</span><span class="n">Type</span><span class="p">,</span> <span class="s">&#39;Exp&#39;</span><span class="p">:</span><span class="n">Exp</span><span class="p">,</span> <span class="s">&#39;shot&#39;</span><span class="p">:</span><span class="n">shot</span><span class="p">,</span> <span class="s">&#39;dtimeIn&#39;</span><span class="p">:</span><span class="n">dtimeIn</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_inputs</span><span class="p">(</span><span class="n">Type</span><span class="o">=</span><span class="n">Type</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="n">Exp</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="n">shot</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="n">SavePath</span><span class="p">,</span> <span class="n">dtime</span><span class="o">=</span><span class="n">dtime</span><span class="p">,</span> <span class="n">dtimeIn</span><span class="o">=</span><span class="n">dtimeIn</span><span class="p">)</span>
            <span class="n">Val</span> <span class="o">=</span> <span class="n">tfpf</span><span class="o">.</span><span class="n">ID</span><span class="p">(</span><span class="s">&#39;Struct&#39;</span><span class="p">,</span> <span class="n">Val</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="n">Type</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="n">Exp</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="n">shot</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="n">SavePath</span><span class="p">,</span> <span class="n">dtime</span><span class="o">=</span><span class="n">dtime</span><span class="p">,</span> <span class="n">dtimeIn</span><span class="o">=</span><span class="n">dtimeIn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Id</span> <span class="o">=</span> <span class="n">Val</span>

    <span class="k">def</span> <span class="nf">_set_arrayorder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arrayorder</span><span class="p">):</span>
        <span class="n">tfpf</span><span class="o">.</span><span class="n">_set_arrayorder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arrayorder</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_Ves</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Ves</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_inputs</span><span class="p">(</span><span class="n">Ves</span><span class="o">=</span><span class="n">Ves</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Type</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Ves</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">set_LObj</span><span class="p">([</span><span class="n">Ves</span><span class="o">.</span><span class="n">Id</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Ves</span> <span class="o">=</span> <span class="n">Ves</span>

    <span class="k">def</span> <span class="nf">_set_Poly</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Poly</span><span class="p">,</span> <span class="n">DLong</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Clock</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">Sino_RefPt</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Sino_NP</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">TorNP</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Done</span><span class="p">:</span>
            <span class="n">Out</span> <span class="o">=</span> <span class="n">tfpf</span><span class="o">.</span><span class="n">_get_FromItself</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;DLong&#39;</span><span class="p">:</span><span class="n">DLong</span><span class="p">,</span> <span class="s">&#39;_Clock&#39;</span><span class="p">:</span><span class="n">Clock</span><span class="p">})</span>
            <span class="n">DLong</span><span class="p">,</span> <span class="n">Clock</span> <span class="o">=</span> <span class="n">Out</span><span class="p">[</span><span class="s">&#39;DLong&#39;</span><span class="p">],</span> <span class="n">Out</span><span class="p">[</span><span class="s">&#39;Clock&#39;</span><span class="p">]</span>
        <span class="n">tfpf</span><span class="o">.</span><span class="n">_check_NotNone</span><span class="p">({</span><span class="s">&#39;Poly&#39;</span><span class="p">:</span><span class="n">Poly</span><span class="p">,</span> <span class="s">&#39;Clock&#39;</span><span class="p">:</span><span class="n">Clock</span><span class="p">})</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ves</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">Type</span><span class="o">==</span><span class="s">&#39;Lin&#39;</span> <span class="ow">and</span> <span class="n">DLong</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="n">DLong</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">DLong</span>
        <span class="n">Out</span> <span class="o">=</span> <span class="n">_tfg_c</span><span class="o">.</span><span class="n">_Ves_set_Poly</span><span class="p">(</span><span class="n">Poly</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrayorder</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Type</span><span class="p">,</span> <span class="n">DLong</span><span class="o">=</span><span class="n">DLong</span><span class="p">,</span> <span class="n">Clock</span><span class="o">=</span><span class="n">Clock</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Poly</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_NP</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_P1Max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_P1Min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_P2Max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_P2Min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_BaryP</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_BaryL</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Surf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_BaryS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DLong</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_VolLin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_BaryV</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Vect</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Vin</span> <span class="o">=</span> <span class="n">Out</span>

<div class="viewcode-block" id="Struct.isInside"><a class="viewcode-back" href="../../../Auto_tofu.geom.html#tofu.geom.Struct.isInside">[docs]</a>    <span class="k">def</span> <span class="nf">isInside</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Pts</span><span class="p">,</span> <span class="n">In</span><span class="o">=</span><span class="s">&#39;(X,Y,Z)&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return an array of booleans indicating whether each point lies inside the Ves volume</span>

<span class="sd">        Tests for each point whether it lies inside the Ves object.</span>
<span class="sd">        The points coordinates can be provided in 2D or 3D, just specify which coordinate system is provided using the &#39;In&#39; parameter.</span>
<span class="sd">        An array of boolean flags is returned.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        Pts :   np.ndarray</span>
<span class="sd">            (2,N) or (3,N) array with the coordinates of the points to be tested</span>
<span class="sd">        In :    str</span>
<span class="sd">            Flag indicating the coordinate system in which the points are provided, in [&#39;(X,Y,Z)&#39;,&#39;(R,Z)&#39;,&#39;&#39;]</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ind :   np.ndarray</span>
<span class="sd">            Array of booleans of shape (N,), True if a point is inside the Ves volume</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_tfg_c</span><span class="o">.</span><span class="n">_Ves_isInside</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Poly</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">DLong</span><span class="p">,</span> <span class="n">Pts</span><span class="p">,</span> <span class="n">In</span><span class="o">=</span><span class="n">In</span><span class="p">)</span></div>

<div class="viewcode-block" id="Struct.plot"><a class="viewcode-back" href="../../../Auto_tofu.geom.html#tofu.geom.Struct.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Lax</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Proj</span><span class="o">=</span><span class="s">&#39;All&#39;</span><span class="p">,</span> <span class="n">Elt</span><span class="o">=</span><span class="s">&#39;P&#39;</span><span class="p">,</span> <span class="n">Pdict</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Bsdict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">TorBsd</span><span class="p">,</span> <span class="n">Bvdict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">TorBvd</span><span class="p">,</span> <span class="n">Vdict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">TorVind</span><span class="p">,</span>
             <span class="n">BsdictHor</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">TorBsTord</span><span class="p">,</span> <span class="n">BvdictHor</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">TorBvTord</span><span class="p">,</span> <span class="n">Lim</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">Tor3DThetalim</span><span class="p">,</span> <span class="n">Nstep</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">TorNTheta</span><span class="p">,</span> <span class="n">LegDict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">TorLegd</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="k">True</span><span class="p">,</span> <span class="n">a4</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="k">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Plot the polygon defining the vessel, with a cross-section view, a longitudinal view or both, and optionally its reference point for plotting it in projection space</span>

<span class="sd">        Generic method for plotting the Ves object, the projections to be plotted, the elements to plot, and the dictionaries or properties to be used for plotting each elements can all be specified using keyword arguments.</span>
<span class="sd">        If an ax is not provided a default one is created.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        Lax :       list or plt.Axes</span>
<span class="sd">            The axes to be used for plotting (provide a list of 2 axes if Proj=&#39;All&#39;), if None a new figure with axes is created</span>
<span class="sd">        Proj :      str</span>
<span class="sd">            Flag specifying the kind of projection used for the plot (&#39;Cross&#39; for a cross-section, &#39;Hor&#39; for a horizontal plane, or &#39;All&#39; for the two plots)</span>
<span class="sd">        Elt  :      str</span>
<span class="sd">            Flag specifying which elements to plot, each capital letter corresponds to an element</span>
<span class="sd">                * &#39;P&#39;: polygon</span>
<span class="sd">                * &#39;Bs&#39;: (surfacic) center of mass</span>
<span class="sd">                * &#39;Bv&#39;: (volumic) center of mass for Tor type</span>
<span class="sd">                * &#39;V&#39;: vector pointing inward perpendicular to each segment defining the polygon</span>
<span class="sd">        Pdict :     dict or None</span>
<span class="sd">            Dictionary of properties used for plotting the polygon, fed to plt.Axes.plot() or plt.plot_surface() if Proj=&#39;3d&#39;, set to ToFu_Defauts.py if None</span>
<span class="sd">        Bsdict :    dict</span>
<span class="sd">            Dictionary of properties used for plotting point &#39;Bs&#39; in Cross-section projection, fed to plt.Axes.plot()</span>
<span class="sd">        BsdictHor : dict</span>
<span class="sd">            Dictionry of properties used for plotting point &#39;Bs&#39; in horizontal projection, fed to plt.Axes.plot()</span>
<span class="sd">        Bvdict :    dict</span>
<span class="sd">            Dictionary of properties used for plotting point &#39;Bv&#39; in Cross-section projection, fed to plt.Axes.plot()</span>
<span class="sd">        BvdictHor : dict</span>
<span class="sd">            Dictionary of properties used for plotting point &#39;Bv&#39; in horizontal projection, fed to plt.Axes.plot()</span>
<span class="sd">        Vdict :     dict</span>
<span class="sd">            Dictionary of properties used for plotting point &#39;V&#39; in cross-section projection, fed to plt.Axes.quiver()</span>
<span class="sd">        LegDict :   dict or None</span>
<span class="sd">            Dictionary of properties used for plotting the legend, fed to plt.legend(), the legend is not plotted if None</span>
<span class="sd">        Lim :       list or tuple</span>
<span class="sd">            Array of a lower and upper limit of angle (rad.) or length for plotting the &#39;3d&#39; Proj</span>
<span class="sd">        Nstep :     int</span>
<span class="sd">            Number of points for sampling in ignorable coordinate (toroidal angle or length)</span>
<span class="sd">        draw :      bool</span>
<span class="sd">            Flag indicating whether the fig.canvas.draw() shall be called automatically</span>
<span class="sd">        a4 :        bool</span>
<span class="sd">            Flag indicating whether the figure should be plotted in a4 dimensions for printing</span>
<span class="sd">        Test :      bool</span>
<span class="sd">            Flag indicating whether the inputs should be tested for conformity</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        La          list or plt.Axes    Handles of the axes used for plotting (list if several axes where used)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_tfg_p</span><span class="o">.</span><span class="n">Struct_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Lax</span><span class="o">=</span><span class="n">Lax</span><span class="p">,</span> <span class="n">Proj</span><span class="o">=</span><span class="n">Proj</span><span class="p">,</span> <span class="n">Elt</span><span class="o">=</span><span class="n">Elt</span><span class="p">,</span> <span class="n">Pdict</span><span class="o">=</span><span class="n">Pdict</span><span class="p">,</span> <span class="n">Bsdict</span><span class="o">=</span><span class="n">Bsdict</span><span class="p">,</span> <span class="n">Bvdict</span><span class="o">=</span><span class="n">Bvdict</span><span class="p">,</span> <span class="n">Vdict</span><span class="o">=</span><span class="n">Vdict</span><span class="p">,</span>
                                  <span class="n">BsdictHor</span><span class="o">=</span><span class="n">BsdictHor</span><span class="p">,</span> <span class="n">BvdictHor</span><span class="o">=</span><span class="n">BvdictHor</span><span class="p">,</span> <span class="n">Lim</span><span class="o">=</span><span class="n">Lim</span><span class="p">,</span> <span class="n">Nstep</span><span class="o">=</span><span class="n">Nstep</span><span class="p">,</span> <span class="n">LegDict</span><span class="o">=</span><span class="n">LegDict</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="n">draw</span><span class="p">,</span> <span class="n">a4</span><span class="o">=</span><span class="n">a4</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="n">Test</span><span class="p">)</span></div>

<div class="viewcode-block" id="Struct.save"><a class="viewcode-back" href="../../../Auto_tofu.geom.html#tofu.geom.Struct.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">SaveName</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Path</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Mode</span><span class="o">=</span><span class="s">&#39;npz&#39;</span><span class="p">,</span> <span class="n">compressed</span><span class="o">=</span><span class="k">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Save the object in folder Name, under file name SaveName, using specified mode</span>

<span class="sd">        Most tofu objects can be saved automatically as numpy arrays (.npz, recommended) at the default location (recommended) by simply calling self.save()</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        SaveName :  None / str</span>
<span class="sd">            The name to be used for the saved file, if None (recommended) uses self.Id.SaveName</span>
<span class="sd">        Path :      None / str</span>
<span class="sd">            Path specifying where to save the file, if None (recommended) uses self.Id.SavePath</span>
<span class="sd">        Mode :      str</span>
<span class="sd">            Flag specifying whether to save the object as a numpy array file (&#39;.npz&#39;, recommended) or an object using cPickle (not recommended, heavier and may cause retro-compatibility issues)</span>
<span class="sd">        compressed :    bool</span>
<span class="sd">            Flag, used when Mode=&#39;npz&#39;, indicating whether to use np.savez or np.savez_compressed (slower saving and loading but smaller files)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tfpf</span><span class="o">.</span><span class="n">Save_Generic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">SaveName</span><span class="o">=</span><span class="n">SaveName</span><span class="p">,</span> <span class="n">Path</span><span class="o">=</span><span class="n">Path</span><span class="p">,</span> <span class="n">Mode</span><span class="o">=</span><span class="n">Mode</span><span class="p">,</span> <span class="n">compressed</span><span class="o">=</span><span class="n">compressed</span><span class="p">)</span></div></div>




<span class="k">def</span> <span class="nf">_Struct_check_inputs</span><span class="p">(</span><span class="n">Id</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Poly</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">DLong</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Vess</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Clock</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">arrayorder</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">dtime</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">dtimeIn</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">Id</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">Id</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">tfpf</span><span class="o">.</span><span class="n">ID</span><span class="p">],</span> <span class="s">&quot;Arg Id must be a str or a tfpf.ID object !&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">Poly</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">Poly</span><span class="p">,</span><span class="s">&#39;__iter__&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">Poly</span><span class="p">)</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">2</span> <span class="ow">and</span> <span class="mi">2</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">Poly</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s">&quot;Arg Poly must be a dict or an iterable with 2D coordinates of cross section poly !&quot;</span>
    <span class="n">bools</span> <span class="o">=</span> <span class="p">[</span><span class="n">Clock</span><span class="p">,</span><span class="n">dtimeIn</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="ow">not</span> <span class="n">aa</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">bools</span><span class="p">]):</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">aa</span> <span class="ow">is</span> <span class="k">None</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">aa</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">bool</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">bools</span><span class="p">]),</span> <span class="s">&quot; Args [Clock,dtimeIn] must all be bool !&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">arrayorder</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">arrayorder</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;C&#39;</span><span class="p">,</span><span class="s">&#39;F&#39;</span><span class="p">],</span> <span class="s">&quot;Arg arrayorder must be in [&#39;C&#39;,&#39;F&#39;] !&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">Type</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">Type</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;Tor&#39;</span><span class="p">,</span><span class="s">&#39;Lin&#39;</span><span class="p">],</span> <span class="s">&quot;Arg Type must be in [&#39;Tor&#39;,&#39;Lin&#39;] !&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">Exp</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">Exp</span> <span class="ow">in</span> <span class="n">tfd</span><span class="o">.</span><span class="n">AllowedExp</span><span class="p">,</span> <span class="s">&quot;Ar Exp must be in &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">AllowedExp</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; !&quot;</span>
    <span class="n">strs</span> <span class="o">=</span> <span class="p">[</span><span class="n">SavePath</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="ow">not</span> <span class="n">aa</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">strs</span><span class="p">]):</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">aa</span> <span class="ow">is</span> <span class="k">None</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">aa</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">strs</span><span class="p">]),</span> <span class="s">&quot;Args [Type,Exp,SavePath] must all be str !&quot;</span>
    <span class="n">Iter2</span> <span class="o">=</span> <span class="p">[</span><span class="n">DLong</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="ow">not</span> <span class="n">aa</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">Iter2</span><span class="p">]):</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">aa</span> <span class="ow">is</span> <span class="k">None</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">aa</span><span class="p">,</span><span class="s">&#39;__iter__&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">aa</span><span class="p">)</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">aa</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="o">==</span><span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">Iter2</span><span class="p">]),</span> <span class="s">&quot;Args [DLong,Sino_RefPt] must be an iterable with len()=2 !&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">Vess</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">Vess</span><span class="p">)</span> <span class="ow">is</span> <span class="n">Ves</span><span class="p">,</span> <span class="s">&quot;Arg Ves must be a tofu.geom.Ves instance !&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Type</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">Type</span><span class="o">==</span><span class="n">Vess</span><span class="o">.</span><span class="n">Type</span><span class="p">,</span> <span class="s">&quot;Arg Ves must have same Type as the Struct instance !&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">dtime</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">dtime</span><span class="p">)</span> <span class="ow">is</span> <span class="n">dtm</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="s">&quot;Arg dtime must be a dtm.datetime !&quot;</span>

























<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">###############################################################################</span>
<span class="sd">###############################################################################</span>
<span class="sd">                        LOS class and functions</span>
<span class="sd">###############################################################################</span>
<span class="sd">&quot;&quot;&quot;</span>


<div class="viewcode-block" id="LOS"><a class="viewcode-back" href="../../../Auto_tofu.geom.html#tofu.geom.LOS">[docs]</a><span class="k">class</span> <span class="nc">LOS</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; A Line-Of-Sight object (semi-line with signed direction) with all useful geometrical parameters, associated :class:`~tofu.geom.Ves` object and built-in methods for plotting, defined in (X,Y,Z) cartesian coordinates</span>

<span class="sd">    A Line of Sight (LOS) is a semi-line. It is a useful approximate representation of a (more accurate) Volume of Sight (VOS) when the latter is narrow and elongated.</span>
<span class="sd">    It is usually associated to a detector placed behind apertures.</span>
<span class="sd">    When associated to a :class:`~tofu.geom.Ves` object, special points are automatically computed (entry point, exit point, closest point to the center of the :class:`~tofu.geom.Ves` object...) as well as a projection in a cross-section.</span>
<span class="sd">    While tofu provides the possibility of creating LOS objects for academic and simplification pueposes, it is generally not recommended to use them for doing physics, consider using a Detect object instead (which will provide you with a proper and automatically-computed VOS as well as with a LOS if you want).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        Id :            str / tfpf.ID</span>
<span class="sd">            A name string or a pre-built tfpf.ID class to be used to identify this particular instance, if a string is provided, it is fed to tfpf.ID()</span>
<span class="sd">        Du :            list / tuple</span>
<span class="sd">            List of 2 arrays of len=3, the (X,Y,Z) coordinates of respectively the starting point D of the LOS and its directing vector u (will be automatically normalized)</span>
<span class="sd">        Ves :           :class:`~tofu.geom.Ves`</span>
<span class="sd">            A :class:`~tofu.geom.Ves` instance to be associated to the created LOS</span>
<span class="sd">        Sino_RefPt :    None or np.ndarray</span>
<span class="sd">            If provided, array of size=2 containing the (R,Z) (for &#39;Tor&#39; Type) or (Y,Z) (for &#39;Lin&#39; Type) coordinates of the reference point for the sinogram</span>
<span class="sd">        arrayorder :    str</span>
<span class="sd">            Flag indicating whether the attributes of type=np.ndarray (e.g.: Poly) should be made C-contiguous (&#39;C&#39;) or Fortran-contiguous (&#39;F&#39;)</span>
<span class="sd">        Type       :    None</span>
<span class="sd">            (not used in the current version)</span>
<span class="sd">        Exp        :    None / str</span>
<span class="sd">            Experiment to which the Lens belongs, should be identical to Ves.Id.Exp if Ves is provided, if None and Ves is provided, Ves.Id.Exp is used</span>
<span class="sd">        Diag       :    None / str</span>
<span class="sd">            Diagnostic to which the Lens belongs</span>
<span class="sd">        shot       :    None / int</span>
<span class="sd">            Shot number from which this Lens is usable (in case its position was changed from a previous configuration)</span>
<span class="sd">        SavePath :      None / str</span>
<span class="sd">            If provided, forces the default saving path of the object to the provided value</span>
<span class="sd">        dtime      :    None / dtm.datetime</span>
<span class="sd">            A time reference to be used to identify this particular instance (used for debugging mostly)</span>
<span class="sd">        dtimeIn    :    bool</span>
<span class="sd">            Flag indicating whether dtime should be included in the SaveName (used for debugging mostly)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="n">Du</span><span class="p">,</span> <span class="n">Ves</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Sino_RefPt</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">arrayorder</span><span class="o">=</span><span class="s">&#39;C&#39;</span><span class="p">,</span> <span class="n">Clock</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Diag</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">dtime</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">dtimeIn</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Done</span> <span class="o">=</span> <span class="k">False</span>
        <span class="n">tfpf</span><span class="o">.</span><span class="n">_check_NotNone</span><span class="p">({</span><span class="s">&#39;Clock&#39;</span><span class="p">:</span><span class="n">Clock</span><span class="p">,</span><span class="s">&#39;arrayorder&#39;</span><span class="p">:</span><span class="n">arrayorder</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_inputs</span><span class="p">(</span><span class="n">Clock</span><span class="o">=</span><span class="n">Clock</span><span class="p">,</span> <span class="n">arrayorder</span><span class="o">=</span><span class="n">arrayorder</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_arrayorder</span> <span class="o">=</span> <span class="n">arrayorder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Clock</span> <span class="o">=</span> <span class="n">Clock</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Ves</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="n">Exp</span> <span class="o">=</span> <span class="n">Exp</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">Exp</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">else</span> <span class="n">Ves</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Exp</span>
            <span class="k">assert</span> <span class="n">Exp</span><span class="o">==</span><span class="n">Ves</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Exp</span><span class="p">,</span> <span class="s">&quot;Arg Exp must be identical to the Ves.Exp !&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_Id</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="n">Type</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="n">Exp</span><span class="p">,</span> <span class="n">Diag</span><span class="o">=</span><span class="n">Diag</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="n">shot</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="n">SavePath</span><span class="p">,</span> <span class="n">dtime</span><span class="o">=</span><span class="n">dtime</span><span class="p">,</span> <span class="n">dtimeIn</span><span class="o">=</span><span class="n">dtimeIn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_Du</span><span class="p">(</span><span class="n">Du</span><span class="p">,</span> <span class="n">Calc</span><span class="o">=</span><span class="k">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_Ves</span><span class="p">(</span><span class="n">Ves</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_Sino</span><span class="p">(</span><span class="n">RefPt</span><span class="o">=</span><span class="n">Sino_RefPt</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Done</span> <span class="o">=</span> <span class="k">True</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Id</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">D</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Du</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">u</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Du</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Du</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Du</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Ves</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Ves</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">PIn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_PIn</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">POut</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_POut</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">kPIn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kPIn</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">kPOut</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kPOut</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">PRMin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_PRMin</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Sino_RefPt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Sino_RefPt</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Sino_P</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Sino_P</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Sino_Pk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Sino_Pk</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Sino_p</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Sino_p</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Sino_theta</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Sino_theta</span>

    <span class="k">def</span> <span class="nf">_check_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Id</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Du</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Ves</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Sino_RefPt</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Clock</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">arrayorder</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Diag</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">dtime</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">dtimeIn</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Calc</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
        <span class="n">_LOS_check_inputs</span><span class="p">(</span><span class="n">Id</span><span class="o">=</span><span class="n">Id</span><span class="p">,</span> <span class="n">Du</span><span class="o">=</span><span class="n">Du</span><span class="p">,</span> <span class="n">Vess</span><span class="o">=</span><span class="n">Ves</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="n">Type</span><span class="p">,</span> <span class="n">Sino_RefPt</span><span class="o">=</span><span class="n">Sino_RefPt</span><span class="p">,</span> <span class="n">Clock</span><span class="o">=</span><span class="n">Clock</span><span class="p">,</span> <span class="n">arrayorder</span><span class="o">=</span><span class="n">arrayorder</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="n">Exp</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="n">shot</span><span class="p">,</span> <span class="n">Diag</span><span class="o">=</span><span class="n">Diag</span><span class="p">,</span> <span class="n">dtime</span><span class="o">=</span><span class="n">dtime</span><span class="p">,</span> <span class="n">dtimeIn</span><span class="o">=</span><span class="n">dtimeIn</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="n">SavePath</span><span class="p">,</span> <span class="n">Calc</span><span class="o">=</span><span class="n">Calc</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_set_Id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Val</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Diag</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">dtime</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">dtimeIn</span><span class="o">=</span><span class="k">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Done</span><span class="p">:</span>
            <span class="n">Out</span> <span class="o">=</span> <span class="n">tfpf</span><span class="o">.</span><span class="n">_get_FromItself</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;Type&#39;</span><span class="p">:</span><span class="n">Type</span><span class="p">,</span> <span class="s">&#39;Exp&#39;</span><span class="p">:</span><span class="n">Exp</span><span class="p">,</span> <span class="s">&#39;shot&#39;</span><span class="p">:</span><span class="n">shot</span><span class="p">,</span> <span class="s">&#39;Diag&#39;</span><span class="p">:</span><span class="n">Diag</span><span class="p">,</span> <span class="s">&#39;dtime&#39;</span><span class="p">:</span><span class="n">dtime</span><span class="p">,</span> <span class="s">&#39;_dtimeIn&#39;</span><span class="p">:</span><span class="n">dtimeIn</span><span class="p">,</span> <span class="s">&#39;SavePath&#39;</span><span class="p">:</span><span class="n">SavePath</span><span class="p">})</span>
            <span class="n">Type</span><span class="p">,</span> <span class="n">Exp</span><span class="p">,</span> <span class="n">shot</span><span class="p">,</span> <span class="n">Diag</span><span class="p">,</span> <span class="n">dtime</span><span class="p">,</span> <span class="n">dtimeIn</span><span class="p">,</span> <span class="n">SavePath</span> <span class="o">=</span> <span class="n">Out</span><span class="p">[</span><span class="s">&#39;Type&#39;</span><span class="p">],</span> <span class="n">Out</span><span class="p">[</span><span class="s">&#39;Exp&#39;</span><span class="p">],</span> <span class="n">Out</span><span class="p">[</span><span class="s">&#39;shot&#39;</span><span class="p">],</span> <span class="n">Out</span><span class="p">[</span><span class="s">&#39;Diag&#39;</span><span class="p">],</span> <span class="n">Out</span><span class="p">[</span><span class="s">&#39;dtime&#39;</span><span class="p">],</span> <span class="n">Out</span><span class="p">[</span><span class="s">&#39;dtimeIn&#39;</span><span class="p">],</span> <span class="n">Out</span><span class="p">[</span><span class="s">&#39;SavePath&#39;</span><span class="p">]</span>
        <span class="n">tfpf</span><span class="o">.</span><span class="n">_check_NotNone</span><span class="p">({</span><span class="s">&#39;Id&#39;</span><span class="p">:</span><span class="n">Val</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_inputs</span><span class="p">(</span><span class="n">Id</span><span class="o">=</span><span class="n">Val</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">Val</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">tfpf</span><span class="o">.</span><span class="n">_check_NotNone</span><span class="p">({</span><span class="s">&#39;Exp&#39;</span><span class="p">:</span><span class="n">Exp</span><span class="p">,</span> <span class="s">&#39;shot&#39;</span><span class="p">:</span><span class="n">shot</span><span class="p">,</span> <span class="s">&#39;Diag&#39;</span><span class="p">:</span><span class="n">Diag</span><span class="p">,</span> <span class="s">&#39;dtimeIn&#39;</span><span class="p">:</span><span class="n">dtimeIn</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_inputs</span><span class="p">(</span><span class="n">Type</span><span class="o">=</span><span class="n">Type</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="n">Exp</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="n">shot</span><span class="p">,</span> <span class="n">Diag</span><span class="o">=</span><span class="n">Diag</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="n">SavePath</span><span class="p">,</span> <span class="n">dtime</span><span class="o">=</span><span class="n">dtime</span><span class="p">,</span> <span class="n">dtimeIn</span><span class="o">=</span><span class="n">dtimeIn</span><span class="p">)</span>
            <span class="n">Val</span> <span class="o">=</span> <span class="n">tfpf</span><span class="o">.</span><span class="n">ID</span><span class="p">(</span><span class="s">&#39;LOS&#39;</span><span class="p">,</span> <span class="n">Val</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="n">Type</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="n">Exp</span><span class="p">,</span> <span class="n">Diag</span><span class="o">=</span><span class="n">Diag</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="n">shot</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="n">SavePath</span><span class="p">,</span> <span class="n">dtime</span><span class="o">=</span><span class="n">dtime</span><span class="p">,</span> <span class="n">dtimeIn</span><span class="o">=</span><span class="n">dtimeIn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Id</span> <span class="o">=</span> <span class="n">Val</span>

    <span class="k">def</span> <span class="nf">_set_Du</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Du</span><span class="p">,</span> <span class="n">Calc</span><span class="o">=</span><span class="k">True</span><span class="p">):</span>
        <span class="n">tfpf</span><span class="o">.</span><span class="n">_check_NotNone</span><span class="p">({</span><span class="s">&#39;Du&#39;</span><span class="p">:</span><span class="n">Du</span><span class="p">,</span><span class="s">&#39;Calc&#39;</span><span class="p">:</span><span class="n">Calc</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_inputs</span><span class="p">(</span><span class="n">Du</span><span class="o">=</span><span class="n">Du</span><span class="p">,</span> <span class="n">Calc</span><span class="o">=</span><span class="n">Calc</span><span class="p">)</span>
        <span class="n">DD</span><span class="p">,</span> <span class="n">uu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">Du</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">Du</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">uu</span> <span class="o">=</span> <span class="n">uu</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">uu</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Du</span> <span class="o">=</span> <span class="p">(</span><span class="n">DD</span><span class="p">,</span><span class="n">uu</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">Calc</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_calc_InOutPolProj</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_set_Ves</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Ves</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
        <span class="n">tfpf</span><span class="o">.</span><span class="n">_check_NotNone</span><span class="p">({</span><span class="s">&#39;Ves&#39;</span><span class="p">:</span><span class="n">Ves</span><span class="p">,</span> <span class="s">&#39;Exp&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Exp</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_inputs</span><span class="p">(</span><span class="n">Ves</span><span class="o">=</span><span class="n">Ves</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Exp</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Ves</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">set_LObj</span><span class="p">([</span><span class="n">Ves</span><span class="o">.</span><span class="n">Id</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Ves</span> <span class="o">=</span> <span class="n">Ves</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calc_InOutPolProj</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_calc_InOutPolProj</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">PIn</span><span class="p">,</span> <span class="n">POut</span><span class="p">,</span> <span class="n">kPOut</span><span class="p">,</span> <span class="n">kPIn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">3</span><span class="p">,)),</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">3</span><span class="p">,)),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ves</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="n">PIn</span><span class="p">,</span> <span class="n">POut</span><span class="p">,</span> <span class="n">kPIn</span><span class="p">,</span> <span class="n">kPOut</span><span class="p">,</span> <span class="n">Err</span> <span class="o">=</span> <span class="n">_tfg_c</span><span class="o">.</span><span class="n">_LOS_calc_InOutPolProj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">Type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">Poly</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">Vin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">DLong</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">D</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">Err</span><span class="p">:</span>
                <span class="n">La</span> <span class="o">=</span> <span class="n">_tfg_p</span><span class="o">.</span><span class="n">_LOS_calc_InOutPolProj_Debug</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">PIn</span><span class="p">,</span> <span class="n">POut</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_PIn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_POut</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kPIn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kPOut</span> <span class="o">=</span> <span class="n">PIn</span><span class="p">,</span> <span class="n">POut</span><span class="p">,</span> <span class="n">kPIn</span><span class="p">,</span> <span class="n">kPOut</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_CrossProj</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_set_CrossProj</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kPIn</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kPOut</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s">&#39;LOS &#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Name</span><span class="o">+</span><span class="s">&#39; has no PIn or POut for computing the PolProj !&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_PRMin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_RMin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kRMin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_PolProjAng</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_PplotOut</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_PplotIn</span> <span class="o">=</span> <span class="n">_tfg_c</span><span class="o">.</span><span class="n">_LOS_set_CrossProj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">Type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">D</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kPIn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kPOut</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_Sino</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">RefPt</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_inputs</span><span class="p">(</span><span class="n">Sino_RefPt</span><span class="o">=</span><span class="n">RefPt</span><span class="p">)</span>
        <span class="n">RefPt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">Sino_RefPt</span> <span class="k">if</span> <span class="n">RefPt</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">RefPt</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Sino_RefPt</span> <span class="o">=</span> <span class="n">RefPt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Ves</span><span class="o">.</span><span class="n">_set_Sino</span><span class="p">(</span><span class="n">RefPt</span><span class="p">)</span>
        <span class="n">kMax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kPOut</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">kMax</span><span class="p">):</span>
            <span class="n">kMax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">Type</span><span class="o">==</span><span class="s">&#39;Tor&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_Sino_P</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Sino_Pk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Sino_Pr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Sino_PTheta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Sino_p</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Sino_theta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Sino_Phi</span> <span class="o">=</span> <span class="n">_tfg_gg</span><span class="o">.</span><span class="n">Calc_Impact_Line</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">D</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">,</span> <span class="n">RefPt</span><span class="p">,</span> <span class="n">kOut</span><span class="o">=</span><span class="n">kMax</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">Type</span><span class="o">==</span><span class="s">&#39;Lin&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_Sino_P</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Sino_Pk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Sino_Pr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Sino_PTheta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Sino_p</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Sino_theta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Sino_Phi</span> <span class="o">=</span> <span class="n">_tfg_gg</span><span class="o">.</span><span class="n">Calc_Impact_Line_Lin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">D</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">,</span> <span class="n">RefPt</span><span class="p">,</span> <span class="n">kOut</span><span class="o">=</span><span class="n">kMax</span><span class="p">)</span>

<div class="viewcode-block" id="LOS.plot"><a class="viewcode-back" href="../../../Auto_tofu.geom.html#tofu.geom.LOS.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Lax</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Proj</span><span class="o">=</span><span class="s">&#39;All&#39;</span><span class="p">,</span> <span class="n">Lplot</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">LOSLplot</span><span class="p">,</span> <span class="n">Elt</span><span class="o">=</span><span class="s">&#39;LDIORP&#39;</span><span class="p">,</span> <span class="n">EltVes</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">Leg</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span>
            <span class="n">Ldict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">LOSLd</span><span class="p">,</span> <span class="n">MdictD</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">LOSMd</span><span class="p">,</span> <span class="n">MdictI</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">LOSMd</span><span class="p">,</span> <span class="n">MdictO</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">LOSMd</span><span class="p">,</span> <span class="n">MdictR</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">LOSMd</span><span class="p">,</span> <span class="n">MdictP</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">LOSMd</span><span class="p">,</span> <span class="n">LegDict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">TorLegd</span><span class="p">,</span>
            <span class="n">Vesdict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">Vesdict</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="k">True</span><span class="p">,</span> <span class="n">a4</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="k">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Plot the LOS, in a cross-section projection, a horizontal projection or both, and optionally the :class:`~tofu.geom.Ves` object associated to it.</span>

<span class="sd">        Plot the desired projections of the LOS object.</span>
<span class="sd">        The plot can include the special points, the directing vector, and the properties of the plotted objects are specified by dictionaries.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        Lax :       list / plt.Axes</span>
<span class="sd">            The axes to be used for plotting (provide a list of 2 axes if Proj=&#39;All&#39;), if None a new figure with axes is created</span>
<span class="sd">        Proj :      str</span>
<span class="sd">            Flag specifying the kind of projection used for the plot (&#39;Cross&#39; for a cross-section, &#39;Hor&#39; for a horizontal plane, &#39;All&#39; both and &#39;3d&#39; for 3d)</span>
<span class="sd">        Elt :       str</span>
<span class="sd">            Flag specifying which elements to plot, each capital letter corresponds to an element</span>
<span class="sd">                * &#39;L&#39;: LOS</span>
<span class="sd">                * &#39;D&#39;: Starting point of the LOS</span>
<span class="sd">                * &#39;I&#39;: Input point (i.e.: where the LOS enters the Vessel)</span>
<span class="sd">                * &#39;O&#39;: Output point (i.e.: where the LOS exits the Vessel)</span>
<span class="sd">                * &#39;R&#39;: Point of minimal major radius R (only for Vessel of Type=&#39;Tor&#39;)</span>
<span class="sd">                * &#39;P&#39;: Point of used for impact parameter (i.e.: minimal distance to reference point Sino_RefPt)</span>
<span class="sd">        Lplot :     str</span>
<span class="sd">            Flag specifying whether to plot the full LOS (&#39;Tot&#39;: from starting point output point) or only the fraction inside the vessel (&#39;In&#39;: from input to output point)</span>
<span class="sd">        EltVes :    str</span>
<span class="sd">            Flag specifying the elements of the Vessel to be plotted, fed to :meth:`~tofu.geom.Ves.plot`</span>
<span class="sd">        Leg :       str</span>
<span class="sd">            Legend to be used to identify this LOS, if Leg=&#39;&#39; the LOS name is used</span>
<span class="sd">        Ldict :     dict / None</span>
<span class="sd">            Dictionary of properties used for plotting the polygon, fed to plt.Axes.plot() or plt.plot_surface() if Proj=&#39;3d&#39;, set to ToFu_Defauts.py if None</span>
<span class="sd">        MdictD :    dict</span>
<span class="sd">            Dictionary of properties used for plotting point &#39;D&#39;, fed to plt.Axes.plot()</span>
<span class="sd">        MdictI :    dict</span>
<span class="sd">            Dictionary of properties used for plotting point &#39;I&#39;, fed to plt.Axes.plot()</span>
<span class="sd">        MdictO :    dict</span>
<span class="sd">            Dictionary of properties used for plotting point &#39;O&#39;, fed to plt.Axes.plot()</span>
<span class="sd">        MdictR :    dict</span>
<span class="sd">            Dictionary of properties used for plotting point &#39;R&#39;, fed to plt.Axes.plot()</span>
<span class="sd">        MdictP :    dict</span>
<span class="sd">            Dictionary of properties used for plotting point &#39;P&#39;, fed to plt.Axes.plot()</span>
<span class="sd">        LegDict :   dict or None</span>
<span class="sd">            Dictionary of properties used for plotting the legend, fed to plt.legend(), the legend is not plotted if None</span>
<span class="sd">        Vesdict :   dict</span>
<span class="sd">            Dictionary of kwdargs to fed to :meth:`~tofu.geom.Ves.plot`, and &#39;EltVes&#39; is used instead of &#39;Elt&#39;</span>
<span class="sd">        draw :      bool</span>
<span class="sd">            Flag indicating whether the fig.canvas.draw() shall be called automatically</span>
<span class="sd">        a4 :        bool</span>
<span class="sd">            Flag indicating whether the figure should be plotted in a4 dimensions for printing</span>
<span class="sd">        Test :      bool</span>
<span class="sd">            Flag indicating whether the inputs should be tested for conformity</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        La :        list / plt.Axes</span>
<span class="sd">            Handles of the axes used for plotting (list if several axes where used)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_tfg_p</span><span class="o">.</span><span class="n">GLLOS_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Lax</span><span class="o">=</span><span class="n">Lax</span><span class="p">,</span> <span class="n">Proj</span><span class="o">=</span><span class="n">Proj</span><span class="p">,</span> <span class="n">Lplot</span><span class="o">=</span><span class="n">Lplot</span><span class="p">,</span> <span class="n">Elt</span><span class="o">=</span><span class="n">Elt</span><span class="p">,</span> <span class="n">EltVes</span><span class="o">=</span><span class="n">EltVes</span><span class="p">,</span> <span class="n">Leg</span><span class="o">=</span><span class="n">Leg</span><span class="p">,</span>
            <span class="n">Ldict</span><span class="o">=</span><span class="n">Ldict</span><span class="p">,</span> <span class="n">MdictD</span><span class="o">=</span><span class="n">MdictD</span><span class="p">,</span> <span class="n">MdictI</span><span class="o">=</span><span class="n">MdictI</span><span class="p">,</span> <span class="n">MdictO</span><span class="o">=</span><span class="n">MdictO</span><span class="p">,</span> <span class="n">MdictR</span><span class="o">=</span><span class="n">MdictR</span><span class="p">,</span> <span class="n">MdictP</span><span class="o">=</span><span class="n">MdictP</span><span class="p">,</span> <span class="n">LegDict</span><span class="o">=</span><span class="n">LegDict</span><span class="p">,</span>
            <span class="n">Vesdict</span><span class="o">=</span><span class="n">Vesdict</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="n">draw</span><span class="p">,</span> <span class="n">a4</span><span class="o">=</span><span class="n">a4</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="n">Test</span><span class="p">)</span></div>


<span class="c">#    def plot_3D_mlab(self,Lplot=&#39;Tot&#39;,PDIOR=&#39;DIOR&#39;,axP=&#39;None&#39;,axT=&#39;None&#39;, Ldict=Ldict_Def,Mdict=Mdict_Def,LegDict=LegDict_Def):</span>
<span class="c">#        fig = Plot_3D_mlab_GLOS()</span>
<span class="c">#        return fig</span>

<div class="viewcode-block" id="LOS.plot_Sinogram"><a class="viewcode-back" href="../../../Auto_tofu.geom.html#tofu.geom.LOS.plot_Sinogram">[docs]</a>    <span class="k">def</span> <span class="nf">plot_Sinogram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Proj</span><span class="o">=</span><span class="s">&#39;Cross&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Elt</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">LOSImpElt</span><span class="p">,</span> <span class="n">Sketch</span><span class="o">=</span><span class="k">True</span><span class="p">,</span> <span class="n">Ang</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">LOSImpAng</span><span class="p">,</span> <span class="n">AngUnit</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">LOSImpAngUnit</span><span class="p">,</span>
            <span class="n">Ldict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">LOSMImpd</span><span class="p">,</span> <span class="n">Vdict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">TorPFilld</span><span class="p">,</span> <span class="n">LegDict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">TorLegd</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="k">True</span><span class="p">,</span> <span class="n">a4</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="k">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Plot the sinogram of the vessel polygon, by computing its envelopp in a cross-section, can also plot a 3D version of it</span>

<span class="sd">        Plot the LOS in projection space (where sinograms are plotted) as a point.</span>
<span class="sd">        You can plot the conventional projection-space (in 2D in a cross-section), or a 3D extrapolation of it, where the third coordinate is provided by the angle that the LOS makes with the cross-section plane (useful in case of multiple LOS with a partially tangential view).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        Proj :      str</span>
<span class="sd">            Flag indicating whether to plot a classic sinogram (&#39;Cross&#39;) from the vessel cross-section (assuming 2D), or an extended 3D version (&#39;3d&#39;) of it with additional angle</span>
<span class="sd">        ax :        None or plt.Axes</span>
<span class="sd">            The axes on which the plot should be done, if None a new figure and axes is created</span>
<span class="sd">        Elt :       str</span>
<span class="sd">            Flag indicating which elements to plot, each capital letter stands for one element</span>
<span class="sd">                * &#39;L&#39;: LOS</span>
<span class="sd">                * &#39;V&#39;: Vessel</span>
<span class="sd">        Ang  :      str</span>
<span class="sd">            Flag indicating which angle to use for the impact parameter, the angle of the line itself (xi) or of its impact parameter (theta)</span>
<span class="sd">        AngUnit :   str</span>
<span class="sd">            Flag for the angle units to be displayed, &#39;rad&#39; for radians or &#39;deg&#39; for degrees</span>
<span class="sd">        Sketch :    bool</span>
<span class="sd">            Flag indicating whether a small skecth showing the definitions of angles &#39;theta&#39; and &#39;xi&#39; should be included or not</span>
<span class="sd">        Ldict :     dict</span>
<span class="sd">            Dictionary of properties used for plotting the LOS point, fed to plt.plot() if Proj=&#39;Cross&#39; and to plt.plot_surface() if Proj=&#39;3d&#39;</span>
<span class="sd">        Vdict :     dict</span>
<span class="sd">            Dictionary of properties used for plotting the polygon envelopp, fed to plt.plot() if Proj=&#39;Cross&#39; and to plt.plot_surface() if Proj=&#39;3d&#39;</span>
<span class="sd">        LegDict :   None or dict</span>
<span class="sd">            Dictionary of properties used for plotting the legend, fed to plt.legend(), the legend is not plotted if None</span>
<span class="sd">        draw :      bool</span>
<span class="sd">            Flag indicating whether to draw the figure</span>
<span class="sd">        a4 :        bool</span>
<span class="sd">            Flag indicating whether the figure should be plotted in a4 dimensions for printing</span>
<span class="sd">        Test :      bool</span>
<span class="sd">            Flag indicating whether the inputs shall be tested for conformity</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ax :        plt.Axes</span>
<span class="sd">            The axes used to plot</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_tfg_p</span><span class="o">.</span><span class="n">GLOS_plot_Sinogram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Proj</span><span class="o">=</span><span class="n">Proj</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">Elt</span><span class="o">=</span><span class="n">Elt</span><span class="p">,</span> <span class="n">Sketch</span><span class="o">=</span><span class="n">Sketch</span><span class="p">,</span> <span class="n">Ang</span><span class="o">=</span><span class="n">Ang</span><span class="p">,</span> <span class="n">AngUnit</span><span class="o">=</span><span class="n">AngUnit</span><span class="p">,</span>
            <span class="n">Ldict</span><span class="o">=</span><span class="n">Ldict</span><span class="p">,</span> <span class="n">Vdict</span><span class="o">=</span><span class="n">Vdict</span><span class="p">,</span> <span class="n">LegDict</span><span class="o">=</span><span class="n">LegDict</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="n">draw</span><span class="p">,</span> <span class="n">a4</span><span class="o">=</span><span class="n">a4</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="n">Test</span><span class="p">)</span></div>


<div class="viewcode-block" id="LOS.save"><a class="viewcode-back" href="../../../Auto_tofu.geom.html#tofu.geom.LOS.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">SaveName</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Path</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Mode</span><span class="o">=</span><span class="s">&#39;npz&#39;</span><span class="p">,</span> <span class="n">compressed</span><span class="o">=</span><span class="k">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Save the object in folder Name, under file name SaveName, using specified mode</span>

<span class="sd">        Most tofu objects can be saved automatically as numpy arrays (.npz, recommended) at the default location (recommended) by simply calling self.save()</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        SaveName :  None / str</span>
<span class="sd">            The name to be used for the saved file, if None (recommended) uses self.Id.SaveName</span>
<span class="sd">        Path :      None / str</span>
<span class="sd">            Path specifying where to save the file, if None (recommended) uses self.Id.SavePath</span>
<span class="sd">        Mode :      str</span>
<span class="sd">            Flag specifying whether to save the object as a numpy array file (&#39;.npz&#39;, recommended) or an object using cPickle (not recommended, heavier and may cause retro-compatibility issues)</span>
<span class="sd">        compressed :    bool</span>
<span class="sd">            Flag, used when Mode=&#39;npz&#39;, indicating whether to use np.savez or np.savez_compressed (slower saving and loading but smaller files)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tfpf</span><span class="o">.</span><span class="n">Save_Generic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">SaveName</span><span class="o">=</span><span class="n">SaveName</span><span class="p">,</span> <span class="n">Path</span><span class="o">=</span><span class="n">Path</span><span class="p">,</span> <span class="n">Mode</span><span class="o">=</span><span class="n">Mode</span><span class="p">,</span> <span class="n">compressed</span><span class="o">=</span><span class="n">compressed</span><span class="p">)</span></div></div>






<span class="k">def</span> <span class="nf">_LOS_check_inputs</span><span class="p">(</span><span class="n">Id</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Du</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Vess</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Sino_RefPt</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Clock</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">arrayorder</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Diag</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">dtime</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">dtimeIn</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Calc</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">Id</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">Id</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">tfpf</span><span class="o">.</span><span class="n">ID</span><span class="p">],</span> <span class="s">&quot;Arg Id must be a str or a tfpf.ID object !&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">Du</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">Du</span><span class="p">,</span><span class="s">&#39;__iter__&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">Du</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">([</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">du</span><span class="p">,</span><span class="s">&#39;__iter__&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">du</span><span class="p">)</span><span class="o">==</span><span class="mi">3</span> <span class="k">for</span> <span class="n">du</span> <span class="ow">in</span> <span class="n">Du</span><span class="p">]),</span> <span class="s">&quot;Arg Du must be an iterable containing of two iterables of len()=3 (cartesian coordinates) !&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">Vess</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">Vess</span><span class="p">)</span> <span class="ow">is</span> <span class="n">Ves</span><span class="p">,</span> <span class="s">&quot;Arg Ves must be a Ves instance !&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Exp</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">Exp</span><span class="o">==</span><span class="n">Vess</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Exp</span><span class="p">,</span> <span class="s">&quot;Arg Exp must be the same as Ves.Id.Exp !&quot;</span>
    <span class="n">bools</span> <span class="o">=</span> <span class="p">[</span><span class="n">Clock</span><span class="p">,</span><span class="n">dtimeIn</span><span class="p">,</span><span class="n">Calc</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="ow">not</span> <span class="n">aa</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">bools</span><span class="p">]):</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">aa</span> <span class="ow">is</span> <span class="k">None</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">aa</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">bool</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">bools</span><span class="p">]),</span> <span class="s">&quot; Args [Clock,dtimeIn,Calc] must all be bool !&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">arrayorder</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">arrayorder</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;C&#39;</span><span class="p">,</span><span class="s">&#39;F&#39;</span><span class="p">],</span> <span class="s">&quot;Arg arrayorder must be in [&#39;C&#39;,&#39;F&#39;] !&quot;</span>
    <span class="k">assert</span> <span class="n">Type</span> <span class="ow">is</span> <span class="k">None</span><span class="p">,</span> <span class="s">&quot;Arg Type must be None for a LOS object !&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">Exp</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">Exp</span> <span class="ow">in</span> <span class="n">tfd</span><span class="o">.</span><span class="n">AllowedExp</span><span class="p">,</span> <span class="s">&quot;Arg Exp must be in &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">AllowedExp</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; !&quot;</span>
    <span class="n">strs</span> <span class="o">=</span> <span class="p">[</span><span class="n">Diag</span><span class="p">,</span><span class="n">SavePath</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="ow">not</span> <span class="n">aa</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">strs</span><span class="p">]):</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">aa</span> <span class="ow">is</span> <span class="k">None</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">aa</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">strs</span><span class="p">]),</span> <span class="s">&quot;Args [Diag,SavePath] must all be str !&quot;</span>
    <span class="n">Iter2</span> <span class="o">=</span> <span class="p">[</span><span class="n">Sino_RefPt</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="ow">not</span> <span class="n">aa</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">Iter2</span><span class="p">]):</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">aa</span> <span class="ow">is</span> <span class="k">None</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">aa</span><span class="p">,</span><span class="s">&#39;__iter__&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">aa</span><span class="p">)</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">aa</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="o">==</span><span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">Iter2</span><span class="p">]),</span> <span class="s">&quot;Args [DLong,Sino_RefPt] must be an iterable with len()=2 !&quot;</span>
    <span class="n">Ints</span> <span class="o">=</span> <span class="p">[</span><span class="n">shot</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="ow">not</span> <span class="n">aa</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">Ints</span><span class="p">]):</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">aa</span> <span class="ow">is</span> <span class="k">None</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">aa</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">Ints</span><span class="p">]),</span> <span class="s">&quot;Args [Sino_NP,shot] must be int !&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">dtime</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">dtime</span><span class="p">)</span> <span class="ow">is</span> <span class="n">dtm</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="s">&quot;Arg dtime must be a dtm.datetime !&quot;</span>





<div class="viewcode-block" id="GLOS"><a class="viewcode-back" href="../../../Auto_tofu.geom.html#tofu.geom.GLOS">[docs]</a><span class="k">class</span> <span class="nc">GLOS</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; An object regrouping a group of LOS objects with some common features (e.g.: all belong to the same camera) and the same :class:`~tofu.geom.Ves` object, provides methods for common computing and plotting</span>

<span class="sd">    Usually :class:`LOS` correspond to detectors which are naturally grouped in &#39;cameras&#39; (sets of detectors located in the same place or sharing an aperture or a data acquisition system).</span>
<span class="sd">    The GLOS object provided by tofu provides the object-oriented equivalent.</span>
<span class="sd">    The GLOS objects provides the same methods as the :class:`LOS` objects, plus extra methods for fast handling or selecting of the whole set.</span>
<span class="sd">    Note that you must first create each :class:`LOS` independently and then provide them as a list argument to a GLOS object.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    Id :            str / tfpf.ID</span>
<span class="sd">        A name string or a pre-built tfpf.ID class to be used to identify this particular instance, if a string is provided, it is fed to tfpf.ID()</span>
<span class="sd">    LLOS :          list / :class:&#39;LOS&#39;</span>
<span class="sd">        List of LOS instances with the same :class:`~tofu.geom.Ves` instance</span>
<span class="sd">    Type :          None</span>
<span class="sd">        (not used in the current version)</span>
<span class="sd">    Exp :           None / str</span>
<span class="sd">        Experiment to which the Lens belongs, should be identical to Ves.Id.Exp if Ves is provided, if None and Ves is provided, Ves.Id.Exp is used</span>
<span class="sd">    Diag :          None / str</span>
<span class="sd">        Diagnostic to which the Lens belongs</span>
<span class="sd">    shot :          None / int</span>
<span class="sd">        Shot number from which this Lens is usable (in case its position was changed from a previous configuration)</span>
<span class="sd">    Sino_RefPt :    None / iterable</span>
<span class="sd">        If provided, array of size=2 containing the (R,Z) (for &#39;Tor&#39; Type) or (Y,Z) (for &#39;Lin&#39; Type) coordinates of the reference point for the sinogram</span>
<span class="sd">    arrayorder :    str</span>
<span class="sd">        Flag indicating whether the attributes of type=np.ndarray (e.g.: Poly) should be made C-contiguous (&#39;C&#39;) or Fortran-contiguous (&#39;F&#39;)</span>
<span class="sd">    SavePath :      None / str</span>
<span class="sd">        If provided, forces the default saving path of the object to the provided value</span>
<span class="sd">    dtime       None / dtm.datetime</span>
<span class="sd">        A time reference to be used to identify this particular instance (used for debugging mostly)</span>
<span class="sd">    dtimeIn     bool</span>
<span class="sd">        Flag indicating whether dtime should be included in the SaveName (used for debugging mostly)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="n">LLOS</span><span class="p">,</span> <span class="n">Ves</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Sino_RefPt</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Diag</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">arrayorder</span><span class="o">=</span><span class="s">&#39;C&#39;</span><span class="p">,</span> <span class="n">Clock</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">dtime</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">dtimeIn</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Done</span> <span class="o">=</span> <span class="k">False</span>
        <span class="n">tfpf</span><span class="o">.</span><span class="n">_check_NotNone</span><span class="p">({</span><span class="s">&#39;Clock&#39;</span><span class="p">:</span><span class="n">Clock</span><span class="p">,</span><span class="s">&#39;arrayorder&#39;</span><span class="p">:</span><span class="n">arrayorder</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_inputs</span><span class="p">(</span><span class="n">Clock</span><span class="o">=</span><span class="n">Clock</span><span class="p">,</span> <span class="n">arrayorder</span><span class="o">=</span><span class="n">arrayorder</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_arrayorder</span> <span class="o">=</span> <span class="n">arrayorder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Clock</span> <span class="o">=</span> <span class="n">Clock</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_check_inputs</span><span class="p">(</span><span class="n">Exp</span><span class="o">=</span><span class="n">Exp</span><span class="p">,</span> <span class="n">Diag</span><span class="o">=</span><span class="n">Diag</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="n">shot</span><span class="p">,</span> <span class="n">Ves</span><span class="o">=</span><span class="n">Ves</span><span class="p">,</span> <span class="n">LLOS</span><span class="o">=</span><span class="n">LLOS</span><span class="p">)</span>
        <span class="n">Exp</span> <span class="o">=</span> <span class="n">Exp</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">Exp</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">else</span> <span class="n">LLOS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Exp</span>
        <span class="k">assert</span> <span class="n">Exp</span><span class="o">==</span><span class="n">LLOS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Exp</span><span class="p">,</span> <span class="s">&quot;Arg Exp must be identical to the LLOS !&quot;</span>
        <span class="n">Diag</span> <span class="o">=</span> <span class="n">Diag</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">Diag</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">else</span> <span class="n">LLOS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Diag</span>
        <span class="k">assert</span> <span class="n">Diag</span><span class="o">==</span><span class="n">LLOS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Diag</span><span class="p">,</span> <span class="s">&quot;Arg Diag must be identical to the LLOS !&quot;</span>
        <span class="n">shot</span> <span class="o">=</span> <span class="n">shot</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">shot</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">else</span> <span class="n">LLOS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">shot</span>
        <span class="k">assert</span> <span class="n">shot</span><span class="o">==</span><span class="n">LLOS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">shot</span><span class="p">,</span> <span class="s">&quot;Arg shot must be identical to the LLOS !&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_Id</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="n">Exp</span><span class="p">,</span> <span class="n">Diag</span><span class="o">=</span><span class="n">Diag</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="n">shot</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="n">Type</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="n">SavePath</span><span class="p">,</span> <span class="n">dtime</span><span class="o">=</span><span class="n">dtime</span><span class="p">,</span> <span class="n">dtimeIn</span><span class="o">=</span><span class="n">dtimeIn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_LLOS</span><span class="p">(</span><span class="n">LLOS</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Ves</span> <span class="ow">is</span> <span class="k">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">tfpf</span><span class="o">.</span><span class="n">CheckSameObj</span><span class="p">(</span><span class="n">LLOS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Ves</span><span class="p">,</span> <span class="n">Ves</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;Poly&#39;</span><span class="p">,</span><span class="s">&#39;Type&#39;</span><span class="p">,</span><span class="s">&#39;Name&#39;</span><span class="p">,</span><span class="s">&#39;Exp&#39;</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_Ves</span><span class="p">(</span><span class="n">Ves</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_Sino</span><span class="p">(</span><span class="n">RefPt</span><span class="o">=</span><span class="n">Sino_RefPt</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Done</span> <span class="o">=</span> <span class="k">True</span>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Id</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">LLOS</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_LLOS</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Ves</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_LLOS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Ves</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nLOS</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nLOS</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Sino_RefPt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_LLOS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Sino_RefPt</span>

    <span class="k">def</span> <span class="nf">_check_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Id</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">LLOS</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Ves</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Sino_RefPt</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Diag</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">arrayorder</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Clock</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">dtime</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">dtimeIn</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
        <span class="n">_GLOS_check_inputs</span><span class="p">(</span><span class="n">Id</span><span class="o">=</span><span class="n">Id</span><span class="p">,</span> <span class="n">LLOS</span><span class="o">=</span><span class="n">LLOS</span><span class="p">,</span> <span class="n">Vess</span><span class="o">=</span><span class="n">Ves</span><span class="p">,</span> <span class="n">Sino_RefPt</span><span class="o">=</span><span class="n">Sino_RefPt</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="n">Type</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="n">Exp</span><span class="p">,</span> <span class="n">Diag</span><span class="o">=</span><span class="n">Diag</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="n">shot</span><span class="p">,</span> <span class="n">arrayorder</span><span class="o">=</span><span class="n">arrayorder</span><span class="p">,</span> <span class="n">Clock</span><span class="o">=</span><span class="n">Clock</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="n">SavePath</span><span class="p">,</span> <span class="n">dtime</span><span class="o">=</span><span class="n">dtime</span><span class="p">,</span> <span class="n">dtimeIn</span><span class="o">=</span><span class="n">dtimeIn</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_Id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Val</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Diag</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">dtime</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">dtimeIn</span><span class="o">=</span><span class="k">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Done</span><span class="p">:</span>
            <span class="n">Out</span> <span class="o">=</span> <span class="n">tfpf</span><span class="o">.</span><span class="n">_get_FromItself</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;Type&#39;</span><span class="p">:</span><span class="n">Type</span><span class="p">,</span> <span class="s">&#39;Exp&#39;</span><span class="p">:</span><span class="n">Exp</span><span class="p">,</span> <span class="s">&#39;shot&#39;</span><span class="p">:</span><span class="n">shot</span><span class="p">,</span> <span class="s">&#39;Diag&#39;</span><span class="p">:</span><span class="n">Diag</span><span class="p">,</span> <span class="s">&#39;dtime&#39;</span><span class="p">:</span><span class="n">dtime</span><span class="p">,</span> <span class="s">&#39;_dtimeIn&#39;</span><span class="p">:</span><span class="n">dtimeIn</span><span class="p">,</span> <span class="s">&#39;SavePath&#39;</span><span class="p">:</span><span class="n">SavePath</span><span class="p">})</span>
            <span class="n">Type</span><span class="p">,</span> <span class="n">Exp</span><span class="p">,</span> <span class="n">shot</span><span class="p">,</span> <span class="n">Diag</span><span class="p">,</span> <span class="n">dtime</span><span class="p">,</span> <span class="n">dtimeIn</span><span class="p">,</span> <span class="n">SavePath</span> <span class="o">=</span> <span class="n">Out</span><span class="p">[</span><span class="s">&#39;Type&#39;</span><span class="p">],</span> <span class="n">Out</span><span class="p">[</span><span class="s">&#39;Exp&#39;</span><span class="p">],</span> <span class="n">Out</span><span class="p">[</span><span class="s">&#39;shot&#39;</span><span class="p">],</span> <span class="n">Out</span><span class="p">[</span><span class="s">&#39;Diag&#39;</span><span class="p">],</span> <span class="n">Out</span><span class="p">[</span><span class="s">&#39;dtime&#39;</span><span class="p">],</span> <span class="n">Out</span><span class="p">[</span><span class="s">&#39;dtimeIn&#39;</span><span class="p">],</span> <span class="n">Out</span><span class="p">[</span><span class="s">&#39;SavePath&#39;</span><span class="p">]</span>
        <span class="n">tfpf</span><span class="o">.</span><span class="n">_check_NotNone</span><span class="p">({</span><span class="s">&#39;Id&#39;</span><span class="p">:</span><span class="n">Val</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_inputs</span><span class="p">(</span><span class="n">Id</span><span class="o">=</span><span class="n">Val</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">Val</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">tfpf</span><span class="o">.</span><span class="n">_check_NotNone</span><span class="p">({</span><span class="s">&#39;Exp&#39;</span><span class="p">:</span><span class="n">Exp</span><span class="p">,</span> <span class="s">&#39;shot&#39;</span><span class="p">:</span><span class="n">shot</span><span class="p">,</span> <span class="s">&#39;Diag&#39;</span><span class="p">:</span><span class="n">Diag</span><span class="p">,</span> <span class="s">&#39;dtimeIn&#39;</span><span class="p">:</span><span class="n">dtimeIn</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_inputs</span><span class="p">(</span><span class="n">Type</span><span class="o">=</span><span class="n">Type</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="n">Exp</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="n">shot</span><span class="p">,</span> <span class="n">Diag</span><span class="o">=</span><span class="n">Diag</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="n">SavePath</span><span class="p">,</span> <span class="n">dtime</span><span class="o">=</span><span class="n">dtime</span><span class="p">,</span> <span class="n">dtimeIn</span><span class="o">=</span><span class="n">dtimeIn</span><span class="p">)</span>
            <span class="n">Val</span> <span class="o">=</span> <span class="n">tfpf</span><span class="o">.</span><span class="n">ID</span><span class="p">(</span><span class="s">&#39;GLOS&#39;</span><span class="p">,</span> <span class="n">Val</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="n">Type</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="n">Exp</span><span class="p">,</span> <span class="n">Diag</span><span class="o">=</span><span class="n">Diag</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="n">shot</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="n">SavePath</span><span class="p">,</span> <span class="n">dtime</span><span class="o">=</span><span class="n">dtime</span><span class="p">,</span> <span class="n">dtimeIn</span><span class="o">=</span><span class="n">dtimeIn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Id</span> <span class="o">=</span> <span class="n">Val</span>


    <span class="k">def</span> <span class="nf">_set_LLOS</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">LLOS</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_inputs</span><span class="p">(</span><span class="n">LLOS</span><span class="o">=</span><span class="n">LLOS</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">LLOS</span><span class="p">,</span><span class="n">LOS</span><span class="p">):</span>
            <span class="n">LLOS</span> <span class="o">=</span> <span class="p">[</span><span class="n">LLOS</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nLOS</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">LLOS</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_LLOS</span> <span class="o">=</span> <span class="n">LLOS</span>
        <span class="n">LObj</span> <span class="o">=</span> <span class="p">[</span><span class="n">ll</span><span class="o">.</span><span class="n">Id</span> <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="n">LLOS</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">LLOS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Ves</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="n">LObj</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">LLOS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">Id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">set_LObj</span><span class="p">(</span><span class="n">LObj</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_Ves</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Ves</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_inputs</span><span class="p">(</span><span class="n">Ves</span><span class="o">=</span><span class="n">V</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">nLOS</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_LLOS</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">_set_Ves</span><span class="p">(</span><span class="n">Ves</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Ves</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">set_LObj</span><span class="p">([</span><span class="n">Ves</span><span class="o">.</span><span class="n">Id</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_set_Sino</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">RefPt</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_inputs</span><span class="p">(</span><span class="n">Sino_RefPt</span><span class="o">=</span><span class="n">RefPt</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nLOS</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_LLOS</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">_set_Sino</span><span class="p">(</span><span class="n">RefPt</span><span class="o">=</span><span class="n">RefPt</span><span class="p">)</span>

<div class="viewcode-block" id="GLOS.select"><a class="viewcode-back" href="../../../Auto_tofu.geom.html#tofu.geom.GLOS.select">[docs]</a>    <span class="k">def</span> <span class="nf">select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Val</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Crit</span><span class="o">=</span><span class="s">&#39;Name&#39;</span><span class="p">,</span> <span class="n">PreExp</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">PostExp</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Log</span><span class="o">=</span><span class="s">&#39;any&#39;</span><span class="p">,</span> <span class="n">InOut</span><span class="o">=</span><span class="s">&#39;In&#39;</span><span class="p">,</span> <span class="n">Out</span><span class="o">=</span><span class="nb">bool</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the indices or instances of all instances matching the specified criterion.</span>

<span class="sd">        The selection can be done according to 2 different mechanism (1) and (2).</span>

<span class="sd">        For mechanism (1): the user provides the value (Val) that the specified criterion (Crit) should take for a :class:`LOS` to be selected.</span>
<span class="sd">        The criteria are typically attributes of the self.Id attribute (i.e.: name of the instance, or user-defined attributes like the camera head...)</span>

<span class="sd">        For mechanism (2), used if Val=None: the user provides a str expression (or a list of such) to be fed to eval(), used to check on quantitative criteria, placed before the criterion value (e.g.: &#39;not &#39; or &#39;&lt;=&#39;).</span>
<span class="sd">        Another str or list of str expressions can be provided that will be placed after the criterion value.</span>

<span class="sd">        Other parameters are used to specify logical operators for the selection (match any or all the criterion...) and the type of output.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        Crit :      str</span>
<span class="sd">            Flag indicating which criterion to use for discrimination</span>
<span class="sd">            Can be set to any attribute of the tofu.pathfile.ID class (e.g.: &#39;Name&#39;,&#39;SaveName&#39;,&#39;SavePath&#39;...) or any key of ID.USRdict (e.g.: &#39;Exp&#39;...)</span>
<span class="sd">        Val :       list, str or None</span>
<span class="sd">            The value to match for the chosen criterion, can be a list of different values</span>
<span class="sd">            Used for selection mechanism (1)</span>
<span class="sd">        PreExp :    list, str or None</span>
<span class="sd">            A str of list of str expressions to be fed to eval(), used to check on quantitative criteria, placed before the criterion value (e.g.: &#39;not &#39;)</span>
<span class="sd">            Used for selection mechanism (2)</span>
<span class="sd">        PostExp :   list, str or None</span>
<span class="sd">            A str of list of str expressions to be fed to eval(), used to check on quantitative criteria, placed after the criterion value (e.g.: &#39;&gt;=5.&#39;)</span>
<span class="sd">            Used for selection mechanism (2)</span>
<span class="sd">        Log :       str</span>
<span class="sd">            Flag indicating whether the criterion shall match all provided values or one of them (&#39;any&#39; or &#39;all&#39;)</span>
<span class="sd">        InOut :     str</span>
<span class="sd">            Flag indicating whether the returned indices are the ones matching the criterion (&#39;In&#39;) or the ones not matching it (&#39;Out&#39;)</span>
<span class="sd">        Out :       type / str</span>
<span class="sd">            Flag indicating in which form shall the result be returned, as an array of integer indices (int), an array of booleans (bool), a list of names (&#39;Names&#39;) or a list of instances (&#39;LOS&#39;)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ind :       list / np.ndarray</span>
<span class="sd">            The computed output (array of index, list of names or instances depending on parameter &#39;Out&#39;)</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        &gt;&gt;&gt; import tofu.geom as tfg</span>
<span class="sd">        &gt;&gt;&gt; ves = tfg.Ves(&#39;ves&#39;, [[0.,1.,1.,0.],[0.,0.,1.,1.]], DLong=[-1.,1.], Type=&#39;Lin&#39;, Exp=&#39;Misc&#39;, shot=0)</span>
<span class="sd">        &gt;&gt;&gt; los1 = tfg.LOS(&#39;los1&#39;, ([0.,-0.1,-0.1],[0.,1.,1.]), Ves=ves, Exp=&#39;Misc&#39;, Diag=&#39;D&#39;, shot=0)</span>
<span class="sd">        &gt;&gt;&gt; los2 = tfg.LOS(&#39;los2&#39;, ([0.,-0.1,-0.1],[0.,0.5,1.]), Ves=ves, Exp=&#39;Misc&#39;, Diag=&#39;D&#39;, shot=1)</span>
<span class="sd">        &gt;&gt;&gt; los3 = tfg.LOS(&#39;los3&#39;, ([0.,-0.1,-0.1],[0.,1.,0.5]), Ves=ves, Exp=&#39;Misc&#39;, Diag=&#39;D&#39;, shot=1)</span>
<span class="sd">        &gt;&gt;&gt; glos = tfg.GLOS(&#39;glos&#39;, [los1,los2,los3])</span>
<span class="sd">        &gt;&gt;&gt; ind = glos.select(Val=[&#39;los1&#39;,&#39;los3&#39;], Log=&#39;any&#39;, Out=&#39;LOS&#39;)</span>
<span class="sd">        &gt;&gt;&gt; print [ii.Id.Name for ii in ind]</span>
<span class="sd">        [&#39;los1&#39;, &#39;los3&#39;]</span>
<span class="sd">        &gt;&gt;&gt; ind = glos.select(Val=[&#39;los1&#39;,&#39;los3&#39;], Log=&#39;any&#39;, InOut=&#39;Out&#39;, Out=int)</span>
<span class="sd">        array([1])</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Out</span><span class="o">==</span><span class="s">&#39;LOS&#39;</span><span class="p">:</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">tfpf</span><span class="o">.</span><span class="n">SelectFromListId</span><span class="p">([</span><span class="n">ll</span><span class="o">.</span><span class="n">Id</span> <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">LLOS</span><span class="p">],</span> <span class="n">Val</span><span class="o">=</span><span class="n">Val</span><span class="p">,</span> <span class="n">Crit</span><span class="o">=</span><span class="n">Crit</span><span class="p">,</span> <span class="n">PreExp</span><span class="o">=</span><span class="n">PreExp</span><span class="p">,</span> <span class="n">PostExp</span><span class="o">=</span><span class="n">PostExp</span><span class="p">,</span> <span class="n">Log</span><span class="o">=</span><span class="n">Log</span><span class="p">,</span> <span class="n">InOut</span><span class="o">=</span><span class="n">InOut</span><span class="p">,</span> <span class="n">Out</span><span class="o">=</span><span class="n">Out</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">tfpf</span><span class="o">.</span><span class="n">SelectFromListId</span><span class="p">([</span><span class="n">ll</span><span class="o">.</span><span class="n">Id</span> <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">LLOS</span><span class="p">],</span> <span class="n">Val</span><span class="o">=</span><span class="n">Val</span><span class="p">,</span> <span class="n">Crit</span><span class="o">=</span><span class="n">Crit</span><span class="p">,</span> <span class="n">PreExp</span><span class="o">=</span><span class="n">PreExp</span><span class="p">,</span> <span class="n">PostExp</span><span class="o">=</span><span class="n">PostExp</span><span class="p">,</span> <span class="n">Log</span><span class="o">=</span><span class="n">Log</span><span class="p">,</span> <span class="n">InOut</span><span class="o">=</span><span class="n">InOut</span><span class="p">,</span> <span class="n">Out</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">LLOS</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">ind</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">ind</span></div>


<div class="viewcode-block" id="GLOS.plot"><a class="viewcode-back" href="../../../Auto_tofu.geom.html#tofu.geom.GLOS.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Lax</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Proj</span><span class="o">=</span><span class="s">&#39;All&#39;</span><span class="p">,</span> <span class="n">Lplot</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">LOSLplot</span><span class="p">,</span> <span class="n">Elt</span><span class="o">=</span><span class="s">&#39;LDIORP&#39;</span><span class="p">,</span> <span class="n">EltVes</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">Leg</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span>
            <span class="n">Ldict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">LOSLd</span><span class="p">,</span> <span class="n">MdictD</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">LOSMd</span><span class="p">,</span> <span class="n">MdictI</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">LOSMd</span><span class="p">,</span> <span class="n">MdictO</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">LOSMd</span><span class="p">,</span> <span class="n">MdictR</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">LOSMd</span><span class="p">,</span> <span class="n">MdictP</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">LOSMd</span><span class="p">,</span> <span class="n">LegDict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">TorLegd</span><span class="p">,</span>
            <span class="n">ind</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Val</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Crit</span><span class="o">=</span><span class="s">&#39;Name&#39;</span><span class="p">,</span> <span class="n">PreExp</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">PostExp</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Log</span><span class="o">=</span><span class="s">&#39;any&#39;</span><span class="p">,</span> <span class="n">InOut</span><span class="o">=</span><span class="s">&#39;In&#39;</span><span class="p">,</span>
            <span class="n">Vesdict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">Vesdict</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="k">True</span><span class="p">,</span> <span class="n">a4</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="k">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Plot the GLOS, with a cross-section view, a horizontal view or both, and optionally the :class:`~tofu.geom.Ves` object associated to it.</span>

<span class="sd">        Plot all the :class:`LOS` of the GLOS, or only a selection of them (using the same parameters as self.select()).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        Lax :       list or plt.Axes</span>
<span class="sd">            The axes to be used for plotting (provide a list of 2 axes if Proj=&#39;All&#39;), if None a new figure with axes is created</span>
<span class="sd">        Proj :      str</span>
<span class="sd">            Flag specifying the kind of projection used for the plot (&#39;Cross&#39; for a cross-section, &#39;Hor&#39; for a horizontal plane, &#39;All&#39; both and &#39;3d&#39; for 3d)</span>
<span class="sd">        Elt :       str</span>
<span class="sd">            Flag specifying which elements to plot, each capital letter corresponds to an element</span>
<span class="sd">                * &#39;L&#39;: LOS</span>
<span class="sd">                * &#39;D&#39;: Starting point of the LOS</span>
<span class="sd">                * &#39;I&#39;: Input point (i.e.: where the LOS enters the Vessel)</span>
<span class="sd">                * &#39;O&#39;: Output point (i.e.: where the LOS exits the Vessel)</span>
<span class="sd">                * &#39;R&#39;: Point of minimal major radius R (only for Vessel of Type=&#39;Tor&#39;)</span>
<span class="sd">                * &#39;P&#39;: Point of used for impact parameter (i.e.: minimal distance to reference point ImpRZ)</span>
<span class="sd">        Lplot :     str</span>
<span class="sd">            Flag specifying whether to plot the full LOS (&#39;Tot&#39;: from starting point output point) or only the fraction inside the vessel (&#39;In&#39;: from input to output point)</span>
<span class="sd">        EltVes :    str</span>
<span class="sd">            Flag specifying the elements of the Vessel to be plotted, fed to :meth:`~tofu.geom.Ves.plot`</span>
<span class="sd">        Leg :       str</span>
<span class="sd">            Legend to be used to identify this LOS, if Leg=&#39;&#39; the LOS name is used</span>
<span class="sd">        Ldict :     dict or None</span>
<span class="sd">            Dictionary of properties used for plotting the polygon, fed to plt.Axes.plot() or plt.plot_surface() if Proj=&#39;3d&#39;, set to ToFu_Defauts.py if None</span>
<span class="sd">        MdictD :    dict</span>
<span class="sd">            Dictionary of properties used for plotting point &#39;D&#39;, fed to plt.Axes.plot()</span>
<span class="sd">        MdictI :    dict</span>
<span class="sd">            Dictionary of properties used for plotting point &#39;I&#39;, fed to plt.Axes.plot()</span>
<span class="sd">        MdictO :    dict</span>
<span class="sd">            Dictionary of properties used for plotting point &#39;O&#39;, fed to plt.Axes.plot()</span>
<span class="sd">        MdictR :    dict</span>
<span class="sd">            Dictionary of properties used for plotting point &#39;R&#39;, fed to plt.Axes.plot()</span>
<span class="sd">        MdictP :    dict</span>
<span class="sd">            Dictionary of properties used for plotting point &#39;P&#39;, fed to plt.Axes.plot()</span>
<span class="sd">        LegDict :   dict or None</span>
<span class="sd">            Dictionary of properties used for plotting the legend, fed to plt.legend(), the legend is not plotted if None</span>
<span class="sd">        Vesdict :   dict</span>
<span class="sd">            Dictionary of kwdargs to fed to :meth:`~tofu.geom.Ves.plot`, and &#39;EltVes&#39; is used instead of &#39;Elt&#39;</span>
<span class="sd">        Lim :       list or tuple</span>
<span class="sd">            Array of a lower and upper limit of angle (rad.) or length for plotting the &#39;3d&#39; Proj</span>
<span class="sd">        draw :      bool</span>
<span class="sd">            Flag indicating whether the fig.canvas.draw() shall be called automatically</span>
<span class="sd">        Test :      bool</span>
<span class="sd">            Flag indicating whether the inputs should be tested for conformity</span>

<span class="sd">        ind         None or np.ndarray</span>
<span class="sd">            Array of indices (int or bool) of the LOS to be plotted if only some of them are to be plotted</span>
<span class="sd">        kwdargs</span>
<span class="sd">            kwdargs to be fed to GLOS.select() if ind=None and only a fraction of the LOS are to be plotted</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            La :    list or plt.Axes</span>
<span class="sd">                Handles of the axes used for plotting (list if several axes where used)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_tfg_p</span><span class="o">.</span><span class="n">GLLOS_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Lax</span><span class="o">=</span><span class="n">Lax</span><span class="p">,</span> <span class="n">Proj</span><span class="o">=</span><span class="n">Proj</span><span class="p">,</span> <span class="n">Lplot</span><span class="o">=</span><span class="n">Lplot</span><span class="p">,</span> <span class="n">Elt</span><span class="o">=</span><span class="n">Elt</span><span class="p">,</span> <span class="n">EltVes</span><span class="o">=</span><span class="n">EltVes</span><span class="p">,</span> <span class="n">Leg</span><span class="o">=</span><span class="n">Leg</span><span class="p">,</span>
            <span class="n">Ldict</span><span class="o">=</span><span class="n">Ldict</span><span class="p">,</span> <span class="n">MdictD</span><span class="o">=</span><span class="n">MdictD</span><span class="p">,</span> <span class="n">MdictI</span><span class="o">=</span><span class="n">MdictI</span><span class="p">,</span> <span class="n">MdictO</span><span class="o">=</span><span class="n">MdictO</span><span class="p">,</span> <span class="n">MdictR</span><span class="o">=</span><span class="n">MdictR</span><span class="p">,</span> <span class="n">MdictP</span><span class="o">=</span><span class="n">MdictP</span><span class="p">,</span> <span class="n">LegDict</span><span class="o">=</span><span class="n">LegDict</span><span class="p">,</span>
            <span class="n">Vesdict</span><span class="o">=</span><span class="n">Vesdict</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="n">draw</span><span class="p">,</span> <span class="n">a4</span><span class="o">=</span><span class="n">a4</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="n">Test</span><span class="p">,</span>
            <span class="n">ind</span><span class="o">=</span><span class="n">ind</span><span class="p">,</span> <span class="n">Val</span><span class="o">=</span><span class="n">Val</span><span class="p">,</span> <span class="n">Crit</span><span class="o">=</span><span class="n">Crit</span><span class="p">,</span> <span class="n">PreExp</span><span class="o">=</span><span class="n">PreExp</span><span class="p">,</span> <span class="n">PostExp</span><span class="o">=</span><span class="n">PostExp</span><span class="p">,</span> <span class="n">Log</span><span class="o">=</span><span class="n">Log</span><span class="p">,</span> <span class="n">InOut</span><span class="o">=</span><span class="n">InOut</span><span class="p">)</span></div>

<span class="c">#    def plot_3D_mlab(self,Lplot=&#39;Tot&#39;,PDIOR=&#39;DIOR&#39;,ax=&#39;None&#39;, Ldict=Ldict_Def,Mdict=Mdict_Def,LegDict=LegDict_Def):</span>
<span class="c">#        fig = Plot_3D_mlab_GLOS()</span>
<span class="c">#        return fig</span>

<div class="viewcode-block" id="GLOS.plot_Sinogram"><a class="viewcode-back" href="../../../Auto_tofu.geom.html#tofu.geom.GLOS.plot_Sinogram">[docs]</a>    <span class="k">def</span> <span class="nf">plot_Sinogram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Proj</span><span class="o">=</span><span class="s">&#39;Cross&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Elt</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">LOSImpElt</span><span class="p">,</span> <span class="n">Sketch</span><span class="o">=</span><span class="k">True</span><span class="p">,</span> <span class="n">Ang</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">LOSImpAng</span><span class="p">,</span> <span class="n">AngUnit</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">LOSImpAngUnit</span><span class="p">,</span>
            <span class="n">Ldict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">LOSMImpd</span><span class="p">,</span> <span class="n">Vdict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">TorPFilld</span><span class="p">,</span> <span class="n">LegDict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">TorLegd</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="k">True</span><span class="p">,</span> <span class="n">a4</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="k">True</span><span class="p">,</span>
            <span class="n">ind</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Val</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Crit</span><span class="o">=</span><span class="s">&#39;Name&#39;</span><span class="p">,</span> <span class="n">PreExp</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">PostExp</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Log</span><span class="o">=</span><span class="s">&#39;any&#39;</span><span class="p">,</span> <span class="n">InOut</span><span class="o">=</span><span class="s">&#39;In&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Plot the sinogram of the vessel polygon, by computing its envelopp in a cross-section, can also plot a 3D version of it</span>

<span class="sd">        Plot all the :class:`LOS` of the GLOS, or only a selection of them in projection space</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        Proj :      str</span>
<span class="sd">            Flag indicating whether to plot a classic sinogram (&#39;Cross&#39;) from the vessel cross-section (assuming 2D), or an extended 3D version &#39;3d&#39; of it with additional angle, default: &#39;Cross&#39;</span>
<span class="sd">        ax :        None or plt.Axes</span>
<span class="sd">            The axes on which the plot should be done, if None a new figure and axes is created, default: None</span>
<span class="sd">        Elt :       str</span>
<span class="sd">            Flag indicating which elements to plot, each capital letter stands for one element, default: &#39;LV&#39;</span>
<span class="sd">                * &#39;L&#39;: LOS</span>
<span class="sd">                * &#39;V&#39;: Vessel</span>
<span class="sd">        Ang :       str</span>
<span class="sd">            Flag indicating which angle to use for the impact parameter, the angle of the line itself (xi) or of its impact parameter (theta), default: &#39;theta&#39;</span>
<span class="sd">        AngUnit :   str</span>
<span class="sd">            Flag for the angle units to be displayed, &#39;rad&#39; for radians or &#39;deg&#39; for degrees, default: &#39;rad&#39;</span>
<span class="sd">        Sketch :    bool</span>
<span class="sd">            Flag indicating whether a small skecth showing the definitions of angles &#39;theta&#39; and &#39;xi&#39; should be included or not</span>
<span class="sd">        Ldict :     dict</span>
<span class="sd">            Dictionary of properties used for plotting the LOS point, fed to plt.plot() if Proj=&#39;Cross&#39; and to plt.plot_surface() if Proj=&#39;3d&#39;, default: see ToFu_Defaults.py</span>
<span class="sd">        Vdict :     dict</span>
<span class="sd">            Dictionary of properties used for plotting the polygon envelopp, fed to plt.plot() if Proj=&#39;Cross&#39; and to plt.plot_surface() if Proj=&#39;3d&#39;, default: see ToFu_Defaults.py</span>
<span class="sd">        LegDict :   None or dict</span>
<span class="sd">            Dictionary of properties used for plotting the legend, fed to plt.legend(), the legend is not plotted if None, default: see ToFu_Defaults.py</span>
<span class="sd">        draw :      bool</span>
<span class="sd">            Flag indicating whether to draw the figure, default: True</span>
<span class="sd">        Test :      bool</span>
<span class="sd">            Flag indicating whether the inputs shall be tested for conformity, default: True</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ax :        plt.Axes</span>
<span class="sd">            The axes used to plot</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_tfg_p</span><span class="o">.</span><span class="n">GLOS_plot_Sinogram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Proj</span><span class="o">=</span><span class="n">Proj</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">Elt</span><span class="o">=</span><span class="n">Elt</span><span class="p">,</span> <span class="n">Sketch</span><span class="o">=</span><span class="n">Sketch</span><span class="p">,</span> <span class="n">Ang</span><span class="o">=</span><span class="n">Ang</span><span class="p">,</span> <span class="n">AngUnit</span><span class="o">=</span><span class="n">AngUnit</span><span class="p">,</span>
            <span class="n">Ldict</span><span class="o">=</span><span class="n">Ldict</span><span class="p">,</span> <span class="n">Vdict</span><span class="o">=</span><span class="n">Vdict</span><span class="p">,</span> <span class="n">LegDict</span><span class="o">=</span><span class="n">LegDict</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="n">draw</span><span class="p">,</span> <span class="n">a4</span><span class="o">=</span><span class="n">a4</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="n">Test</span><span class="p">,</span>
            <span class="n">ind</span><span class="o">=</span><span class="n">ind</span><span class="p">,</span> <span class="n">Val</span><span class="o">=</span><span class="n">Val</span><span class="p">,</span> <span class="n">Crit</span><span class="o">=</span><span class="n">Crit</span><span class="p">,</span> <span class="n">PreExp</span><span class="o">=</span><span class="n">PreExp</span><span class="p">,</span> <span class="n">PostExp</span><span class="o">=</span><span class="n">PostExp</span><span class="p">,</span> <span class="n">Log</span><span class="o">=</span><span class="n">Log</span><span class="p">,</span> <span class="n">InOut</span><span class="o">=</span><span class="n">InOut</span><span class="p">)</span></div>



<div class="viewcode-block" id="GLOS.save"><a class="viewcode-back" href="../../../Auto_tofu.geom.html#tofu.geom.GLOS.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">SaveName</span><span class="o">=</span><span class="k">None</span><span class="p">,</span><span class="n">Path</span><span class="o">=</span><span class="k">None</span><span class="p">,</span><span class="n">Mode</span><span class="o">=</span><span class="s">&#39;npz&#39;</span><span class="p">,</span> <span class="n">compressed</span><span class="o">=</span><span class="k">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Save the object in folder Name, under file name SaveName, using specified mode</span>

<span class="sd">        Most tofu objects can be saved automatically as numpy arrays (.npz, recommended) at the default location (recommended) by simply calling self.save()</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        SaveName :  None / str</span>
<span class="sd">            The name to be used for the saved file, if None (recommended) uses self.Id.SaveName</span>
<span class="sd">        Path :      None / str</span>
<span class="sd">            Path specifying where to save the file, if None (recommended) uses self.Id.SavePath</span>
<span class="sd">        Mode :      str</span>
<span class="sd">            Flag specifying whether to save the object as a numpy array file (&#39;.npz&#39;, recommended) or an object using cPickle (not recommended, heavier and may cause retro-compatibility issues)</span>
<span class="sd">        compressed :    bool</span>
<span class="sd">            Flag, used when Mode=&#39;npz&#39;, indicating whether to use np.savez or np.savez_compressed (slower saving and loading but smaller files)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tfpf</span><span class="o">.</span><span class="n">Save_Generic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">SaveName</span><span class="o">=</span><span class="n">SaveName</span><span class="p">,</span> <span class="n">Path</span><span class="o">=</span><span class="n">Path</span><span class="p">,</span> <span class="n">Mode</span><span class="o">=</span><span class="n">Mode</span><span class="p">,</span> <span class="n">compressed</span><span class="o">=</span><span class="n">compressed</span><span class="p">)</span></div></div>




<span class="k">def</span> <span class="nf">_GLOS_check_inputs</span><span class="p">(</span><span class="n">Id</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">LLOS</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Vess</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Sino_RefPt</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Clock</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">arrayorder</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Diag</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">dtime</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">dtimeIn</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">Id</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">Id</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">tfpf</span><span class="o">.</span><span class="n">ID</span><span class="p">],</span> <span class="s">&quot;Arg Id must be a str or a tfpf.ID object !&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">Vess</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">Vess</span><span class="p">)</span> <span class="ow">is</span> <span class="n">Ves</span><span class="p">,</span> <span class="s">&quot;Arg Ves must be a Ves instance !&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Exp</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">Exp</span><span class="o">==</span><span class="n">Vess</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Exp</span><span class="p">,</span> <span class="s">&quot;Arg Exp must be identical to Ves.Id.Exp !&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">arrayorder</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">arrayorder</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;C&#39;</span><span class="p">,</span><span class="s">&#39;F&#39;</span><span class="p">],</span> <span class="s">&quot;Arg arrayorder must be in [&#39;C&#39;,&#39;F&#39;] !&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">LLOS</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="nb">type</span><span class="p">(</span><span class="n">ll</span><span class="p">)</span> <span class="ow">is</span> <span class="n">LOS</span> <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="n">LLOS</span><span class="p">]),</span> <span class="s">&quot;Arg LLOS must be a list of LOS objects !&quot;</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">ll</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Exp</span><span class="o">==</span><span class="n">LLOS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Exp</span> <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="n">LLOS</span><span class="p">]),</span> <span class="s">&quot;All LOS must have the same Exp !&quot;</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">ll</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Type</span><span class="o">==</span><span class="n">LLOS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Type</span> <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="n">LLOS</span><span class="p">]),</span> <span class="s">&quot;All LOS must have the same Type !&quot;</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">tfpf</span><span class="o">.</span><span class="n">CheckSameObj</span><span class="p">(</span><span class="n">LLOS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Ves</span><span class="p">,</span><span class="n">ll</span><span class="o">.</span><span class="n">Ves</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;Poly&#39;</span><span class="p">,</span><span class="s">&#39;Type&#39;</span><span class="p">,</span><span class="s">&#39;Name&#39;</span><span class="p">,</span><span class="s">&#39;Exp&#39;</span><span class="p">,</span><span class="s">&#39;SaveName&#39;</span><span class="p">,</span><span class="s">&#39;shot&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="n">LLOS</span><span class="p">]),</span> <span class="s">&quot;All LOS in LLOS must have the same Ves instance !&quot;</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">ll</span><span class="o">.</span><span class="n">_arrayorder</span><span class="o">==</span><span class="n">LLOS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">_arrayorder</span> <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="n">LLOS</span><span class="p">]),</span> <span class="s">&quot;All LOS should have the same arrayorder !&quot;</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">ll</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Diag</span><span class="o">==</span><span class="n">LLOS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Diag</span> <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="n">LLOS</span><span class="p">]),</span> <span class="s">&quot;All LOS should have the same Diag !&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">arrayorder</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">LLOS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">_arrayorder</span><span class="o">==</span><span class="n">arrayorder</span><span class="p">,</span> <span class="s">&quot;All LOS should have the same arrayorder as provided !&quot;</span>
    <span class="k">assert</span> <span class="n">Type</span> <span class="ow">is</span> <span class="k">None</span><span class="p">,</span> <span class="s">&quot;Arg Type must be None for a GLOS object !&quot;</span>
    <span class="n">bools</span> <span class="o">=</span> <span class="p">[</span><span class="n">Clock</span><span class="p">,</span><span class="n">dtimeIn</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="ow">not</span> <span class="n">aa</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">bools</span><span class="p">]):</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">aa</span> <span class="ow">is</span> <span class="k">None</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">aa</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">bool</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">bools</span><span class="p">]),</span> <span class="s">&quot; Args [Clock,dtimeIn] must all be bool !&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">Exp</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">Exp</span> <span class="ow">in</span> <span class="n">tfd</span><span class="o">.</span><span class="n">AllowedExp</span><span class="p">,</span> <span class="s">&quot;Arg Exp must be in &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">AllowedExp</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; !&quot;</span>
    <span class="n">strs</span> <span class="o">=</span> <span class="p">[</span><span class="n">Diag</span><span class="p">,</span><span class="n">SavePath</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="ow">not</span> <span class="n">aa</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">strs</span><span class="p">]):</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">aa</span> <span class="ow">is</span> <span class="k">None</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">aa</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">strs</span><span class="p">]),</span> <span class="s">&quot;Args [Diag,SavePath] must all be str !&quot;</span>
    <span class="n">Ints</span> <span class="o">=</span> <span class="p">[</span><span class="n">shot</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="ow">not</span> <span class="n">aa</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">Ints</span><span class="p">]):</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">aa</span> <span class="ow">is</span> <span class="k">None</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">aa</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">Ints</span><span class="p">]),</span> <span class="s">&quot;Args [Sino_NP,shot] must be int !&quot;</span>
    <span class="n">Iter2</span> <span class="o">=</span> <span class="p">[</span><span class="n">Sino_RefPt</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="ow">not</span> <span class="n">aa</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">Iter2</span><span class="p">]):</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">aa</span> <span class="ow">is</span> <span class="k">None</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">aa</span><span class="p">,</span><span class="s">&#39;__iter__&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">aa</span><span class="p">)</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">aa</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="o">==</span><span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">Iter2</span><span class="p">]),</span> <span class="s">&quot;Args [DLong,Sino_RefPt] must be an iterable with len()=2 !&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">dtime</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">dtime</span><span class="p">)</span> <span class="ow">is</span> <span class="n">dtm</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="s">&quot;Arg dtime must be a dtm.datetime !&quot;</span>







<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">###############################################################################</span>
<span class="sd">###############################################################################</span>
<span class="sd">                   Lens class and functions</span>
<span class="sd">###############################################################################</span>
<span class="sd">&quot;&quot;&quot;</span>



<div class="viewcode-block" id="Lens"><a class="viewcode-back" href="../../../Auto_tofu.geom.html#tofu.geom.Lens">[docs]</a><span class="k">class</span> <span class="nc">Lens</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; A Lens class with all geometrical data and built-in methods, defined as a planar polygon in 3D cartesian coordinates, with optional :class:`~tofu.geom.Ves` object</span>

<span class="sd">    A Lens object is useful for implementing one of the two possible optical arrangements available in tofu.</span>
<span class="sd">    A Lens (implicitly convergent) is used for focusing incoming light on a detector of reduced size (i.e.g: like the end of an optic fiber cable).</span>
<span class="sd">    In this case, anmd in its current version, tofu only handles spherical lenses and assumes that the detector has a circular active surface, centered on the same axis as the lens and located in its focal plane.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    Id :            str or tfpf.ID</span>
<span class="sd">        A name string or a pre-built tfpf.ID class to be used to identify this particular instance, if a string is provided, it is fed to tfpf.ID()</span>
<span class="sd">    O :             iterable</span>
<span class="sd">        Array of 3D cartesian coordinates of the center of the Lens</span>
<span class="sd">    nIn :           iterable</span>
<span class="sd">        Array of 3D cartesian coordiantes of the vector defining the axis of the Lens</span>
<span class="sd">    Rad :           float</span>
<span class="sd">        Radius of the Lens</span>
<span class="sd">    F1 :            float</span>
<span class="sd">        Focal length of the Lens, on the detector side</span>
<span class="sd">    F2 :            float</span>
<span class="sd">        Focal length of the Lens, on the plasma side (only np.inf supported so far)</span>
<span class="sd">    Type :          str</span>
<span class="sd">        Flag indicating the type of Lens (only &#39;Sph&#39; - for spherical lens - supported so far)</span>
<span class="sd">    R1 :            None or float</span>
<span class="sd">        Radius of the first face of the Lens, for full description only</span>
<span class="sd">    R2 :            None or float</span>
<span class="sd">        Radius of the second face of the Lens, for full description only</span>
<span class="sd">    dd :            None or float</span>
<span class="sd">        Width of the Lens along its axis, for full description only</span>
<span class="sd">    Ves :           :class:`~tofu.geom.Ves`</span>
<span class="sd">        :class:`~tofu.geom.Ves` object to which the aperture is assigned</span>
<span class="sd">    Exp :           None or str</span>
<span class="sd">        Experiment to which the Lens belongs, should be identical to Ves.Id.Exp if Ves is provided, if None and Ves is provided, Ves.Id.Exp is used</span>
<span class="sd">    Diag :          None or str</span>
<span class="sd">        Diagnostic to which the Lens belongs</span>
<span class="sd">    shot :          None or int</span>
<span class="sd">        Shot number from which this Lens is usable (in case its position was changed from a previous configuration)</span>
<span class="sd">    SavePath :      None / str</span>
<span class="sd">        If provided, forces the default saving path of the object to the provided value</span>
<span class="sd">    Clock :         bool</span>
<span class="sd">        Flag indicating whether the input polygon should be made clockwise (True) or counter-clockwise (False), default: False</span>
<span class="sd">    arrayorder :    str</span>
<span class="sd">        Flag indicating whether the attributes of type=np.ndarray (e.g.: Poly) should be made C-contiguous (&#39;C&#39;) or Fortran-contiguous (&#39;F&#39;), default: &#39;C&#39;</span>
<span class="sd">    dtime :         None or dtm.datetime</span>
<span class="sd">        A time reference to be used to identify this particular instance (used for debugging mostly), default: None</span>
<span class="sd">    dtimeIn :       bool</span>
<span class="sd">        Flag indicating whether dtime should be included in the SaveName (used for debugging mostly), default: False</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="n">O</span><span class="p">,</span> <span class="n">nIn</span><span class="p">,</span> <span class="n">Rad</span><span class="p">,</span> <span class="n">F1</span><span class="p">,</span> <span class="n">F2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">R1</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">R2</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">dd</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Ves</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="s">&#39;Sph&#39;</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Diag</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">arrayorder</span><span class="o">=</span><span class="s">&#39;C&#39;</span><span class="p">,</span> <span class="n">Clock</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">dtime</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">dtimeIn</span><span class="o">=</span><span class="k">False</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_Done</span> <span class="o">=</span> <span class="k">False</span>
        <span class="n">tfpf</span><span class="o">.</span><span class="n">_check_NotNone</span><span class="p">({</span><span class="s">&#39;Clock&#39;</span><span class="p">:</span><span class="n">Clock</span><span class="p">,</span><span class="s">&#39;arrayorder&#39;</span><span class="p">:</span><span class="n">arrayorder</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_inputs</span><span class="p">(</span><span class="n">Clock</span><span class="o">=</span><span class="n">Clock</span><span class="p">,</span> <span class="n">arrayorder</span><span class="o">=</span><span class="n">arrayorder</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_arrayorder</span> <span class="o">=</span> <span class="n">arrayorder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Clock</span> <span class="o">=</span> <span class="n">Clock</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">Ves</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="n">Exp</span> <span class="o">=</span> <span class="n">Exp</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">Exp</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">else</span> <span class="n">Ves</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Exp</span>
            <span class="k">assert</span> <span class="n">Exp</span><span class="o">==</span><span class="n">Ves</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Exp</span><span class="p">,</span> <span class="s">&quot;Arg Exp must be identical to the Ves.Id.Exp !&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_Id</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="n">Type</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="n">Exp</span><span class="p">,</span> <span class="n">Diag</span><span class="o">=</span><span class="n">Diag</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="n">shot</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="n">SavePath</span><span class="p">,</span> <span class="n">dtime</span><span class="o">=</span><span class="n">dtime</span><span class="p">,</span> <span class="n">dtimeIn</span><span class="o">=</span><span class="n">dtimeIn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_geom</span><span class="p">(</span><span class="n">O</span><span class="p">,</span> <span class="n">nIn</span><span class="p">,</span> <span class="n">Rad</span><span class="p">,</span> <span class="n">F1</span><span class="p">,</span> <span class="n">F2</span><span class="o">=</span><span class="n">F2</span><span class="p">,</span> <span class="n">R1</span><span class="o">=</span><span class="n">R1</span><span class="p">,</span> <span class="n">R2</span><span class="o">=</span><span class="n">R2</span><span class="p">,</span> <span class="n">dd</span><span class="o">=</span><span class="n">dd</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_Ves</span><span class="p">(</span><span class="n">Ves</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Done</span> <span class="o">=</span> <span class="k">True</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Type</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Id</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">O</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_O</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">BaryS</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_O</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Rad</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Rad</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">F1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_F1</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">F2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_F2</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nIn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nIn</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Poly</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">NP</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return a simple representation of the Lens as a 3D circle (if Lens.Type=&#39;Sph&#39;) &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">Type</span><span class="o">==</span><span class="s">&#39;Sph&#39;</span><span class="p">,</span> <span class="s">&quot;Coded only for Lens.Type=&#39;Sph&#39; !&quot;</span>
        <span class="n">thet</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="n">NP</span><span class="p">)</span>
        <span class="n">e1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">nIn</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">nIn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mf">0.</span><span class="p">])</span>
        <span class="n">e1</span> <span class="o">=</span> <span class="n">e1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">e1</span><span class="p">)</span>
        <span class="n">e2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nIn</span><span class="p">,</span><span class="n">e1</span><span class="p">)</span>
        <span class="n">Poly</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">O</span><span class="p">,(</span><span class="n">NP</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rad</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">thet</span><span class="p">)</span><span class="o">*</span><span class="n">e1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">thet</span><span class="p">)</span><span class="o">*</span><span class="n">e2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">thet</span><span class="p">)</span><span class="o">*</span><span class="n">e1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">thet</span><span class="p">)</span><span class="o">*</span><span class="n">e2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">thet</span><span class="p">)</span><span class="o">*</span><span class="n">e1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">thet</span><span class="p">)</span><span class="o">*</span><span class="n">e2</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span>
        <span class="n">Poly</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">Poly</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_arrayorder</span><span class="o">==</span><span class="s">&#39;C&#39;</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">asfortranarray</span><span class="p">(</span><span class="n">Poly</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Poly</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Surf</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">Type</span><span class="o">==</span><span class="s">&#39;Sph&#39;</span><span class="p">,</span> <span class="s">&quot;Coded only for Lens.Type=&#39;Sph&#39; !&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">Rad</span><span class="o">**</span><span class="mi">2</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Full</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Full</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">R1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_R1</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">R2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_R2</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dd</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Ves</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Ves</span>

    <span class="k">def</span> <span class="nf">_check_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Id</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">O</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">nIn</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Rad</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">F1</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">F2</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">R1</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">R2</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">dd</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Ves</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Diag</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">arrayorder</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Clock</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">dtime</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">dtimeIn</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
        <span class="n">_Lens_check_inputs</span><span class="p">(</span><span class="n">Id</span><span class="o">=</span><span class="n">Id</span><span class="p">,</span> <span class="n">O</span><span class="o">=</span><span class="n">O</span><span class="p">,</span> <span class="n">nIn</span><span class="o">=</span><span class="n">nIn</span><span class="p">,</span> <span class="n">Rad</span><span class="o">=</span><span class="n">Rad</span><span class="p">,</span> <span class="n">F1</span><span class="o">=</span><span class="n">F1</span><span class="p">,</span> <span class="n">F2</span><span class="o">=</span><span class="n">F2</span><span class="p">,</span> <span class="n">R1</span><span class="o">=</span><span class="n">R1</span><span class="p">,</span> <span class="n">R2</span><span class="o">=</span><span class="n">R2</span><span class="p">,</span> <span class="n">dd</span><span class="o">=</span><span class="n">dd</span><span class="p">,</span> <span class="n">Vess</span><span class="o">=</span><span class="n">Ves</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="n">Type</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="n">Exp</span><span class="p">,</span> <span class="n">Diag</span><span class="o">=</span><span class="n">Diag</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="n">shot</span><span class="p">,</span> <span class="n">arrayorder</span><span class="o">=</span><span class="n">arrayorder</span><span class="p">,</span> <span class="n">Clock</span><span class="o">=</span><span class="n">Clock</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="n">SavePath</span><span class="p">,</span> <span class="n">dtime</span><span class="o">=</span><span class="n">dtime</span><span class="p">,</span> <span class="n">dtimeIn</span><span class="o">=</span><span class="n">dtimeIn</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_set_Id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Val</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Diag</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">dtime</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">dtimeIn</span><span class="o">=</span><span class="k">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Done</span><span class="p">:</span>
            <span class="n">Out</span> <span class="o">=</span> <span class="n">tfpf</span><span class="o">.</span><span class="n">_get_FromItself</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;Type&#39;</span><span class="p">:</span><span class="n">Type</span><span class="p">,</span> <span class="s">&#39;Exp&#39;</span><span class="p">:</span><span class="n">Exp</span><span class="p">,</span> <span class="s">&#39;shot&#39;</span><span class="p">:</span><span class="n">shot</span><span class="p">,</span> <span class="s">&#39;Diag&#39;</span><span class="p">:</span><span class="n">Diag</span><span class="p">,</span> <span class="s">&#39;dtime&#39;</span><span class="p">:</span><span class="n">dtime</span><span class="p">,</span> <span class="s">&#39;_dtimeIn&#39;</span><span class="p">:</span><span class="n">dtimeIn</span><span class="p">,</span> <span class="s">&#39;SavePath&#39;</span><span class="p">:</span><span class="n">SavePath</span><span class="p">})</span>
            <span class="n">Type</span><span class="p">,</span> <span class="n">Exp</span><span class="p">,</span> <span class="n">shot</span><span class="p">,</span> <span class="n">Diag</span><span class="p">,</span> <span class="n">dtime</span><span class="p">,</span> <span class="n">dtimeIn</span><span class="p">,</span> <span class="n">SavePath</span> <span class="o">=</span> <span class="n">Out</span><span class="p">[</span><span class="s">&#39;Type&#39;</span><span class="p">],</span> <span class="n">Out</span><span class="p">[</span><span class="s">&#39;Exp&#39;</span><span class="p">],</span> <span class="n">Out</span><span class="p">[</span><span class="s">&#39;shot&#39;</span><span class="p">],</span> <span class="n">Out</span><span class="p">[</span><span class="s">&#39;Diag&#39;</span><span class="p">],</span> <span class="n">Out</span><span class="p">[</span><span class="s">&#39;dtime&#39;</span><span class="p">],</span> <span class="n">Out</span><span class="p">[</span><span class="s">&#39;dtimeIn&#39;</span><span class="p">],</span> <span class="n">Out</span><span class="p">[</span><span class="s">&#39;SavePath&#39;</span><span class="p">]</span>
        <span class="n">tfpf</span><span class="o">.</span><span class="n">_check_NotNone</span><span class="p">({</span><span class="s">&#39;Id&#39;</span><span class="p">:</span><span class="n">Val</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_inputs</span><span class="p">(</span><span class="n">Id</span><span class="o">=</span><span class="n">Val</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">Val</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">tfpf</span><span class="o">.</span><span class="n">_check_NotNone</span><span class="p">({</span><span class="s">&#39;Type&#39;</span><span class="p">:</span><span class="n">Type</span><span class="p">,</span> <span class="s">&#39;Exp&#39;</span><span class="p">:</span><span class="n">Exp</span><span class="p">,</span> <span class="s">&#39;shot&#39;</span><span class="p">:</span><span class="n">shot</span><span class="p">,</span> <span class="s">&#39;Diag&#39;</span><span class="p">:</span><span class="n">Diag</span><span class="p">,</span> <span class="s">&#39;dtimeIn&#39;</span><span class="p">:</span><span class="n">dtimeIn</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_inputs</span><span class="p">(</span><span class="n">Type</span><span class="o">=</span><span class="n">Type</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="n">Exp</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="n">shot</span><span class="p">,</span> <span class="n">Diag</span><span class="o">=</span><span class="n">Diag</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="n">SavePath</span><span class="p">,</span> <span class="n">dtime</span><span class="o">=</span><span class="n">dtime</span><span class="p">,</span> <span class="n">dtimeIn</span><span class="o">=</span><span class="n">dtimeIn</span><span class="p">)</span>
            <span class="n">Val</span> <span class="o">=</span> <span class="n">tfpf</span><span class="o">.</span><span class="n">ID</span><span class="p">(</span><span class="s">&#39;Lens&#39;</span><span class="p">,</span> <span class="n">Val</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="n">Type</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="n">Exp</span><span class="p">,</span> <span class="n">Diag</span><span class="o">=</span><span class="n">Diag</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="n">shot</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="n">SavePath</span><span class="p">,</span> <span class="n">dtime</span><span class="o">=</span><span class="n">dtime</span><span class="p">,</span> <span class="n">dtimeIn</span><span class="o">=</span><span class="n">dtimeIn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Id</span> <span class="o">=</span> <span class="n">Val</span>

    <span class="k">def</span> <span class="nf">_set_geom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">O</span><span class="p">,</span> <span class="n">nIn</span><span class="p">,</span> <span class="n">Rad</span><span class="p">,</span> <span class="n">F1</span><span class="p">,</span> <span class="n">F2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">R1</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">R2</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">dd</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
        <span class="n">tfpf</span><span class="o">.</span><span class="n">_check_NotNone</span><span class="p">({</span><span class="s">&#39;O&#39;</span><span class="p">:</span><span class="n">O</span><span class="p">,</span><span class="s">&#39;nIn&#39;</span><span class="p">:</span><span class="n">nIn</span><span class="p">,</span><span class="s">&#39;Rad&#39;</span><span class="p">:</span><span class="n">Rad</span><span class="p">,</span><span class="s">&#39;F1&#39;</span><span class="p">:</span><span class="n">F1</span><span class="p">,</span><span class="s">&#39;F2&#39;</span><span class="p">:</span><span class="n">F2</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_inputs</span><span class="p">(</span><span class="n">O</span><span class="o">=</span><span class="n">O</span><span class="p">,</span> <span class="n">nIn</span><span class="o">=</span><span class="n">nIn</span><span class="p">,</span> <span class="n">Rad</span><span class="o">=</span><span class="n">Rad</span><span class="p">,</span> <span class="n">F1</span><span class="o">=</span><span class="n">F1</span><span class="p">,</span> <span class="n">F2</span><span class="o">=</span><span class="n">F2</span><span class="p">,</span> <span class="n">R1</span><span class="o">=</span><span class="n">R1</span><span class="p">,</span> <span class="n">R2</span><span class="o">=</span><span class="n">R2</span><span class="p">,</span> <span class="n">dd</span><span class="o">=</span><span class="n">dd</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_O</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nIn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Rad</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_F1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_F2</span> <span class="o">=</span> <span class="n">_tfg_c</span><span class="o">.</span><span class="n">_Lens_set_geom_reduced</span><span class="p">(</span><span class="n">O</span><span class="p">,</span> <span class="n">nIn</span><span class="p">,</span> <span class="n">Rad</span><span class="p">,</span> <span class="n">F1</span><span class="p">,</span> <span class="n">F2</span><span class="o">=</span><span class="n">F2</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Type</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Full</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_R1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_R2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_C1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_C2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Angmax1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Angmax2</span> <span class="o">=</span> <span class="n">_tfg_c</span><span class="o">.</span><span class="n">_Lens_set_geom_full</span><span class="p">(</span><span class="n">R1</span><span class="o">=</span><span class="n">R1</span><span class="p">,</span> <span class="n">R2</span><span class="o">=</span><span class="n">R2</span><span class="p">,</span> <span class="n">dd</span><span class="o">=</span><span class="n">dd</span><span class="p">,</span> <span class="n">O</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">O</span><span class="p">,</span> <span class="n">Rad</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Rad</span><span class="p">,</span> <span class="n">nIn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nIn</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Type</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_Ves</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">Ves</span><span class="p">):</span>
        <span class="n">tfpf</span><span class="o">.</span><span class="n">_check_NotNone</span><span class="p">({</span><span class="s">&#39;Ves&#39;</span><span class="p">:</span><span class="n">Ves</span><span class="p">,</span> <span class="s">&#39;Exp&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Exp</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_inputs</span><span class="p">(</span><span class="n">Ves</span><span class="o">=</span><span class="n">Ves</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Exp</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Ves</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">set_LObj</span><span class="p">([</span><span class="n">Ves</span><span class="o">.</span><span class="n">Id</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">Ves</span><span class="o">.</span><span class="n">Type</span><span class="o">==</span><span class="s">&#39;Tor&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_nIn</span> <span class="o">=</span> <span class="n">_tfg_c</span><span class="o">.</span><span class="n">Calc_nInFromTor_Poly</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BaryS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nIn</span><span class="p">,</span> <span class="n">Ves</span><span class="o">.</span><span class="n">BaryS</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">Ves</span><span class="o">.</span><span class="n">Type</span><span class="o">==</span><span class="s">&#39;Lin&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_nIn</span> <span class="o">=</span> <span class="n">_tfg_c</span><span class="o">.</span><span class="n">Calc_nInFromLin_Poly</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BaryS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nIn</span><span class="p">,</span> <span class="n">Ves</span><span class="o">.</span><span class="n">BaryS</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_geom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">O</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nIn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rad</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">F1</span><span class="p">,</span> <span class="n">F2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">F2</span><span class="p">,</span> <span class="n">R1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">R1</span><span class="p">,</span> <span class="n">R2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">R2</span><span class="p">,</span> <span class="n">dd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dd</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Ves</span> <span class="o">=</span> <span class="n">Ves</span>


    <span class="k">def</span> <span class="nf">_get_CircleInFocPlaneFromPts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Pts</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="k">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Compute the image of the lens projected on its focal plane as seen from arbitrary points in the plasma, treated with 3D coordinates and reduced lens model as input</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        Pts :   np.ndarray</span>
<span class="sd">            (3,N) or (3,) array of points 3D cartesian coordinates</span>
<span class="sd">        Test :  bool</span>
<span class="sd">            Flag indicating whether the inputs should be tested for conformity, default: True</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Cents : np.ndarray</span>
<span class="sd">            (3,N) array of the 3D cartesian coordinates of the centers of the image circles of the lens on the focal plane from points Pts</span>
<span class="sd">        Rads :  np.ndarray</span>
<span class="sd">            (N,) array of the radius of the image circles of the lens on the focal plane from points Pts</span>
<span class="sd">        d :     np.ndarray</span>
<span class="sd">            (N,) array of the algebraic distance along the lens axis between the Lens O-point and Pts</span>
<span class="sd">        r :     np.ndarray</span>
<span class="sd">            (N,) array of the absolute distance between Pts and the Lens axis</span>
<span class="sd">        rIm :   np.ndarray</span>
<span class="sd">            (N,) array of the absolute distance between Pts images (center of the image circles on the focal plane) and the Lens axis</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">Pts</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">Test</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">Type</span><span class="o">==</span><span class="s">&#39;Sph&#39;</span><span class="p">,</span> <span class="s">&quot;Can only be computed for spherical lenses, cylindrical lenses not coded yet !&quot;</span>
            <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">Pts</span><span class="p">)</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="ow">and</span> <span class="n">Pts</span><span class="o">.</span><span class="n">ndim</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="ow">and</span> <span class="mi">3</span> <span class="ow">in</span> <span class="n">Pts</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s">&quot;Arg Pts must be a (3,N), (N,3) or (3,) np.ndarray !&quot;</span>
            <span class="k">assert</span> <span class="n">out</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;2d&#39;</span><span class="p">,</span><span class="s">&#39;3d&#39;</span><span class="p">],</span> <span class="s">&quot;Arg out must be &#39;2D&#39; or &#39;3D&#39; !&quot;</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Type</span><span class="o">==</span><span class="s">&#39;Sph&#39;</span><span class="p">,</span> <span class="s">&quot;Only coded for spherical lens !&quot;</span>
        <span class="k">if</span> <span class="n">Pts</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">Pts</span> <span class="o">=</span> <span class="n">Pts</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Pts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">3</span> <span class="ow">and</span> <span class="n">Pts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
            <span class="n">Pts</span> <span class="o">=</span> <span class="n">Pts</span><span class="o">.</span><span class="n">T</span>
        <span class="n">Cs0</span><span class="p">,</span><span class="n">Cs1</span><span class="p">,</span><span class="n">Cs2</span><span class="p">,</span> <span class="n">RadIm</span><span class="p">,</span> <span class="n">din</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">rIm</span><span class="p">,</span> <span class="n">nperp0</span><span class="p">,</span><span class="n">nperp1</span><span class="p">,</span><span class="n">nperp2</span> <span class="o">=</span> <span class="n">_tfg_gg</span><span class="o">.</span><span class="n">_Lens_get_CircleInFocPlaneFromPts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">O</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">O</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">O</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">nIn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">nIn</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">nIn</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rad</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">F1</span><span class="p">,</span> <span class="n">Pts</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span><span class="n">Pts</span><span class="p">[</span><span class="mi">1</span><span class="p">,:],</span><span class="n">Pts</span><span class="p">[</span><span class="mi">2</span><span class="p">,:],</span> <span class="n">F2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">F2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">Cs0</span><span class="p">,</span><span class="n">Cs1</span><span class="p">,</span><span class="n">Cs2</span><span class="p">]),</span> <span class="n">RadIm</span><span class="p">,</span> <span class="n">din</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">rIm</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">nperp0</span><span class="p">,</span><span class="n">nperp1</span><span class="p">,</span><span class="n">nperp2</span><span class="p">])</span>


<div class="viewcode-block" id="Lens.plot_alone"><a class="viewcode-back" href="../../../Auto_tofu.geom.html#tofu.geom.Lens.plot_alone">[docs]</a>    <span class="k">def</span> <span class="nf">plot_alone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">V</span><span class="o">=</span><span class="s">&#39;red&#39;</span><span class="p">,</span> <span class="n">nin</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">nout</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">Lmax</span><span class="o">=</span><span class="s">&#39;F&#39;</span><span class="p">,</span> <span class="n">V_NP</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">src</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="k">True</span><span class="p">,</span> <span class="n">a4</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="k">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Plot a 2D representation of the Lens object, optionally with 2D viewing cone and rays of several sources in the plane, either with reduced of full representation</span>

<span class="sd">        Plot a sketch of the Lens, optionally with ray-traced incoming light beams.</span>
<span class="sd">        This plotting routine does not consider any syurrounding and plots everything assuming the origine of the coordinate system is on the Lens</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ax :    None or plt.Axes</span>
<span class="sd">            Axes to be used for plotting, if None a new figure with axes is created (default: None)</span>
<span class="sd">        V :     str</span>
<span class="sd">            Flag indicating whether the Lens should be considered in its reduced geometry model (&#39;red&#39;) or its full version (&#39;full&#39;), default: &#39;red&#39;</span>
<span class="sd">        nin :   float</span>
<span class="sd">            Value of the optical index to be used inside the Lens (useful when V=&#39;full&#39; only)</span>
<span class="sd">        nout :  float</span>
<span class="sd">            Value of the optical index to be used outside the Lens (useful when V=&#39;full&#39; only)</span>
<span class="sd">        Lmax :  float</span>
<span class="sd">            Maximum length on which the source beams should be plotted after going through the Lens, if &#39;F&#39; all beams are plotted up to the focal plane</span>
<span class="sd">        V_NP :  int</span>
<span class="sd">            Number of points to be used to plot each circle fraction of the full version of the Lens geometry (useful when V=&#39;full&#39; only)</span>
<span class="sd">        src :   None or dict</span>
<span class="sd">            Dictionary of parameters for the source of ray beams:</span>
<span class="sd">                * &#39;Pt&#39;:   iterable of len()=2 with the 2D cartesian coordinates of the point where the source should be located with reference to the Lens center (0,0) and axis (1,0)</span>
<span class="sd">                * &#39;Type&#39;: Flag indicating whether the source should a point (&#39;Pt&#39;) or an array of parallel beams perpendicular to a plane passing through Pt</span>
<span class="sd">                * &#39;nn&#39;:   iterable of len()=2 with the 2D cartesian coordinates of a vector directing the array of parallel beams</span>
<span class="sd">                * &#39;NP&#39;:   int, number of beams to be plotted from the source</span>
<span class="sd">        draw :  bool</span>
<span class="sd">            Flag indicating whether the fig.canvas.draw() shall be called automatically, default: True</span>
<span class="sd">        a4 :    bool</span>
<span class="sd">            Flag indicating whether the figure should be a4 size (for printing or saving as pdf for example)</span>
<span class="sd">        Test :  bool</span>
<span class="sd">            Flag indicating whether the inputs should be tested for conformity, default: True</span>

<span class="sd">        Returns</span>
<span class="sd">        --------</span>
<span class="sd">        ax :    plt.Axes</span>
<span class="sd">            Handle of the axes used for plotting</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_tfg_p</span><span class="o">.</span><span class="n">Lens_plot_alone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">V</span><span class="o">=</span><span class="n">V</span><span class="p">,</span> <span class="n">nin</span><span class="o">=</span><span class="n">nin</span><span class="p">,</span> <span class="n">nout</span><span class="o">=</span><span class="n">nout</span><span class="p">,</span> <span class="n">Lmax</span><span class="o">=</span><span class="n">Lmax</span><span class="p">,</span> <span class="n">V_NP</span><span class="o">=</span><span class="n">V_NP</span><span class="p">,</span> <span class="n">src</span><span class="o">=</span><span class="n">src</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="n">draw</span><span class="p">,</span> <span class="n">a4</span><span class="o">=</span><span class="n">a4</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="n">Test</span><span class="p">)</span></div>


<div class="viewcode-block" id="Lens.plot"><a class="viewcode-back" href="../../../Auto_tofu.geom.html#tofu.geom.Lens.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Lax</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Proj</span><span class="o">=</span><span class="s">&#39;All&#39;</span><span class="p">,</span> <span class="n">Elt</span><span class="o">=</span><span class="s">&#39;PV&#39;</span><span class="p">,</span> <span class="n">EltVes</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">Leg</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">LVIn</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">ApLVin</span><span class="p">,</span> <span class="n">Pdict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">ApPd</span><span class="p">,</span> <span class="n">Vdict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">ApVd</span><span class="p">,</span> <span class="n">Vesdict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">Vesdict</span><span class="p">,</span> <span class="n">LegDict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">TorLegd</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="k">True</span><span class="p">,</span> <span class="n">a4</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="k">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Plot the Lens object, optionally with the associated :class:`~tofu.geom.Ves` object</span>

<span class="sd">        Plot the chosen projections of the Lens polygon.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        Lax :       list or plt.Axes</span>
<span class="sd">            The axes to be used for plotting (provide a list of 2 axes if Proj=&#39;All&#39;), if None a new figure with axes is created</span>
<span class="sd">        Proj :      str</span>
<span class="sd">            Flag specifying the kind of projection used for the plot (&#39;Cross&#39; for a cross-section, &#39;Hor&#39; for a horizontal plane, &#39;All&#39; both and &#39;3d&#39; for 3d)</span>
<span class="sd">        Elt :       str</span>
<span class="sd">            Flag specifying which elements to plot, each capital letter corresponds to an element</span>
<span class="sd">                * &#39;P&#39;: polygon</span>
<span class="sd">                * &#39;V&#39;: vector perpendicular to the polygon, oriented towards the interior of the Vessel</span>
<span class="sd">        EltVes :    str</span>
<span class="sd">            Flag specifying the elements of the Vessel to be plotted, fed to :meth:`~tofu.geom.Ves.plot`</span>
<span class="sd">        Leg :       str</span>
<span class="sd">            Legend to be used to identify this LOS, if Leg=&#39;&#39; the LOS name is used</span>
<span class="sd">        LVIn :      float</span>
<span class="sd">            Length (in data coordinates, meters) of the vector &#39;V&#39;</span>
<span class="sd">        Pdict :     dict</span>
<span class="sd">            Dictionary of properties used for plotting the polygon, fed to plt.Axes.plot() or plt.plot_surface() if Proj=&#39;3d&#39;, set to ToFu_Defauts.py if None (default: None)</span>
<span class="sd">        Vdict :     dict</span>
<span class="sd">            Dictionary of properties used for plotting vector &#39;V&#39;, fed to plt.Axes.plot()</span>
<span class="sd">        Vesdict :   dict</span>
<span class="sd">            Dictionary of kwdargs to fed to :meth:`~tofu.geom.Ves.plot`, and &#39;EltVes&#39; is used instead of &#39;Elt&#39;</span>
<span class="sd">        LegDict :   dict or None</span>
<span class="sd">            Dictionary of properties used for plotting the legend, fed to plt.legend(), the legend is not plotted if None</span>
<span class="sd">        draw :      bool</span>
<span class="sd">            Flag indicating whether the fig.canvas.draw() shall be called automatically</span>
<span class="sd">        a4 :        bool</span>
<span class="sd">            Flag indicating whether the figure should be a4 size (for printing or saving as pdf for example)</span>
<span class="sd">        Test :      bool</span>
<span class="sd">            Flag indicating whether the inputs should be tested for conformity</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Lax :       list or plt.Axes</span>
<span class="sd">            Handles of the axes used for plotting (list if several axes where used)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_tfg_p</span><span class="o">.</span><span class="n">LLens_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Lax</span><span class="o">=</span><span class="n">Lax</span><span class="p">,</span> <span class="n">Proj</span><span class="o">=</span><span class="n">Proj</span><span class="p">,</span> <span class="n">Elt</span><span class="o">=</span><span class="n">Elt</span><span class="p">,</span> <span class="n">EltVes</span><span class="o">=</span><span class="n">EltVes</span><span class="p">,</span> <span class="n">Leg</span><span class="o">=</span><span class="n">Leg</span><span class="p">,</span> <span class="n">LVIn</span><span class="o">=</span><span class="n">LVIn</span><span class="p">,</span> <span class="n">Pdict</span><span class="o">=</span><span class="n">Pdict</span><span class="p">,</span> <span class="n">Vdict</span><span class="o">=</span><span class="n">Vdict</span><span class="p">,</span> <span class="n">Vesdict</span><span class="o">=</span><span class="n">Vesdict</span><span class="p">,</span> <span class="n">LegDict</span><span class="o">=</span><span class="n">LegDict</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="n">draw</span><span class="p">,</span> <span class="n">a4</span><span class="o">=</span><span class="n">a4</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="n">Test</span><span class="p">)</span></div>


<div class="viewcode-block" id="Lens.save"><a class="viewcode-back" href="../../../Auto_tofu.geom.html#tofu.geom.Lens.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">SaveName</span><span class="o">=</span><span class="k">None</span><span class="p">,</span><span class="n">Path</span><span class="o">=</span><span class="k">None</span><span class="p">,</span><span class="n">Mode</span><span class="o">=</span><span class="s">&#39;npz&#39;</span><span class="p">,</span> <span class="n">compressed</span><span class="o">=</span><span class="k">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Save the object in folder Name, under file name SaveName, using specified mode</span>

<span class="sd">        Most tofu objects can be saved automatically as numpy arrays (.npz, recommended) at the default location (recommended) by simply calling self.save()</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        SaveName :  None / str</span>
<span class="sd">            The name to be used for the saved file, if None (recommended) uses self.Id.SaveName</span>
<span class="sd">        Path :      None / str</span>
<span class="sd">            Path specifying where to save the file, if None (recommended) uses self.Id.SavePath</span>
<span class="sd">        Mode :      str</span>
<span class="sd">            Flag specifying whether to save the object as a numpy array file (&#39;.npz&#39;, recommended) or an object using cPickle (not recommended, heavier and may cause retro-compatibility issues)</span>
<span class="sd">        compressed :    bool</span>
<span class="sd">            Flag, used when Mode=&#39;npz&#39;, indicating whether to use np.savez or np.savez_compressed (slower saving and loading but smaller files)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tfpf</span><span class="o">.</span><span class="n">Save_Generic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">SaveName</span><span class="o">=</span><span class="n">SaveName</span><span class="p">,</span> <span class="n">Path</span><span class="o">=</span><span class="n">Path</span><span class="p">,</span> <span class="n">Mode</span><span class="o">=</span><span class="n">Mode</span><span class="p">,</span> <span class="n">compressed</span><span class="o">=</span><span class="n">compressed</span><span class="p">)</span></div></div>



<span class="k">def</span> <span class="nf">_Lens_check_inputs</span><span class="p">(</span><span class="n">Id</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">O</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">nIn</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Rad</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">F1</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">F2</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">R1</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">R2</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">dd</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Vess</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Diag</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">arrayorder</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Clock</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">dtime</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">dtimeIn</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">Id</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">Id</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">tfpf</span><span class="o">.</span><span class="n">ID</span><span class="p">],</span> <span class="s">&quot;Arg Id must be a str or a tfpf.ID object !&quot;</span>
    <span class="n">floats</span> <span class="o">=</span> <span class="p">[</span><span class="n">Rad</span><span class="p">,</span><span class="n">F1</span><span class="p">,</span><span class="n">F2</span><span class="p">,</span><span class="n">R1</span><span class="p">,</span><span class="n">R2</span><span class="p">,</span><span class="n">dd</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="ow">not</span> <span class="n">oo</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">for</span> <span class="n">oo</span> <span class="ow">in</span> <span class="n">floats</span><span class="p">]):</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">oo</span> <span class="ow">is</span> <span class="k">None</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">oo</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">float</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]</span> <span class="k">for</span> <span class="n">oo</span> <span class="ow">in</span> <span class="n">floats</span><span class="p">]),</span> <span class="s">&quot;Args Rad, F1 and F2 must be floats !&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">Vess</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">Vess</span><span class="p">)</span> <span class="ow">is</span> <span class="n">Ves</span><span class="p">,</span> <span class="s">&quot;Arg Ves must be a Ves instance !&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Exp</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">Exp</span><span class="o">==</span><span class="n">Vess</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Exp</span><span class="p">,</span> <span class="s">&quot;Arg Exp must be identical to Ves.Id.Exp !&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">arrayorder</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">arrayorder</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;C&#39;</span><span class="p">,</span><span class="s">&#39;F&#39;</span><span class="p">],</span> <span class="s">&quot;Arg arrayorder must be in [&#39;C&#39;,&#39;F&#39;] !&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">Type</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">Type</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;Sph&#39;</span><span class="p">],</span> <span class="s">&quot;Arg Type must be in [&#39;Sph&#39;] !&quot;</span>
    <span class="n">bools</span> <span class="o">=</span> <span class="p">[</span><span class="n">Clock</span><span class="p">,</span><span class="n">dtimeIn</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="ow">not</span> <span class="n">aa</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">bools</span><span class="p">]):</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">aa</span> <span class="ow">is</span> <span class="k">None</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">aa</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">bool</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">bools</span><span class="p">]),</span> <span class="s">&quot; Args [Clock,dtimeIn] must all be bool !&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">Exp</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">Exp</span> <span class="ow">in</span> <span class="n">tfd</span><span class="o">.</span><span class="n">AllowedExp</span><span class="p">,</span> <span class="s">&quot;Arg Exp must be in &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">AllowedExp</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; !&quot;</span>
    <span class="n">strs</span> <span class="o">=</span> <span class="p">[</span><span class="n">Diag</span><span class="p">,</span><span class="n">SavePath</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="ow">not</span> <span class="n">aa</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">strs</span><span class="p">]):</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">aa</span> <span class="ow">is</span> <span class="k">None</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">aa</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">strs</span><span class="p">]),</span> <span class="s">&quot;Args [Diag,SavePath] must all be str !&quot;</span>
    <span class="n">Ints</span> <span class="o">=</span> <span class="p">[</span><span class="n">shot</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="ow">not</span> <span class="n">aa</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">Ints</span><span class="p">]):</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">aa</span> <span class="ow">is</span> <span class="k">None</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">aa</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">Ints</span><span class="p">]),</span> <span class="s">&quot;Args [Sino_NP,shot] must be int !&quot;</span>
    <span class="n">Iter3</span> <span class="o">=</span> <span class="p">[</span><span class="n">O</span><span class="p">,</span><span class="n">nIn</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="ow">not</span> <span class="n">aa</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">Iter3</span><span class="p">]):</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">aa</span> <span class="ow">is</span> <span class="k">None</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">aa</span><span class="p">,</span><span class="s">&#39;__iter__&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">aa</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="o">==</span><span class="p">(</span><span class="mi">3</span><span class="p">,))</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">Iter3</span><span class="p">]),</span> <span class="s">&quot;Args [O,nIn] must be an iterable with len()=3 (3D cartesian coordinates) !&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">dtime</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">dtime</span><span class="p">)</span> <span class="ow">is</span> <span class="n">dtm</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="s">&quot;Arg dtime must be a dtm.datetime !&quot;</span>









<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">###############################################################################</span>
<span class="sd">###############################################################################</span>
<span class="sd">                   Aperture class and functions</span>
<span class="sd">###############################################################################</span>
<span class="sd">&quot;&quot;&quot;</span>


<div class="viewcode-block" id="Apert"><a class="viewcode-back" href="../../../Auto_tofu.geom.html#tofu.geom.Apert">[docs]</a><span class="k">class</span> <span class="nc">Apert</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; An Aperture class with all geometrical data and built-in methods, defined as a planar polygon in 3D cartesian coordinates, with optional :class:`~tofu.geom.Ves` object</span>

<span class="sd">    An Apert object is useful for implementing one of the two possible optical arrangements available in tofu.</span>
<span class="sd">    An aperture is modelled as a planar polygon (of any non self-intersecting shape) through which light can pass (fully transparent) and around which light cannot pass (fully non-transparent).</span>
<span class="sd">    One of the added-values of tofu is that it allows to create several non-coplanar aperture and assign them to a single detector. It then computes automatically the volume of sight by assuming that a detectable photon should go through all apertures.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    Id :        str or tfpf.ID</span>
<span class="sd">        A name string or a pre-built tfpf.ID class to be used to identify this particular instance, if a string is provided, it is fed to tfpf.ID()</span>
<span class="sd">    Poly :      np.ndarray</span>
<span class="sd">        An array (2,N) or (N,2) defining the contour of the aperture in 3D (X,Y,Z) cartesian coordinates, if not closed, will be closed automatically</span>
<span class="sd">    Ves :       :class:`~tofu.geom.Ves`</span>
<span class="sd">        :class:`~tofu.geom.Ves` object to which the aperture is assigned</span>
<span class="sd">    Type :      None or str</span>
<span class="sd">        Flag specifying the type of Apert</span>
<span class="sd">    Exp :       None or str</span>
<span class="sd">        Experiment to which the Lens belongs, should be identical to Ves.Id.Exp if Ves is provided, if None and Ves is provided, Ves.Id.Exp is used</span>
<span class="sd">    Diag :      None or str</span>
<span class="sd">        Diagnostic to which the Lens belongs</span>
<span class="sd">    shot :      None or int</span>
<span class="sd">        Shot number from which this Lens is usable (in case its position was changed from a previous configuration)</span>
<span class="sd">    SavePath :      None / str</span>
<span class="sd">        If provided, forces the default saving path of the object to the provided value</span>
<span class="sd">    Clock :     bool</span>
<span class="sd">        Flag indicating whether the input polygon should be made clockwise (True) or counter-clockwise (False)</span>
<span class="sd">    dtime :     None or dtm.datetime</span>
<span class="sd">        A time reference to be used to identify this particular instance (mostly used for debugging)</span>
<span class="sd">    dtimeIn :   bool</span>
<span class="sd">        Flag indicating whether dtime should be included in the SaveName (mostly used for debugging)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="n">Poly</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Ves</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Diag</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">arrayorder</span><span class="o">=</span><span class="s">&#39;C&#39;</span><span class="p">,</span> <span class="n">Clock</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">dtime</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">dtimeIn</span><span class="o">=</span><span class="k">False</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_Done</span> <span class="o">=</span> <span class="k">False</span>
        <span class="n">tfpf</span><span class="o">.</span><span class="n">_check_NotNone</span><span class="p">({</span><span class="s">&#39;Clock&#39;</span><span class="p">:</span><span class="n">Clock</span><span class="p">,</span><span class="s">&#39;arrayorder&#39;</span><span class="p">:</span><span class="n">arrayorder</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_inputs</span><span class="p">(</span><span class="n">Clock</span><span class="o">=</span><span class="n">Clock</span><span class="p">,</span> <span class="n">arrayorder</span><span class="o">=</span><span class="n">arrayorder</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_arrayorder</span> <span class="o">=</span> <span class="n">arrayorder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Clock</span> <span class="o">=</span> <span class="n">Clock</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">Ves</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="n">Exp</span> <span class="o">=</span> <span class="n">Exp</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">Exp</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">else</span> <span class="n">Ves</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Exp</span>
            <span class="k">assert</span> <span class="n">Exp</span><span class="o">==</span><span class="n">Ves</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Exp</span><span class="p">,</span> <span class="s">&quot;Arg Exp must be identical to the Ves.Id.Exp !&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_Id</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="n">Type</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="n">Exp</span><span class="p">,</span> <span class="n">Diag</span><span class="o">=</span><span class="n">Diag</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="n">shot</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="n">SavePath</span><span class="p">,</span> <span class="n">dtime</span><span class="o">=</span><span class="n">dtime</span><span class="p">,</span> <span class="n">dtimeIn</span><span class="o">=</span><span class="n">dtimeIn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_Poly</span><span class="p">(</span><span class="n">Poly</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_Ves</span><span class="p">(</span><span class="n">Ves</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_arrayorder</span><span class="p">(</span><span class="n">arrayorder</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Done</span> <span class="o">=</span> <span class="k">True</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the associated tfpf.ID object &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Id</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Poly</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the planar polygon defining the aperture (in 3D cartesian coordinates) &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Poly</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">NP</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the number of points defining the polygon &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_NP</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nIn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the normalized vector perpendicular to the polygon surface and oriented towards the interior of the associated vessel (in 3D cartesian coordinates) &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nIn</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">BaryS</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the (surfacic) center of mass of the polygon (in 3D cartesian coordinates) &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_BaryS</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Surf</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the area of the polygon &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Surf</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Rad</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Rad</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">F1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="k">None</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Ves</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the associated :class:`~tofu.geom.Ves` object &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Ves</span>

    <span class="k">def</span> <span class="nf">_check_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Id</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Poly</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Ves</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Diag</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">arrayorder</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Clock</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">dtime</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">dtimeIn</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
        <span class="n">_Apert_check_inputs</span><span class="p">(</span><span class="n">Id</span><span class="o">=</span><span class="n">Id</span><span class="p">,</span> <span class="n">Poly</span><span class="o">=</span><span class="n">Poly</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="n">Type</span><span class="p">,</span> <span class="n">Vess</span><span class="o">=</span><span class="n">Ves</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="n">Exp</span><span class="p">,</span> <span class="n">Diag</span><span class="o">=</span><span class="n">Diag</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="n">shot</span><span class="p">,</span> <span class="n">arrayorder</span><span class="o">=</span><span class="n">arrayorder</span><span class="p">,</span> <span class="n">Clock</span><span class="o">=</span><span class="n">Clock</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="n">SavePath</span><span class="p">,</span> <span class="n">dtime</span><span class="o">=</span><span class="n">dtime</span><span class="p">,</span> <span class="n">dtimeIn</span><span class="o">=</span><span class="n">dtimeIn</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_set_Id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Val</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Diag</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">dtime</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">dtimeIn</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Done</span><span class="p">:</span>
            <span class="n">Out</span> <span class="o">=</span> <span class="n">tfpf</span><span class="o">.</span><span class="n">_get_FromItself</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;Type&#39;</span><span class="p">:</span><span class="n">Type</span><span class="p">,</span> <span class="s">&#39;Exp&#39;</span><span class="p">:</span><span class="n">Exp</span><span class="p">,</span> <span class="s">&#39;shot&#39;</span><span class="p">:</span><span class="n">shot</span><span class="p">,</span> <span class="s">&#39;Diag&#39;</span><span class="p">:</span><span class="n">Diag</span><span class="p">,</span> <span class="s">&#39;dtime&#39;</span><span class="p">:</span><span class="n">dtime</span><span class="p">,</span> <span class="s">&#39;_dtimeIn&#39;</span><span class="p">:</span><span class="n">dtimeIn</span><span class="p">,</span> <span class="s">&#39;SavePath&#39;</span><span class="p">:</span><span class="n">SavePath</span><span class="p">})</span>
            <span class="n">Type</span><span class="p">,</span> <span class="n">Exp</span><span class="p">,</span> <span class="n">shot</span><span class="p">,</span> <span class="n">Diag</span><span class="p">,</span> <span class="n">dtime</span><span class="p">,</span> <span class="n">dtimeIn</span><span class="p">,</span> <span class="n">SavePath</span> <span class="o">=</span> <span class="n">Out</span><span class="p">[</span><span class="s">&#39;Type&#39;</span><span class="p">],</span> <span class="n">Out</span><span class="p">[</span><span class="s">&#39;Exp&#39;</span><span class="p">],</span> <span class="n">Out</span><span class="p">[</span><span class="s">&#39;shot&#39;</span><span class="p">],</span> <span class="n">Out</span><span class="p">[</span><span class="s">&#39;Diag&#39;</span><span class="p">],</span> <span class="n">Out</span><span class="p">[</span><span class="s">&#39;dtime&#39;</span><span class="p">],</span> <span class="n">Out</span><span class="p">[</span><span class="s">&#39;dtimeIn&#39;</span><span class="p">],</span> <span class="n">Out</span><span class="p">[</span><span class="s">&#39;SavePath&#39;</span><span class="p">]</span>
        <span class="n">tfpf</span><span class="o">.</span><span class="n">_check_NotNone</span><span class="p">({</span><span class="s">&#39;Id&#39;</span><span class="p">:</span><span class="n">Val</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_inputs</span><span class="p">(</span><span class="n">Id</span><span class="o">=</span><span class="n">Val</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">Val</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">tfpf</span><span class="o">.</span><span class="n">_check_NotNone</span><span class="p">({</span><span class="s">&#39;Exp&#39;</span><span class="p">:</span><span class="n">Exp</span><span class="p">,</span> <span class="s">&#39;shot&#39;</span><span class="p">:</span><span class="n">shot</span><span class="p">,</span> <span class="s">&#39;Diag&#39;</span><span class="p">:</span><span class="n">Diag</span><span class="p">,</span> <span class="s">&#39;dtimeIn&#39;</span><span class="p">:</span><span class="n">dtimeIn</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_inputs</span><span class="p">(</span><span class="n">Type</span><span class="o">=</span><span class="n">Type</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="n">Exp</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="n">shot</span><span class="p">,</span> <span class="n">Diag</span><span class="o">=</span><span class="n">Diag</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="n">SavePath</span><span class="p">,</span> <span class="n">dtime</span><span class="o">=</span><span class="n">dtime</span><span class="p">,</span> <span class="n">dtimeIn</span><span class="o">=</span><span class="n">dtimeIn</span><span class="p">)</span>
            <span class="n">Val</span> <span class="o">=</span> <span class="n">tfpf</span><span class="o">.</span><span class="n">ID</span><span class="p">(</span><span class="s">&#39;Apert&#39;</span><span class="p">,</span> <span class="n">Val</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="n">Type</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="n">Exp</span><span class="p">,</span> <span class="n">Diag</span><span class="o">=</span><span class="n">Diag</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="n">shot</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="n">SavePath</span><span class="p">,</span> <span class="n">dtime</span><span class="o">=</span><span class="n">dtime</span><span class="p">,</span> <span class="n">dtimeIn</span><span class="o">=</span><span class="n">dtimeIn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Id</span> <span class="o">=</span> <span class="n">Val</span>

    <span class="k">def</span> <span class="nf">_set_arrayorder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arrayorder</span><span class="p">):</span>
        <span class="n">tfpf</span><span class="o">.</span><span class="n">_set_arrayorder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arrayorder</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_Poly</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Poly</span><span class="p">):</span>
        <span class="n">tfpf</span><span class="o">.</span><span class="n">_check_NotNone</span><span class="p">({</span><span class="s">&#39;Poly&#39;</span><span class="p">:</span><span class="n">Poly</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_inputs</span><span class="p">(</span><span class="n">Poly</span><span class="o">=</span><span class="n">Poly</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Poly</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_NP</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nIn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_BaryP</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Surf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_BaryS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Rad</span> <span class="o">=</span>  <span class="n">_tfg_c</span><span class="o">.</span><span class="n">_ApDetect_set_Poly</span><span class="p">(</span><span class="n">Poly</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_arrayorder</span><span class="p">,</span> <span class="n">Clock</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_Clock</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Surf</span><span class="o">&gt;</span><span class="mf">0.</span><span class="p">,</span> <span class="s">&quot;Input Poly has 0 area !&quot;</span>

    <span class="k">def</span> <span class="nf">_set_Ves</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Ves</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
        <span class="n">tfpf</span><span class="o">.</span><span class="n">_check_NotNone</span><span class="p">({</span><span class="s">&#39;Ves&#39;</span><span class="p">:</span><span class="n">Ves</span><span class="p">,</span> <span class="s">&#39;Exp&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Exp</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_inputs</span><span class="p">(</span><span class="n">Ves</span><span class="o">=</span><span class="n">Ves</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Exp</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Ves</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">set_LObj</span><span class="p">([</span><span class="n">Ves</span><span class="o">.</span><span class="n">Id</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">Ves</span><span class="o">.</span><span class="n">Type</span><span class="o">==</span><span class="s">&#39;Tor&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_nIn</span> <span class="o">=</span> <span class="n">_tfg_c</span><span class="o">.</span><span class="n">Calc_nInFromTor_Poly</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BaryS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nIn</span><span class="p">,</span> <span class="n">Ves</span><span class="o">.</span><span class="n">BaryS</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">Ves</span><span class="o">.</span><span class="n">Type</span><span class="o">==</span><span class="s">&#39;Lin&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_nIn</span> <span class="o">=</span> <span class="n">_tfg_c</span><span class="o">.</span><span class="n">Calc_nInFromLin_Poly</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BaryS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nIn</span><span class="p">,</span> <span class="n">Ves</span><span class="o">.</span><span class="n">BaryS</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Ves</span> <span class="o">=</span> <span class="n">Ves</span>


<div class="viewcode-block" id="Apert.plot"><a class="viewcode-back" href="../../../Auto_tofu.geom.html#tofu.geom.Apert.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Lax</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Proj</span><span class="o">=</span><span class="s">&#39;All&#39;</span><span class="p">,</span> <span class="n">Elt</span><span class="o">=</span><span class="s">&#39;PV&#39;</span><span class="p">,</span> <span class="n">EltVes</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">Leg</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">LVIn</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">ApLVin</span><span class="p">,</span> <span class="n">Pdict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">ApPd</span><span class="p">,</span> <span class="n">Vdict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">ApVd</span><span class="p">,</span>
            <span class="n">Vesdict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">Vesdict</span><span class="p">,</span> <span class="n">LegDict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">TorLegd</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="k">True</span><span class="p">,</span> <span class="n">a4</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="k">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Plot the Apert, with a cross-section view, a horizontal view or both, or a 3d view, and optionally the :class:`~tofu.geom.Ves` object associated to it.</span>

<span class="sd">        Plot the desired projections of the polygon defining the aperture.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        Lax         list or plt.Axes</span>
<span class="sd">            The axes to be used for plotting (provide a list of 2 axes if Proj=&#39;All&#39;), if None a new figure with axes is created</span>
<span class="sd">        Proj        str</span>
<span class="sd">            Flag specifying the kind of projection used for the plot (&#39;Cross&#39; for a cross-section, &#39;Hor&#39; for a horizontal plane, &#39;All&#39; both and &#39;3d&#39; for 3d)</span>
<span class="sd">        Elt         str</span>
<span class="sd">            Flag specifying which elements to plot, each capital letter corresponds to an element</span>
<span class="sd">                * &#39;P&#39;: polygon</span>
<span class="sd">                * &#39;V&#39;: vector perpendicular to the polygon, oriented towards the interior of the Vessel</span>
<span class="sd">        EltVes      str</span>
<span class="sd">            Flag specifying the elements of the Vessel to be plotted, fed to :meth:`~tofu.geom.Ves.plot`</span>
<span class="sd">        Leg         str</span>
<span class="sd">            Legend to be used to identify this LOS, if Leg=&#39;&#39; the LOS name is used</span>
<span class="sd">        LVIn        float</span>
<span class="sd">            Length (in data coordinates, meters) of the vector &#39;V&#39;</span>
<span class="sd">        Pdict       dict</span>
<span class="sd">            Dictionary of properties used for plotting the polygon, fed to plt.Axes.plot() or plt.plot_surface() if Proj=&#39;3d&#39;, set to ToFu_Defauts.py if None</span>
<span class="sd">        Vdict       dict</span>
<span class="sd">            Dictionary of properties used for plotting vector &#39;V&#39;, fed to plt.Axes.plot()</span>
<span class="sd">        Vesdict     dict</span>
<span class="sd">            Dictionary of kwdargs to fed to :meth:`~tofu.geom.Ves.plot`, and &#39;EltVes&#39; is used instead of &#39;Elt&#39;</span>
<span class="sd">        LegDict     dict or None</span>
<span class="sd">            Dictionary of properties used for plotting the legend, fed to plt.legend(), the legend is not plotted if None</span>
<span class="sd">        draw        bool</span>
<span class="sd">            Flag indicating whether the fig.canvas.draw() shall be called automatically</span>
<span class="sd">        a4          bool</span>
<span class="sd">            Flag indicating whether the figure should be a4 size (for printing or saving as pdf for example)</span>
<span class="sd">        Test        bool</span>
<span class="sd">            Flag indicating whether the inputs should be tested for conformity</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        La          list or plt.Axes</span>
<span class="sd">            Handles of the axes used for plotting (list if several axes where used)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_tfg_p</span><span class="o">.</span><span class="n">LApert_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Lax</span><span class="o">=</span><span class="n">Lax</span><span class="p">,</span> <span class="n">Proj</span><span class="o">=</span><span class="n">Proj</span><span class="p">,</span> <span class="n">Elt</span><span class="o">=</span><span class="n">Elt</span><span class="p">,</span> <span class="n">EltVes</span><span class="o">=</span><span class="n">EltVes</span><span class="p">,</span> <span class="n">Leg</span><span class="o">=</span><span class="n">Leg</span><span class="p">,</span> <span class="n">LVIn</span><span class="o">=</span><span class="n">LVIn</span><span class="p">,</span> <span class="n">Pdict</span><span class="o">=</span><span class="n">Pdict</span><span class="p">,</span> <span class="n">Vdict</span><span class="o">=</span><span class="n">Vdict</span><span class="p">,</span> <span class="n">Vesdict</span><span class="o">=</span><span class="n">Vesdict</span><span class="p">,</span> <span class="n">LegDict</span><span class="o">=</span><span class="n">LegDict</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="n">draw</span><span class="p">,</span> <span class="n">a4</span><span class="o">=</span><span class="n">a4</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="n">Test</span><span class="p">)</span></div>


<div class="viewcode-block" id="Apert.save"><a class="viewcode-back" href="../../../Auto_tofu.geom.html#tofu.geom.Apert.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">SaveName</span><span class="o">=</span><span class="k">None</span><span class="p">,</span><span class="n">Path</span><span class="o">=</span><span class="k">None</span><span class="p">,</span><span class="n">Mode</span><span class="o">=</span><span class="s">&#39;npz&#39;</span><span class="p">,</span> <span class="n">compressed</span><span class="o">=</span><span class="k">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Save the object in folder Name, under file name SaveName, using specified mode</span>

<span class="sd">        Most tofu objects can be saved automatically as numpy arrays (.npz, recommended) at the default location (recommended) by simply calling self.save()</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        SaveName :  None / str</span>
<span class="sd">            The name to be used for the saved file, if None (recommended) uses self.Id.SaveName</span>
<span class="sd">        Path :      None / str</span>
<span class="sd">            Path specifying where to save the file, if None (recommended) uses self.Id.SavePath</span>
<span class="sd">        Mode :      str</span>
<span class="sd">            Flag specifying whether to save the object as a numpy array file (&#39;.npz&#39;, recommended) or an object using cPickle (not recommended, heavier and may cause retro-compatibility issues)</span>
<span class="sd">        compressed :    bool</span>
<span class="sd">            Flag, used when Mode=&#39;npz&#39;, indicating whether to use np.savez or np.savez_compressed (slower saving and loading but smaller files)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tfpf</span><span class="o">.</span><span class="n">Save_Generic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">SaveName</span><span class="o">=</span><span class="n">SaveName</span><span class="p">,</span> <span class="n">Path</span><span class="o">=</span><span class="n">Path</span><span class="p">,</span> <span class="n">Mode</span><span class="o">=</span><span class="n">Mode</span><span class="p">,</span> <span class="n">compressed</span><span class="o">=</span><span class="n">compressed</span><span class="p">)</span></div></div>



<span class="k">def</span> <span class="nf">_Apert_check_inputs</span><span class="p">(</span><span class="n">Id</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Poly</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Vess</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Diag</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">arrayorder</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Clock</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">dtime</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">dtimeIn</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">Id</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">Id</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">tfpf</span><span class="o">.</span><span class="n">ID</span><span class="p">],</span> <span class="s">&quot;Arg Id must be a str or a tfpf.ID object !&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">Poly</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">Poly</span><span class="p">,</span><span class="s">&#39;__getitem__&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">Poly</span><span class="p">)</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">2</span> <span class="ow">and</span> <span class="mi">3</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">Poly</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s">&quot;Arg Poly must be a dict or an iterable with 3D cartesian coordinates of points !&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">Vess</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">Vess</span><span class="p">)</span> <span class="ow">is</span> <span class="n">Ves</span><span class="p">,</span> <span class="s">&quot;Arg Ves must be a Ves instance !&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Exp</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">Exp</span><span class="o">==</span><span class="n">Vess</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Exp</span><span class="p">,</span> <span class="s">&quot;Arg Exp must be the same as the Ves.Id.Exp !&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">arrayorder</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">arrayorder</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;C&#39;</span><span class="p">,</span><span class="s">&#39;F&#39;</span><span class="p">],</span> <span class="s">&quot;Arg arrayorder must be in [&#39;C&#39;,&#39;F&#39;] !&quot;</span>
    <span class="n">bools</span> <span class="o">=</span> <span class="p">[</span><span class="n">Clock</span><span class="p">,</span><span class="n">dtimeIn</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="ow">not</span> <span class="n">aa</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">bools</span><span class="p">]):</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">aa</span> <span class="ow">is</span> <span class="k">None</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">aa</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">bool</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">bools</span><span class="p">]),</span> <span class="s">&quot; Args [CalcEtend,CalcSpanImp,CalcCone,CalcPreComp,Calc,Verb,Clock,dtimeIn] must all be bool !&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">Exp</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">Exp</span> <span class="ow">in</span> <span class="n">tfd</span><span class="o">.</span><span class="n">AllowedExp</span><span class="p">,</span> <span class="s">&quot;Arg Exp must be in &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">AllowedExp</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; !&quot;</span>
    <span class="k">assert</span> <span class="n">Type</span> <span class="ow">is</span> <span class="k">None</span><span class="p">,</span> <span class="s">&quot;Arg Type must be None for Apert objects !&quot;</span>
    <span class="n">strs</span> <span class="o">=</span> <span class="p">[</span><span class="n">Diag</span><span class="p">,</span><span class="n">SavePath</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="ow">not</span> <span class="n">aa</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">strs</span><span class="p">]):</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">aa</span> <span class="ow">is</span> <span class="k">None</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">aa</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">strs</span><span class="p">]),</span> <span class="s">&quot;Args [Type,Exp,Diag,SavePath] must all be str !&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">shot</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">shot</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">,</span> <span class="s">&quot;Arg shot must be a int !&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">dtime</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">dtime</span><span class="p">)</span> <span class="ow">is</span> <span class="n">dtm</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="s">&quot;Arg dtime must be a dtm.datetime !&quot;</span>




<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">###############################################################################</span>
<span class="sd">###############################################################################</span>
<span class="sd">                   Detector and GDetect classes and functions</span>
<span class="sd">###############################################################################</span>
<span class="sd">&quot;&quot;&quot;</span>




<div class="viewcode-block" id="Detect"><a class="viewcode-back" href="../../../Auto_tofu.geom.html#tofu.geom.Detect">[docs]</a><span class="k">class</span> <span class="nc">Detect</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; A Detector class with all geometrical data and built-in methods, defined as a planar polygon in 3D cartesian coordinates, with optional aperture objects</span>

<span class="sd">    A Detect object is at the core of tofu&#39;s added value and is mostly defined by a 3D planar polygon of any non self-intersecting shape representing the active surface of a detector.</span>
<span class="sd">    It can then be associated to optics (a :class:`Lens` or a list of :class:`Apert` objects) and to a :class:`~tofu.geom.Ves` to automatically compute a natural :class:&#39;LOS&#39; (with its etendue) and, most importantly, a proper VOS (that can be discretized for 3D numerical integration).</span>
<span class="sd">    It can be 2 different types: either &#39;Circ&#39; if it is associated to a :class:`Lens` (in which case it is simply defined by radius and is assumed to be circular and placed at the focal plane of the :class:`Lens` object), or None in the more general case in which it is associated to a set of apertures.</span>
<span class="sd">    Most of the commonly used quantities are automatically calculated (etendue of the LOS, VOS...) and it comes with built-in methods for plotting and computing synthetic data.</span>

<span class="sd">    To compute the VOS, tofu tests all points inside a 3D grid to see if each point is visible from the detector through the apertures or not.</span>
<span class="sd">    The meshed space is determined by the volume spanned by a LOS sampling of the VOS.</span>
<span class="sd">    Then, a contour function is used to find the polygons limiting the cross-section and horizontal projections of the VOS.</span>
<span class="sd">    Once computed, the viewing cones are assigned to attributes of the Detect instance.</span>

<span class="sd">    In the particular case (1) when the LOS of the detector lies entirely inside one cross-section (e.g.: tomography diagnostics), tofu also computes the integral in the direction of the ignorable coordinate of the solid angle on a regular mesh (for faster computation of the geometry assuming toroidaly invariant basis functions).</span>
<span class="sd">    This regular mesh is defined in 2D, by the distance between a mesh point and the detector (k) and by the poloidal angle between the LOS and the line going from the detector to the mesh point (psi)</span>


<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    Id :                str or tfpf.ID</span>
<span class="sd">        A name string or a pre-built tfpf.ID class to be used to identify this particular instance, if a string is provided, it is fed to tfpf.ID()</span>
<span class="sd">    Poly :              dict or np.ndarray</span>
<span class="sd">        Contains the information regarding the geometry of the Detect object</span>
<span class="sd">            * np.ndarray: (2,N) or (N,2) defining the contour of the detector active surface in 3D (X,Y,Z) cartesian coordinates, if not closed, will be closed automatically, if Type=None</span>
<span class="sd">            * dict: dictionary of properties for a circular detector placed in the focal plane of a Lens on its axis, contains field &#39;Rad&#39;=float (radius), if Optics is Lens and Type=&#39;Circ&#39;</span>
<span class="sd">    Optics :            list or Lens</span>
<span class="sd">        The optics to be associated to the detector, either a spherical :class:`~tofu.geom.Lens` or a list of apertures :class:`~tofu.geom.Apert`</span>
<span class="sd">    Ves :               :class:`~tofu.geom.Ves` or None</span>
<span class="sd">        :class:`~tofu.geom.Ves` object to which the detector is assigned</span>
<span class="sd">    Sino_RefPt :        np.ndarray or None</span>
<span class="sd">        Array of size=2 containing the (R,Z) (for &#39;Tor&#39; Type) or (Y,Z) (for &#39;Lin&#39; Type) coordinates of the reference point for the sinogram</span>
<span class="sd">    CalcEtend :         bool</span>
<span class="sd">        Flag indicating whether to compute the etendue</span>
<span class="sd">    CalcSpanImp :       bool</span>
<span class="sd">        Flag indicating whether to compute the maximal span of the viewing volume</span>
<span class="sd">    CalcCone :          bool</span>
<span class="sd">        Flag indicating whether to compute the viewing volume or viewing cone and its two projections</span>
<span class="sd">    CalcPreComp :       bool</span>
<span class="sd">        Flag indicating whether to pre-compute a set of pre-defined points inside the viewing volume for faster computation of signal from 3D emissivity</span>
<span class="sd">    Calc :              bool</span>
<span class="sd">        Flag indicating whether to compute all the above</span>
<span class="sd">    Verb :              bool</span>
<span class="sd">        Flag indicating whether the creation of the object should be verbose (comments for each step)</span>

<span class="sd">    Etend_Method :      str</span>
<span class="sd">        Flag indicating which numerical integration to use for the computation of the etendue (picked from scipy.integrate : &#39;quad&#39;, &#39;simps&#39;, &#39;trapz&#39;)</span>
<span class="sd">    Etend_RelErr :      float</span>
<span class="sd">        If Etend_Method=&#39;quad&#39;, specifies the maximum relative error to be tolerated on the value of the integral (i.e.: etendue)</span>
<span class="sd">    Etend_dX12 :        list</span>
<span class="sd">        If Etend_Method in [&#39;simps&#39;,&#39;trapz&#39;], which implies a discretization of the plane perpendicular to the LOS, specifies the resolution of the discretization</span>
<span class="sd">    Etend_dX12Mode :    str</span>
<span class="sd">        If Etend_Method in [&#39;simps&#39;,&#39;trapz&#39;], specifies whether Etend_dX12 should be iunderstood as an absolute distance (&#39;abs&#39;) or a fraction of the maximum width (&#39;rel&#39;)</span>
<span class="sd">    Etend_Ratio :       float</span>
<span class="sd">        The numerical integration is performed on an automatically-deterimned interval, this ratio (fraction of unity) is a safety margin to increase a bit the interval and make sure all non-zero values are included</span>
<span class="sd">    Colis :             bool</span>
<span class="sd">        Flag indicating whether the collision detection mechanism should be considered when computing the VOS</span>
<span class="sd">    LOSRef :            str</span>
<span class="sd">        Key indicating which of the :class:`~tofu.geom.LOS` in the LOS dictionary should be considered as the reference LOS</span>
<span class="sd">    Cone_DRY :          float</span>
<span class="sd">        Resolution of the grid in the R (for &#39;Tor&#39; vessel types) or Y (for &#39;Lin&#39; vessel types) direction, in meters</span>
<span class="sd">    Cone_DXTheta :      float</span>
<span class="sd">        Resolution of the grid in the toroidal (for &#39;Tor&#39; vessel types, in radians) or X (for &#39;Lin&#39; vessel types, in meters) direction</span>
<span class="sd">    Cone_DZ :           float</span>
<span class="sd">        Resolution of the grid in the Z direction, in meters</span>
<span class="sd">    Cone_NPsi :         int</span>
<span class="sd">        Number of points of the regular mesh in psi direction (angle), in case (1)</span>
<span class="sd">    Cone_Nk :           bool</span>
<span class="sd">        Flag indicating whether the inputs should be tested for conformity</span>

<span class="sd">    Type :              None / str</span>
<span class="sd">        If the detector is associated to a :class:`~tofu.geom.Lens`, it should be of type &#39;Circ&#39; (only circular shaped detectors are handled by tofu behind spherical lenses)</span>
<span class="sd">    Exp :               None or str</span>
<span class="sd">        Experiment to which the Lens belongs, should be identical to Ves.Id.Exp if Ves is provided, if None and Ves is provided, Ves.Id.Exp is used</span>
<span class="sd">    Diag :              None or str</span>
<span class="sd">        Diagnostic to which the Lens belongs</span>
<span class="sd">    shot :              None or int</span>
<span class="sd">        Shot number from which this Lens is usable (in case its position was changed from a previous configuration)</span>
<span class="sd">    SavePath :          None / str</span>
<span class="sd">        If provided, forces the default saving path of the object to the provided value</span>
<span class="sd">    Clock :             bool</span>
<span class="sd">        Flag indicating whether the input polygon should be made clockwise (True) or counter-clockwise (False), default: False</span>
<span class="sd">    arrayorder :        str</span>
<span class="sd">        Flag indicating whether the attributes of type=np.ndarray (e.g.: Poly) should be made C-contiguous (&#39;C&#39;) or Fortran-contiguous (&#39;F&#39;), default: &#39;C&#39;</span>
<span class="sd">    dtime :         None or dtm.datetime</span>
<span class="sd">        A time reference to be used to identify this particular instance (used for debugging mostly)</span>
<span class="sd">    dtimeIn :       bool</span>
<span class="sd">        Flag indicating whether dtime should be included in the SaveName (used for debugging mostly)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="n">Poly</span><span class="p">,</span> <span class="n">Optics</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Ves</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Sino_RefPt</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">CalcEtend</span><span class="o">=</span><span class="k">True</span><span class="p">,</span> <span class="n">CalcSpanImp</span><span class="o">=</span><span class="k">True</span><span class="p">,</span> <span class="n">CalcCone</span><span class="o">=</span><span class="k">True</span><span class="p">,</span> <span class="n">CalcPreComp</span><span class="o">=</span><span class="k">True</span><span class="p">,</span> <span class="n">Calc</span><span class="o">=</span><span class="k">True</span><span class="p">,</span> <span class="n">Verb</span><span class="o">=</span><span class="k">True</span><span class="p">,</span>
            <span class="n">Etend_Method</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetEtendMethod</span><span class="p">,</span> <span class="n">Etend_RelErr</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetEtendepsrel</span><span class="p">,</span> <span class="n">Etend_dX12</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetEtenddX12</span><span class="p">,</span> <span class="n">Etend_dX12Mode</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetEtenddX12Mode</span><span class="p">,</span> <span class="n">Etend_Ratio</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetEtendRatio</span><span class="p">,</span> <span class="n">Colis</span><span class="o">=</span><span class="k">True</span><span class="p">,</span> <span class="n">LOSRef</span><span class="o">=</span><span class="s">&#39;Cart&#39;</span><span class="p">,</span>
            <span class="n">Cone_DRY</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetConeDRY</span><span class="p">,</span> <span class="n">Cone_DXTheta</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Cone_DZ</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetConeDZ</span><span class="p">,</span> <span class="n">Cone_NPsi</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">Cone_Nk</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
            <span class="n">arrayorder</span><span class="o">=</span><span class="s">&#39;C&#39;</span><span class="p">,</span> <span class="n">Clock</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Diag</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">dtime</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">dtimeIn</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_Done</span> <span class="o">=</span> <span class="k">False</span>
        <span class="n">tfpf</span><span class="o">.</span><span class="n">_check_NotNone</span><span class="p">({</span><span class="s">&#39;Clock&#39;</span><span class="p">:</span><span class="n">Clock</span><span class="p">,</span><span class="s">&#39;arrayorder&#39;</span><span class="p">:</span><span class="n">arrayorder</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_inputs</span><span class="p">(</span><span class="n">Clock</span><span class="o">=</span><span class="n">Clock</span><span class="p">,</span> <span class="n">arrayorder</span><span class="o">=</span><span class="n">arrayorder</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_arrayorder</span> <span class="o">=</span> <span class="n">arrayorder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Clock</span> <span class="o">=</span> <span class="n">Clock</span>

        <span class="c"># Check consistency of Type, Exp, Diag, shot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_inputs</span><span class="p">(</span><span class="n">Poly</span><span class="o">=</span><span class="n">Poly</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="n">Type</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="n">Exp</span><span class="p">,</span> <span class="n">Diag</span><span class="o">=</span><span class="n">Diag</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="n">shot</span><span class="p">,</span> <span class="n">Ves</span><span class="o">=</span><span class="n">Ves</span><span class="p">,</span> <span class="n">Optics</span><span class="o">=</span><span class="n">Optics</span><span class="p">)</span>
        <span class="n">Poly</span><span class="p">,</span> <span class="n">Type</span><span class="p">,</span> <span class="n">Exp</span><span class="p">,</span> <span class="n">Diag</span><span class="p">,</span> <span class="n">shot</span><span class="p">,</span> <span class="n">Ves</span> <span class="o">=</span> <span class="n">_Detect_set_Defaults</span><span class="p">(</span><span class="n">Poly</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="n">Type</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="n">Exp</span><span class="p">,</span> <span class="n">Diag</span><span class="o">=</span><span class="n">Diag</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="n">shot</span><span class="p">,</span> <span class="n">Ves</span><span class="o">=</span><span class="n">Ves</span><span class="p">,</span> <span class="n">Optics</span><span class="o">=</span><span class="n">Optics</span><span class="p">)</span>

        <span class="c"># Run all computation routines</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_Id</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="n">Type</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="n">Exp</span><span class="p">,</span> <span class="n">Diag</span><span class="o">=</span><span class="n">Diag</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="n">shot</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="n">SavePath</span><span class="p">,</span> <span class="n">dtime</span><span class="o">=</span><span class="n">dtime</span><span class="p">,</span> <span class="n">dtimeIn</span><span class="o">=</span><span class="n">dtimeIn</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">Verb</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s">&quot;TFG.Detect object &quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Name</span><span class="o">+</span><span class="s">&quot; : Creating...&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_Poly</span><span class="p">(</span><span class="n">Poly</span><span class="p">,</span> <span class="n">Calc</span><span class="o">=</span><span class="k">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initAll</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_Optics</span><span class="p">(</span><span class="n">Optics</span><span class="p">,</span> <span class="n">Calc</span><span class="o">=</span><span class="k">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_Ves</span><span class="p">(</span><span class="n">Ves</span><span class="p">,</span> <span class="n">Calc</span><span class="o">=</span><span class="k">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_arrayorder</span><span class="p">(</span><span class="n">arrayorder</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">Calc</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_calc_All</span><span class="p">(</span><span class="n">Sino_RefPt</span><span class="o">=</span><span class="n">Sino_RefPt</span><span class="p">,</span> <span class="n">CalcEtend</span><span class="o">=</span><span class="n">CalcEtend</span><span class="p">,</span> <span class="n">CalcSpanImp</span><span class="o">=</span><span class="n">CalcSpanImp</span><span class="p">,</span> <span class="n">CalcCone</span><span class="o">=</span><span class="n">CalcCone</span><span class="p">,</span> <span class="n">CalcPreComp</span><span class="o">=</span><span class="n">CalcPreComp</span><span class="p">,</span> <span class="n">Verb</span><span class="o">=</span><span class="n">Verb</span><span class="p">,</span>
                    <span class="n">Etend_Method</span><span class="o">=</span><span class="n">Etend_Method</span><span class="p">,</span> <span class="n">Etend_RelErr</span><span class="o">=</span><span class="n">Etend_RelErr</span><span class="p">,</span> <span class="n">Etend_dX12</span><span class="o">=</span><span class="n">Etend_dX12</span><span class="p">,</span> <span class="n">Etend_dX12Mode</span><span class="o">=</span><span class="n">Etend_dX12Mode</span><span class="p">,</span> <span class="n">Etend_Ratio</span><span class="o">=</span><span class="n">Etend_Ratio</span><span class="p">,</span> <span class="n">LOSRef</span><span class="o">=</span><span class="n">LOSRef</span><span class="p">,</span>
                    <span class="n">Cone_DRY</span><span class="o">=</span><span class="n">Cone_DRY</span><span class="p">,</span> <span class="n">Cone_DXTheta</span><span class="o">=</span><span class="n">Cone_DXTheta</span><span class="p">,</span> <span class="n">Cone_DZ</span><span class="o">=</span><span class="n">Cone_DZ</span><span class="p">,</span>
                    <span class="n">Cone_NPsi</span><span class="o">=</span><span class="n">Cone_NPsi</span><span class="p">,</span> <span class="n">Cone_Nk</span><span class="o">=</span><span class="n">Cone_Nk</span><span class="p">,</span> <span class="n">Colis</span><span class="o">=</span><span class="n">Colis</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">Verb</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s">&quot;TFG.Detect object &quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Name</span><span class="o">+</span><span class="s">&quot; : Created !&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Done</span> <span class="o">=</span> <span class="k">True</span>



    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the associated tfpf.ID object &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Id</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Poly</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the planar polygon defining the aperture (in 3D cartesian coordinates) &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Type</span><span class="o">==</span><span class="s">&#39;Circ&#39;</span><span class="p">:</span>
            <span class="n">NP</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NP</span>
            <span class="n">thet</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="n">NP</span><span class="p">)</span>
            <span class="n">e1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">nIn</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">nIn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mf">0.</span><span class="p">])</span>
            <span class="n">e1</span> <span class="o">=</span> <span class="n">e1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">e1</span><span class="p">)</span>
            <span class="n">e2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nIn</span><span class="p">,</span><span class="n">e1</span><span class="p">)</span>
            <span class="n">Poly</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BaryS</span><span class="p">,(</span><span class="n">NP</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rad</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">thet</span><span class="p">)</span><span class="o">*</span><span class="n">e1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">thet</span><span class="p">)</span><span class="o">*</span><span class="n">e2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">thet</span><span class="p">)</span><span class="o">*</span><span class="n">e1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">thet</span><span class="p">)</span><span class="o">*</span><span class="n">e2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">thet</span><span class="p">)</span><span class="o">*</span><span class="n">e1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">thet</span><span class="p">)</span><span class="o">*</span><span class="n">e2</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span>
            <span class="n">Poly</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">Poly</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_arrayorder</span><span class="o">==</span><span class="s">&#39;C&#39;</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">asfortranarray</span><span class="p">(</span><span class="n">Poly</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">Poly</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Poly</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Rad</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the radius of the polygon (if Type=&#39;Circ&#39;, else None) &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Rad</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">NP</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the number of points defining the polygon &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_NP</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nIn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the normalized vector perpendicular to the polygon surface and oriented towards the interior of the associated vessel (in 3D cartesian coordinates) &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nIn</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">BaryS</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the (surfacic) center of mass of the polygon (in 3D cartesian coordinates) &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_BaryS</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Surf</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the area of the polygon &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Surf</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Ves</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the associated :class:`~tofu.geom.Ves` object &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Ves</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Optics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the list of associated Optics objects (:class:`Lens` or list of :class:`Apert`) &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Optics</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">OpticsNb</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the number of associated Optics &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_OpticsNb</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">OpticsType</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the type of associated Optics objects &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_OpticsType</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">LOS</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the dictionary of associated :class:`LOS` objects &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_LOS</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Sino_RefPt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the coordinates (R,Z) or (Y,Z) for Ves of Type &#39;Tor&#39; or (Y,Z) for Ves of Type &#39;Lin&#39; of the reference point used to compute the sinogram &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Sino_RefPt</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Cone_PolyCross</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the polygon that is the projection in a cross-section of the viewing cone &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Cone_PolyCrossbis</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Cone_PolyHor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the polygon that is the projection in a horizontal plane of the viewing cone &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Cone_PolyHorbis</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">SAngCross_Points</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the pre-computed points of the VOS in a cross-section projection &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SAngCross_Points</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">SAngCross_Int</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the integral of the solid angle at pre-computed points of the VOS in a cross-section projection &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SAngCross_Int</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">SAngHor_Points</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the pre-computed points of the VOS in a horizontal projection &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SAngHor_Points</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">SAngHor_Int</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the integral of the solid angle at pre-computed points of the VOS in a horizontal projection &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SAngHor_Int</span>


    <span class="k">def</span> <span class="nf">_check_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Id</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Poly</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Optics</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Ves</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Sino_RefPt</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Diag</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">CalcEtend</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">CalcSpanImp</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">CalcCone</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">CalcPreComp</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Calc</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Verb</span><span class="o">=</span><span class="k">None</span><span class="p">,</span>
        <span class="n">Etend_RelErr</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Etend_dX12</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Etend_dX12Mode</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Etend_Ratio</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Colis</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">LOSRef</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Etend_Method</span><span class="o">=</span><span class="k">None</span><span class="p">,</span>
        <span class="n">MarginRMin</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">NEdge</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">NRad</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Nk</span><span class="o">=</span><span class="k">None</span><span class="p">,</span>
        <span class="n">Cone_DRY</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Cone_DXTheta</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Cone_DZ</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Cone_NPsi</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Cone_Nk</span><span class="o">=</span><span class="k">None</span><span class="p">,</span>
        <span class="n">arrayorder</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Clock</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">dtime</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">dtimeIn</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
        <span class="n">_Detect_check_inputs</span><span class="p">(</span><span class="n">Id</span><span class="o">=</span><span class="n">Id</span><span class="p">,</span> <span class="n">Poly</span><span class="o">=</span><span class="n">Poly</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="n">Type</span><span class="p">,</span> <span class="n">Optics</span><span class="o">=</span><span class="n">Optics</span><span class="p">,</span> <span class="n">Vess</span><span class="o">=</span><span class="n">Ves</span><span class="p">,</span> <span class="n">Sino_RefPt</span><span class="o">=</span><span class="n">Sino_RefPt</span><span class="p">,</span> <span class="n">CalcEtend</span><span class="o">=</span><span class="n">CalcEtend</span><span class="p">,</span> <span class="n">CalcSpanImp</span><span class="o">=</span><span class="n">CalcSpanImp</span><span class="p">,</span> <span class="n">CalcCone</span><span class="o">=</span><span class="n">CalcCone</span><span class="p">,</span> <span class="n">CalcPreComp</span><span class="o">=</span><span class="n">CalcPreComp</span><span class="p">,</span> <span class="n">Calc</span><span class="o">=</span><span class="n">Calc</span><span class="p">,</span> <span class="n">Verb</span><span class="o">=</span><span class="n">Verb</span><span class="p">,</span>
                <span class="n">Etend_RelErr</span><span class="o">=</span><span class="n">Etend_RelErr</span><span class="p">,</span> <span class="n">Etend_dX12</span><span class="o">=</span><span class="n">Etend_dX12</span><span class="p">,</span> <span class="n">Etend_dX12Mode</span><span class="o">=</span><span class="n">Etend_dX12Mode</span><span class="p">,</span> <span class="n">Etend_Ratio</span><span class="o">=</span><span class="n">Etend_Ratio</span><span class="p">,</span> <span class="n">Colis</span><span class="o">=</span><span class="n">Colis</span><span class="p">,</span> <span class="n">LOSRef</span><span class="o">=</span><span class="n">LOSRef</span><span class="p">,</span> <span class="n">Etend_Method</span><span class="o">=</span><span class="n">Etend_Method</span><span class="p">,</span>
                <span class="n">MarginRMin</span><span class="o">=</span><span class="n">MarginRMin</span><span class="p">,</span> <span class="n">NEdge</span><span class="o">=</span><span class="n">NEdge</span><span class="p">,</span> <span class="n">NRad</span><span class="o">=</span><span class="n">NRad</span><span class="p">,</span> <span class="n">Nk</span><span class="o">=</span><span class="n">Nk</span><span class="p">,</span>
                <span class="n">Cone_DRY</span><span class="o">=</span><span class="n">Cone_DRY</span><span class="p">,</span> <span class="n">Cone_DXTheta</span><span class="o">=</span><span class="n">Cone_DXTheta</span><span class="p">,</span> <span class="n">Cone_DZ</span><span class="o">=</span><span class="n">Cone_DZ</span><span class="p">,</span> <span class="n">Cone_NPsi</span><span class="o">=</span><span class="n">Cone_NPsi</span><span class="p">,</span> <span class="n">Cone_Nk</span><span class="o">=</span><span class="n">Cone_Nk</span><span class="p">,</span>
                <span class="n">arrayorder</span><span class="o">=</span><span class="n">arrayorder</span><span class="p">,</span> <span class="n">Clock</span><span class="o">=</span><span class="n">Clock</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="n">Exp</span><span class="p">,</span> <span class="n">Diag</span><span class="o">=</span><span class="n">Diag</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="n">shot</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="n">SavePath</span><span class="p">,</span> <span class="n">dtime</span><span class="o">=</span><span class="n">dtime</span><span class="p">,</span> <span class="n">dtimeIn</span><span class="o">=</span><span class="n">dtimeIn</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_Id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Val</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Diag</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">dtime</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">dtimeIn</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Done</span><span class="p">:</span>
            <span class="n">Out</span> <span class="o">=</span> <span class="n">tfpf</span><span class="o">.</span><span class="n">_get_FromItself</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;Type&#39;</span><span class="p">:</span><span class="n">Type</span><span class="p">,</span> <span class="s">&#39;Exp&#39;</span><span class="p">:</span><span class="n">Exp</span><span class="p">,</span> <span class="s">&#39;shot&#39;</span><span class="p">:</span><span class="n">shot</span><span class="p">,</span> <span class="s">&#39;Diag&#39;</span><span class="p">:</span><span class="n">Diag</span><span class="p">,</span> <span class="s">&#39;dtime&#39;</span><span class="p">:</span><span class="n">dtime</span><span class="p">,</span> <span class="s">&#39;_dtimeIn&#39;</span><span class="p">:</span><span class="n">dtimeIn</span><span class="p">,</span> <span class="s">&#39;SavePath&#39;</span><span class="p">:</span><span class="n">SavePath</span><span class="p">})</span>
            <span class="n">Type</span><span class="p">,</span> <span class="n">Exp</span><span class="p">,</span> <span class="n">shot</span><span class="p">,</span> <span class="n">Diag</span><span class="p">,</span> <span class="n">dtime</span><span class="p">,</span> <span class="n">dtimeIn</span><span class="p">,</span> <span class="n">SavePath</span> <span class="o">=</span> <span class="n">Out</span><span class="p">[</span><span class="s">&#39;Type&#39;</span><span class="p">],</span> <span class="n">Out</span><span class="p">[</span><span class="s">&#39;Exp&#39;</span><span class="p">],</span> <span class="n">Out</span><span class="p">[</span><span class="s">&#39;shot&#39;</span><span class="p">],</span> <span class="n">Out</span><span class="p">[</span><span class="s">&#39;Diag&#39;</span><span class="p">],</span> <span class="n">Out</span><span class="p">[</span><span class="s">&#39;dtime&#39;</span><span class="p">],</span> <span class="n">Out</span><span class="p">[</span><span class="s">&#39;dtimeIn&#39;</span><span class="p">],</span> <span class="n">Out</span><span class="p">[</span><span class="s">&#39;SavePath&#39;</span><span class="p">]</span>
        <span class="n">tfpf</span><span class="o">.</span><span class="n">_check_NotNone</span><span class="p">({</span><span class="s">&#39;Id&#39;</span><span class="p">:</span><span class="n">Val</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_inputs</span><span class="p">(</span><span class="n">Id</span><span class="o">=</span><span class="n">Val</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">Val</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">tfpf</span><span class="o">.</span><span class="n">_check_NotNone</span><span class="p">({</span><span class="s">&#39;Exp&#39;</span><span class="p">:</span><span class="n">Exp</span><span class="p">,</span> <span class="s">&#39;shot&#39;</span><span class="p">:</span><span class="n">shot</span><span class="p">,</span> <span class="s">&#39;Diag&#39;</span><span class="p">:</span><span class="n">Diag</span><span class="p">,</span> <span class="s">&#39;dtimeIn&#39;</span><span class="p">:</span><span class="n">dtimeIn</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_inputs</span><span class="p">(</span><span class="n">Type</span><span class="o">=</span><span class="n">Type</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="n">Exp</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="n">shot</span><span class="p">,</span> <span class="n">Diag</span><span class="o">=</span><span class="n">Diag</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="n">SavePath</span><span class="p">,</span> <span class="n">dtime</span><span class="o">=</span><span class="n">dtime</span><span class="p">,</span> <span class="n">dtimeIn</span><span class="o">=</span><span class="n">dtimeIn</span><span class="p">)</span>
            <span class="n">Val</span> <span class="o">=</span> <span class="n">tfpf</span><span class="o">.</span><span class="n">ID</span><span class="p">(</span><span class="s">&#39;Detect&#39;</span><span class="p">,</span> <span class="n">Val</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="n">Type</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="n">Exp</span><span class="p">,</span> <span class="n">Diag</span><span class="o">=</span><span class="n">Diag</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="n">shot</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="n">SavePath</span><span class="p">,</span> <span class="n">dtime</span><span class="o">=</span><span class="n">dtime</span><span class="p">,</span> <span class="n">dtimeIn</span><span class="o">=</span><span class="n">dtimeIn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Id</span> <span class="o">=</span> <span class="n">Val</span>

    <span class="k">def</span> <span class="nf">_set_Poly</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Poly</span><span class="p">,</span> <span class="n">Calc</span><span class="o">=</span><span class="k">True</span><span class="p">,</span> <span class="n">CalcEtend</span><span class="o">=</span><span class="k">True</span><span class="p">,</span> <span class="n">CalcSpanImp</span><span class="o">=</span><span class="k">True</span><span class="p">,</span> <span class="n">CalcCone</span><span class="o">=</span><span class="k">True</span><span class="p">,</span> <span class="n">CalcPreComp</span><span class="o">=</span><span class="k">True</span><span class="p">,</span> <span class="n">NPDef</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
        <span class="n">tfpf</span><span class="o">.</span><span class="n">_check_NotNone</span><span class="p">({</span><span class="s">&#39;Poly&#39;</span><span class="p">:</span><span class="n">Poly</span><span class="p">})</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Done</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">OpticsType</span><span class="o">==</span><span class="s">&#39;Lens&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_inputs</span><span class="p">(</span><span class="n">Poly</span><span class="o">=</span><span class="n">Poly</span><span class="p">,</span> <span class="n">Optics</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Optics</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Calc</span><span class="o">=</span><span class="n">Calc</span><span class="p">,</span> <span class="n">CalcEtend</span><span class="o">=</span><span class="n">CalcEtend</span><span class="p">,</span> <span class="n">CalcSpanImp</span><span class="o">=</span><span class="n">CalcSpanImp</span><span class="p">,</span> <span class="n">CalcCone</span><span class="o">=</span><span class="n">CalcCone</span><span class="p">,</span> <span class="n">CalcPreComp</span><span class="o">=</span><span class="n">CalcPreComp</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_inputs</span><span class="p">(</span><span class="n">Poly</span><span class="o">=</span><span class="n">Poly</span><span class="p">,</span> <span class="n">Calc</span><span class="o">=</span><span class="n">Calc</span><span class="p">,</span> <span class="n">CalcEtend</span><span class="o">=</span><span class="n">CalcEtend</span><span class="p">,</span> <span class="n">CalcSpanImp</span><span class="o">=</span><span class="n">CalcSpanImp</span><span class="p">,</span> <span class="n">CalcCone</span><span class="o">=</span><span class="n">CalcCone</span><span class="p">,</span> <span class="n">CalcPreComp</span><span class="o">=</span><span class="n">CalcPreComp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Poly</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_NP</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nIn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_BaryP</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Surf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_BaryS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Rad</span> <span class="o">=</span>  <span class="n">_tfg_c</span><span class="o">.</span><span class="n">_ApDetect_set_Poly</span><span class="p">(</span><span class="n">Poly</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Type</span><span class="p">,</span> <span class="n">arrayorder</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_arrayorder</span><span class="p">,</span> <span class="n">Clock</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_Clock</span><span class="p">,</span> <span class="n">NP</span><span class="o">=</span><span class="n">NPDef</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Surf</span><span class="o">&gt;</span><span class="mf">0.</span><span class="p">,</span> <span class="s">&quot;Input Poly has 0 area !&quot;</span>
        <span class="k">if</span> <span class="n">Calc</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_calc_All</span><span class="p">(</span><span class="n">CalcEtend</span><span class="o">=</span><span class="n">CalcEtend</span><span class="p">,</span> <span class="n">CalcSpanImp</span><span class="o">=</span><span class="n">CalcSpanImp</span><span class="p">,</span> <span class="n">CalcCone</span><span class="o">=</span><span class="n">CalcCone</span><span class="p">,</span> <span class="n">CalcPreComp</span><span class="o">=</span><span class="n">CalcPreComp</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_initAll</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Ves</span> <span class="o">=</span> <span class="k">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Optics</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nOptics</span> <span class="o">=</span> <span class="k">None</span><span class="p">,</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_SAngPlane</span> <span class="o">=</span> <span class="k">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_LOS_ApertPolyInt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_LOS_ApertPolyInt_S</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_LOS_ApertPolyInt_BaryS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_LOS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_TorAngRef</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_LOS_NP</span> <span class="o">=</span> <span class="k">None</span><span class="p">,</span> <span class="k">None</span><span class="p">,</span> <span class="k">None</span><span class="p">,</span> <span class="k">None</span><span class="p">,</span> <span class="k">None</span><span class="p">,</span> <span class="k">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Sino_RefPt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Sino_CrossProj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_LOSRef</span> <span class="o">=</span>  <span class="k">None</span><span class="p">,</span> <span class="k">None</span><span class="p">,</span> <span class="k">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Span_R</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Span_Theta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Span_X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Span_Y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Span_Z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Span_k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Span_NEdge</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Span_NRad</span> <span class="o">=</span> <span class="k">None</span><span class="p">,</span> <span class="k">None</span><span class="p">,</span> <span class="k">None</span><span class="p">,</span> <span class="k">None</span><span class="p">,</span> <span class="k">None</span><span class="p">,</span> <span class="k">None</span><span class="p">,</span> <span class="k">None</span><span class="p">,</span> <span class="k">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Cone_PolyCross</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Cone_PolyHor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Cone_PolyCrossbis</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Cone_PolyHorbis</span> <span class="o">=</span> <span class="k">None</span><span class="p">,</span> <span class="k">None</span><span class="p">,</span> <span class="k">None</span><span class="p">,</span> <span class="k">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Cone_Poly_DR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Cone_Poly_DZ</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Cone_Poly_DTheta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Cone_Poly_NEdge</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Cone_Poly_NRad</span> <span class="o">=</span> <span class="k">None</span><span class="p">,</span> <span class="k">None</span><span class="p">,</span> <span class="k">None</span><span class="p">,</span> <span class="k">None</span><span class="p">,</span> <span class="k">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Cone_PolyCross_RefLCorners</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Cone_PolyCross_RefLBary</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Cone_PolyCross_RefdMax</span> <span class="o">=</span> <span class="k">None</span><span class="p">,</span> <span class="k">None</span><span class="p">,</span> <span class="k">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Cone_PolyHor_RefLCorners</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Cone_PolyHor_RefLBary</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Cone_PolyHor_RefdMax</span> <span class="o">=</span> <span class="k">None</span><span class="p">,</span> <span class="k">None</span><span class="p">,</span> <span class="k">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_SAngCross_Points</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SAngHor_Points</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SAngCross_Max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SAngHor_Max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SAngCross_Int</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SAngHor_Int</span> <span class="o">=</span> <span class="k">None</span><span class="p">,</span> <span class="k">None</span><span class="p">,</span> <span class="k">None</span><span class="p">,</span> <span class="k">None</span><span class="p">,</span> <span class="k">None</span><span class="p">,</span> <span class="k">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_SAngCross_Reg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SAngCross_Reg_K</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SAngCross_Reg_Psi</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SAngCross_Reg_Int</span> <span class="o">=</span> <span class="k">False</span><span class="p">,</span> <span class="k">None</span><span class="p">,</span> <span class="k">None</span><span class="p">,</span> <span class="k">None</span>
        <span class="c"># Parameters of Synthetic diagnostics</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_SynthDiag_Done</span> <span class="o">=</span> <span class="k">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_SynthDiag_ds</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SynthDiag_dsMode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SynthDiag_MarginS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SynthDiag_dX12</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SynthDiag_dX12Mode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SynthDiag_Colis</span> <span class="o">=</span> <span class="k">None</span><span class="p">,</span> <span class="k">None</span><span class="p">,</span> <span class="k">None</span><span class="p">,</span> <span class="k">None</span><span class="p">,</span> <span class="k">None</span><span class="p">,</span> <span class="k">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reset_SynthDiag</span><span class="p">()</span>
        <span class="c"># Parameters of Resolution computing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reset_Res</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_set_Optics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Optics</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Calc</span><span class="o">=</span><span class="k">True</span><span class="p">,</span> <span class="n">CalcEtend</span><span class="o">=</span><span class="k">True</span><span class="p">,</span> <span class="n">CalcSpanImp</span><span class="o">=</span><span class="k">True</span><span class="p">,</span> <span class="n">CalcCone</span><span class="o">=</span><span class="k">True</span><span class="p">,</span> <span class="n">CalcPreComp</span><span class="o">=</span><span class="k">True</span><span class="p">):</span>
        <span class="n">Polytemp</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;Rad&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">Rad</span><span class="p">}</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Type</span><span class="o">==</span><span class="s">&#39;Circ&#39;</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">Poly</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_inputs</span><span class="p">(</span><span class="n">Poly</span><span class="o">=</span><span class="n">Polytemp</span><span class="p">,</span> <span class="n">Optics</span><span class="o">=</span><span class="n">Optics</span><span class="p">,</span> <span class="n">Calc</span><span class="o">=</span><span class="n">Calc</span><span class="p">,</span> <span class="n">CalcEtend</span><span class="o">=</span><span class="n">CalcEtend</span><span class="p">,</span> <span class="n">CalcSpanImp</span><span class="o">=</span><span class="n">CalcSpanImp</span><span class="p">,</span> <span class="n">CalcCone</span><span class="o">=</span><span class="n">CalcCone</span><span class="p">,</span> <span class="n">CalcPreComp</span><span class="o">=</span><span class="n">CalcPreComp</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Optics</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="n">Optics</span> <span class="o">=</span> <span class="n">Optics</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">Optics</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span> <span class="k">else</span> <span class="p">[</span><span class="n">Optics</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_Optics</span> <span class="o">=</span> <span class="n">Optics</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_OpticsNb</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Optics</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_OpticsType</span> <span class="o">=</span> <span class="s">&quot;Lens&quot;</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">Optics</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">is</span> <span class="n">Lens</span> <span class="k">else</span> <span class="s">&quot;Apert&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">set_LObj</span><span class="p">([</span><span class="n">aa</span><span class="o">.</span><span class="n">Id</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">Optics</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_Optics_Lens_Cone</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">Calc</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_calc_All</span><span class="p">(</span><span class="n">CalcEtend</span><span class="o">=</span><span class="n">CalcEtend</span><span class="p">,</span> <span class="n">CalcSpanImp</span><span class="o">=</span><span class="n">CalcSpanImp</span><span class="p">,</span> <span class="n">CalcCone</span><span class="o">=</span><span class="n">CalcCone</span><span class="p">,</span> <span class="n">CalcPreComp</span><span class="o">=</span><span class="n">CalcPreComp</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_Optics_Lens_Cone</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">OpticsType</span> <span class="o">==</span> <span class="s">&quot;Lens&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_Optics_Lens_ConeHalfAng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Rad</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Optics</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">F1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_Optics_Lens_ConeTip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Optics</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">O</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">Optics</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">nIn</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Optics</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Rad</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Optics</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">F1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rad</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_Optics_Lens_ConeTip</span> <span class="o">=</span> <span class="k">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_Optics_Lens_ConeHalfAng</span> <span class="o">=</span> <span class="k">None</span>


    <span class="k">def</span> <span class="nf">_set_Ves</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Ves</span><span class="p">,</span> <span class="n">Calc</span><span class="o">=</span><span class="k">True</span><span class="p">,</span> <span class="n">CalcEtend</span><span class="o">=</span><span class="k">True</span><span class="p">,</span> <span class="n">CalcSpanImp</span><span class="o">=</span><span class="k">True</span><span class="p">,</span> <span class="n">CalcCone</span><span class="o">=</span><span class="k">True</span><span class="p">,</span> <span class="n">CalcPreComp</span><span class="o">=</span><span class="k">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_inputs</span><span class="p">(</span><span class="n">Ves</span><span class="o">=</span><span class="n">Ves</span><span class="p">,</span> <span class="n">Calc</span><span class="o">=</span><span class="n">Calc</span><span class="p">,</span> <span class="n">CalcEtend</span><span class="o">=</span><span class="n">CalcEtend</span><span class="p">,</span> <span class="n">CalcSpanImp</span><span class="o">=</span><span class="n">CalcSpanImp</span><span class="p">,</span> <span class="n">CalcCone</span><span class="o">=</span><span class="n">CalcCone</span><span class="p">,</span> <span class="n">CalcPreComp</span><span class="o">=</span><span class="n">CalcPreComp</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Ves</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_Ves</span> <span class="o">=</span> <span class="n">Ves</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">set_LObj</span><span class="p">([</span><span class="n">Ves</span><span class="o">.</span><span class="n">Id</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">Ves</span><span class="o">.</span><span class="n">Type</span><span class="o">==</span><span class="s">&#39;Tor&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_nIn</span> <span class="o">=</span> <span class="n">_tfg_c</span><span class="o">.</span><span class="n">Calc_nInFromTor_Poly</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BaryS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nIn</span><span class="p">,</span> <span class="n">Ves</span><span class="o">.</span><span class="n">BaryS</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">Ves</span><span class="o">.</span><span class="n">Type</span><span class="o">==</span><span class="s">&#39;Lin&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_nIn</span> <span class="o">=</span> <span class="n">_tfg_c</span><span class="o">.</span><span class="n">Calc_nInFromLin_Poly</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BaryS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nIn</span><span class="p">,</span> <span class="n">Ves</span><span class="o">.</span><span class="n">BaryS</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">Calc</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_calc_All</span><span class="p">(</span><span class="n">CalcEtend</span><span class="o">=</span><span class="n">CalcEtend</span><span class="p">,</span> <span class="n">CalcSpanImp</span><span class="o">=</span><span class="n">CalcSpanImp</span><span class="p">,</span> <span class="n">CalcCone</span><span class="o">=</span><span class="n">CalcCone</span><span class="p">,</span> <span class="n">CalcPreComp</span><span class="o">=</span><span class="n">CalcPreComp</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_arrayorder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arrayorder</span><span class="p">):</span>
        <span class="n">tfpf</span><span class="o">.</span><span class="n">_set_arrayorder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arrayorder</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_calc_All</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Sino_RefPt</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">CalcEtend</span><span class="o">=</span><span class="k">True</span><span class="p">,</span> <span class="n">CalcSpanImp</span><span class="o">=</span><span class="k">True</span><span class="p">,</span> <span class="n">CalcCone</span><span class="o">=</span><span class="k">True</span><span class="p">,</span> <span class="n">CalcPreComp</span><span class="o">=</span><span class="k">True</span><span class="p">,</span>
            <span class="n">Etend_Method</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetEtendMethod</span><span class="p">,</span> <span class="n">Etend_RelErr</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetEtendepsrel</span><span class="p">,</span> <span class="n">Etend_dX12</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetEtenddX12</span><span class="p">,</span> <span class="n">Etend_dX12Mode</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetEtenddX12Mode</span><span class="p">,</span> <span class="n">Etend_Ratio</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetEtendRatio</span><span class="p">,</span> <span class="n">Colis</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetCalcEtendColis</span><span class="p">,</span> <span class="n">LOSRef</span><span class="o">=</span><span class="s">&#39;Cart&#39;</span><span class="p">,</span>
            <span class="n">Cone_DRY</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetConeDRY</span><span class="p">,</span> <span class="n">Cone_DXTheta</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Cone_DZ</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetConeDZ</span><span class="p">,</span> <span class="n">Cone_NPsi</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">Cone_Nk</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">Verb</span><span class="o">=</span><span class="k">True</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_check_inputs</span><span class="p">(</span><span class="n">Sino_RefPt</span><span class="o">=</span><span class="n">Sino_RefPt</span><span class="p">,</span> <span class="n">CalcEtend</span><span class="o">=</span><span class="n">CalcEtend</span><span class="p">,</span> <span class="n">CalcSpanImp</span><span class="o">=</span><span class="n">CalcSpanImp</span><span class="p">,</span> <span class="n">CalcCone</span><span class="o">=</span><span class="n">CalcCone</span><span class="p">,</span> <span class="n">CalcPreComp</span><span class="o">=</span><span class="n">CalcPreComp</span><span class="p">,</span>
                <span class="n">Etend_Method</span><span class="o">=</span><span class="n">Etend_Method</span><span class="p">,</span> <span class="n">Etend_RelErr</span><span class="o">=</span><span class="n">Etend_RelErr</span><span class="p">,</span> <span class="n">Etend_dX12</span><span class="o">=</span><span class="n">Etend_dX12</span><span class="p">,</span> <span class="n">Etend_dX12Mode</span><span class="o">=</span><span class="n">Etend_dX12Mode</span><span class="p">,</span> <span class="n">Etend_Ratio</span><span class="o">=</span><span class="n">Etend_Ratio</span><span class="p">,</span> <span class="n">LOSRef</span><span class="o">=</span><span class="n">LOSRef</span><span class="p">,</span>
                <span class="n">Cone_DRY</span><span class="o">=</span><span class="n">Cone_DRY</span><span class="p">,</span> <span class="n">Cone_DXTheta</span><span class="o">=</span><span class="n">Cone_DXTheta</span><span class="p">,</span> <span class="n">Cone_DZ</span><span class="o">=</span><span class="n">Cone_DZ</span><span class="p">,</span> <span class="n">Cone_NPsi</span><span class="o">=</span><span class="n">Cone_NPsi</span><span class="p">,</span> <span class="n">Cone_Nk</span><span class="o">=</span><span class="n">Cone_Nk</span><span class="p">,</span> <span class="n">Colis</span><span class="o">=</span><span class="n">Colis</span><span class="p">)</span>

        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">OpticsNb</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ves</span> <span class="ow">is</span> <span class="k">None</span><span class="p">,</span> <span class="s">&quot;Calculation of [LOS, Etendue, Span and Cone] not possible without Optics and Ves !&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_SAngPnPe1e2</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_LOS</span><span class="p">(</span><span class="n">CalcEtend</span><span class="o">=</span><span class="n">CalcEtend</span><span class="p">,</span> <span class="n">Method</span><span class="o">=</span><span class="n">Etend_Method</span><span class="p">,</span> <span class="n">RelErr</span><span class="o">=</span><span class="n">Etend_RelErr</span><span class="p">,</span> <span class="n">dX12</span><span class="o">=</span><span class="n">Etend_dX12</span><span class="p">,</span> <span class="n">dX12Mode</span><span class="o">=</span><span class="n">Etend_dX12Mode</span><span class="p">,</span> <span class="n">Ratio</span><span class="o">=</span><span class="n">Etend_Ratio</span><span class="p">,</span> <span class="n">Colis</span><span class="o">=</span><span class="n">Colis</span><span class="p">,</span> <span class="n">LOSRef</span><span class="o">=</span><span class="n">LOSRef</span><span class="p">,</span> <span class="n">Verb</span><span class="o">=</span><span class="n">Verb</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_SinoSpan</span><span class="p">(</span><span class="n">CalcSpanImp</span><span class="o">=</span><span class="n">CalcSpanImp</span><span class="p">,</span> <span class="n">Sino_RefPt</span><span class="o">=</span><span class="n">Sino_RefPt</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_ConeWidthAlongLOS</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_ConePoly</span><span class="p">(</span><span class="n">CalcCone</span><span class="o">=</span><span class="n">CalcCone</span><span class="p">,</span> <span class="n">DRY</span><span class="o">=</span><span class="n">Cone_DRY</span><span class="p">,</span> <span class="n">DXTheta</span><span class="o">=</span><span class="n">Cone_DXTheta</span><span class="p">,</span> <span class="n">DZ</span><span class="o">=</span><span class="n">Cone_DZ</span><span class="p">,</span> <span class="n">NPsi</span><span class="o">=</span><span class="n">Cone_NPsi</span><span class="p">,</span> <span class="n">Nk</span><span class="o">=</span><span class="n">Cone_Nk</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_SigPrecomp</span><span class="p">(</span><span class="n">CalcPreComp</span><span class="o">=</span><span class="n">CalcPreComp</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_SAngPnPe1e2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">Optics</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="c">#sca = np.array([np.sum((aa.BaryS-self.BaryS)*self.nIn) for aa in self.LApert])</span>
            <span class="n">sca</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">aa</span><span class="o">.</span><span class="n">Surf</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Optics</span><span class="p">])</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">sca</span><span class="p">)</span>
            <span class="n">e1</span><span class="p">,</span> <span class="n">e2</span> <span class="o">=</span> <span class="n">_tfg_gg</span><span class="o">.</span><span class="n">Calc_DefaultCheck_e1e2_PLane_1D</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Optics</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">BaryS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Optics</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">nIn</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_SAngPlane</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Optics</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">BaryS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Optics</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">nIn</span><span class="p">,</span> <span class="n">e1</span><span class="p">,</span> <span class="n">e2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_LOS</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">CalcEtend</span><span class="o">=</span><span class="k">True</span><span class="p">,</span> <span class="n">Method</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetEtendMethod</span><span class="p">,</span> <span class="n">RelErr</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetEtendepsrel</span><span class="p">,</span> <span class="n">dX12</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetEtenddX12</span><span class="p">,</span> <span class="n">dX12Mode</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetEtenddX12Mode</span><span class="p">,</span> <span class="n">Ratio</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetEtendRatio</span><span class="p">,</span> <span class="n">Colis</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetCalcEtendColis</span><span class="p">,</span> <span class="n">LOSRef</span><span class="o">=</span><span class="s">&#39;Cart&#39;</span><span class="p">,</span> <span class="n">Verb</span><span class="o">=</span><span class="k">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_inputs</span><span class="p">(</span><span class="n">CalcEtend</span><span class="o">=</span><span class="n">CalcEtend</span><span class="p">,</span> <span class="n">Etend_Method</span><span class="o">=</span><span class="n">Method</span><span class="p">,</span> <span class="n">Etend_RelErr</span><span class="o">=</span><span class="n">RelErr</span><span class="p">,</span> <span class="n">Etend_dX12</span><span class="o">=</span><span class="n">dX12</span><span class="p">,</span> <span class="n">Etend_dX12Mode</span><span class="o">=</span><span class="n">dX12Mode</span><span class="p">,</span> <span class="n">Etend_Ratio</span><span class="o">=</span><span class="n">Ratio</span><span class="p">,</span> <span class="n">Colis</span><span class="o">=</span><span class="n">Colis</span><span class="p">,</span> <span class="n">LOSRef</span><span class="o">=</span><span class="n">LOSRef</span><span class="p">,</span> <span class="n">Verb</span><span class="o">=</span><span class="n">Verb</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ves</span> <span class="ow">is</span> <span class="k">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">Optics</span> <span class="ow">is</span> <span class="k">None</span><span class="p">):</span>
            <span class="c">#try:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_LOS_ApertPolyInt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_LOS_ApertPolyInt_S</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_LOS_ApertPolyInt_BaryS</span><span class="p">,</span> <span class="n">du</span> <span class="o">=</span> <span class="n">_tfg_c</span><span class="o">.</span><span class="n">_Detect_set_LOS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="p">[</span><span class="n">oo</span><span class="o">.</span><span class="n">Surf</span> <span class="k">for</span> <span class="n">oo</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Optics</span><span class="p">],</span> <span class="p">[</span><span class="n">oo</span><span class="o">.</span><span class="n">BaryS</span> <span class="k">for</span> <span class="n">oo</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Optics</span><span class="p">],</span>
                    <span class="p">[</span><span class="n">oo</span><span class="o">.</span><span class="n">nIn</span> <span class="k">for</span> <span class="n">oo</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Optics</span><span class="p">],</span> <span class="p">[</span><span class="n">oo</span><span class="o">.</span><span class="n">Poly</span> <span class="k">for</span> <span class="n">oo</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Optics</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">BaryS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Poly</span><span class="p">,</span> <span class="n">OpType</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">OpticsType</span><span class="p">,</span> <span class="n">Verb</span><span class="o">=</span><span class="n">Verb</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="k">True</span><span class="p">)</span>
            <span class="n">LOSCart</span> <span class="o">=</span> <span class="n">LOS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Name</span><span class="o">+</span><span class="s">&quot;_Cart&quot;</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BaryS</span><span class="p">,</span><span class="n">du</span><span class="p">),</span> <span class="n">Ves</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Ves</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Exp</span><span class="p">,</span> <span class="n">Diag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Diag</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">shot</span><span class="p">,</span>
                    <span class="n">dtime</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">dtime</span><span class="p">,</span> <span class="n">dtimeIn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">_dtimeIn</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">SavePath</span><span class="p">)</span>
            <span class="n">PRef</span> <span class="o">=</span> <span class="p">(</span><span class="n">LOSCart</span><span class="o">.</span><span class="n">POut</span><span class="o">+</span><span class="n">LOSCart</span><span class="o">.</span><span class="n">PIn</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_LOS</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;Cart&#39;</span><span class="p">:{</span><span class="s">&#39;LOS&#39;</span><span class="p">:</span><span class="n">LOSCart</span><span class="p">,</span><span class="s">&#39;PRef&#39;</span><span class="p">:</span><span class="n">PRef</span><span class="p">}}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_LOSRef</span> <span class="o">=</span> <span class="n">LOSRef</span>
            <span class="k">if</span> <span class="n">CalcEtend</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set_Etendue</span><span class="p">(</span><span class="n">Method</span><span class="o">=</span><span class="n">Method</span><span class="p">,</span> <span class="n">RelErr</span><span class="o">=</span><span class="n">RelErr</span><span class="p">,</span> <span class="n">dX12</span><span class="o">=</span><span class="n">dX12</span><span class="p">,</span> <span class="n">dX12Mode</span><span class="o">=</span><span class="n">dX12Mode</span><span class="p">,</span> <span class="n">Ratio</span><span class="o">=</span><span class="n">Ratio</span><span class="p">,</span> <span class="n">Colis</span><span class="o">=</span><span class="n">Colis</span><span class="p">)</span>
            <span class="c">#except:</span>
            <span class="c">#    self._LOS = &quot;Impossible !&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_LOS</span> <span class="o">=</span> <span class="s">&quot;Impossible !&quot;</span>

    <span class="k">def</span> <span class="nf">_set_Etendue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Method</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetEtendMethod</span><span class="p">,</span> <span class="n">RelErr</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetEtendepsrel</span><span class="p">,</span> <span class="n">dX12</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetEtenddX12</span><span class="p">,</span> <span class="n">dX12Mode</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetEtenddX12Mode</span><span class="p">,</span> <span class="n">Ratio</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetEtendRatio</span><span class="p">,</span> <span class="n">Colis</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetCalcEtendColis</span><span class="p">):</span>    <span class="c"># Pb with Lens quad vs trapz !</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_inputs</span><span class="p">(</span><span class="n">Etend_Method</span><span class="o">=</span><span class="n">Method</span><span class="p">,</span> <span class="n">Etend_RelErr</span><span class="o">=</span><span class="n">RelErr</span><span class="p">,</span> <span class="n">Etend_dX12</span><span class="o">=</span><span class="n">dX12</span><span class="p">,</span> <span class="n">Etend_dX12Mode</span><span class="o">=</span><span class="n">dX12Mode</span><span class="p">,</span> <span class="n">Etend_Ratio</span><span class="o">=</span><span class="n">Ratio</span><span class="p">,</span> <span class="n">Colis</span><span class="o">=</span><span class="n">Colis</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOS</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&quot;Impossible !&quot;</span><span class="p">,</span><span class="k">None</span><span class="p">]:</span>
            <span class="nb">print</span> <span class="s">&quot;    &quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Name</span><span class="o">+</span><span class="s">&quot; : Computing Entendue...&quot;</span>
            <span class="n">LOPolys</span> <span class="o">=</span> <span class="p">[</span><span class="n">oo</span><span class="o">.</span><span class="n">Poly</span> <span class="k">for</span> <span class="n">oo</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Optics</span><span class="p">]</span>
            <span class="n">LOnIns</span> <span class="o">=</span> <span class="p">[</span><span class="n">oo</span><span class="o">.</span><span class="n">nIn</span> <span class="k">for</span> <span class="n">oo</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Optics</span><span class="p">]</span>
            <span class="n">LSurfs</span> <span class="o">=</span> <span class="p">[</span><span class="n">oo</span><span class="o">.</span><span class="n">Surf</span> <span class="k">for</span> <span class="n">oo</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Optics</span><span class="p">]</span>
            <span class="n">LOBaryS</span> <span class="o">=</span> <span class="p">[</span><span class="n">oo</span><span class="o">.</span><span class="n">BaryS</span> <span class="k">for</span> <span class="n">oo</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Optics</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="p">[</span><span class="n">kk</span><span class="p">][</span><span class="s">&#39;Etend_0Dir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Surf</span> <span class="o">*</span> <span class="n">_tfg_gg</span><span class="o">.</span><span class="n">Calc_SAngVect_LPolys1Point_Flex</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_LOS_ApertPolyInt</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">BaryS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SAngPlane</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SAngPlane</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SAngPlane</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SAngPlane</span><span class="p">[</span><span class="mi">3</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="p">[</span><span class="n">kk</span><span class="p">][</span><span class="s">&#39;Etend_0Inv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_LOS_ApertPolyInt_S</span> <span class="o">*</span> <span class="n">_tfg_gg</span><span class="o">.</span><span class="n">Calc_SAngVect_LPolys1Point_Flex</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">Poly</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_LOS_ApertPolyInt_BaryS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">BaryS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SAngPlane</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SAngPlane</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SAngPlane</span><span class="p">[</span><span class="mi">3</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">PRef</span><span class="p">,</span> <span class="n">LOSu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="p">[</span><span class="n">kk</span><span class="p">][</span><span class="s">&#39;PRef&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="p">[</span><span class="n">kk</span><span class="p">][</span><span class="s">&#39;LOS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">u</span>
                <span class="n">e1</span><span class="p">,</span> <span class="n">e2</span> <span class="o">=</span> <span class="n">_tfg_gg</span><span class="o">.</span><span class="n">Calc_DefaultCheck_e1e2_PLane_1D</span><span class="p">(</span><span class="n">PRef</span><span class="p">,</span> <span class="n">LOSu</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="p">[</span><span class="n">kk</span><span class="p">][</span><span class="s">&#39;Etend&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_tfg_c</span><span class="o">.</span><span class="n">Calc_Etendue_PlaneLOS</span><span class="p">(</span><span class="n">PRef</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">LOSu</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">Poly</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">BaryS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nIn</span><span class="p">,</span> <span class="n">LOPolys</span><span class="p">,</span> <span class="n">LOnIns</span><span class="p">,</span> <span class="n">LSurfs</span><span class="p">,</span> <span class="n">LOBaryS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SAngPlane</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">Poly</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">_Vin</span><span class="p">,</span> <span class="n">DLong</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">DLong</span><span class="p">,</span>
                        <span class="n">Lens_ConeTip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Optics_Lens_ConeTip</span><span class="p">,</span> <span class="n">Lens_ConeHalfAng</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_Optics_Lens_ConeHalfAng</span><span class="p">,</span> <span class="n">RadL</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Optics</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Rad</span><span class="p">,</span> <span class="n">RadD</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Rad</span><span class="p">,</span> <span class="n">F1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Optics</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">F1</span><span class="p">,</span>
                        <span class="n">OpType</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">OpticsType</span><span class="p">,</span> <span class="n">VType</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">Type</span><span class="p">,</span> <span class="n">Mode</span><span class="o">=</span><span class="n">Method</span><span class="p">,</span> <span class="n">e1</span><span class="o">=</span><span class="n">e1</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">e2</span><span class="o">=</span><span class="n">e2</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">epsrel</span><span class="o">=</span><span class="n">RelErr</span><span class="p">,</span> <span class="n">Ratio</span><span class="o">=</span><span class="n">Ratio</span><span class="p">,</span> <span class="n">dX12</span><span class="o">=</span><span class="n">dX12</span><span class="p">,</span> <span class="n">dX12Mode</span><span class="o">=</span><span class="n">dX12Mode</span><span class="p">,</span> <span class="n">Colis</span><span class="o">=</span><span class="n">Colis</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="k">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="p">[</span><span class="n">kk</span><span class="p">][</span><span class="s">&#39;Etend_Method&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="p">[</span><span class="n">kk</span><span class="p">][</span><span class="s">&#39;Etend_Ratio&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="p">[</span><span class="n">kk</span><span class="p">][</span><span class="s">&#39;Etend_Colis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Method</span><span class="p">,</span> <span class="n">Ratio</span><span class="p">,</span> <span class="n">Colis</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="p">[</span><span class="n">kk</span><span class="p">][</span><span class="s">&#39;Etend_RelErr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">RelErr</span> <span class="k">if</span> <span class="n">Method</span><span class="o">==</span><span class="s">&#39;quad&#39;</span> <span class="k">else</span> <span class="k">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="p">[</span><span class="n">kk</span><span class="p">][</span><span class="s">&#39;Etend_dX12&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">None</span> <span class="k">if</span> <span class="n">Method</span><span class="o">==</span><span class="s">&#39;quad&#39;</span> <span class="k">else</span> <span class="n">dX12</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="p">[</span><span class="n">kk</span><span class="p">][</span><span class="s">&#39;Etend_dX12Mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">None</span> <span class="k">if</span> <span class="n">Method</span><span class="o">==</span><span class="s">&#39;quad&#39;</span> <span class="k">else</span> <span class="n">dX12Mode</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;Detect &quot;</span><span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Name</span> <span class="o">+</span><span class="s">&quot; : calculation of Etendue not possible because LOS impossible !&quot;</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_set_SinoSpan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Sino_RefPt</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">CalcSpanImp</span><span class="o">=</span><span class="k">True</span><span class="p">,</span> <span class="n">MarginRMin</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetSpanRMinMargin</span><span class="p">,</span> <span class="n">NEdge</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetSpanNEdge</span><span class="p">,</span> <span class="n">NRad</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetSpanNRad</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_inputs</span><span class="p">(</span><span class="n">Sino_RefPt</span><span class="o">=</span><span class="n">Sino_RefPt</span><span class="p">,</span> <span class="n">CalcSpanImp</span><span class="o">=</span><span class="n">CalcSpanImp</span><span class="p">,</span> <span class="n">MarginRMin</span><span class="o">=</span><span class="n">MarginRMin</span><span class="p">,</span> <span class="n">NEdge</span><span class="o">=</span><span class="n">NEdge</span><span class="p">,</span> <span class="n">NRad</span><span class="o">=</span><span class="n">NRad</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">CalcSpanImp</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="o">==</span><span class="s">&#39;Impossible !&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOS</span> <span class="ow">is</span> <span class="k">None</span><span class="p">):</span>
            <span class="nb">print</span> <span class="s">&quot;    &quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Name</span><span class="o">+</span><span class="s">&quot; : Computing Span and Sinogram...&quot;</span>
            <span class="k">if</span> <span class="n">Sino_RefPt</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
                <span class="n">Sino_RefPt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">BaryS</span>
            <span class="n">Sino_RefPt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">Sino_RefPt</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="p">[</span><span class="n">kk</span><span class="p">][</span><span class="s">&#39;LOS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_set_Sino</span><span class="p">(</span><span class="n">RefPt</span><span class="o">=</span><span class="n">Sino_RefPt</span><span class="p">)</span>
            <span class="n">P</span><span class="p">,</span> <span class="n">nP</span><span class="p">,</span> <span class="n">e1</span><span class="p">,</span> <span class="n">e2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SAngPlane</span>
            <span class="n">LOPolys</span> <span class="o">=</span> <span class="p">[</span><span class="n">oo</span><span class="o">.</span><span class="n">Poly</span> <span class="k">for</span> <span class="n">oo</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Optics</span><span class="p">]</span>
            <span class="n">LOBaryS</span> <span class="o">=</span> <span class="p">[</span><span class="n">oo</span><span class="o">.</span><span class="n">BaryS</span> <span class="k">for</span> <span class="n">oo</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Optics</span><span class="p">]</span>
            <span class="n">LOSD</span><span class="p">,</span> <span class="n">LOSu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_LOSRef</span><span class="p">][</span><span class="s">&#39;LOS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">D</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_LOSRef</span><span class="p">][</span><span class="s">&#39;LOS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">u</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">Type</span><span class="o">==</span><span class="s">&#39;Tor&#39;</span><span class="p">:</span>
                <span class="n">RMinMax</span><span class="p">,</span> <span class="n">ThetaMinMax</span><span class="p">,</span> <span class="n">ZMinMax</span><span class="p">,</span> <span class="n">kMinMax</span><span class="p">,</span> <span class="n">Sino_CrossProj</span><span class="p">,</span> <span class="n">Span_NEdge</span><span class="p">,</span> <span class="n">Span_NRad</span> <span class="o">=</span> <span class="n">_tfg_c</span><span class="o">.</span><span class="n">Calc_SpanImpBoth_2Steps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Poly</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NP</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">BaryS</span><span class="p">,</span> <span class="n">LOPolys</span><span class="p">,</span> <span class="n">LOBaryS</span><span class="p">,</span> <span class="n">LOSD</span><span class="p">,</span> <span class="n">LOSu</span><span class="p">,</span> <span class="n">Sino_RefPt</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">nP</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">Poly</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">Vin</span><span class="p">,</span> <span class="n">DLong</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">DLong</span><span class="p">,</span> <span class="n">VType</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">Type</span><span class="p">,</span> <span class="n">e1</span><span class="o">=</span><span class="n">e1</span><span class="p">,</span> <span class="n">e2</span><span class="o">=</span><span class="n">e2</span><span class="p">,</span> <span class="n">OpType</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">OpticsType</span><span class="p">,</span> <span class="n">Lens_ConeTip</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_Optics_Lens_ConeTip</span><span class="p">,</span> <span class="n">NEdge</span><span class="o">=</span><span class="n">NEdge</span><span class="p">,</span> <span class="n">NRad</span><span class="o">=</span><span class="n">NRad</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="k">True</span><span class="p">)</span>
                <span class="n">RMinMax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">MarginRMin</span><span class="o">*</span><span class="n">RMinMax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">_P1Min</span><span class="p">[</span><span class="mi">0</span><span class="p">]]))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_Sino_RefPt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Span_R</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Span_Theta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Span_Z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Span_k</span> <span class="o">=</span> <span class="n">Sino_RefPt</span><span class="p">,</span> <span class="n">RMinMax</span><span class="p">,</span> <span class="n">ThetaMinMax</span><span class="p">,</span> <span class="n">ZMinMax</span><span class="p">,</span> <span class="n">kMinMax</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_Span_X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Span_Y</span> <span class="o">=</span> <span class="k">None</span><span class="p">,</span> <span class="k">None</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">Type</span><span class="o">==</span><span class="s">&#39;Lin&#39;</span><span class="p">:</span>
                <span class="n">XMinMax</span><span class="p">,</span> <span class="n">YMinMax</span><span class="p">,</span> <span class="n">ZMinMax</span><span class="p">,</span> <span class="n">kMinMax</span><span class="p">,</span> <span class="n">Sino_CrossProj</span><span class="p">,</span> <span class="n">Span_NEdge</span><span class="p">,</span> <span class="n">Span_NRad</span> <span class="o">=</span> <span class="n">_tfg_c</span><span class="o">.</span><span class="n">Calc_SpanImpBoth_2Steps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Poly</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NP</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">BaryS</span><span class="p">,</span> <span class="n">LOPolys</span><span class="p">,</span> <span class="n">LOBaryS</span><span class="p">,</span> <span class="n">LOSD</span><span class="p">,</span> <span class="n">LOSu</span><span class="p">,</span> <span class="n">Sino_RefPt</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">nP</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">Poly</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">Vin</span><span class="p">,</span> <span class="n">DLong</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">DLong</span><span class="p">,</span> <span class="n">VType</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">Type</span><span class="p">,</span> <span class="n">e1</span><span class="o">=</span><span class="n">e1</span><span class="p">,</span> <span class="n">e2</span><span class="o">=</span><span class="n">e2</span><span class="p">,</span> <span class="n">OpType</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">OpticsType</span><span class="p">,</span> <span class="n">Lens_ConeTip</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_Optics_Lens_ConeTip</span><span class="p">,</span> <span class="n">NEdge</span><span class="o">=</span><span class="n">NEdge</span><span class="p">,</span> <span class="n">NRad</span><span class="o">=</span><span class="n">NRad</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="k">True</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_Sino_RefPt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Span_X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Span_Y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Span_Z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Span_k</span> <span class="o">=</span> <span class="n">Sino_RefPt</span><span class="p">,</span> <span class="n">XMinMax</span><span class="p">,</span> <span class="n">YMinMax</span><span class="p">,</span> <span class="n">ZMinMax</span><span class="p">,</span> <span class="n">kMinMax</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_Span_R</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Span_Theta</span> <span class="o">=</span> <span class="k">None</span><span class="p">,</span> <span class="k">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_Sino_CrossProj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Span_NEdge</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Span_NRad</span> <span class="o">=</span> <span class="n">Sino_CrossProj</span><span class="p">,</span> <span class="n">Span_NEdge</span><span class="p">,</span> <span class="n">Span_NRad</span>
            <span class="c"># Sino_CrossProj = Imp_PolProj</span>

    <span class="k">def</span> <span class="nf">_set_ConeWidthAlongLOS</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">Nk</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_inputs</span><span class="p">(</span><span class="n">Nk</span><span class="o">=</span><span class="n">Nk</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="o">==</span><span class="s">&#39;Impossible !&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOS</span> <span class="ow">is</span> <span class="k">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Span_k</span> <span class="ow">is</span> <span class="k">None</span><span class="p">):</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_Span_k</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">_Span_k</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">Nk</span><span class="p">)</span>
            <span class="n">P</span><span class="p">,</span> <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_LOSRef</span><span class="p">][</span><span class="s">&#39;LOS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">D</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_LOSRef</span><span class="p">][</span><span class="s">&#39;LOS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">u</span>
            <span class="n">e1</span><span class="p">,</span> <span class="n">e2</span> <span class="o">=</span> <span class="n">_tfg_gg</span><span class="o">.</span><span class="n">Calc_DefaultCheck_e1e2_PLane_1D</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">u</span><span class="p">)</span>
            <span class="n">Ps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">P</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">k</span><span class="o">*</span><span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">P</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">k</span><span class="o">*</span><span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">P</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">k</span><span class="o">*</span><span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span>
            <span class="n">nPs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">u</span><span class="p">,(</span><span class="n">Nk</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
            <span class="n">e1s</span><span class="p">,</span> <span class="n">e2s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">e1</span><span class="p">,(</span><span class="n">Nk</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">e2</span><span class="p">,(</span><span class="n">Nk</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
            <span class="n">LOPolys</span> <span class="o">=</span> <span class="p">[</span><span class="n">oo</span><span class="o">.</span><span class="n">Poly</span> <span class="k">for</span> <span class="n">oo</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Optics</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">OpticsType</span><span class="o">==</span><span class="s">&#39;Apert&#39;</span><span class="p">:</span>
                <span class="n">LOSurfs</span> <span class="o">=</span> <span class="p">[</span><span class="n">oo</span><span class="o">.</span><span class="n">Surf</span> <span class="k">for</span> <span class="n">oo</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Optics</span><span class="p">]</span>
                <span class="n">LOnIns</span> <span class="o">=</span> <span class="p">[</span><span class="n">oo</span><span class="o">.</span><span class="n">nIn</span> <span class="k">for</span> <span class="n">oo</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Optics</span><span class="p">]</span>
                <span class="n">LnPtemp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">LOnIns</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">LOSurfs</span><span class="p">,(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
                <span class="n">MinX1</span><span class="p">,</span> <span class="n">MinX2</span><span class="p">,</span> <span class="n">MaxX1</span><span class="p">,</span> <span class="n">MaxX2</span><span class="p">,</span> <span class="n">e1</span><span class="p">,</span> <span class="n">e2</span> <span class="o">=</span> <span class="n">_tfg_c</span><span class="o">.</span><span class="n">Calc_ViewConePointsMinMax_PlanesDetectApert_2Steps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Poly</span><span class="p">,</span> <span class="n">LOPolys</span><span class="p">,</span> <span class="n">LnPtemp</span><span class="p">,</span> <span class="n">LOSurfs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Optics</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">BaryS</span><span class="p">,</span> <span class="n">Ps</span><span class="p">,</span> <span class="n">nPs</span><span class="p">,</span> <span class="n">e1</span><span class="o">=</span><span class="n">e1s</span><span class="p">,</span> <span class="n">e2</span><span class="o">=</span><span class="n">e2s</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="k">True</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">OpticsType</span><span class="o">==</span><span class="s">&#39;Lens&#39;</span><span class="p">:</span>
                <span class="n">MinX1</span><span class="p">,</span> <span class="n">MinX2</span><span class="p">,</span> <span class="n">MaxX1</span><span class="p">,</span> <span class="n">MaxX2</span><span class="p">,</span> <span class="n">e1</span><span class="p">,</span> <span class="n">e2</span> <span class="o">=</span> <span class="n">_tfg_c</span><span class="o">.</span><span class="n">Calc_ViewConePointsMinMax_PlanesDetectLens</span><span class="p">(</span><span class="n">LOPolys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Optics_Lens_ConeTip</span><span class="p">,</span> <span class="n">Ps</span><span class="p">,</span> <span class="n">nPs</span><span class="p">,</span> <span class="n">e1</span><span class="o">=</span><span class="n">e1s</span><span class="p">,</span> <span class="n">e2</span><span class="o">=</span><span class="n">e2s</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="k">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ConeWidth_k</span> <span class="o">=</span> <span class="n">k</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ConeWidth_X1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">MinX1</span><span class="p">,</span><span class="n">MaxX1</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ConeWidth_X2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">MinX2</span><span class="p">,</span><span class="n">MaxX2</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ConeWidth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ConeWidth_X1</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ConeWidth_X2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)]),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_set_Sino</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">RefPt</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_inputs</span><span class="p">(</span><span class="n">Sino_RefPt</span><span class="o">=</span><span class="n">Sino_RefPt</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Ves</span><span class="o">.</span><span class="n">_set_Sino</span><span class="p">(</span><span class="n">RefPt</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_SinoSpan</span><span class="p">(</span><span class="n">RefPt</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_isOnGoodSide</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Pts</span><span class="p">,</span> <span class="n">NbPoly</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Log</span><span class="o">=</span><span class="s">&#39;all&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Check whether each point is on the inside or the outside of each Detect and Apert (with respect to nIn) &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_tfg_c</span><span class="o">.</span><span class="n">_Detect_isOnGoodSide</span><span class="p">(</span><span class="n">Pts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">BaryS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nIn</span><span class="p">,</span> <span class="p">[</span><span class="n">oo</span><span class="o">.</span><span class="n">BaryS</span> <span class="k">for</span> <span class="n">oo</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Optics</span><span class="p">],</span> <span class="p">[</span><span class="n">oo</span><span class="o">.</span><span class="n">nIn</span> <span class="k">for</span> <span class="n">oo</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Optics</span><span class="p">],</span> <span class="n">NbPoly</span><span class="o">=</span><span class="n">NbPoly</span><span class="p">,</span> <span class="n">Log</span><span class="o">=</span><span class="n">Log</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_isInsideConeWidthLim</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Pts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Check whether each point lies inside the enveloppe of the viewing cone &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_tfg_c</span><span class="o">.</span><span class="n">_Detect_isInsideConeWidthLim</span><span class="p">(</span><span class="n">Pts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_LOSRef</span><span class="p">][</span><span class="s">&#39;LOS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">D</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_LOSRef</span><span class="p">][</span><span class="s">&#39;LOS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">u</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ConeWidth_k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ConeWidth_X1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ConeWidth_X2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_ConePoly</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">CalcCone</span><span class="o">=</span><span class="k">True</span><span class="p">,</span> <span class="n">DRY</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetConeDRY</span><span class="p">,</span> <span class="n">DXTheta</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">DZ</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetConeDZ</span><span class="p">,</span> <span class="n">NPsi</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">Nk</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="k">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; If CalcCone is True, compute the projections of the VOS, also called viewing cones elsewhere in the documentation</span>

<span class="sd">        To compute the VOS, tofu tests all points inside a 3D grid to see if each point is visible from the detector through the apertures or not.</span>
<span class="sd">        The meshed space is determined by the volume spanned by a LOS sampling of the VOS.</span>
<span class="sd">        Then, a contour function is used to find the polygons limiting the cross-section and horizontal projections of the VOS.</span>
<span class="sd">        Once computed, the viewing cones are assigned to attributes of the Detect instance.</span>

<span class="sd">        In the particular case (1) when the LOS of the detector lies entirely inside one cross-section (e.g.: tomography diagnostics), tofu also computes the integral in the direction of the ignorable coordinate of the solid angle on a regular mesh (for faster computation of the geometry assuming toroidaly invariant basis functions).</span>
<span class="sd">        This regular mesh is defined in 2D, by the distance between a mesh point and the detector (k) and by the poloidal angle between the LOS and the line going from the detector to the mesh point (psi)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        DRY :       float</span>
<span class="sd">            Resolution of the grid in the R (for &#39;Tor&#39; vessel types) or Y (for &#39;Lin&#39; vessel types) direction, in meters</span>
<span class="sd">        DXTheta :    float</span>
<span class="sd">            Resolution of the grid in the toroidal (for &#39;Tor&#39; vessel types, in radians) or X (for &#39;Lin&#39; vessel types, in meters) direction</span>
<span class="sd">        DZ :        float</span>
<span class="sd">            Resolution of the grid in the Z direction, in meters</span>
<span class="sd">        NPsi :      int</span>
<span class="sd">            Number of points of the regular mesh in psi direction (angle), in case (1)</span>
<span class="sd">        Nk :        int</span>
<span class="sd">            Number of points of the regular mesh in k direction (distance), in case (1)</span>
<span class="sd">        Test :      bool</span>
<span class="sd">            Flag indicating whether the inputs should be tested for conformity</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">CalcCone</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="o">==</span><span class="s">&#39;Impossible&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOS</span> <span class="ow">is</span> <span class="k">None</span><span class="p">):</span>
            <span class="nb">print</span> <span class="s">&quot;    &quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Name</span><span class="o">+</span><span class="s">&quot; : Computing ConePoly...&quot;</span>
            <span class="n">DPoly</span><span class="p">,</span> <span class="n">DBaryS</span><span class="p">,</span> <span class="n">DnIn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Poly</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">BaryS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nIn</span>
            <span class="n">LOPolys</span> <span class="o">=</span> <span class="p">[</span><span class="n">oo</span><span class="o">.</span><span class="n">Poly</span> <span class="k">for</span> <span class="n">oo</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Optics</span><span class="p">]</span>
            <span class="n">LOnIns</span> <span class="o">=</span> <span class="p">[</span><span class="n">oo</span><span class="o">.</span><span class="n">nIn</span> <span class="k">for</span> <span class="n">oo</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Optics</span><span class="p">]</span>
            <span class="n">LSurfs</span> <span class="o">=</span> <span class="p">[</span><span class="n">oo</span><span class="o">.</span><span class="n">Surf</span> <span class="k">for</span> <span class="n">oo</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Optics</span><span class="p">]</span>
            <span class="n">LOBaryS</span> <span class="o">=</span> <span class="p">[</span><span class="n">oo</span><span class="o">.</span><span class="n">BaryS</span> <span class="k">for</span> <span class="n">oo</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Optics</span><span class="p">]</span>
            <span class="n">LOSD</span><span class="p">,</span> <span class="n">LOSu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_LOSRef</span><span class="p">][</span><span class="s">&#39;LOS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">D</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_LOSRef</span><span class="p">][</span><span class="s">&#39;LOS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">u</span>
            <span class="n">LOSPIn</span><span class="p">,</span> <span class="n">LOSPOut</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_LOSRef</span><span class="p">][</span><span class="s">&#39;LOS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">PIn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_LOSRef</span><span class="p">][</span><span class="s">&#39;LOS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">POut</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_SAngCross_Reg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SAngCross_Reg_Int</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SAngCross_Reg_K</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SAngCross_Reg_Psi</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SAngCross_Points</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SAngCross_Max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SAngCross_Int</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SAngHor_Points</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SAngHor_Max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SAngHor_Int</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Cone_PolyCross</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Cone_PolyHor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Cone_PolyCrossbis</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Cone_PolyHorbis</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Cone_Poly_DX</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Cone_Poly_DY</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Cone_Poly_DR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Cone_Poly_DTheta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Cone_Poly_DZ</span> \
                    <span class="o">=</span> <span class="n">_tfg_c</span><span class="o">.</span><span class="n">_Detect_set_ConePoly</span><span class="p">(</span><span class="n">DPoly</span><span class="p">,</span> <span class="n">DBaryS</span><span class="p">,</span> <span class="n">DnIn</span><span class="p">,</span> <span class="n">LOPolys</span><span class="p">,</span> <span class="n">LOnIns</span><span class="p">,</span> <span class="n">LSurfs</span><span class="p">,</span> <span class="n">LOBaryS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SAngPlane</span><span class="p">,</span> <span class="n">LOSD</span><span class="p">,</span> <span class="n">LOSu</span><span class="p">,</span> <span class="n">LOSPIn</span><span class="p">,</span> <span class="n">LOSPOut</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Span_k</span><span class="p">,</span>
                            <span class="n">Span_R</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_Span_R</span><span class="p">,</span> <span class="n">Span_Theta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_Span_Theta</span><span class="p">,</span> <span class="n">Span_X</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_Span_X</span><span class="p">,</span> <span class="n">Span_Y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_Span_Y</span><span class="p">,</span> <span class="n">Span_Z</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_Span_Z</span><span class="p">,</span>
                            <span class="n">ConeWidth_k</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ConeWidth_k</span><span class="p">,</span> <span class="n">ConeWidth_X1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ConeWidth_X1</span><span class="p">,</span> <span class="n">ConeWidth_X2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ConeWidth_X2</span><span class="p">,</span> <span class="n">Lens_ConeTip</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_Optics_Lens_ConeTip</span><span class="p">,</span> <span class="n">Lens_ConeHalfAng</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_Optics_Lens_ConeHalfAng</span><span class="p">,</span>
                            <span class="n">RadD</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Rad</span><span class="p">,</span> <span class="n">RadL</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Optics</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Rad</span><span class="p">,</span> <span class="n">F1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Optics</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">F1</span><span class="p">,</span> <span class="n">VPoly</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">Poly</span><span class="p">,</span> <span class="n">VVin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">Vin</span><span class="p">,</span> <span class="n">DLong</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">DLong</span><span class="p">,</span>
                            <span class="n">VType</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">Type</span><span class="p">,</span> <span class="n">OpType</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">OpticsType</span><span class="p">,</span> <span class="n">NPsi</span><span class="o">=</span><span class="n">NPsi</span><span class="p">,</span> <span class="n">Nk</span><span class="o">=</span><span class="n">Nk</span><span class="p">,</span> <span class="n">thet</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="n">DPoly</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                            <span class="n">DXTheta</span><span class="o">=</span><span class="n">DXTheta</span><span class="p">,</span> <span class="n">DRY</span><span class="o">=</span><span class="n">DRY</span><span class="p">,</span> <span class="n">DZ</span><span class="o">=</span><span class="n">DZ</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="k">True</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_get_KPsiCrossInt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">PtsRZ</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Computes k and psi for a set of points in cross-section (R,Z) or (Y,Z) coordinates &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_tfg_c</span><span class="o">.</span><span class="n">_Detect_get_KPsiCrossInt</span><span class="p">(</span><span class="n">PtsRZ</span><span class="p">,</span> <span class="n">SAngCross_Reg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_SAngCross_Reg</span><span class="p">,</span> <span class="n">LOSPOut</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="p">[</span><span class="s">&#39;Cart&#39;</span><span class="p">][</span><span class="s">&#39;LOS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">POut</span><span class="p">,</span> <span class="n">DBaryS</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">BaryS</span><span class="p">,</span> <span class="n">VType</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">Type</span><span class="p">)</span>



<div class="viewcode-block" id="Detect.refine_ConePoly"><a class="viewcode-back" href="../../../Auto_tofu.geom.html#tofu.geom.Detect.refine_ConePoly">[docs]</a>    <span class="k">def</span> <span class="nf">refine_ConePoly</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dMax</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetConeRefdMax</span><span class="p">,</span> <span class="n">Proj</span><span class="o">=</span><span class="s">&#39;Cross&#39;</span><span class="p">,</span> <span class="n">indPoly</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">Verb</span><span class="o">=</span><span class="k">True</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="k">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Reduce the number of points of the selected Cone_Poly projection using the provided maximum distance and checking for convexity</span>

<span class="sd">        Provide a built-in method to simplify the 2 projections of the viewing cone (VOS).</span>
<span class="sd">        In its raw form, the projection of the VOS is a polygon with potentially a high number of points (computed using matplotlib._cntr() function).</span>
<span class="sd">        A re-sampled version of this polygon is computed by taking its convex hull and checking, for each edge, how far it is from the original edge.</span>
<span class="sd">        Each edge (2 points) of the convex hull is then compared to the set of original edges it encloses.</span>
<span class="sd">        If the maximum distance between this convex hull-derived edge and the original set of edges is smaller than dMax, then the convex hull-derived egde is used, otherwise the original edges are preserved.</span>
<span class="sd">        The method does not return a value, instead it assigns the new polygon to a dedicated attribute of the object, thus ensuring that both the original and the re-sampled projections of the VOS are available.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dMax :      float</span>
<span class="sd">            Threshold absolute distance that limits the acceptable discrepancy between the original polygon and its convex hull (checked for each edge of the convex hull)</span>
<span class="sd">        Proj :      str</span>
<span class="sd">            Flag indicating to which projection of the VOS the method should be applied</span>
<span class="sd">        indPoly :   int</span>
<span class="sd">            Index of the polygon to be treated (i.e.: in case one projection of the VOS results in a list of several polygons instead of just one polygon as is usually the case)</span>
<span class="sd">        Verb :      bool</span>
<span class="sd">            Flag indicating whether a one-line comment should be printed at the end of the calculation giving the number of points of the new polygon vs the number of points of the original polygon</span>
<span class="sd">        Test :      bool</span>
<span class="sd">            Flag indicating whether the inputs should be tested for conformity</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">Proj</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;Cross&#39;</span><span class="p">,</span><span class="s">&#39;Hor&#39;</span><span class="p">],</span> <span class="s">&quot;Arg Proj must be in [&#39;Cross&#39;,&#39;Hor&#39;] !&quot;</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">indPoly</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span> <span class="ow">and</span> <span class="n">indPoly</span><span class="o">&lt;=</span><span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_Cone_PolyCrossbis</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_Cone_PolyHorbis</span><span class="p">)),</span> <span class="s">&quot;Arg indPoly must be a valid int index !&quot;</span>
        <span class="n">Poly</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_Cone_PolyCross</span><span class="p">[</span><span class="n">indPoly</span><span class="p">])</span> <span class="k">if</span> <span class="n">Proj</span><span class="o">==</span><span class="s">&#39;Cross&#39;</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_Cone_PolyHor</span><span class="p">[</span><span class="n">indPoly</span><span class="p">])</span>
        <span class="n">PP</span> <span class="o">=</span> <span class="n">_tfg_c</span><span class="o">.</span><span class="n">Refine_ConePoly_All</span><span class="p">(</span><span class="n">Poly</span><span class="p">,</span> <span class="n">dMax</span><span class="o">=</span><span class="n">dMax</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">Proj</span><span class="o">==</span><span class="s">&#39;Cross&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_Cone_PolyCrossbis</span><span class="p">[</span><span class="n">indPoly</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Cone_PolyCross_dMax</span> <span class="o">=</span> <span class="n">PP</span><span class="p">,</span> <span class="n">dMax</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_Cone_PolyHorbis</span><span class="p">[</span><span class="n">indPoly</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Cone_PolyHor_dMax</span> <span class="o">=</span> <span class="n">PP</span><span class="p">,</span> <span class="n">dMax</span>
        <span class="k">if</span> <span class="n">Verb</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s">&quot;        &quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Name</span><span class="o">+</span><span class="s">&quot;.refine_ConePoly(&#39;&quot;</span><span class="o">+</span><span class="n">Proj</span><span class="o">+</span><span class="s">&quot;&#39;) : from &quot;</span><span class="p">,</span> <span class="n">Poly</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&quot;to&quot;</span><span class="p">,</span> <span class="n">PP</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&quot;points&quot;</span></div>

<div class="viewcode-block" id="Detect.isInside"><a class="viewcode-back" href="../../../Auto_tofu.geom.html#tofu.geom.Detect.isInside">[docs]</a>    <span class="k">def</span> <span class="nf">isInside</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Points</span><span class="p">,</span> <span class="n">In</span><span class="o">=</span><span class="s">&#39;(X,Y,Z)&#39;</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="k">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return an array of indices indicating whether each point lies both in the cross-section and horizontal porojections of the viewing cone</span>

<span class="sd">        Like for the :class:`~tofu.geom.Ves` object, points can be provided in 2D or 3D coordinates (specified by &#39;In&#39;), and an array of booleans is returned.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        Points :    np.ndarray</span>
<span class="sd">            (2,N) or (3,N) array of coordinates of the N points to be tested</span>
<span class="sd">        In :        str</span>
<span class="sd">            Flag indicating in which coordinate system the Points are provided, must be in [&#39;(R,Z)&#39;,&#39;(Y,Z)&#39;,&#39;(X,Y)&#39;,&#39;(X,Y,Z)&#39;,&#39;(R,phi,Z)&#39;]</span>
<span class="sd">                * &#39;(R,Z)&#39;: All points are assumed to lie in the horizontal projection, for &#39;Tor&#39; vessel type only</span>
<span class="sd">                * &#39;(Y,Z)&#39;: All points are assumed to lie in the horizontal projection, for &#39;Lin&#39; vessel type only</span>
<span class="sd">                * &#39;(X,Y)&#39;: All points are assumed to lie in the cross-section projection</span>
<span class="sd">        Test :      bool</span>
<span class="sd">            Flag indicating whether the inputs should be tested for conformity</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ind :       np.ndarray</span>
<span class="sd">            (N,) array of booleans with True if a point lies inside both projections of the viewing cone</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="o">==</span><span class="s">&#39;Impossible !&#39;</span><span class="p">,</span> <span class="s">&quot;The detected volume is zero !&quot;</span>
        <span class="n">TorAngRef</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_LOSRef</span><span class="p">][</span><span class="s">&#39;PRef&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_LOSRef</span><span class="p">][</span><span class="s">&#39;PRef&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">Type</span><span class="o">==</span><span class="s">&#39;Tor&#39;</span> <span class="k">else</span> <span class="k">None</span>
        <span class="k">return</span> <span class="n">_tfg_c</span><span class="o">.</span><span class="n">_Detect_isInside</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_Cone_PolyCrossbis</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Cone_PolyHorbis</span><span class="p">,</span> <span class="n">Points</span><span class="p">,</span> <span class="n">In</span><span class="o">=</span><span class="n">In</span><span class="p">,</span> <span class="n">VType</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">Type</span><span class="p">,</span> <span class="n">TorAngRef</span><span class="o">=</span><span class="n">TorAngRef</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="n">Test</span><span class="p">)</span></div>


<div class="viewcode-block" id="Detect.calc_SAngVect"><a class="viewcode-back" href="../../../Auto_tofu.geom.html#tofu.geom.Detect.calc_SAngVect">[docs]</a>    <span class="k">def</span> <span class="nf">calc_SAngVect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Pts</span><span class="p">,</span> <span class="n">In</span><span class="o">=</span><span class="s">&#39;(X,Y,Z)&#39;</span><span class="p">,</span> <span class="n">Colis</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetCalcSAngVectColis</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="k">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the Solid Angle of the Detect-Apert system as seen from the specified points, including collisions detection or not</span>

<span class="sd">        Compute the solid angle and the directing vector subtended by the Detect-Optics system as seen from the desired points (provided in the specified coordinates).</span>
<span class="sd">        This can be useful for visualizing the solid angle distribution or for computing synthetic signal from simulated emissivity in a 3D numerical integration manner.</span>
<span class="sd">        The automtic detection of collisions with the edges of the :class:`~tofu.geom.Ves` object can be switched off (not recommended).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        Pts :   np.ndarray</span>
<span class="sd">            (2,N) or (3,N) array of coordinates of the provided N points</span>
<span class="sd">        In :    str</span>
<span class="sd">            Flag indicating in which coordinate system the Pts are provided, must be in [&#39;(R,Z)&#39;,&#39;(X,Y,Z)&#39;,&#39;(R,phi,Z)&#39;]</span>
<span class="sd">        Colis : bool</span>
<span class="sd">            Flag indicating whether collision detection should be activated</span>
<span class="sd">        Test :  bool</span>
<span class="sd">            Flag indicating whether the inputs should be tested for conformity</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        SAng :  np.ndarray</span>
<span class="sd">            (N,) array of floats, the computed solid angles</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">Test</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Pts</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">Pts</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">2</span> <span class="ow">and</span> <span class="n">Pts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span> <span class="s">&quot;Arg Pts must be a 2D np.ndarray !&quot;</span>
        <span class="n">CrossRef</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_LOSRef</span><span class="p">][</span><span class="s">&#39;PRef&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_LOSRef</span><span class="p">][</span><span class="s">&#39;PRef&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">Type</span><span class="o">==</span><span class="s">&#39;Tor&#39;</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_LOSRef</span><span class="p">][</span><span class="s">&#39;PRef&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">Pts</span> <span class="o">=</span> <span class="n">_tfg_gg</span><span class="o">.</span><span class="n">CoordShift</span><span class="p">(</span><span class="n">Pts</span><span class="p">,</span> <span class="n">In</span><span class="o">=</span><span class="n">In</span><span class="p">,</span> <span class="n">Out</span><span class="o">=</span><span class="s">&#39;(X,Y,Z)&#39;</span><span class="p">,</span> <span class="n">CrossRef</span><span class="o">=</span><span class="n">CrossRef</span><span class="p">)</span>
        <span class="n">LOPolys</span> <span class="o">=</span> <span class="p">[</span><span class="n">oo</span><span class="o">.</span><span class="n">Poly</span> <span class="k">for</span> <span class="n">oo</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Optics</span><span class="p">]</span>
        <span class="n">LOnIns</span> <span class="o">=</span> <span class="p">[</span><span class="n">oo</span><span class="o">.</span><span class="n">nIn</span> <span class="k">for</span> <span class="n">oo</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Optics</span><span class="p">]</span>
        <span class="n">LOBaryS</span> <span class="o">=</span> <span class="p">[</span><span class="n">oo</span><span class="o">.</span><span class="n">BaryS</span> <span class="k">for</span> <span class="n">oo</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Optics</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">_tfg_c</span><span class="o">.</span><span class="n">_Detect_SAngVect_Points</span><span class="p">(</span><span class="n">Pts</span><span class="p">,</span> <span class="n">DPoly</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Poly</span><span class="p">,</span> <span class="n">DBaryS</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">BaryS</span><span class="p">,</span> <span class="n">DnIn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nIn</span><span class="p">,</span> <span class="n">LOBaryS</span><span class="o">=</span><span class="n">LOBaryS</span><span class="p">,</span> <span class="n">LOnIns</span><span class="o">=</span><span class="n">LOnIns</span><span class="p">,</span> <span class="n">LOPolys</span><span class="o">=</span><span class="n">LOPolys</span><span class="p">,</span> <span class="n">SAngPlane</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_SAngPlane</span><span class="p">,</span> <span class="n">Lens_ConeTip</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_Optics_Lens_ConeTip</span><span class="p">,</span> <span class="n">Lens_ConeHalfAng</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_Optics_Lens_ConeHalfAng</span><span class="p">,</span> <span class="n">RadL</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Optics</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Rad</span><span class="p">,</span> <span class="n">RadD</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Rad</span><span class="p">,</span> <span class="n">F1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Optics</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">F1</span><span class="p">,</span> <span class="n">thet</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">NP</span><span class="p">),</span> <span class="n">OpType</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">OpticsType</span><span class="p">,</span> <span class="n">VPoly</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">Poly</span><span class="p">,</span> <span class="n">VVin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">Vin</span><span class="p">,</span> <span class="n">DLong</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">DLong</span><span class="p">,</span> <span class="n">VType</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">Type</span><span class="p">,</span> <span class="n">Cone_PolyCrossbis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_Cone_PolyCrossbis</span><span class="p">,</span> <span class="n">Cone_PolyHorbis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_Cone_PolyHorbis</span><span class="p">,</span> <span class="n">TorAngRef</span><span class="o">=</span><span class="n">CrossRef</span><span class="p">,</span> <span class="n">Colis</span><span class="o">=</span><span class="n">Colis</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="n">Test</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_get_SAngIntMax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Proj</span><span class="o">=</span><span class="s">&#39;Cross&#39;</span><span class="p">,</span> <span class="n">SAng</span><span class="o">=</span><span class="s">&#39;Int&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the Int or Max of the SAng in a cross-section or horizontal projection &quot;&quot;&quot;</span>
        <span class="n">CrossRef</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_LOSRef</span><span class="p">][</span><span class="s">&#39;PRef&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_LOSRef</span><span class="p">][</span><span class="s">&#39;PRef&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">Type</span><span class="o">==</span><span class="s">&#39;Tor&#39;</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_LOSRef</span><span class="p">][</span><span class="s">&#39;PRef&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">_tfg_c</span><span class="o">.</span><span class="n">_Detect_get_SAngIntMax</span><span class="p">(</span><span class="n">SAngCross_Reg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_SAngCross_Reg</span><span class="p">,</span> <span class="n">SAngCross_Points</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_SAngCross_Points</span><span class="p">,</span> <span class="n">SAngCross_Reg_K</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_SAngCross_Reg_K</span><span class="p">,</span> <span class="n">SAngCross_Reg_Psi</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_SAngCross_Reg_Psi</span><span class="p">,</span> <span class="n">SAngCross_Reg_Int</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_SAngCross_Reg_Int</span><span class="p">,</span> <span class="n">SAngCross_Int</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_SAngCross_Int</span><span class="p">,</span> <span class="n">SAngCross_Max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_SAngCross_Max</span><span class="p">,</span> <span class="n">SAngHor_Points</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_SAngHor_Points</span><span class="p">,</span> <span class="n">SAngHor_Int</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_SAngHor_Int</span><span class="p">,</span> <span class="n">SAngHor_Max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_SAngHor_Max</span><span class="p">,</span> <span class="n">Cone_PolyCrossbis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_Cone_PolyCrossbis</span><span class="p">,</span> <span class="n">Cone_PolyHorbis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_Cone_PolyHorbis</span><span class="p">,</span> <span class="n">TorAngRef</span><span class="o">=</span><span class="n">CrossRef</span><span class="p">,</span> <span class="n">DBaryS</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">BaryS</span><span class="p">,</span> <span class="n">LOSPOut</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_LOSRef</span><span class="p">][</span><span class="s">&#39;LOS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">POut</span><span class="p">,</span> <span class="n">Proj</span><span class="o">=</span><span class="n">Proj</span><span class="p">,</span> <span class="n">SAng</span><span class="o">=</span><span class="n">SAng</span><span class="p">,</span> <span class="n">VType</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">Type</span><span class="p">)</span>



<div class="viewcode-block" id="Detect.set_SigPrecomp"><a class="viewcode-back" href="../../../Auto_tofu.geom.html#tofu.geom.Detect.set_SigPrecomp">[docs]</a>    <span class="k">def</span> <span class="nf">set_SigPrecomp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">CalcPreComp</span><span class="o">=</span><span class="k">True</span><span class="p">,</span> <span class="n">dX12</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">dX12Mode</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">ds</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">dsMode</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">MarginS</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Colis</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Precompute a 3D grid for fast integration of a 3D emissivity for a synthetic diagnostic approach</span>

<span class="sd">        In order to accelerate the computation of synthetic signal from simulated emissivity, it is possible to pre-compute a discretisation of the VOS (mesh points + solid angle) and store it as an attribute of the Detect object.</span>
<span class="sd">        While such pre-computation does speed-up significantly the numerical integration, it also burdens the object with heavy attributes that can make it too big to save.</span>
<span class="sd">        Hence, the saving method has a special argument that allows to specify that these pre-computed attributes should not be saved but should instead be re-computed automatically when loading the file.</span>
<span class="sd">        The parameters dX12, dX12Mode, ds and dsMode give the user control over how fine the discretization of the VOS should be, which affects both the accuracy of the numerical integration and the size of the resulting mesh.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        CalcPreComp :   bool</span>
<span class="sd">            Flag indicating whether the pre-computation should be run</span>
<span class="sd">        dX12 :          list</span>
<span class="sd">            Array of the 2 resolutions to be used to define the grid in a plane perpendicular to the LOS</span>
<span class="sd">        dX12Mode :      str</span>
<span class="sd">            Flag specifying whether the values in dX12 are absolute distances or relative values (i.e. fraction of the total width [0;1])</span>
<span class="sd">        ds :            float</span>
<span class="sd">            Float indicating the resolution in the longitudinal direction</span>
<span class="sd">        dsMode :        str</span>
<span class="sd">            Flag specifying whether ds is an absolute distance or relative (i.e. fraction of the total length [0;1])</span>
<span class="sd">        MarginS :       float</span>
<span class="sd">            Float specifying</span>
<span class="sd">        Colis :         bool</span>
<span class="sd">            Flag indicating whether collision detection should be used</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">CalcPreComp</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="o">==</span><span class="s">&#39;Impossible !&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOS</span> <span class="ow">is</span> <span class="k">None</span><span class="p">):</span>
            <span class="nb">print</span> <span class="s">&quot;    &quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Name</span><span class="o">+</span><span class="s">&quot; : Pre-computing 3D matrix for synthetic diag...&quot;</span>

            <span class="n">LOPolys</span> <span class="o">=</span> <span class="p">[</span><span class="n">oo</span><span class="o">.</span><span class="n">Poly</span> <span class="k">for</span> <span class="n">oo</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Optics</span><span class="p">]</span>
            <span class="n">LOBaryS</span> <span class="o">=</span> <span class="p">[</span><span class="n">oo</span><span class="o">.</span><span class="n">BaryS</span> <span class="k">for</span> <span class="n">oo</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Optics</span><span class="p">]</span>
            <span class="n">LOnIns</span> <span class="o">=</span> <span class="p">[</span><span class="n">oo</span><span class="o">.</span><span class="n">nIn</span> <span class="k">for</span> <span class="n">oo</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Optics</span><span class="p">]</span>
            <span class="n">LOSD</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_LOSRef</span><span class="p">][</span><span class="s">&#39;LOS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">D</span>
            <span class="n">LOSu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_LOSRef</span><span class="p">][</span><span class="s">&#39;LOS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">u</span>
            <span class="n">thet</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Poly</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">CrossRef</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_LOSRef</span><span class="p">][</span><span class="s">&#39;PRef&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_LOSRef</span><span class="p">][</span><span class="s">&#39;PRef&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">Type</span><span class="o">==</span><span class="s">&#39;Tor&#39;</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_LOSRef</span><span class="p">][</span><span class="s">&#39;PRef&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SynthDiag_Done</span><span class="p">:</span>
                <span class="n">dX12</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">DetSynthdX12</span> <span class="k">if</span> <span class="n">dX12</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SynthDiag_dX12</span>
                <span class="n">dX12Mode</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">DetSynthdX12Mode</span> <span class="k">if</span> <span class="n">dX12Mode</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SynthDiag_dX12Mode</span>
                <span class="n">ds</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">DetSynthds</span> <span class="k">if</span> <span class="n">ds</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SynthDiag_ds</span>
                <span class="n">dsMode</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">DetSynthdsMode</span> <span class="k">if</span> <span class="n">dsMode</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SynthDiag_dsMode</span>
                <span class="n">MarginS</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">DetSynthMarginS</span> <span class="k">if</span> <span class="n">MarginS</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SynthDiag_MarginS</span>
                <span class="n">Colis</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">DetCalcSAngVectColis</span> <span class="k">if</span> <span class="n">Colis</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SynthDiag_Colis</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dX12</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">DetSynthdX12</span> <span class="k">if</span> <span class="n">dX12</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">else</span> <span class="n">dX12</span>
                <span class="n">dX12Mode</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">DetSynthdX12Mode</span> <span class="k">if</span> <span class="n">dX12Mode</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">else</span> <span class="n">dX12Mode</span>
                <span class="n">ds</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">DetSynthds</span> <span class="k">if</span> <span class="n">ds</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">else</span> <span class="n">ds</span>
                <span class="n">dsMode</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">DetSynthdsMode</span> <span class="k">if</span> <span class="n">dsMode</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">else</span> <span class="n">dsMode</span>
                <span class="n">MarginS</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">DetSynthMarginS</span> <span class="k">if</span> <span class="n">MarginS</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">else</span> <span class="n">MarginS</span>
                <span class="n">Colis</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">DetCalcSAngVectColis</span> <span class="k">if</span> <span class="n">Colis</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">else</span> <span class="n">Colis</span>

            <span class="n">Out</span> <span class="o">=</span> <span class="n">_tfg_c</span><span class="o">.</span><span class="n">_Detect_set_SigPrecomp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Poly</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">BaryS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nIn</span><span class="p">,</span> <span class="n">LOPolys</span><span class="p">,</span> <span class="n">LOBaryS</span><span class="p">,</span> <span class="n">LOnIns</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SAngPlane</span><span class="p">,</span> <span class="n">LOSD</span><span class="o">=</span><span class="n">LOSD</span><span class="p">,</span> <span class="n">LOSu</span><span class="o">=</span><span class="n">LOSu</span><span class="p">,</span> <span class="n">Span_k</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_Span_k</span><span class="p">,</span> <span class="n">ConeWidth_k</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ConeWidth_k</span><span class="p">,</span> <span class="n">ConeWidth_X1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ConeWidth_X1</span><span class="p">,</span>
                    <span class="n">ConeWidth_X2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ConeWidth_X2</span><span class="p">,</span> <span class="n">Cone_PolyCrossbis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_Cone_PolyCrossbis</span><span class="p">,</span> <span class="n">Cone_PolyHorbis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_Cone_PolyHorbis</span><span class="p">,</span>
                    <span class="n">Lens_ConeTip</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_Optics_Lens_ConeTip</span><span class="p">,</span> <span class="n">Lens_ConeHalfAng</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_Optics_Lens_ConeHalfAng</span><span class="p">,</span> <span class="n">RadL</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Optics</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Rad</span><span class="p">,</span> <span class="n">RadD</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Rad</span><span class="p">,</span> <span class="n">F1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Optics</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">F1</span><span class="p">,</span> <span class="n">thet</span><span class="o">=</span><span class="n">thet</span><span class="p">,</span>
                    <span class="n">VPoly</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">Poly</span><span class="p">,</span> <span class="n">VVin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">Vin</span><span class="p">,</span> <span class="n">DLong</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">DLong</span><span class="p">,</span> <span class="n">CrossRef</span><span class="o">=</span><span class="n">CrossRef</span><span class="p">,</span> <span class="n">dX12</span><span class="o">=</span><span class="n">dX12</span><span class="p">,</span> <span class="n">dX12Mode</span><span class="o">=</span><span class="n">dX12Mode</span><span class="p">,</span> <span class="n">ds</span><span class="o">=</span><span class="n">ds</span><span class="p">,</span> <span class="n">dsMode</span><span class="o">=</span><span class="n">dsMode</span><span class="p">,</span> <span class="n">MarginS</span><span class="o">=</span><span class="n">MarginS</span><span class="p">,</span> <span class="n">VType</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">Type</span><span class="p">,</span> <span class="n">OpType</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">OpticsType</span><span class="p">,</span> <span class="n">Colis</span><span class="o">=</span><span class="n">Colis</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_SynthDiag_Points</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SynthDiag_SAng</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SynthDiag_Vect</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SynthDiag_dV</span> <span class="o">=</span> <span class="n">Out</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Out</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">Out</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">Out</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_SynthDiag_ds</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SynthDiag_dsMode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SynthDiag_MarginS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SynthDiag_dX12</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SynthDiag_dX12Mode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SynthDiag_Colis</span> <span class="o">=</span> <span class="n">Out</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">Out</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">Out</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">Out</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="n">Out</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">Out</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_SynthDiag_Done</span> <span class="o">=</span> <span class="k">True</span></div>

    <span class="k">def</span> <span class="nf">_reset_SynthDiag</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_SynthDiag_Points</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SynthDiag_SAng</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SynthDiag_Vect</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SynthDiag_dV</span> <span class="o">=</span> <span class="k">None</span><span class="p">,</span> <span class="k">None</span><span class="p">,</span> <span class="k">None</span><span class="p">,</span> <span class="k">None</span>

<div class="viewcode-block" id="Detect.calc_Sig"><a class="viewcode-back" href="../../../Auto_tofu.geom.html#tofu.geom.Detect.calc_Sig">[docs]</a>    <span class="k">def</span> <span class="nf">calc_Sig</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ff</span><span class="p">,</span> <span class="n">extargs</span><span class="o">=</span><span class="p">{},</span> <span class="n">Method</span><span class="o">=</span><span class="s">&#39;Vol&#39;</span><span class="p">,</span> <span class="n">Mode</span><span class="o">=</span><span class="s">&#39;simps&#39;</span><span class="p">,</span> <span class="n">PreComp</span><span class="o">=</span><span class="k">True</span><span class="p">,</span>
            <span class="n">epsrel</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetSynthEpsrel</span><span class="p">,</span> <span class="n">dX12</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetSynthdX12</span><span class="p">,</span> <span class="n">dX12Mode</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetSynthdX12Mode</span><span class="p">,</span> <span class="n">ds</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetSynthds</span><span class="p">,</span> <span class="n">dsMode</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetSynthdsMode</span><span class="p">,</span> <span class="n">MarginS</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetSynthMarginS</span><span class="p">,</span> <span class="n">Colis</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetCalcSAngVectColis</span><span class="p">,</span>  <span class="n">Test</span><span class="o">=</span><span class="k">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the signal computed from an input emissivity function, using a 3D or LOS method</span>

<span class="sd">        The synthetic signal resulting from a simulated emissivity can be computed automatically in several ways.</span>
<span class="sd">        The user can choose between a VOS and a LOS approach (volume integration or line integration with etendue).</span>
<span class="sd">        In each case the user can choose between the numerical integration method (from scipy.integrate + np.sum()).</span>
<span class="sd">        It is possible to specify that, for a VOS approach, you want to use the pre-conputed mesh for faster computation (see :meth:`~tofu.geom.Detect.set_SigPrecomp`).</span>
<span class="sd">        For a VOS approach, the user can specify how fine the discretization should be.</span>
<span class="sd">        The collision detection with the edges of the :class:`~tofu.geom.Ves` object can be switched off (not recommended).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ff :        function</span>
<span class="sd">            Input emissiviy function, should take one input as follows:</span>
<span class="sd">                * ff(Pts), where Points is a np.ndarray of shape=(3,N), with the (X,Y,Z) coordinates of any N number of points</span>
<span class="sd">        Method :    str</span>
<span class="sd">            Flag indicating whether the spatial integration should be done with a volume (&#39;Vol&#39;) or a LOS (&#39;LOS&#39;) approach</span>
<span class="sd">        Mode :      str</span>
<span class="sd">            Flag indicating the numerical integration method in [&#39;quad&#39;,&#39;simps&#39;,&#39;trapz&#39;,&#39;nptrapz&#39;,&#39;sum&#39;]</span>
<span class="sd">        PreComp :   bool</span>
<span class="sd">            Flag indicating whether the pre-computed grid should be used</span>
<span class="sd">        epsrel :    float</span>
<span class="sd">            Float specifying the tolerated relative error on the numerical integration, used for &#39;quad&#39;</span>
<span class="sd">        dX12 :      list</span>
<span class="sd">            Array of the 2 resolutions to be used to define the grid in a plane perpendicular to the LOS</span>
<span class="sd">        dX12Mode :  str</span>
<span class="sd">            Flag specifying whether the values in dX12 are absolute distances or relative values (i.e. fraction of the total width [0;1])</span>
<span class="sd">        ds :        float</span>
<span class="sd">            Float indicating the resolution in the longitudinal direction</span>
<span class="sd">        dsMode :    str</span>
<span class="sd">            Flag specifying whether ds is an absolute distance or relative (i.e. fraction of the total length [0;1])</span>
<span class="sd">        Colis :     bool</span>
<span class="sd">            Flag indicating whether collision detection should be used</span>
<span class="sd">        Test :      bool</span>
<span class="sd">            Flag indicating whether the inputs should be tested for conformity</span>

<span class="sd">        Returns</span>
<span class="sd">        --------</span>
<span class="sd">        Sig :       float</span>
<span class="sd">            The computed signal</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># * ff(Pts, Vect), where Vect is a np.ndarray of shape=(3,N) with the (X,Y,Z) coordinates of a vector indicating the direction in which photons are emitted</span>
        <span class="k">if</span> <span class="n">PreComp</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">Method</span><span class="o">==</span><span class="s">&#39;LOS&#39;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SynthDiag_ds</span> <span class="ow">is</span> <span class="k">None</span><span class="p">,</span> <span class="s">&quot;The precomputed matrix shall be computed before using it..... &quot;</span>

        <span class="n">LOPolys</span> <span class="o">=</span> <span class="p">[</span><span class="n">oo</span><span class="o">.</span><span class="n">Poly</span> <span class="k">for</span> <span class="n">oo</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Optics</span><span class="p">]</span>
        <span class="n">LOBaryS</span> <span class="o">=</span> <span class="p">[</span><span class="n">oo</span><span class="o">.</span><span class="n">BaryS</span> <span class="k">for</span> <span class="n">oo</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Optics</span><span class="p">]</span>
        <span class="n">LOnIn</span> <span class="o">=</span> <span class="p">[</span><span class="n">oo</span><span class="o">.</span><span class="n">nIn</span> <span class="k">for</span> <span class="n">oo</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Optics</span><span class="p">]</span>
        <span class="n">LOSD</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_LOSRef</span><span class="p">][</span><span class="s">&#39;LOS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">D</span>
        <span class="n">LOSu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_LOSRef</span><span class="p">][</span><span class="s">&#39;LOS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">u</span>
        <span class="n">LOSkPIn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_LOSRef</span><span class="p">][</span><span class="s">&#39;LOS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">kPIn</span>
        <span class="n">LOSkPOut</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_LOSRef</span><span class="p">][</span><span class="s">&#39;LOS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">kPOut</span>
        <span class="n">LOSEtend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_LOSRef</span><span class="p">][</span><span class="s">&#39;Etend&#39;</span><span class="p">]</span>
        <span class="n">thet</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Poly</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">CrossRef</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_LOSRef</span><span class="p">][</span><span class="s">&#39;PRef&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_LOSRef</span><span class="p">][</span><span class="s">&#39;PRef&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">Type</span><span class="o">==</span><span class="s">&#39;Tor&#39;</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_LOSRef</span><span class="p">][</span><span class="s">&#39;PRef&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">Sig</span> <span class="o">=</span> <span class="n">_tfg_c</span><span class="o">.</span><span class="n">_Detect_SigSynthDiag</span><span class="p">(</span><span class="n">ff</span><span class="p">,</span> <span class="n">extargs</span><span class="o">=</span><span class="n">extargs</span><span class="p">,</span> <span class="n">Method</span><span class="o">=</span><span class="n">Method</span><span class="p">,</span> <span class="n">Mode</span><span class="o">=</span><span class="n">Mode</span><span class="p">,</span> <span class="n">PreComp</span><span class="o">=</span><span class="n">PreComp</span><span class="p">,</span>
            <span class="n">DPoly</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Poly</span><span class="p">,</span> <span class="n">DBaryS</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">BaryS</span><span class="p">,</span> <span class="n">DnIn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nIn</span><span class="p">,</span> <span class="n">LOPolys</span><span class="o">=</span><span class="n">LOPolys</span><span class="p">,</span> <span class="n">LOBaryS</span><span class="o">=</span><span class="n">LOBaryS</span><span class="p">,</span> <span class="n">LOnIn</span><span class="o">=</span><span class="n">LOnIn</span><span class="p">,</span> <span class="n">Lens_ConeTip</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_Optics_Lens_ConeTip</span><span class="p">,</span> <span class="n">Lens_ConeHalfAng</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_Optics_Lens_ConeHalfAng</span><span class="p">,</span>
            <span class="n">RadL</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Optics</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Rad</span><span class="p">,</span> <span class="n">RadD</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Rad</span><span class="p">,</span> <span class="n">F1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Optics</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">F1</span><span class="p">,</span> <span class="n">thet</span><span class="o">=</span><span class="n">thet</span><span class="p">,</span> <span class="n">OpType</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">OpticsType</span><span class="p">,</span>
            <span class="n">LOSD</span><span class="o">=</span><span class="n">LOSD</span><span class="p">,</span> <span class="n">LOSu</span><span class="o">=</span><span class="n">LOSu</span><span class="p">,</span> <span class="n">LOSkPIn</span><span class="o">=</span><span class="n">LOSkPIn</span><span class="p">,</span> <span class="n">LOSkPOut</span><span class="o">=</span><span class="n">LOSkPOut</span><span class="p">,</span> <span class="n">LOSEtend</span><span class="o">=</span><span class="n">LOSEtend</span><span class="p">,</span> <span class="n">Span_k</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_Span_k</span><span class="p">,</span> <span class="n">ConeWidth_X1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ConeWidth_X1</span><span class="p">,</span> <span class="n">ConeWidth_X2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ConeWidth_X2</span><span class="p">,</span> <span class="n">SAngPlane</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_SAngPlane</span><span class="p">,</span> <span class="n">CrossRef</span><span class="o">=</span><span class="n">CrossRef</span><span class="p">,</span>
            <span class="n">Cone_PolyCrossbis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_Cone_PolyCrossbis</span><span class="p">,</span> <span class="n">Cone_PolyHorbis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_Cone_PolyHorbis</span><span class="p">,</span> <span class="n">VPoly</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">Poly</span><span class="p">,</span>  <span class="n">VVin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">Vin</span><span class="p">,</span> <span class="n">VType</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">Type</span><span class="p">,</span>
            <span class="n">SynthDiag_Points</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_SynthDiag_Points</span><span class="p">,</span> <span class="n">SynthDiag_SAng</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_SynthDiag_SAng</span><span class="p">,</span> <span class="n">SynthDiag_Vect</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_SynthDiag_Vect</span><span class="p">,</span> <span class="n">SynthDiag_dV</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_SynthDiag_dV</span><span class="p">,</span>
            <span class="n">SynthDiag_dX12</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_SynthDiag_dX12</span><span class="p">,</span> <span class="n">SynthDiag_dX12Mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_SynthDiag_dX12Mode</span><span class="p">,</span> <span class="n">SynthDiag_ds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_SynthDiag_ds</span><span class="p">,</span>
            <span class="n">SynthDiag_dsMode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_SynthDiag_dsMode</span><span class="p">,</span> <span class="n">SynthDiag_MarginS</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_SynthDiag_MarginS</span><span class="p">,</span> <span class="n">SynthDiag_Colis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_SynthDiag_Colis</span><span class="p">,</span>
            <span class="n">epsrel</span><span class="o">=</span><span class="n">epsrel</span><span class="p">,</span> <span class="n">dX12</span><span class="o">=</span><span class="n">dX12</span><span class="p">,</span> <span class="n">dX12Mode</span><span class="o">=</span><span class="n">dX12Mode</span><span class="p">,</span> <span class="n">ds</span><span class="o">=</span><span class="n">ds</span><span class="p">,</span> <span class="n">dsMode</span><span class="o">=</span><span class="n">dsMode</span><span class="p">,</span> <span class="n">MarginS</span><span class="o">=</span><span class="n">MarginS</span><span class="p">,</span> <span class="n">Colis</span><span class="o">=</span><span class="n">Colis</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="n">Test</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Sig</span></div>

    <span class="k">def</span> <span class="nf">_debug_Etendue_BenchmarkRatioMode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">RelErr</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetEtendepsrel</span><span class="p">,</span> <span class="n">Ratio</span><span class="o">=</span><span class="p">[</span><span class="mf">0.01</span><span class="p">,</span><span class="mf">0.05</span><span class="p">,</span><span class="mf">0.2</span><span class="p">,</span><span class="mf">0.5</span><span class="p">],</span> <span class="n">Modes</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;simps&#39;</span><span class="p">,</span><span class="s">&#39;trapz&#39;</span><span class="p">,</span><span class="s">&#39;quad&#39;</span><span class="p">],</span> <span class="n">dX12</span><span class="o">=</span><span class="p">[</span><span class="mf">0.002</span><span class="p">,</span><span class="mf">0.002</span><span class="p">],</span> <span class="n">dX12Mode</span><span class="o">=</span><span class="s">&#39;abs&#39;</span><span class="p">,</span> <span class="n">Colis</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetCalcEtendColis</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the etendue computed 3 different numerical integration methods, with or without collisions, with more or less margin for the perpendicular plane size (Ratio)</span>

<span class="sd">        USed for debugging, compute the etendue with various values of the Ratio (extra margin for the integration intervals), to check it does not affect the computed value</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        RelErr :        float</span>
<span class="sd">            Float specifying the tolerated relative error on the numerical integration, used for &#39;quad&#39;</span>
<span class="sd">        Ratio :         list</span>
<span class="sd">            Array of values in [0,1] specifying margin to be used to define the edges of the perpendicular plane</span>
<span class="sd">        Colis :         bool</span>
<span class="sd">            Flag indicating whether collision detection should be used</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        EtendSimps :    np.ndarray</span>
<span class="sd">            (NLos,NRatio) array of the computed etendues with numerical integration &#39;simps&#39;, where NLos is the number of LOS of Detect and NRatio=len(Ratio)</span>
<span class="sd">        EtendTrapz :    np.ndarray</span>
<span class="sd">            (NLos,NRatio) array of the computed etendues with numerical integration &#39;trapz&#39;, where NLos is the number of LOS of Detect and NRatio=len(Ratio)</span>
<span class="sd">        EtendQuad :     np.ndarray</span>
<span class="sd">            (NLos,NRatio) array of the computed etendues with numerical integration &#39;quad&#39;, where NLos is the number of LOS of Detect and NRatio=len(Ratio)</span>
<span class="sd">        Keys :          list</span>
<span class="sd">            List of the available LOS</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="o">==</span><span class="s">&#39;Impossible !&#39;</span><span class="p">:</span>
            <span class="n">Keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="n">NLOS</span><span class="p">,</span> <span class="n">NR</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Keys</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">Ratio</span><span class="p">)</span>
            <span class="n">Etends</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="n">Modes</span><span class="p">:</span>
                <span class="n">Etends</span><span class="p">[</span><span class="n">kk</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">NLOS</span><span class="p">,</span><span class="n">NR</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">NLOS</span><span class="p">):</span>
                    <span class="n">PRef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="p">[</span><span class="n">Keys</span><span class="p">[</span><span class="n">jj</span><span class="p">]][</span><span class="s">&#39;PRef&#39;</span><span class="p">]</span>
                    <span class="n">LOSu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="p">[</span><span class="n">Keys</span><span class="p">[</span><span class="n">jj</span><span class="p">]][</span><span class="s">&#39;LOS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">u</span>
                    <span class="n">e1</span><span class="p">,</span> <span class="n">e2</span> <span class="o">=</span> <span class="n">_tfg_gg</span><span class="o">.</span><span class="n">Calc_DefaultCheck_e1e2_PLane_1D</span><span class="p">(</span><span class="n">PRef</span><span class="p">,</span> <span class="n">LOSu</span><span class="p">)</span>
                    <span class="n">PRef</span> <span class="o">=</span> <span class="n">PRef</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
                    <span class="n">LOSu</span> <span class="o">=</span> <span class="n">LOSu</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
                    <span class="n">e1</span><span class="p">,</span> <span class="n">e2</span> <span class="o">=</span> <span class="n">e1</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">e2</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
                    <span class="n">LOPolys</span> <span class="o">=</span> <span class="p">[</span><span class="n">oo</span><span class="o">.</span><span class="n">Poly</span> <span class="k">for</span> <span class="n">oo</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Optics</span><span class="p">]</span>
                    <span class="n">LOBaryS</span> <span class="o">=</span> <span class="p">[</span><span class="n">oo</span><span class="o">.</span><span class="n">BaryS</span> <span class="k">for</span> <span class="n">oo</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Optics</span><span class="p">]</span>
                    <span class="n">LOnIn</span> <span class="o">=</span> <span class="p">[</span><span class="n">oo</span><span class="o">.</span><span class="n">nIn</span> <span class="k">for</span> <span class="n">oo</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Optics</span><span class="p">]</span>
                    <span class="n">LOSurfs</span> <span class="o">=</span> <span class="p">[</span><span class="n">oo</span><span class="o">.</span><span class="n">Surf</span> <span class="k">for</span> <span class="n">oo</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Optics</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">Ratio</span><span class="p">)):</span>
                        <span class="nb">print</span> <span class="s">&quot;    ...Computing Etendue with integration method&quot;</span><span class="p">,</span> <span class="n">kk</span><span class="p">,</span> <span class="s">&quot; for LOS &quot;</span><span class="p">,</span> <span class="n">Keys</span><span class="p">[</span><span class="n">jj</span><span class="p">],</span> <span class="s">&quot; and Ratio=&quot;</span><span class="p">,</span> <span class="n">Ratio</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
                        <span class="n">Etends</span><span class="p">[</span><span class="n">kk</span><span class="p">][</span><span class="n">jj</span><span class="p">,</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">_tfg_c</span><span class="o">.</span><span class="n">Calc_Etendue_PlaneLOS</span><span class="p">(</span><span class="n">PRef</span><span class="p">,</span> <span class="n">LOSu</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Poly</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">BaryS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nIn</span><span class="p">,</span> <span class="n">LOPolys</span><span class="p">,</span> <span class="n">LOnIn</span><span class="p">,</span> <span class="n">LOSurfs</span><span class="p">,</span> <span class="n">LOBaryS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SAngPlane</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">Poly</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">Vin</span><span class="p">,</span> <span class="n">DLong</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">DLong</span><span class="p">,</span>
                                <span class="n">Lens_ConeTip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Optics_Lens_ConeTip</span><span class="p">,</span> <span class="n">Lens_ConeHalfAng</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_Optics_Lens_ConeHalfAng</span><span class="p">,</span> <span class="n">RadL</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Optics</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Rad</span><span class="p">,</span> <span class="n">RadD</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Rad</span><span class="p">,</span> <span class="n">F1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Optics</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">F1</span><span class="p">,</span>
                                <span class="n">OpType</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">OpticsType</span><span class="p">,</span> <span class="n">VType</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">Type</span><span class="p">,</span> <span class="n">Mode</span><span class="o">=</span><span class="n">kk</span><span class="p">,</span> <span class="n">e1</span><span class="o">=</span><span class="n">e1</span><span class="p">,</span> <span class="n">e2</span><span class="o">=</span><span class="n">e2</span><span class="p">,</span> <span class="n">epsrel</span><span class="o">=</span><span class="n">RelErr</span><span class="p">,</span> <span class="n">Ratio</span><span class="o">=</span><span class="n">Ratio</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">dX12</span><span class="o">=</span><span class="n">dX12</span><span class="p">,</span> <span class="n">dX12Mode</span><span class="o">=</span><span class="n">dX12Mode</span><span class="p">,</span> <span class="n">Colis</span><span class="o">=</span><span class="n">Colis</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="k">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">Etends</span><span class="p">,</span> <span class="n">Ratio</span><span class="p">,</span> <span class="n">RelErr</span><span class="p">,</span> <span class="n">dX12</span><span class="p">,</span> <span class="n">dX12Mode</span><span class="p">,</span> <span class="n">Colis</span>


<div class="viewcode-block" id="Detect.calc_Etendue_AlongLOS"><a class="viewcode-back" href="../../../Auto_tofu.geom.html#tofu.geom.Detect.calc_Etendue_AlongLOS">[docs]</a>    <span class="k">def</span> <span class="nf">calc_Etendue_AlongLOS</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Length</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">NP</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetEtendOnLOSNP</span><span class="p">,</span> <span class="n">Modes</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;trapz&#39;</span><span class="p">,</span><span class="s">&#39;quad&#39;</span><span class="p">],</span> <span class="n">RelErr</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetEtendepsrel</span><span class="p">,</span> <span class="n">dX12</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetSynthdX12</span><span class="p">,</span> <span class="n">dX12Mode</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetSynthdX12Mode</span><span class="p">,</span> <span class="n">Ratio</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetEtendRatio</span><span class="p">,</span>
            <span class="n">Colis</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetSAngColis</span><span class="p">,</span> <span class="n">LOSRef</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="k">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the etendue computed at different points along the LOS, with various numerical methods, with or without collision detection</span>

<span class="sd">        Computing the etendue along the LOS of a Detect object can be useful for checking whether the etendue is constant (as it should be if the LOS approximation is to be used).</span>
<span class="sd">        Cases with non-constant etendue include in particular partially obstructed VOS in the divertor region of Tokamaks.</span>
<span class="sd">        Also useful for debugging: if the etendue is not constant but the VOS is not obstructed, something might be wrong with the computation of the etendue or with the model (e.g.: for Lens optics).</span>
<span class="sd">        Indeed, the model implemented for a Lens is ideal, but a close look at the etendue shows that the model is not perfect (but sufficiently accurate for most uses though).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        Length :    str</span>
<span class="sd">            Flag indicating whether to use the full length of the VOS (including partially obstructed parts: &#39;&#39;), or just the length of the LOS unil its exit point (&#39;LOS&#39;).</span>
<span class="sd">        NP :        int</span>
<span class="sd">            Number of points (uniformly distributed along the LOS) where the etendue should be computed</span>
<span class="sd">        Modes :     list or str</span>
<span class="sd">            Flag or list of flags indicating which numerical integration methods shoud be used in [&#39;quad&#39;,&#39;simps&#39;,&#39;trapz&#39;]</span>
<span class="sd">        RelErr :    float</span>
<span class="sd">            For &#39;quad&#39;, a positive float defining the relative tolerance allowed</span>
<span class="sd">        dX12 :      list</span>
<span class="sd">            For &#39;simps&#39; or &#39;trapz&#39;, a list of 2 floats defining the resolution of the sampling in X1 and X2</span>
<span class="sd">        dX12Mode :  str</span>
<span class="sd">            For &#39;simps&#39; or&#39;trapz&#39;, &#39;rel&#39; or &#39;abs&#39;, if &#39;rel&#39; the resolution dX12 is in dimensionless units in [0;1] (hence a value of 0.1 means 10 discretisation points between the extremes), if &#39;abs&#39; dX12 is in meters</span>
<span class="sd">        Ratio :     float</span>
<span class="sd">            A float specifying the relative margin to be taken for integration boundaries</span>
<span class="sd">        Colis :     bool</span>
<span class="sd">            Flag indicating whether collision detection should be used</span>
<span class="sd">        LOSRef :    None or str</span>
<span class="sd">            Flag indicating which LOS should be used</span>
<span class="sd">        Test :      bool</span>
<span class="sd">            Flag indicating whether the inputs should be tested for conformity</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Etend :     np.ndarray</span>
<span class="sd">            Computed etendues</span>
<span class="sd">        Pts :       np.ndarray</span>
<span class="sd">            (3,NP) array specifying the 3D (X,Y,Z) coordinates of the points along the LOS where the etendue was computed</span>
<span class="sd">        kPts :      np.ndarray</span>
<span class="sd">            (NP,) array of the distance-coordinate k along the LOS</span>
<span class="sd">        LOSRef :    str</span>
<span class="sd">            The LOS that was used</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">Test</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">Modes</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;quad&#39;</span><span class="p">,</span><span class="s">&#39;simps&#39;</span><span class="p">,</span><span class="s">&#39;trapz&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">Modes</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">([</span><span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;quad&#39;</span><span class="p">,</span><span class="s">&#39;simps&#39;</span><span class="p">,</span><span class="s">&#39;trapz&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="n">Modes</span><span class="p">])),</span> <span class="s">&quot;Arg Modes must be a list of Modes to be used (&#39;quad&#39;, &#39;simps&#39; or &#39;trapz&#39;) !&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">Modes</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">Modes</span> <span class="o">=</span> <span class="p">[</span><span class="n">Modes</span><span class="p">]</span>
        <span class="n">NMod</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Modes</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="o">==</span><span class="s">&#39;Impossible !&#39;</span><span class="p">:</span>
            <span class="n">LOSRef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_LOSRef</span> <span class="k">if</span> <span class="n">LOSRef</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">else</span> <span class="n">LOSRef</span>
            <span class="n">RelErr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="p">[</span><span class="n">LOSRef</span><span class="p">][</span><span class="s">&#39;Etend_RelErr&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s">&#39;quad&#39;</span> <span class="ow">in</span> <span class="n">Modes</span> <span class="ow">and</span> <span class="n">RelErr</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">else</span> <span class="n">RelErr</span>
            <span class="n">dX12</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="p">[</span><span class="n">LOSRef</span><span class="p">][</span><span class="s">&#39;Etend_dX12&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="p">(</span><span class="n">Modes</span><span class="o">==</span><span class="s">&#39;quad&#39;</span> <span class="ow">or</span> <span class="n">Modes</span><span class="o">==</span><span class="p">[</span><span class="s">&#39;quad&#39;</span><span class="p">]))</span> <span class="ow">and</span> <span class="n">dX12</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">else</span> <span class="n">dX12</span>
            <span class="n">dX12Mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="p">[</span><span class="n">LOSRef</span><span class="p">][</span><span class="s">&#39;Etend_dX12Mode&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="p">(</span><span class="n">Modes</span><span class="o">==</span><span class="s">&#39;quad&#39;</span> <span class="ow">or</span> <span class="n">Modes</span><span class="o">==</span><span class="p">[</span><span class="s">&#39;quad&#39;</span><span class="p">]))</span> <span class="ow">and</span> <span class="n">dX12Mode</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">else</span> <span class="n">dX12Mode</span>
            <span class="n">Ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="p">[</span><span class="n">LOSRef</span><span class="p">][</span><span class="s">&#39;Etend_Ratio&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">Ratio</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">else</span> <span class="n">Ratio</span>
            <span class="n">Etends</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="n">PRef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="p">[</span><span class="n">LOSRef</span><span class="p">][</span><span class="s">&#39;PRef&#39;</span><span class="p">]</span>
            <span class="n">LOSu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="p">[</span><span class="n">LOSRef</span><span class="p">][</span><span class="s">&#39;LOS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">u</span>
            <span class="n">e1</span><span class="p">,</span> <span class="n">e2</span> <span class="o">=</span> <span class="n">_tfg_gg</span><span class="o">.</span><span class="n">Calc_DefaultCheck_e1e2_PLane_1D</span><span class="p">(</span><span class="n">PRef</span><span class="p">,</span> <span class="n">LOSu</span><span class="p">)</span>
            <span class="n">LOPolys</span> <span class="o">=</span> <span class="p">[</span><span class="n">oo</span><span class="o">.</span><span class="n">Poly</span> <span class="k">for</span> <span class="n">oo</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Optics</span><span class="p">]</span>
            <span class="n">LOBaryS</span> <span class="o">=</span> <span class="p">[</span><span class="n">oo</span><span class="o">.</span><span class="n">BaryS</span> <span class="k">for</span> <span class="n">oo</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Optics</span><span class="p">]</span>
            <span class="n">LOnIn</span> <span class="o">=</span> <span class="p">[</span><span class="n">oo</span><span class="o">.</span><span class="n">nIn</span> <span class="k">for</span> <span class="n">oo</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Optics</span><span class="p">]</span>
            <span class="n">LOSurfs</span> <span class="o">=</span> <span class="p">[</span><span class="n">oo</span><span class="o">.</span><span class="n">Surf</span> <span class="k">for</span> <span class="n">oo</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Optics</span><span class="p">]</span>

            <span class="n">k1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="p">[</span><span class="n">LOSRef</span><span class="p">][</span><span class="s">&#39;LOS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">kPIn</span> <span class="k">if</span> <span class="n">Length</span><span class="o">==</span><span class="s">&#39;LOS&#39;</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Span_k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">k2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="p">[</span><span class="n">LOSRef</span><span class="p">][</span><span class="s">&#39;LOS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">kPOut</span> <span class="k">if</span> <span class="n">Length</span><span class="o">==</span><span class="s">&#39;LOS&#39;</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Span_k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">k1</span><span class="p">,</span><span class="n">k2</span><span class="p">,</span><span class="n">NP</span><span class="p">)</span>
            <span class="n">P1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="p">[</span><span class="n">LOSRef</span><span class="p">][</span><span class="s">&#39;LOS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">D</span>
            <span class="n">Ps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">P1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">k</span><span class="o">*</span><span class="n">LOSu</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">P1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">k</span><span class="o">*</span><span class="n">LOSu</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">P1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">k</span><span class="o">*</span><span class="n">LOSu</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span>
            <span class="n">nPs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">LOSu</span><span class="p">,(</span><span class="n">NP</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
            <span class="n">e1</span><span class="p">,</span> <span class="n">e2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">e1</span><span class="p">,(</span><span class="n">NP</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">e2</span><span class="p">,(</span><span class="n">NP</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">NMod</span><span class="p">):</span>
                <span class="nb">print</span> <span class="s">&quot;    ...Computing Etendues of &quot;</span><span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Name</span> <span class="o">+</span><span class="s">&quot; for &quot;</span><span class="p">,</span><span class="n">NP</span><span class="p">,</span><span class="s">&quot; planes with integration method &quot;</span><span class="p">,</span><span class="n">Modes</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
                <span class="n">Etends</span><span class="p">[</span><span class="n">Modes</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span> <span class="o">=</span> <span class="n">_tfg_c</span><span class="o">.</span><span class="n">Calc_Etendue_PlaneLOS</span><span class="p">(</span><span class="n">Ps</span><span class="p">,</span> <span class="n">nPs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Poly</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">BaryS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nIn</span><span class="p">,</span> <span class="n">LOPolys</span><span class="p">,</span> <span class="n">LOnIn</span><span class="p">,</span> <span class="n">LOSurfs</span><span class="p">,</span> <span class="n">LOBaryS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SAngPlane</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">Poly</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">Vin</span><span class="p">,</span> <span class="n">DLong</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">DLong</span><span class="p">,</span> <span class="n">Lens_ConeTip</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_Optics_Lens_ConeTip</span><span class="p">,</span> <span class="n">Lens_ConeHalfAng</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_Optics_Lens_ConeHalfAng</span><span class="p">,</span> <span class="n">RadL</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Optics</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Rad</span><span class="p">,</span> <span class="n">RadD</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Rad</span><span class="p">,</span> <span class="n">F1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Optics</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">F1</span><span class="p">,</span>
                        <span class="n">OpType</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">OpticsType</span><span class="p">,</span> <span class="n">VType</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">Type</span><span class="p">,</span> <span class="n">Mode</span><span class="o">=</span><span class="n">Modes</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">e1</span><span class="o">=</span><span class="n">e1</span><span class="p">,</span> <span class="n">e2</span><span class="o">=</span><span class="n">e2</span><span class="p">,</span> <span class="n">epsrel</span><span class="o">=</span><span class="n">RelErr</span><span class="p">,</span> <span class="n">Ratio</span><span class="o">=</span><span class="n">Ratio</span><span class="p">,</span> <span class="n">dX12</span><span class="o">=</span><span class="n">dX12</span><span class="p">,</span> <span class="n">dX12Mode</span><span class="o">=</span><span class="n">dX12Mode</span><span class="p">,</span> <span class="n">Colis</span><span class="o">=</span><span class="n">Colis</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="k">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">Etends</span><span class="p">,</span> <span class="n">Ps</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">LOSRef</span></div>


<div class="viewcode-block" id="Detect.calc_SAngNb"><a class="viewcode-back" href="../../../Auto_tofu.geom.html#tofu.geom.Detect.calc_SAngNb">[docs]</a>    <span class="k">def</span> <span class="nf">calc_SAngNb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Pts</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Proj</span><span class="o">=</span><span class="s">&#39;Cross&#39;</span><span class="p">,</span> <span class="n">Slice</span><span class="o">=</span><span class="s">&#39;Int&#39;</span><span class="p">,</span> <span class="n">DRY</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">DXTheta</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">DZ</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Colis</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetSAngColis</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Compute the solid angle subtended by the Detect+Optics system as seen for desired points, in a slice or integrated manner</span>

<span class="sd">        Mostly useful in the :class:`GDetect` object when there are several detectors.</span>
<span class="sd">        Computes, for each point in the desired projection, the total solid angle subtended by all the detectors (or its integral) and the number of detectors that &#39;see&#39; each point.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        Pts :       None / np.ndarray</span>
<span class="sd">            (3,N) array of cartesian (X,Y,Z) coordinates of the provided N points, if None a default set of points is computed according to DRY, DXTheta and DZ</span>
<span class="sd">        Proj :      str</span>
<span class="sd">            Flag indicating to which projection of the VOS the method should be applied</span>
<span class="sd">        Slice :     str</span>
<span class="sd">            Flag indicating whether to compute the solid angle (&#39;Slice&#39;), the maximum solid angle along the ignorable coordinate (&#39;Max&#39;), or the integral over the ignorable coordinate (&#39;Int&#39;)</span>
<span class="sd">        DRY :       None / float</span>
<span class="sd">            Resolution (in horizontal direction of the cross-section) of the mesh to be constructed if the points are not provided</span>
<span class="sd">        DXTheta :   None / float</span>
<span class="sd">            Resolution (in ignorable coordinate direction) of the mesh to be constructed if the points are not provided</span>
<span class="sd">        DZ :        None / float</span>
<span class="sd">            Resolution (in vertical direction) of the mesh to be constructed if the points are not provided</span>
<span class="sd">        Colis :     bool</span>
<span class="sd">            Flag indicating whether collision detection should be used</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        SA :        np.ndarray</span>
<span class="sd">            Array of (ND,NP) solid angle values, where ND is the number of detectors and NP the number of points</span>
<span class="sd">        Nb :        np.ndarray</span>
<span class="sd">            Array of (ND,NP) booleans, True if a point is seen by a detector</span>
<span class="sd">        Pts :       np.ndarray</span>
<span class="sd">            The computed points (in case they were not provided)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Return pre-computed data if matches</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="n">ss</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Pts</span><span class="p">,</span><span class="n">DRY</span><span class="p">,</span><span class="n">DXTheta</span><span class="p">,</span><span class="n">DZ</span><span class="p">]])</span> <span class="ow">and</span> <span class="n">Slice</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;Int&#39;</span><span class="p">,</span><span class="s">&#39;Max&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">Proj</span><span class="o">==</span><span class="s">&#39;Cross&#39;</span><span class="p">:</span>
                <span class="n">SA</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SAngCross_Int</span> <span class="k">if</span> <span class="n">Slice</span><span class="o">==</span><span class="s">&#39;Int&#39;</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SAngCross_Max</span>
                <span class="n">Pts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SAngCross_Points</span>
            <span class="k">elif</span> <span class="n">Proj</span><span class="o">==</span><span class="s">&#39;Hor&#39;</span><span class="p">:</span>
                <span class="n">SA</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SAngHor_Int</span> <span class="k">if</span> <span class="n">Slice</span><span class="o">==</span><span class="s">&#39;Int&#39;</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SAngHor_Max</span>
                <span class="n">Pts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SAngHor_Points</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Get the mesh if Pts not provided</span>
            <span class="k">if</span> <span class="n">Pts</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
                <span class="n">LOS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_LOSRef</span><span class="p">][</span><span class="s">&#39;LOS&#39;</span><span class="p">]</span>
                <span class="n">SingPts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">LOS</span><span class="o">.</span><span class="n">PIn</span><span class="p">,</span> <span class="n">LOS</span><span class="o">.</span><span class="n">PIn</span><span class="o">+</span><span class="mf">0.002</span><span class="o">*</span><span class="n">LOS</span><span class="o">.</span><span class="n">u</span><span class="p">,</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">LOS</span><span class="o">.</span><span class="n">POut</span><span class="o">+</span><span class="n">LOS</span><span class="o">.</span><span class="n">PIn</span><span class="p">),</span> <span class="n">LOS</span><span class="o">.</span><span class="n">POut</span><span class="o">-</span><span class="mf">0.002</span><span class="o">*</span><span class="n">LOS</span><span class="o">.</span><span class="n">u</span> <span class="p">,</span> <span class="n">LOS</span><span class="o">.</span><span class="n">POut</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">Type</span><span class="o">==</span><span class="s">&#39;Tor&#39;</span><span class="p">:</span>
                    <span class="n">X1</span><span class="p">,</span> <span class="n">XIgn</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">NX1</span><span class="p">,</span> <span class="n">NIgn</span><span class="p">,</span> <span class="n">NZ</span><span class="p">,</span> <span class="n">Pts</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">_tfg_c</span><span class="o">.</span><span class="n">_get_CrossHorMesh</span><span class="p">(</span><span class="n">SingPoints</span><span class="o">=</span><span class="n">SingPts</span><span class="p">,</span> <span class="n">LSpan_R</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_Span_R</span><span class="p">],</span> <span class="n">LSpan_Theta</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_Span_Theta</span><span class="p">],</span> <span class="n">LSpan_Z</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_Span_Z</span><span class="p">],</span> <span class="n">DR</span><span class="o">=</span><span class="n">DRY</span><span class="p">,</span> <span class="n">DTheta</span><span class="o">=</span><span class="n">DXTheta</span><span class="p">,</span> <span class="n">DZ</span><span class="o">=</span><span class="n">DZ</span><span class="p">,</span>
                            <span class="n">VType</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">Type</span><span class="p">,</span> <span class="n">Proj</span><span class="o">=</span><span class="n">Proj</span><span class="p">,</span> <span class="n">ReturnPts</span><span class="o">=</span><span class="k">True</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">Type</span><span class="o">==</span><span class="s">&#39;Lin&#39;</span><span class="p">:</span>
                    <span class="n">XIgn</span><span class="p">,</span> <span class="n">X1</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">NIgn</span><span class="p">,</span> <span class="n">NX1</span><span class="p">,</span> <span class="n">NZ</span><span class="p">,</span> <span class="n">Pts</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">_tfg_c</span><span class="o">.</span><span class="n">_get_CrossHorMesh</span><span class="p">(</span><span class="n">SingPoints</span><span class="o">=</span><span class="n">SingPts</span><span class="p">,</span> <span class="n">LSpan_X</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_Span_X</span><span class="p">],</span> <span class="n">LSpan_Y</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_Span_Y</span><span class="p">],</span> <span class="n">LSpan_Z</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_Span_Z</span><span class="p">],</span> <span class="n">DX</span><span class="o">=</span><span class="n">DXTheta</span><span class="p">,</span> <span class="n">DY</span><span class="o">=</span><span class="n">DRY</span><span class="p">,</span> <span class="n">DZ</span><span class="o">=</span><span class="n">DZ</span><span class="p">,</span>
                            <span class="n">VType</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">Type</span><span class="p">,</span> <span class="n">Proj</span><span class="o">=</span><span class="n">Proj</span><span class="p">,</span> <span class="n">ReturnPts</span><span class="o">=</span><span class="k">True</span><span class="p">)</span>
            <span class="c"># Get the Solid angle (itself, or Int or Max)</span>
            <span class="k">if</span> <span class="n">Slice</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;Int&#39;</span><span class="p">,</span><span class="s">&#39;Max&#39;</span><span class="p">]:</span>
                <span class="n">FF</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_SAngIntMax</span><span class="p">(</span><span class="n">Proj</span><span class="o">=</span><span class="n">Proj</span><span class="p">,</span> <span class="n">SAng</span><span class="o">=</span><span class="n">Slice</span><span class="p">)</span>
                <span class="n">SA</span> <span class="o">=</span> <span class="n">FF</span><span class="p">(</span><span class="n">Pts</span><span class="p">,</span> <span class="n">In</span><span class="o">=</span><span class="n">out</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">Proj</span><span class="o">==</span><span class="s">&#39;Hor&#39;</span><span class="p">:</span>
                    <span class="n">Span</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Span_Z</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">Span</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Span_Theta</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">Type</span><span class="o">==</span><span class="s">&#39;Tor&#39;</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Span_X</span>
                <span class="k">assert</span> <span class="n">Slice</span><span class="o">&gt;=</span><span class="n">Span</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">Slice</span><span class="o">&lt;=</span><span class="n">Span</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&quot;Arg Slice is outside of the interval were non-zeros values can be found !&quot;</span>
                <span class="n">Ptsint</span> <span class="o">=</span> <span class="n">_tfg_gg</span><span class="o">.</span><span class="n">CoordShift</span><span class="p">(</span><span class="n">Pts</span><span class="p">,</span> <span class="n">In</span><span class="o">=</span><span class="n">out</span><span class="p">,</span> <span class="n">Out</span><span class="o">=</span><span class="s">&#39;(X,Y,Z)&#39;</span><span class="p">,</span> <span class="n">CrossRef</span><span class="o">=</span><span class="n">Slice</span><span class="p">)</span>
                <span class="n">SA</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_SAngVect</span><span class="p">(</span><span class="n">Ptsint</span><span class="p">,</span> <span class="n">In</span><span class="o">=</span><span class="s">&#39;(X,Y,Z)&#39;</span><span class="p">,</span> <span class="n">Colis</span><span class="o">=</span><span class="n">Colis</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="k">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">SA</span><span class="p">,</span> <span class="n">SA</span><span class="o">&gt;</span><span class="mf">0.</span><span class="p">,</span> <span class="n">Pts</span></div>


    <span class="k">def</span> <span class="nf">_calc_Res</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Pts</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">CrossMesh</span><span class="o">=</span><span class="p">[</span><span class="mf">0.01</span><span class="p">,</span><span class="mf">0.01</span><span class="p">],</span> <span class="n">CrossMeshMode</span><span class="o">=</span><span class="s">&#39;abs&#39;</span><span class="p">,</span> <span class="n">Mode</span><span class="o">=</span><span class="s">&#39;Iso&#39;</span><span class="p">,</span> <span class="n">Amp</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">Deg</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">Thres</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">ThresMode</span><span class="o">=</span><span class="s">&#39;rel&#39;</span><span class="p">,</span> <span class="n">ThresMin</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
                 <span class="n">IntResCross</span><span class="o">=</span><span class="p">[</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">0.1</span><span class="p">],</span> <span class="n">IntResCrossMode</span><span class="o">=</span><span class="s">&#39;rel&#39;</span><span class="p">,</span> <span class="n">IntResLong</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">IntResLongMode</span><span class="o">=</span><span class="s">&#39;rel&#39;</span><span class="p">,</span>
                 <span class="n">Eq</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">PlotDetail</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">Cdict</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetConed</span><span class="p">),</span> <span class="n">Ntt</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">SaveName</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="s">&#39;./&#39;</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="k">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Compute the resolution and given input points or grid knots, with specified method and accuracy, the result can be automatically saved (useful for long computations)</span>

<span class="sd">        The definition that tofu proposes for the spatial resolution of a tomography diagnostic is as follows:</span>
<span class="sd">        (describe after publication)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        Pts :               None or iterable</span>
<span class="sd">        CrossMesh :         None or iterable</span>
<span class="sd">        CrossMeshMode :     str</span>
<span class="sd">        Mode :              str</span>
<span class="sd">        Amp :               float</span>
<span class="sd">        Deg :               int</span>
<span class="sd">        steps :             float</span>
<span class="sd">        Thres :             float</span>
<span class="sd">        ThresMode :         str</span>
<span class="sd">        ThresMin :          float</span>
<span class="sd">        IntResCross :       iterable</span>
<span class="sd">        IntResCrossMode :   str</span>
<span class="sd">        IntResLong :        float</span>
<span class="sd">        IntResLongMode :    str</span>
<span class="sd">        Eq :                None or callable</span>
<span class="sd">        PlotDetail :        bool</span>
<span class="sd">        Cdict :             dict</span>
<span class="sd">        Ntt :               int</span>
<span class="sd">        SaveName :          None or str</span>
<span class="sd">        SavePath :          str</span>
<span class="sd">        save :              bool</span>
<span class="sd">        Test :              bool</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Res :               np.ndarray</span>
<span class="sd">        Pts :               np.ndarray</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">Res</span><span class="p">,</span> <span class="n">Pts</span><span class="p">,</span> <span class="n">LDetLim</span><span class="p">,</span> <span class="n">Mode</span><span class="p">,</span> <span class="n">steps</span><span class="p">,</span> <span class="n">Thres</span><span class="p">,</span> <span class="n">ThresMode</span><span class="p">,</span> <span class="n">ThresMin</span><span class="p">,</span> <span class="n">IntResCross</span><span class="p">,</span> <span class="n">IntResCrossMode</span><span class="p">,</span> <span class="n">IntResLong</span><span class="p">,</span> <span class="n">IntResLongMode</span> \
                <span class="o">=</span> <span class="n">_Calc_Resolution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Pts</span><span class="o">=</span><span class="n">Pts</span><span class="p">,</span> <span class="n">CrossMesh</span><span class="o">=</span><span class="n">CrossMesh</span><span class="p">,</span> <span class="n">CrossMeshMode</span><span class="o">=</span><span class="n">CrossMeshMode</span><span class="p">,</span> <span class="n">Mode</span><span class="o">=</span><span class="n">Mode</span><span class="p">,</span> <span class="n">Amp</span><span class="o">=</span><span class="n">Amp</span><span class="p">,</span> <span class="n">Deg</span><span class="o">=</span><span class="n">Deg</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="n">steps</span><span class="p">,</span> <span class="n">Thres</span><span class="o">=</span><span class="n">Thres</span><span class="p">,</span> <span class="n">ThresMode</span><span class="o">=</span><span class="n">ThresMode</span><span class="p">,</span> <span class="n">ThresMin</span><span class="o">=</span><span class="n">ThresMin</span><span class="p">,</span>
                                  <span class="n">IntResCross</span><span class="o">=</span><span class="n">IntResCross</span><span class="p">,</span> <span class="n">IntResCrossMode</span><span class="o">=</span><span class="n">IntResCrossMode</span><span class="p">,</span> <span class="n">IntResLong</span><span class="o">=</span><span class="n">IntResLong</span><span class="p">,</span> <span class="n">IntResLongMode</span><span class="o">=</span><span class="n">IntResLongMode</span><span class="p">,</span>
                                  <span class="n">Eq</span><span class="o">=</span><span class="n">Eq</span><span class="p">,</span> <span class="n">PlotDetail</span><span class="o">=</span><span class="n">PlotDetail</span><span class="p">,</span> <span class="n">Cdict</span><span class="o">=</span><span class="n">Cdict</span><span class="p">,</span> <span class="n">Ntt</span><span class="o">=</span><span class="n">Ntt</span><span class="p">,</span> <span class="n">SaveName</span><span class="o">=</span><span class="n">SaveName</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="n">SavePath</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="n">save</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="n">Test</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Res</span><span class="p">,</span> <span class="n">Pts</span>

    <span class="k">def</span> <span class="nf">_set_Res</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">CrossMesh</span><span class="o">=</span><span class="p">[</span><span class="mf">0.05</span><span class="p">,</span><span class="mf">0.02</span><span class="p">],</span> <span class="n">CrossMeshMode</span><span class="o">=</span><span class="s">&#39;rel&#39;</span><span class="p">,</span> <span class="n">Mode</span><span class="o">=</span><span class="s">&#39;Iso&#39;</span><span class="p">,</span> <span class="n">Amp</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">Deg</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">Thres</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">ThresMode</span><span class="o">=</span><span class="s">&#39;rel&#39;</span><span class="p">,</span> <span class="n">ThresMin</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
                 <span class="n">IntResCross</span><span class="o">=</span><span class="p">[</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">0.1</span><span class="p">],</span> <span class="n">IntResCrossMode</span><span class="o">=</span><span class="s">&#39;rel&#39;</span><span class="p">,</span> <span class="n">IntResLong</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">IntResLongMode</span><span class="o">=</span><span class="s">&#39;rel&#39;</span><span class="p">,</span> <span class="n">Eq</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">EqName</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Ntt</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="k">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Compute the resolution of the Detect instance on a mesh grid of the Cross section, with specified parameters (see :meth:`~self.calc_Res` for details)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        EqName :    str</span>
<span class="sd">            Flag name used to identify the equilibrium reconstruction that was used, if any</span>
<span class="sd">        save :      bool</span>
<span class="sd">            if True the Detect instance saves itself automatically once the computation is finished (useful for long computations)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">Res</span><span class="p">,</span> <span class="n">Pts</span><span class="p">,</span> <span class="n">LDetLim</span><span class="p">,</span> <span class="n">Mode</span><span class="p">,</span> <span class="n">steps</span><span class="p">,</span> <span class="n">Thres</span><span class="p">,</span> <span class="n">ThresMode</span><span class="p">,</span> <span class="n">ThresMin</span><span class="p">,</span> <span class="n">IntResCross</span><span class="p">,</span> <span class="n">IntResCrossMode</span><span class="p">,</span> <span class="n">IntResLong</span><span class="p">,</span> <span class="n">IntResLongMode</span> \
                <span class="o">=</span> <span class="n">_Calc_Resolution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Pts</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">CrossMesh</span><span class="o">=</span><span class="n">CrossMesh</span><span class="p">,</span> <span class="n">CrossMeshMode</span><span class="o">=</span><span class="n">CrossMeshMode</span><span class="p">,</span> <span class="n">Mode</span><span class="o">=</span><span class="n">Mode</span><span class="p">,</span> <span class="n">Amp</span><span class="o">=</span><span class="n">Amp</span><span class="p">,</span> <span class="n">Deg</span><span class="o">=</span><span class="n">Deg</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="n">steps</span><span class="p">,</span> <span class="n">Thres</span><span class="o">=</span><span class="n">Thres</span><span class="p">,</span> <span class="n">ThresMode</span><span class="o">=</span><span class="n">ThresMode</span><span class="p">,</span> <span class="n">ThresMin</span><span class="o">=</span><span class="n">ThresMin</span><span class="p">,</span>
                                  <span class="n">IntResCross</span><span class="o">=</span><span class="n">IntResCross</span><span class="p">,</span> <span class="n">IntResCrossMode</span><span class="o">=</span><span class="n">IntResCrossMode</span><span class="p">,</span> <span class="n">IntResLong</span><span class="o">=</span><span class="n">IntResLong</span><span class="p">,</span> <span class="n">IntResLongMode</span><span class="o">=</span><span class="n">IntResLongMode</span><span class="p">,</span> <span class="n">Eq</span><span class="o">=</span><span class="n">Eq</span><span class="p">,</span> <span class="n">Ntt</span><span class="o">=</span><span class="n">Ntt</span><span class="p">,</span> <span class="n">PlotDetail</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="n">Test</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_Res_Mode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Res_Amp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Res_Deg</span> <span class="o">=</span> <span class="n">Mode</span><span class="p">,</span> <span class="n">Amp</span><span class="p">,</span> <span class="n">Deg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Res_Pts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Res_Res</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Res_CrossMesh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Res_CrossMeshMode</span> <span class="o">=</span> <span class="n">Pts</span><span class="p">,</span> <span class="n">Res</span><span class="p">,</span> <span class="n">CrossMesh</span><span class="p">,</span> <span class="n">CrossMeshMode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Res_steps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Res_Thres</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Res_ThresMode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Res_ThresMin</span> <span class="o">=</span> <span class="n">steps</span><span class="p">,</span> <span class="n">Thres</span><span class="p">,</span> <span class="n">ThresMode</span><span class="p">,</span> <span class="n">ThresMin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Res_IntResCross</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Res_IntResCrossMode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Res_IntResLong</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Res_IntResLongMode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Res_IntNtt</span> <span class="o">=</span> <span class="n">IntResCross</span><span class="p">,</span> <span class="n">IntResCrossMode</span><span class="p">,</span> <span class="n">IntResLong</span><span class="p">,</span> <span class="n">IntResLongMode</span><span class="p">,</span> <span class="n">Ntt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Res_EqName</span> <span class="o">=</span> <span class="n">EqName</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Res_Done</span> <span class="o">=</span> <span class="k">True</span>
        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_reset_Res</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Res_Mode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Res_Amp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Res_Deg</span> <span class="o">=</span> <span class="k">None</span><span class="p">,</span> <span class="k">None</span><span class="p">,</span> <span class="k">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Res_Pts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Res_Res</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Res_CrossMesh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Res_CrossMeshMode</span> <span class="o">=</span> <span class="k">None</span><span class="p">,</span> <span class="k">None</span><span class="p">,</span> <span class="k">None</span><span class="p">,</span> <span class="k">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Res_steps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Res_Thres</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Res_ThresMode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Res_ThresMin</span> <span class="o">=</span> <span class="k">None</span><span class="p">,</span> <span class="k">None</span><span class="p">,</span> <span class="k">None</span><span class="p">,</span> <span class="k">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Res_IntResCross</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Res_IntResCrossMode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Res_IntResLong</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Res_IntResLongMode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Res_IntNtt</span> <span class="o">=</span> <span class="k">None</span><span class="p">,</span> <span class="k">None</span><span class="p">,</span> <span class="k">None</span><span class="p">,</span> <span class="k">None</span><span class="p">,</span> <span class="k">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Res_EqName</span> <span class="o">=</span> <span class="k">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Res_Done</span> <span class="o">=</span> <span class="k">False</span>


<div class="viewcode-block" id="Detect.plot"><a class="viewcode-back" href="../../../Auto_tofu.geom.html#tofu.geom.Detect.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Lax</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Proj</span><span class="o">=</span><span class="s">&#39;All&#39;</span><span class="p">,</span> <span class="n">Elt</span><span class="o">=</span><span class="s">&#39;PVC&#39;</span><span class="p">,</span> <span class="n">EltLOS</span><span class="o">=</span><span class="s">&#39;LDIORP&#39;</span><span class="p">,</span> <span class="n">EltOptics</span><span class="o">=</span><span class="s">&#39;P&#39;</span><span class="p">,</span> <span class="n">EltVes</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span>  <span class="n">Leg</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">LOSRef</span><span class="o">=</span><span class="k">None</span><span class="p">,</span>
            <span class="n">Pdict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">ApPd</span><span class="p">,</span> <span class="n">Vdict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">ApVd</span><span class="p">,</span> <span class="n">Cdict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetConed</span><span class="p">,</span> <span class="n">LVIn</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">ApLVin</span><span class="p">,</span>
            <span class="n">LOSdict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">LOSdict</span><span class="p">,</span> <span class="n">Opticsdict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">Apertdict</span><span class="p">,</span> <span class="n">Vesdict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">Vesdict</span><span class="p">,</span>
            <span class="n">LegDict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">TorLegd</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="k">True</span><span class="p">,</span> <span class="n">a4</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="k">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Plot the Detect instance in a projection or in 3D, its polygon, perpendicular vector, projected viewing cones and optionally its :class:`~tofu.geom.LOS`, :class:`~tofu.geom.Apert`, and :class:`~tofu.geom.Ves` objects</span>

<span class="sd">        The Detect instance can be plotted in a cross-section or horizontal projection, or in 3D.</span>
<span class="sd">        Several of its attributes can be plotted too using the usual &#39;Elt&#39; keyword argument.</span>
<span class="sd">        Dedicated &#39;Elt&#39; keyword arguments are also usable to specify the elements to be plotted for sub-classes like :class:`~tofu.geom.LOS`, :class:`~tofu.geom.Apert`, and :class:`~tofu.geom.Ves`.</span>
<span class="sd">        Dedicated dictionary help specify how each element sshould be plotted.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        Lax :       None, plt.Axes or list</span>
<span class="sd">            Axes or list of axes to be used for plotting, if None a new figure and appropriate axes are created</span>
<span class="sd">        Proj :      str</span>
<span class="sd">            Flag indicating whether to plot the cross-section (&#39;Cross&#39;), the horizontal projection (&#39;Hor&#39;), both (&#39;All&#39;) or a 3D representation (&#39;3D&#39;)</span>
<span class="sd">        Elt :       str</span>
<span class="sd">            Flag indicating which elements of the Detect instance to plot, each capital letter stands for an element</span>
<span class="sd">                * &#39;P&#39;: polygon</span>
<span class="sd">                * &#39;V&#39;: perpendicular vector</span>
<span class="sd">                * &#39;C&#39;: viewing cone</span>
<span class="sd">        EltLOS :    None or str</span>
<span class="sd">            Flag indicating which elements of the LOS to plot, will be fed to LOS.plot(), if None uses the &#39;Elt&#39; arg of LOSdict instead</span>
<span class="sd">        EltOptics : None or str</span>
<span class="sd">            Flag indicating which elements of the Aperts to plot, will be fed to Apert.plot(), if None uses the &#39;Elt&#39; arg of Apertdict instead</span>
<span class="sd">        EltVes :    None or str</span>
<span class="sd">            Flag indicating which elements of the Ves to plot, will be fed to :meth:`~tofu.geom.Ves.plot`, if None uses the &#39;Elt&#39; arg of Vesdict instead</span>
<span class="sd">        Leg :       str</span>
<span class="sd">            Legend to be used for the detector, if &#39;&#39; the Detect.iD.Name is used</span>
<span class="sd">        LOSRef :    None or str</span>
<span class="sd">            Flag indicating which LOS should be represented, if None Detect._LOSRef is used</span>
<span class="sd">        Pdict :     dict</span>
<span class="sd">            Dictionary of properties for the Polygon</span>
<span class="sd">        Vdict :     dict</span>
<span class="sd">            Dictionary of properties for the Vector</span>
<span class="sd">        Cdict :     dict</span>
<span class="sd">            Dictionary of properties for the Cone</span>
<span class="sd">        LVIn :      float</span>
<span class="sd">            Length of the Vector</span>
<span class="sd">        LOSdict :   dict</span>
<span class="sd">            Dictionary of properties for the LOS if EltLOS is not &#39;&#39;, fed to LOS.plot()</span>
<span class="sd">        Apertdict : dict</span>
<span class="sd">            Dictionary of properties for the Apert if EltOptics is not &#39;&#39;, fed to Apert.plot()</span>
<span class="sd">        Vesdict :   dict</span>
<span class="sd">            Dictionary of properties for the Ves if EltVes is not &#39;&#39;, fed to :meth:`~tofu.geom.Ves.plot`</span>
<span class="sd">        LegDict :   dict</span>
<span class="sd">            Dictionary of properties for the legend, fed to plt.legend()</span>
<span class="sd">        draw :      bool</span>
<span class="sd">            Flag indicating whether to draw the figure</span>
<span class="sd">        a4 :        bool</span>
<span class="sd">            Flag indicating whether the default figure should be of size a4 paper</span>
<span class="sd">        Test :      bool</span>
<span class="sd">            Flag indicating whether the inputs should be tested for conformity</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Lax     plt.Axes or list</span>
<span class="sd">            Axes or list of axes used for plotting</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_tfg_p</span><span class="o">.</span><span class="n">GLDetect_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Lax</span><span class="o">=</span><span class="n">Lax</span><span class="p">,</span> <span class="n">Proj</span><span class="o">=</span><span class="n">Proj</span><span class="p">,</span> <span class="n">Elt</span><span class="o">=</span><span class="n">Elt</span><span class="p">,</span> <span class="n">EltOptics</span><span class="o">=</span><span class="n">EltOptics</span><span class="p">,</span> <span class="n">EltLOS</span><span class="o">=</span><span class="n">EltLOS</span><span class="p">,</span> <span class="n">EltVes</span><span class="o">=</span><span class="n">EltVes</span><span class="p">,</span> <span class="n">Leg</span><span class="o">=</span><span class="n">Leg</span><span class="p">,</span> <span class="n">LOSRef</span><span class="o">=</span><span class="n">LOSRef</span><span class="p">,</span>
            <span class="n">Pdict</span><span class="o">=</span><span class="n">Pdict</span><span class="p">,</span> <span class="n">Vdict</span><span class="o">=</span><span class="n">Vdict</span><span class="p">,</span> <span class="n">Cdict</span><span class="o">=</span><span class="n">Cdict</span><span class="p">,</span> <span class="n">LVIn</span><span class="o">=</span><span class="n">LVIn</span><span class="p">,</span>
            <span class="n">LOSdict</span><span class="o">=</span><span class="n">LOSdict</span><span class="p">,</span> <span class="n">Opticsdict</span><span class="o">=</span><span class="n">Opticsdict</span><span class="p">,</span> <span class="n">Vesdict</span><span class="o">=</span><span class="n">Vesdict</span><span class="p">,</span> <span class="n">LegDict</span><span class="o">=</span><span class="n">LegDict</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="n">draw</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="n">Test</span><span class="p">)</span></div>

<div class="viewcode-block" id="Detect.plot_SAngNb"><a class="viewcode-back" href="../../../Auto_tofu.geom.html#tofu.geom.Detect.plot_SAngNb">[docs]</a>    <span class="k">def</span> <span class="nf">plot_SAngNb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Lax</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Proj</span><span class="o">=</span><span class="s">&#39;Cross&#39;</span><span class="p">,</span> <span class="n">Slice</span><span class="o">=</span><span class="s">&#39;Int&#39;</span><span class="p">,</span> <span class="n">Pts</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">plotfunc</span><span class="o">=</span><span class="s">&#39;scatter&#39;</span><span class="p">,</span> <span class="n">DRY</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">DXTheta</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">DZ</span><span class="o">=</span><span class="k">None</span><span class="p">,</span>
            <span class="n">Elt</span><span class="o">=</span><span class="s">&#39;P&#39;</span><span class="p">,</span> <span class="n">EltVes</span><span class="o">=</span><span class="s">&#39;P&#39;</span><span class="p">,</span> <span class="n">EltLOS</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">EltOptics</span><span class="o">=</span><span class="s">&#39;P&#39;</span><span class="p">,</span>
            <span class="n">Pdict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">ApPd</span><span class="p">,</span> <span class="n">Vdict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">ApVd</span><span class="p">,</span> <span class="n">Cdict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetConed</span><span class="p">,</span> <span class="n">LVIn</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">ApLVin</span><span class="p">,</span>
            <span class="n">LOSdict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">LOSdict</span><span class="p">,</span> <span class="n">Opticsdict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">Apertdict</span><span class="p">,</span> <span class="n">Vesdict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">Vesdict</span><span class="p">,</span>
            <span class="n">CDictSA</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">CDictNb</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Colis</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetSAngColis</span><span class="p">,</span> <span class="n">a4</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="k">True</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="k">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Plot the solid angle projections (integrated &#39;Int&#39; or maximum &#39;Max&#39;) as well as the number of detectors visible from each point in the plasma</span>

<span class="sd">        Mostly useful with the :class:`~tofu.geom.GDetect` object, used to visualize the goemetrical coverage in terms of total solid angle and number of detectors &#39;seeing&#39; each point for a set of detectors (see :meth:`~tofu.geom.Detect.calc_SAngNb` method for details).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        Lax :       None or list or plt.Axes</span>
<span class="sd">            Axes or list of Axes to be used for plotting, if None a new figure and appropriate axes are created</span>
<span class="sd">        Proj :      str</span>
<span class="sd">            Flag indicating whether to plot the cross-section (&#39;Cross&#39;) or the horizontal projection (&#39;Hor&#39;)</span>
<span class="sd">        Mode :      str, None or float</span>
<span class="sd">            Flag indicating whether to plot:</span>
<span class="sd">                * &#39;Int&#39;: the integrated value along the projected coordinates</span>
<span class="sd">                * &#39;Max&#39;: the maximum value along the projected coordinates</span>
<span class="sd">                * float: the projected coordinate at which to plot the slice (Theta or X if Proj=&#39;Cross&#39;, Z if Proj=&#39;Hor&#39;)</span>
<span class="sd">                * None: the slice is done in the middle of the viewing volume</span>
<span class="sd">        plotfunc :  str</span>
<span class="sd">            Flag indicating which plotting method to use (&#39;scatter&#39;, &#39;contour&#39;, &#39;contourf&#39; or &#39;imshow&#39;)</span>
<span class="sd">        DCross :    float</span>
<span class="sd">            Resolution along the 1st cross-section coordinate (R for Type=&#39;Tor&#39;, Y for Type=&#39;Lin&#39;)</span>
<span class="sd">        DXTheta :   float</span>
<span class="sd">            Resolution along the ignorable coordinate (Theta for Type=&#39;Tor&#39;, X for Type=&#39;Lin&#39;)</span>
<span class="sd">        DZ :        float</span>
<span class="sd">            Vertical resolution (for both Types)</span>
<span class="sd">        CDictSA :   dict</span>
<span class="sd">            Properties of the solid angle plot, to be fed to the function chosen by plotfunc</span>
<span class="sd">        CDictNb :   dict</span>
<span class="sd">            Properties of the Nb plot, to be fed to the chsoen plotting routine</span>
<span class="sd">        Colis :     bool</span>
<span class="sd">            Flag indicating whether collision detection should be used</span>
<span class="sd">        a4 :        bool</span>
<span class="sd">            Flag indicating whether to use a4 dimensions to create a new figure if Lax=None</span>
<span class="sd">        draw :      bool</span>
<span class="sd">            Flag indicating whether to draw the figure</span>
<span class="sd">        Test :      bool</span>
<span class="sd">            Flag indicating whether the inputs should be tested for conformity</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Lax :       plt.Axes or list</span>
<span class="sd">            List of the axes used for plotting</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">SA</span><span class="p">,</span> <span class="n">Nb</span><span class="p">,</span> <span class="n">Pts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_SAngNb</span><span class="p">(</span><span class="n">Pts</span><span class="o">=</span><span class="n">Pts</span><span class="p">,</span> <span class="n">Proj</span><span class="o">=</span><span class="n">Proj</span><span class="p">,</span> <span class="n">Slice</span><span class="o">=</span><span class="n">Slice</span><span class="p">,</span> <span class="n">DRY</span><span class="o">=</span><span class="n">DRY</span><span class="p">,</span> <span class="n">DXTheta</span><span class="o">=</span><span class="n">DXTheta</span><span class="p">,</span> <span class="n">DZ</span><span class="o">=</span><span class="n">DZ</span><span class="p">,</span> <span class="n">Colis</span><span class="o">=</span><span class="n">Colis</span><span class="p">)</span>
        <span class="n">Lax</span> <span class="o">=</span> <span class="n">_tfg_p</span><span class="o">.</span><span class="n">_GLDetect_plot_SAngNb</span><span class="p">(</span><span class="n">Leg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">SA</span><span class="o">=</span><span class="n">SA</span><span class="p">,</span> <span class="n">Nb</span><span class="o">=</span><span class="n">Nb</span><span class="p">,</span> <span class="n">Pts</span><span class="o">=</span><span class="n">Pts</span><span class="p">,</span> <span class="n">Lax</span><span class="o">=</span><span class="n">Lax</span><span class="p">,</span> <span class="n">Proj</span><span class="o">=</span><span class="n">Proj</span><span class="p">,</span> <span class="n">Slice</span><span class="o">=</span><span class="n">Slice</span><span class="p">,</span> <span class="n">plotfunc</span><span class="o">=</span><span class="n">plotfunc</span><span class="p">,</span> <span class="n">CDictSA</span><span class="o">=</span><span class="n">CDictSA</span><span class="p">,</span> <span class="n">CDictNb</span><span class="o">=</span><span class="n">CDictNb</span><span class="p">,</span> <span class="n">Colis</span><span class="o">=</span><span class="n">Colis</span><span class="p">,</span>
                <span class="n">DRY</span><span class="o">=</span><span class="n">DRY</span><span class="p">,</span> <span class="n">DXTheta</span><span class="o">=</span><span class="n">DXTheta</span><span class="p">,</span> <span class="n">VType</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">Type</span><span class="p">,</span> <span class="n">a4</span><span class="o">=</span><span class="n">a4</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="n">Test</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="ow">not</span> <span class="n">ss</span><span class="o">==</span><span class="s">&#39;&#39;</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Elt</span><span class="p">,</span><span class="n">EltVes</span><span class="p">,</span> <span class="n">EltLOS</span><span class="p">,</span> <span class="n">EltOptics</span><span class="p">]]):</span>
            <span class="n">Lax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Proj</span><span class="o">=</span><span class="n">Proj</span><span class="p">,</span> <span class="n">Lax</span><span class="o">=</span><span class="n">Lax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Elt</span><span class="o">=</span><span class="n">Elt</span><span class="p">,</span> <span class="n">EltVes</span><span class="o">=</span><span class="n">EltVes</span><span class="p">,</span> <span class="n">EltLOS</span><span class="o">=</span><span class="n">EltLOS</span><span class="p">,</span> <span class="n">EltOptics</span><span class="o">=</span><span class="n">EltOptics</span><span class="p">,</span> <span class="n">Pdict</span><span class="o">=</span><span class="n">Pdict</span><span class="p">,</span> <span class="n">Vdict</span><span class="o">=</span><span class="n">Vdict</span><span class="p">,</span> <span class="n">Cdict</span><span class="o">=</span><span class="n">Cdict</span><span class="p">,</span> <span class="n">LVIn</span><span class="o">=</span><span class="n">LVIn</span><span class="p">,</span>
                    <span class="n">LOSdict</span><span class="o">=</span><span class="n">LOSdict</span><span class="p">,</span> <span class="n">Opticsdict</span><span class="o">=</span><span class="n">Opticsdict</span><span class="p">,</span> <span class="n">Vesdict</span><span class="o">=</span><span class="n">Vesdict</span><span class="p">,</span> <span class="n">LegDict</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">a4</span><span class="o">=</span><span class="n">a4</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="n">Test</span><span class="p">)</span>
            <span class="n">Lax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Proj</span><span class="o">=</span><span class="n">Proj</span><span class="p">,</span> <span class="n">Lax</span><span class="o">=</span><span class="n">Lax</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">Elt</span><span class="o">=</span><span class="n">Elt</span><span class="p">,</span> <span class="n">EltVes</span><span class="o">=</span><span class="n">EltVes</span><span class="p">,</span> <span class="n">EltLOS</span><span class="o">=</span><span class="n">EltLOS</span><span class="p">,</span> <span class="n">EltOptics</span><span class="o">=</span><span class="n">EltOptics</span><span class="p">,</span> <span class="n">Pdict</span><span class="o">=</span><span class="n">Pdict</span><span class="p">,</span> <span class="n">Vdict</span><span class="o">=</span><span class="n">Vdict</span><span class="p">,</span> <span class="n">Cdict</span><span class="o">=</span><span class="n">Cdict</span><span class="p">,</span> <span class="n">LVIn</span><span class="o">=</span><span class="n">LVIn</span><span class="p">,</span>
                    <span class="n">LOSdict</span><span class="o">=</span><span class="n">LOSdict</span><span class="p">,</span> <span class="n">Opticsdict</span><span class="o">=</span><span class="n">Opticsdict</span><span class="p">,</span> <span class="n">Vesdict</span><span class="o">=</span><span class="n">Vesdict</span><span class="p">,</span> <span class="n">LegDict</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">a4</span><span class="o">=</span><span class="n">a4</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="n">Test</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">draw</span><span class="p">:</span>
            <span class="n">Lax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">Lax</span></div>

    <span class="k">def</span> <span class="nf">_debug_plot_SAng_OnPlanePerp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Pos</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetSAngPlRa</span><span class="p">,</span> <span class="n">dX12</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetSAngPldX12</span><span class="p">,</span> <span class="n">dX12Mode</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetSAngPldX12Mode</span><span class="p">,</span> <span class="n">Ratio</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetSAngPlRatio</span><span class="p">,</span> <span class="n">SurfDict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetSAngPld</span><span class="p">,</span> <span class="n">LegDict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">TorLegd</span><span class="p">,</span>
            <span class="n">Colis</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetSAngColis</span><span class="p">,</span> <span class="n">LOSRef</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="k">True</span><span class="p">,</span> <span class="n">a4</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="k">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Plot the solid angle subtended by the Detect-Apert system as seen from points on a plane perpendicular to the LOS</span>

<span class="sd">        Used for debugging or illustrative purposes.</span>
<span class="sd">        Plot a surface plot of the solid angle subtended by the Detect+Optics system as seen for all points standing on a plane perpendicular to the LOS (the integral of which is the etendue).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ax :        None or plt.Axes</span>
<span class="sd">            Axes to be used for plotting, if None a new figure and appropriate axes are created</span>
<span class="sd">        Pos :       float</span>
<span class="sd">            Relative position between LOS.PIn and LOS.POut where the plane os to be placed, in ]0;1[</span>
<span class="sd">        dX12 :      list</span>
<span class="sd">            List of 2 floats defining the resolution of the sampling in X1 and X2</span>
<span class="sd">        dX12Mode :  str</span>
<span class="sd">            Flag indicating whether the resolution dX12 is in dimensionless units (in [0;1], hence a value of 0.1 means 10 discretisation points between the extremes), if &#39;abs&#39; dX12 is in meters</span>
<span class="sd">        Ratio :     float</span>
<span class="sd">            A float specifying the relative margin to be taken for integration boundaries</span>
<span class="sd">        SurfDict :  dict</span>
<span class="sd">            Dictionary of properties to be used for plotting the surface plot (fed to :meth:`~matplotlib.pyplot.plot_surface`)</span>
<span class="sd">        LegDict :   None or dict</span>
<span class="sd">            If None, no legend is plotted, else LegDict is fed to :meth:&#39;~matplotlib.pyplot.Axes.legend&#39;</span>
<span class="sd">        Colis :     bool</span>
<span class="sd">            Flag indicating whether collision detection should be used</span>
<span class="sd">        draw :      bool</span>
<span class="sd">            Flag indicating whether to draw the figure</span>
<span class="sd">        a4 :        bool</span>
<span class="sd">            Flag indicating whether the created figure should have a4 dimensions (useful for printing)</span>
<span class="sd">        Test :      bool</span>
<span class="sd">            Flag indicating whether the inputs should be tested for conformity</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ax :        plt.Axes</span>
<span class="sd">            The axes used for plotting</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">Test</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">Pos</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">float</span><span class="p">,</span> <span class="s">&quot;Arg Pos must be a float specifying the relative distance on the LOS at which the plane is to be placed !&quot;</span>
        <span class="k">if</span> <span class="n">LOSRef</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="n">LOSRef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_LOSRef</span>
        <span class="n">Ps</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="p">[</span><span class="n">LOSRef</span><span class="p">][</span><span class="s">&#39;LOS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">PIn</span> <span class="o">+</span> <span class="n">Pos</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="p">[</span><span class="n">LOSRef</span><span class="p">][</span><span class="s">&#39;LOS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">POut</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="p">[</span><span class="n">LOSRef</span><span class="p">][</span><span class="s">&#39;LOS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">PIn</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">nPs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="p">[</span><span class="n">LOSRef</span><span class="p">][</span><span class="s">&#39;LOS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">LOPolys</span> <span class="o">=</span> <span class="p">[</span><span class="n">oo</span><span class="o">.</span><span class="n">Poly</span> <span class="k">for</span> <span class="n">oo</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Optics</span><span class="p">]</span>
        <span class="n">LOBaryS</span> <span class="o">=</span> <span class="p">[</span><span class="n">oo</span><span class="o">.</span><span class="n">BaryS</span> <span class="k">for</span> <span class="n">oo</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Optics</span><span class="p">]</span>
        <span class="n">LOnIns</span> <span class="o">=</span> <span class="p">[</span><span class="n">oo</span><span class="o">.</span><span class="n">nIn</span> <span class="k">for</span> <span class="n">oo</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Optics</span><span class="p">]</span>
        <span class="n">LOSurfs</span> <span class="o">=</span> <span class="p">[</span><span class="n">oo</span><span class="o">.</span><span class="n">Surf</span> <span class="k">for</span> <span class="n">oo</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Optics</span><span class="p">]</span>
        <span class="n">Etend</span><span class="p">,</span> <span class="n">e1</span><span class="p">,</span> <span class="n">e2</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">SA</span><span class="p">,</span> <span class="n">X1</span><span class="p">,</span> <span class="n">X2</span><span class="p">,</span> <span class="n">NumX1</span><span class="p">,</span> <span class="n">NumX2</span> <span class="o">=</span> <span class="n">_tfg_c</span><span class="o">.</span><span class="n">Calc_Etendue_PlaneLOS</span><span class="p">(</span><span class="n">Ps</span><span class="p">,</span> <span class="n">nPs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Poly</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">BaryS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nIn</span><span class="p">,</span> <span class="n">LOPolys</span><span class="p">,</span> <span class="n">LOnIns</span><span class="p">,</span> <span class="n">LOSurfs</span><span class="p">,</span> <span class="n">LOBaryS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SAngPlane</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">Poly</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">Vin</span><span class="p">,</span> <span class="n">DLong</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">DLong</span><span class="p">,</span>
                <span class="n">Lens_ConeTip</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_Optics_Lens_ConeTip</span><span class="p">,</span> <span class="n">Lens_ConeHalfAng</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_Optics_Lens_ConeHalfAng</span><span class="p">,</span> <span class="n">RadL</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Optics</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Rad</span><span class="p">,</span> <span class="n">RadD</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Rad</span><span class="p">,</span> <span class="n">F1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Optics</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">F1</span><span class="p">,</span>
                <span class="n">OpType</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">OpticsType</span><span class="p">,</span> <span class="n">VType</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">Type</span><span class="p">,</span> <span class="n">Mode</span><span class="o">=</span><span class="s">&#39;trapz&#39;</span><span class="p">,</span> <span class="n">dX12</span><span class="o">=</span><span class="n">dX12</span><span class="p">,</span> <span class="n">dX12Mode</span><span class="o">=</span><span class="n">dX12Mode</span><span class="p">,</span> <span class="n">Ratio</span><span class="o">=</span><span class="n">Ratio</span><span class="p">,</span> <span class="n">Colis</span><span class="o">=</span><span class="n">Colis</span><span class="p">,</span> <span class="n">Details</span><span class="o">=</span><span class="k">True</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="k">True</span><span class="p">)</span>

        <span class="c">#SA, X1, X2, numX1, numX2 = _tfg_c.Calc_SAngOnPlane(self, P, self.LOS[LOSRef][&#39;LOS&#39;].u, dX12=dX12, dX12Mode=dX12Mode, e1=None,e2=None, Ratio=Ratio, Colis=Colis, Test=True)</span>
        <span class="n">SA</span> <span class="o">=</span> <span class="n">SA</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">NumX1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">NumX2</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">X1</span><span class="p">,</span> <span class="n">X2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">X1</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),(</span><span class="n">NumX2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">X2</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),(</span><span class="n">NumX1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">Name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">NameLTX</span> <span class="o">+</span> <span class="s">&quot; Pos={0} (Ratio={1})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Pos</span><span class="p">,</span><span class="n">Ratio</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">_tfg_p</span><span class="o">.</span><span class="n">Plot_SAng_Plane</span><span class="p">(</span><span class="n">SA</span><span class="p">,</span> <span class="n">X1</span><span class="p">,</span> <span class="n">X2</span><span class="p">,</span> <span class="n">Name</span><span class="o">=</span><span class="n">Name</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">SurfDict</span><span class="o">=</span><span class="n">SurfDict</span><span class="p">,</span> <span class="n">LegDict</span><span class="o">=</span><span class="n">LegDict</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">a4</span><span class="o">=</span><span class="n">a4</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">draw</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">ax</span>


<div class="viewcode-block" id="Detect.plot_Etend_AlongLOS"><a class="viewcode-back" href="../../../Auto_tofu.geom.html#tofu.geom.Detect.plot_Etend_AlongLOS">[docs]</a>    <span class="k">def</span> <span class="nf">plot_Etend_AlongLOS</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">NP</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetEtendOnLOSNP</span><span class="p">,</span> <span class="n">kMode</span><span class="o">=</span><span class="s">&#39;rel&#39;</span><span class="p">,</span> <span class="n">Modes</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;trapz&#39;</span><span class="p">],</span> <span class="n">Length</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">RelErr</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetEtendepsrel</span><span class="p">,</span> <span class="n">dX12</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetSynthdX12</span><span class="p">,</span> <span class="n">dX12Mode</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetSynthdX12Mode</span><span class="p">,</span> <span class="n">Ratio</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetEtendRatio</span><span class="p">,</span> <span class="n">LOSRef</span><span class="o">=</span><span class="k">None</span><span class="p">,</span>
            <span class="n">LOSPts</span><span class="o">=</span><span class="k">True</span><span class="p">,</span> <span class="n">Ldict</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetEtendOnLOSLd</span><span class="p">),</span> <span class="n">LegDict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">TorLegd</span><span class="p">,</span> <span class="n">Colis</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetSAngColis</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="k">True</span><span class="p">,</span> <span class="n">a4</span><span class="o">=</span><span class="k">True</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="k">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Plot the etendue of the selected LOS along it, with or without collision detection</span>

<span class="sd">        The number of points along the LOS where the etendue is computed can be specified via arguments, as well as the numerical integration method.</span>
<span class="sd">        Arguments Length, NP, Modes, RelErr, dX12, dX12Mode, Ratio, Colis, LOSRef are fed to :meth:`~tofu.geom.Detect.calc_Etendue_AlongLOS`</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ax :        None or plt.Axes</span>
<span class="sd">            Axes to be used for plotting, if None a new figure and appropriate axes are created</span>
<span class="sd">        kMode :     str</span>
<span class="sd">            Flag indicating whether the distance on the line should be plotted as abolute distance (&#39;abs&#39;) or relative to the total length (&#39;rel&#39;)</span>
<span class="sd">        Ldict :     dict</span>
<span class="sd">            Dictionary of properties for plotting the result</span>
<span class="sd">        LegDict :   None / dict</span>
<span class="sd">            If None, no legend is plotted, else LegDict is fed to :meth:&#39;~matplotlib.pyplot.Axes.legend&#39;</span>
<span class="sd">        draw :      bool</span>
<span class="sd">            Flag indicating whether to draw the figure</span>
<span class="sd">        a4 :        bool</span>
<span class="sd">            Flag indicating whether the created figure should have a4 dimensions (useful for printing)</span>
<span class="sd">        Test :      bool</span>
<span class="sd">            Flag indicating whether the inputs should be tested for conformity</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ax :        plt.Axes</span>
<span class="sd">            The axes used for plotting</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Etends</span><span class="p">,</span> <span class="n">Pts</span><span class="p">,</span> <span class="n">kPts</span><span class="p">,</span> <span class="n">LOSRef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_Etendue_AlongLOS</span><span class="p">(</span><span class="n">Length</span><span class="o">=</span><span class="n">Length</span><span class="p">,</span> <span class="n">NP</span><span class="o">=</span><span class="n">NP</span><span class="p">,</span> <span class="n">Modes</span><span class="o">=</span><span class="n">Modes</span><span class="p">,</span> <span class="n">RelErr</span><span class="o">=</span><span class="n">RelErr</span><span class="p">,</span> <span class="n">dX12</span><span class="o">=</span><span class="n">dX12</span><span class="p">,</span> <span class="n">dX12Mode</span><span class="o">=</span><span class="n">dX12Mode</span><span class="p">,</span> <span class="n">Ratio</span><span class="o">=</span><span class="n">Ratio</span><span class="p">,</span> <span class="n">Colis</span><span class="o">=</span><span class="n">Colis</span><span class="p">,</span> <span class="n">LOSRef</span><span class="o">=</span><span class="n">LOSRef</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="k">True</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">_tfg_p</span><span class="o">.</span><span class="n">Plot_Etendue_AlongLOS</span><span class="p">(</span><span class="n">kPts</span><span class="p">,</span> <span class="n">Etends</span><span class="p">,</span> <span class="n">kMode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="p">[</span><span class="n">LOSRef</span><span class="p">][</span><span class="s">&#39;LOS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">NameLTX</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">Colis</span><span class="o">=</span><span class="n">Colis</span><span class="p">,</span>
                <span class="n">Etend</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="p">[</span><span class="n">LOSRef</span><span class="p">][</span><span class="s">&#39;Etend&#39;</span><span class="p">],</span> <span class="n">kPIn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="p">[</span><span class="n">LOSRef</span><span class="p">][</span><span class="s">&#39;LOS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">kPIn</span><span class="p">,</span> <span class="n">kPOut</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">LOS</span><span class="p">[</span><span class="n">LOSRef</span><span class="p">][</span><span class="s">&#39;LOS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">kPOut</span><span class="p">,</span> <span class="n">y0</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
                <span class="n">RelErr</span><span class="o">=</span><span class="n">RelErr</span><span class="p">,</span> <span class="n">dX12</span><span class="o">=</span><span class="n">dX12</span><span class="p">,</span> <span class="n">dX12Mode</span><span class="o">=</span><span class="n">dX12Mode</span><span class="p">,</span> <span class="n">Ratio</span><span class="o">=</span><span class="n">Ratio</span><span class="p">,</span>
                <span class="n">Ldict</span><span class="o">=</span><span class="n">Ldict</span><span class="p">,</span> <span class="n">LegDict</span><span class="o">=</span><span class="n">LegDict</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="n">draw</span><span class="p">,</span> <span class="n">a4</span><span class="o">=</span><span class="n">a4</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="n">Test</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></div>

<div class="viewcode-block" id="Detect.plot_Sinogram"><a class="viewcode-back" href="../../../Auto_tofu.geom.html#tofu.geom.Detect.plot_Sinogram">[docs]</a>    <span class="k">def</span> <span class="nf">plot_Sinogram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Proj</span><span class="o">=</span><span class="s">&#39;Cross&#39;</span><span class="p">,</span> <span class="n">Elt</span><span class="o">=</span><span class="s">&#39;DLV&#39;</span><span class="p">,</span> <span class="n">Ang</span><span class="o">=</span><span class="s">&#39;theta&#39;</span><span class="p">,</span> <span class="n">AngUnit</span><span class="o">=</span><span class="s">&#39;rad&#39;</span><span class="p">,</span> <span class="n">Sketch</span><span class="o">=</span><span class="k">True</span><span class="p">,</span> <span class="n">Ddict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetImpd</span><span class="p">,</span> <span class="n">Ldict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">LOSMImpd</span><span class="p">,</span> <span class="n">Vdict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">TorPFilld</span><span class="p">,</span> <span class="n">LegDict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">TorLegd</span><span class="p">,</span> <span class="n">LOSRef</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="k">True</span><span class="p">,</span> <span class="n">a4</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="k">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Plot the the Detect VOS in projection space, optionally also the associated :class:`~tofu.geom.Ves` object and reference LOS</span>

<span class="sd">        In projection space, a VOS is a patch (as opposed to a LOS which is a point).</span>
<span class="sd">        The patch is estimated by plotting a large number of LOS sampling the VOS and taking the convex hull of the resulting points on projection space.</span>
<span class="sd">        Notice that this method results in irrelevant patches for VOS lying at the edges of the projection space.</span>
<span class="sd">        See :meth:`~tofu.geom.LOS.plot_Sinogram` for details.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ax :        None / plt.Axes</span>
<span class="sd">            Axes on which to plot the Etendue, if None a default axes is created</span>
<span class="sd">        Proj :      str</span>
<span class="sd">            Flag indicating whether to plot the traditional sinogram in a cross-section (&#39;Cross&#39;) or a 3D sinogram (&#39;3d&#39;), cannot be &#39;3d&#39; if &#39;D&#39; in Elt.</span>
<span class="sd">        Elt :       str</span>
<span class="sd">            Flags indicating whether to plot the VOS of the Detect (&#39;D&#39; in Elt =&gt; only Proj=&#39;Cross&#39;), the LOS (&#39;L&#39; in Elt) and the :class:`~tofu.geom.Ves` (&#39;V&#39; in Elt)</span>
<span class="sd">        Ang :       str</span>
<span class="sd">            Flag indicating which angle to use for the plot, with respect to the considered line () or to the impact parameter line ()</span>
<span class="sd">        AngUnit :   str</span>
<span class="sd">            Flag indicating whether the angle should be measured in &#39;rad&#39; or &#39;deg&#39;</span>
<span class="sd">        Sketch :    bool</span>
<span class="sd">            Flag indicating whether a small sketch illustrating the definitions of angles and impact parameter should be included</span>
<span class="sd">        Ddict :     dict</span>
<span class="sd">            Plotting properties of the VOS of the Detect, fed to plt.plot()</span>
<span class="sd">        Ldict :     dict</span>
<span class="sd">            Plotting properties of the LOS, fed to plt.plot()</span>
<span class="sd">        Vdict :     dict</span>
<span class="sd">            Plotting properties of the Ves, fed to plt.plot()</span>
<span class="sd">        LegDict :   None / dict</span>
<span class="sd">            Plotting properties of the legend, if None no legend is plotted</span>
<span class="sd">        LOSRef :    None / str</span>
<span class="sd">            Flag indicating which LOS to plot, if None self._LOSRef is used</span>
<span class="sd">        draw :      bool</span>
<span class="sd">            Flag indicating whether to draw the figure</span>
<span class="sd">        a4 :        bool</span>
<span class="sd">            Flag indicating whether the created figure should have a4 dimensions (useful for printing)</span>
<span class="sd">        Test :      bool</span>
<span class="sd">            Flag indicating whether the inputs should be tested for conformity</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ax :        plt.Axes</span>
<span class="sd">            The axes used for plotting</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">_tfg_p</span><span class="o">.</span><span class="n">GLDetect_plot_Sinogram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Proj</span><span class="o">=</span><span class="n">Proj</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">Elt</span><span class="o">=</span><span class="n">Elt</span><span class="p">,</span> <span class="n">Sketch</span><span class="o">=</span><span class="n">Sketch</span><span class="p">,</span> <span class="n">Ang</span><span class="o">=</span><span class="n">Ang</span><span class="p">,</span> <span class="n">AngUnit</span><span class="o">=</span><span class="n">AngUnit</span><span class="p">,</span> <span class="n">Ddict</span><span class="o">=</span><span class="n">Ddict</span><span class="p">,</span> <span class="n">Ldict</span><span class="o">=</span><span class="n">Ldict</span><span class="p">,</span> <span class="n">Vdict</span><span class="o">=</span><span class="n">Vdict</span><span class="p">,</span> <span class="n">LegDict</span><span class="o">=</span><span class="n">LegDict</span><span class="p">,</span> <span class="n">LOSRef</span><span class="o">=</span><span class="n">LOSRef</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="n">draw</span><span class="p">,</span> <span class="n">a4</span><span class="o">=</span><span class="n">a4</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="n">Test</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></div>



    <span class="k">def</span> <span class="nf">_plot_Res</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">plotfunc</span><span class="o">=</span><span class="s">&#39;scatter&#39;</span><span class="p">,</span> <span class="n">NC</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">CDict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetConed</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="k">True</span><span class="p">,</span> <span class="n">a4</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="k">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Plot the resolution as defined by tofu (see :meth:`~tofu.geom.Detect._calc_Res` for details)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ax :        None / plt.Axes</span>
<span class="sd">            Axes on which to plot the Etendue, if None a default axes is created</span>
<span class="sd">        plotfunc :  str</span>
<span class="sd">            Flag indicating which plotting method to use in [&#39;scatter&#39;,&#39;contour&#39;,&#39;contourf&#39;,&#39;imshow&#39;]</span>
<span class="sd">        NC :        int</span>
<span class="sd">            Number of contours to be plotted if plotfunc in [&#39;contour&#39;,&#39;contourf&#39;]</span>
<span class="sd">        CDict :     dict</span>
<span class="sd">            Dictionary of properties for plotting, fed to the plotting routine</span>
<span class="sd">        draw :      bool</span>
<span class="sd">            Flag indicating whether to draw the figure</span>
<span class="sd">        a4 :        bool</span>
<span class="sd">            Flag indicating whether the created figure should have a4 dimensions (useful for printing)</span>
<span class="sd">        Test :      bool</span>
<span class="sd">            Flag indicating whether the inputs should be tested for conformity</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ax :        plt.Axes</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Res_Done</span><span class="p">,</span> <span class="s">&quot;Cannot plot the resolution before it has been computed on a mesh grid with self.set_Res() !&quot;</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">_tfg_p</span><span class="o">.</span><span class="n">_Resolution_Plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_Res_Pts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Res_Res</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Name</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">plotfunc</span><span class="o">=</span><span class="n">plotfunc</span><span class="p">,</span> <span class="n">NC</span><span class="o">=</span><span class="n">NC</span><span class="p">,</span> <span class="n">CDict</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">CDict</span><span class="p">),</span>
                                     <span class="n">ind</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Val</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="n">draw</span><span class="p">,</span> <span class="n">a4</span><span class="o">=</span><span class="n">a4</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="n">Test</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span>



<div class="viewcode-block" id="Detect.save"><a class="viewcode-back" href="../../../Auto_tofu.geom.html#tofu.geom.Detect.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">SaveName</span><span class="o">=</span><span class="k">None</span><span class="p">,</span><span class="n">Path</span><span class="o">=</span><span class="k">None</span><span class="p">,</span><span class="n">Mode</span><span class="o">=</span><span class="s">&#39;npz&#39;</span><span class="p">,</span> <span class="n">compressed</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">SynthDiag</span><span class="o">=</span><span class="k">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Save the object in folder Name, under file name SaveName, using specified mode</span>

<span class="sd">        Most tofu objects can be saved automatically as numpy arrays (.npz, recommended) at the default location (recommended) by simply calling self.save()</span>
<span class="sd">        In the case of Detect and GDetect instances, there is an additional keyword argument &#39;SynthDiag&#39; which allows to **not** save the pre-computed 3D mesh of the VOS for synthetic diagnostic.</span>
<span class="sd">        Indeed, this pre-computed data is often large and results in big files. Not saving it results in significantly smaller files, and it can be re-computed when loading the instance.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        SaveName :      None / str</span>
<span class="sd">            The name to be used for the saved file, if None (recommended) uses self.Id.SaveName</span>
<span class="sd">        Path :          None / str</span>
<span class="sd">            Path specifying where to save the file, if None (recommended) uses self.Id.SavePath</span>
<span class="sd">        Mode :          str</span>
<span class="sd">            Flag specifying whether to save the object as a numpy array file (&#39;.npz&#39;, recommended) or an object using cPickle (not recommended, heavier and may cause retro-compatibility issues)</span>
<span class="sd">        compressed :    bool</span>
<span class="sd">            Flag, used when Mode=&#39;npz&#39;, indicating whether to use np.savez or np.savez_compressed (slower saving and loading but smaller files)</span>
<span class="sd">        SynthDiag :     bool</span>
<span class="sd">            Flag indicating whether the pre-computed mesh for synthetic diagnostics calculations shall be saved too (can be heavy, if False, it will be re-computed when opening the saved object)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">SynthDiag</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reset_SynthDiag</span><span class="p">()</span>
        <span class="n">tfpf</span><span class="o">.</span><span class="n">Save_Generic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">SaveName</span><span class="o">=</span><span class="n">SaveName</span><span class="p">,</span> <span class="n">Path</span><span class="o">=</span><span class="n">Path</span><span class="p">,</span> <span class="n">Mode</span><span class="o">=</span><span class="n">Mode</span><span class="p">,</span> <span class="n">compressed</span><span class="o">=</span><span class="n">compressed</span><span class="p">)</span></div></div>






<span class="k">def</span> <span class="nf">_Detect_set_Defaults</span><span class="p">(</span><span class="n">Poly</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Diag</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Ves</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Optics</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">Optics</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">Optics</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">Diag</span> <span class="o">=</span> <span class="n">Diag</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">Diag</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">else</span> <span class="n">Optics</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Diag</span>
            <span class="n">Exp</span> <span class="o">=</span> <span class="n">Exp</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">Exp</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">else</span> <span class="n">Optics</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Exp</span>
            <span class="n">Ves</span> <span class="o">=</span> <span class="n">Optics</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Ves</span> <span class="k">if</span> <span class="n">Ves</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">else</span> <span class="n">Ves</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Diag</span> <span class="o">=</span> <span class="n">Diag</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">Diag</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">else</span> <span class="n">Optics</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Diag</span>
            <span class="n">Exp</span> <span class="o">=</span> <span class="n">Exp</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">Exp</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">else</span> <span class="n">Optics</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Exp</span>
            <span class="n">Ves</span> <span class="o">=</span> <span class="n">Optics</span><span class="o">.</span><span class="n">Ves</span> <span class="k">if</span> <span class="n">Ves</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">else</span> <span class="n">Ves</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">Optics</span><span class="p">)</span> <span class="ow">is</span> <span class="n">Lens</span><span class="p">:</span>
            <span class="n">Type</span> <span class="o">=</span> <span class="n">Type</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">Type</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">else</span> <span class="s">&#39;Circ&#39;</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">Ves</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
        <span class="n">Exp</span> <span class="o">=</span> <span class="n">Exp</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">Exp</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">else</span> <span class="n">Ves</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Exp</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">Poly</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">Optics</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">Optics</span><span class="p">)</span> <span class="ow">is</span> <span class="n">Lens</span><span class="p">:</span>
            <span class="n">Poly</span><span class="p">[</span><span class="s">&#39;O&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Optics</span><span class="o">.</span><span class="n">O</span><span class="o">-</span><span class="n">Optics</span><span class="o">.</span><span class="n">F1</span><span class="o">*</span><span class="n">Optics</span><span class="o">.</span><span class="n">nIn</span>
            <span class="n">Poly</span><span class="p">[</span><span class="s">&#39;nIn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Optics</span><span class="o">.</span><span class="n">nIn</span>
    <span class="k">return</span> <span class="n">Poly</span><span class="p">,</span> <span class="n">Type</span><span class="p">,</span> <span class="n">Exp</span><span class="p">,</span> <span class="n">Diag</span><span class="p">,</span> <span class="n">shot</span><span class="p">,</span> <span class="n">Ves</span>






<span class="k">def</span> <span class="nf">_Detect_check_inputs</span><span class="p">(</span><span class="n">Id</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Poly</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Optics</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Vess</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Sino_RefPt</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Diag</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">CalcEtend</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">CalcSpanImp</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">CalcCone</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">CalcPreComp</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Calc</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Verb</span><span class="o">=</span><span class="k">None</span><span class="p">,</span>
        <span class="n">Etend_RelErr</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Etend_dX12</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Etend_dX12Mode</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Etend_Ratio</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Colis</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">LOSRef</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Etend_Method</span><span class="o">=</span><span class="k">None</span><span class="p">,</span>
        <span class="n">MarginRMin</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">NEdge</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">NRad</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Nk</span><span class="o">=</span><span class="k">None</span><span class="p">,</span>
        <span class="n">Cone_DRY</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Cone_DXTheta</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Cone_DZ</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Cone_NPsi</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Cone_Nk</span><span class="o">=</span><span class="k">None</span><span class="p">,</span>
        <span class="n">arrayorder</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Clock</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">dtime</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">dtimeIn</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">Id</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">Id</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">tfpf</span><span class="o">.</span><span class="n">ID</span><span class="p">],</span> <span class="s">&quot;Arg Id must be a str or a tfpf.ID object !&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">Poly</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
        <span class="k">assert</span>  <span class="nb">type</span><span class="p">(</span><span class="n">Poly</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">Poly</span><span class="p">,</span><span class="s">&#39;__getitem__&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">Poly</span><span class="p">)</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">2</span> <span class="ow">and</span> <span class="mi">3</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">Poly</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="s">&quot;Arg Poly must be a dict or an iterable with 3D cartesian coordinates of points !&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">Poly</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">aa</span> <span class="ow">in</span> <span class="n">Poly</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;Rad&#39;</span><span class="p">]]),</span> <span class="s">&quot;Arg Poly must be a dict with keys [&#39;Rad&#39;] !&quot;</span>
            <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">Poly</span><span class="p">[</span><span class="s">&#39;Rad&#39;</span><span class="p">])</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">float</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">],</span> <span class="s">&quot;Arg Poly[&#39;Rad&#39;] must be a float !&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">Optics</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">Optics</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">list</span><span class="p">,</span><span class="n">Apert</span><span class="p">,</span><span class="n">Lens</span><span class="p">],</span> <span class="s">&quot;Arg Optics must be a list, Apert or Lens&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">Optics</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="nb">type</span><span class="p">(</span><span class="n">oo</span><span class="p">)</span> <span class="ow">is</span> <span class="n">Apert</span> <span class="k">for</span> <span class="n">oo</span> <span class="ow">in</span> <span class="n">Optics</span><span class="p">]),</span> <span class="s">&quot;Arg Optics must be a list of Apert !&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">Optics</span><span class="p">)</span> <span class="ow">is</span> <span class="n">Lens</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">Poly</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span> <span class="ow">and</span> <span class="s">&#39;Rad&#39;</span> <span class="ow">in</span> <span class="n">Poly</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="s">&quot;When Optics is a Lens, Poly must be a dict with field &#39;Rad&#39; !&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Exp</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">Optics</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">Exp</span><span class="o">==</span><span class="n">Optics</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Exp</span><span class="p">,</span> <span class="s">&quot;Arg Exp must be the same as the Optics[0].Id.Exp !&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">Exp</span><span class="o">==</span><span class="n">Optics</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Exp</span><span class="p">,</span> <span class="s">&quot;Arg Exp must be the same as the Optics.Id.Exp !&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Diag</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">Optics</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">Diag</span><span class="o">==</span><span class="n">Optics</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Diag</span><span class="p">,</span> <span class="s">&quot;Arg Exp must be the same as the Optics[0].Id.Diag !&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">Diag</span><span class="o">==</span><span class="n">Optics</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Diag</span><span class="p">,</span> <span class="s">&quot;Arg Diag must be the same as the Optics.Id.Diag !&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">Vess</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">Vess</span><span class="p">)</span> <span class="ow">is</span> <span class="n">Ves</span><span class="p">,</span> <span class="s">&quot;Arg Ves must be a Ves instance !&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Exp</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">Exp</span><span class="o">==</span><span class="n">Vess</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Exp</span><span class="p">,</span> <span class="s">&quot;Arg Exp must be the same as the Ves.Id.Exp !&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">arrayorder</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">arrayorder</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;C&#39;</span><span class="p">,</span><span class="s">&#39;F&#39;</span><span class="p">],</span> <span class="s">&quot;Arg arrayorder must be in [&#39;C&#39;,&#39;F&#39;] !&quot;</span>
    <span class="n">bools</span> <span class="o">=</span> <span class="p">[</span><span class="n">CalcEtend</span><span class="p">,</span><span class="n">CalcSpanImp</span><span class="p">,</span><span class="n">CalcCone</span><span class="p">,</span><span class="n">CalcPreComp</span><span class="p">,</span><span class="n">Calc</span><span class="p">,</span><span class="n">Verb</span><span class="p">,</span><span class="n">Colis</span><span class="p">,</span><span class="n">Clock</span><span class="p">,</span><span class="n">dtimeIn</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="ow">not</span> <span class="n">aa</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">bools</span><span class="p">]):</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">aa</span> <span class="ow">is</span> <span class="k">None</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">aa</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">bool</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">bools</span><span class="p">]),</span> <span class="s">&quot; Args [CalcEtend,CalcSpanImp,CalcCone,CalcPreComp,Calc,Verb,Colis,Clock,dtimeIn] must all be bool !&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">Exp</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">Exp</span> <span class="ow">in</span> <span class="n">tfd</span><span class="o">.</span><span class="n">AllowedExp</span><span class="p">,</span> <span class="s">&quot;Arg Exp must be in &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">AllowedExp</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; !&quot;</span>
    <span class="k">assert</span> <span class="n">Type</span> <span class="ow">is</span> <span class="k">None</span> <span class="ow">or</span> <span class="n">Type</span><span class="o">==</span><span class="s">&#39;Circ&#39;</span><span class="p">,</span> <span class="s">&quot;Arg Type must be Circ or None for Detect objects !&quot;</span>
    <span class="n">Iter2</span> <span class="o">=</span> <span class="p">[</span><span class="n">Sino_RefPt</span><span class="p">,</span><span class="n">Etend_dX12</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="ow">not</span> <span class="n">aa</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">Iter2</span><span class="p">]):</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">aa</span> <span class="ow">is</span> <span class="k">None</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">aa</span><span class="p">,</span><span class="s">&#39;__iter__&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">aa</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="o">==</span><span class="p">(</span><span class="mi">2</span><span class="p">,))</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">Iter2</span><span class="p">]),</span> <span class="s">&quot;Args [Sino_RefPt,Etend_dX12] must be an iterable with len()=2 !&quot;</span>
    <span class="n">strs</span> <span class="o">=</span> <span class="p">[</span><span class="n">Etend_dX12Mode</span><span class="p">,</span><span class="n">LOSRef</span><span class="p">,</span><span class="n">Etend_Method</span><span class="p">,</span><span class="n">Diag</span><span class="p">,</span><span class="n">SavePath</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="ow">not</span> <span class="n">aa</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">strs</span><span class="p">]):</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">aa</span> <span class="ow">is</span> <span class="k">None</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">aa</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">strs</span><span class="p">]),</span> <span class="s">&quot;Args [dX12Mode,LOSRef,Method,Diag,SavePath] must all be str !&quot;</span>
    <span class="n">floats</span> <span class="o">=</span> <span class="p">[</span><span class="n">Etend_RelErr</span><span class="p">,</span><span class="n">Etend_Ratio</span><span class="p">,</span><span class="n">MarginRMin</span><span class="p">,</span><span class="n">Cone_DRY</span><span class="p">,</span><span class="n">Cone_DXTheta</span><span class="p">,</span><span class="n">Cone_DZ</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="ow">not</span> <span class="n">aa</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">floats</span><span class="p">]):</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">aa</span> <span class="ow">is</span> <span class="k">None</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">aa</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">float</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">floats</span><span class="p">]),</span> <span class="s">&quot;Args [RelErr,dX12,Ratio,MarginRMin] must all be floats !&quot;</span>
    <span class="n">ints</span> <span class="o">=</span> <span class="p">[</span><span class="n">shot</span><span class="p">,</span><span class="n">NEdge</span><span class="p">,</span><span class="n">NRad</span><span class="p">,</span><span class="n">Nk</span><span class="p">,</span><span class="n">Cone_NPsi</span><span class="p">,</span><span class="n">Cone_Nk</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="ow">not</span> <span class="n">aa</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">ints</span><span class="p">]):</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">aa</span> <span class="ow">is</span> <span class="k">None</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">aa</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">ints</span><span class="p">]),</span> <span class="s">&quot;Args [shot,NEdge,NRad] must be int !&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">dtime</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">dtime</span><span class="p">)</span> <span class="ow">is</span> <span class="n">dtm</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="s">&quot;Arg dtime must be a dtm.datetime !&quot;</span>














<div class="viewcode-block" id="GDetect"><a class="viewcode-back" href="../../../Auto_tofu.geom.html#tofu.geom.GDetect">[docs]</a><span class="k">class</span> <span class="nc">GDetect</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; An object grouping a list of :class:`~tofu.geom.Detect` objects with some common features (e.g.: all belong to the same camera) and the same :class:`~tofu.geom.Ves` object, provides methods for common computing and plotting</span>

<span class="sd">    A GDetect object is a convenient tool for managing groups of detectors, applying common treatment, plotting...</span>
<span class="sd">    It is typically suited for a camera (e.g.: a group of detectors sharing a common aperture)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    Id :            str or tfpf.ID</span>
<span class="sd">        A name string or a pre-built tfpf.ID class to be used to identify this particular instance, if a string is provided, it is fed to :class:`~tofu.pathfile.ID`</span>
<span class="sd">    LDetect :       list or Detect</span>
<span class="sd">        List of Detect instances with the same :class:`~tofu.geom.Ves` instance</span>
<span class="sd">    Type :          None</span>
<span class="sd">        Not used in the current verion of tofu</span>
<span class="sd">    Exp :           None or str</span>
<span class="sd">        Experiment to which the Lens belongs, should be identical to Ves.Id.Exp if Ves is provided, if None and Ves is provided, Ves.Id.Exp is used</span>
<span class="sd">    Diag :          None or str</span>
<span class="sd">        Diagnostic to which the Lens belongs</span>
<span class="sd">    shot :          None or int</span>
<span class="sd">        Shot number from which this Lens is usable (in case its position was changed from a previous configuration)</span>
<span class="sd">    SavePath :      None / str</span>
<span class="sd">        If provided, forces the default saving path of the object to the provided value</span>
<span class="sd">    Sino_RefPt :    None or iterable</span>
<span class="sd">        If provided, forces the common :attr:`~tofu.geom.Detect.Sino_RefPt` to the provided value for all :class:`~tofu.geom.Detect` instances</span>
<span class="sd">    arrayorder :    str</span>
<span class="sd">        Flag indicating whether the attributes of type=np.ndarray (e.g.: Poly) should be made C-contiguous (&#39;C&#39;) or Fortran-contiguous (&#39;F&#39;)</span>
<span class="sd">    dtime :         None or dtm.datetime</span>
<span class="sd">        A time reference to be used to identify this particular instance (used for debugging mostly)</span>
<span class="sd">    dtimeIn :       bool</span>
<span class="sd">        Flag indicating whether dtime should be included in the SaveName (used for debugging mostly)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="n">LDetect</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Diag</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Sino_RefPt</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">LOSRef</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">arrayorder</span><span class="o">=</span><span class="s">&#39;C&#39;</span><span class="p">,</span> <span class="n">Clock</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">dtime</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">dtimeIn</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_Done</span> <span class="o">=</span> <span class="k">False</span>
        <span class="n">tfpf</span><span class="o">.</span><span class="n">_check_NotNone</span><span class="p">({</span><span class="s">&#39;Clock&#39;</span><span class="p">:</span><span class="n">Clock</span><span class="p">,</span><span class="s">&#39;arrayorder&#39;</span><span class="p">:</span><span class="n">arrayorder</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_inputs</span><span class="p">(</span><span class="n">Clock</span><span class="o">=</span><span class="n">Clock</span><span class="p">,</span> <span class="n">arrayorder</span><span class="o">=</span><span class="n">arrayorder</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_arrayorder</span> <span class="o">=</span> <span class="n">arrayorder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Clock</span> <span class="o">=</span> <span class="n">Clock</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_check_inputs</span><span class="p">(</span><span class="n">LDetect</span><span class="o">=</span><span class="n">LDetect</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="n">Exp</span><span class="p">,</span> <span class="n">Diag</span><span class="o">=</span><span class="n">Diag</span><span class="p">)</span>
        <span class="n">LDetect</span><span class="p">,</span> <span class="n">Exp</span><span class="p">,</span> <span class="n">Diag</span><span class="p">,</span> <span class="n">Sino_RefPt</span><span class="p">,</span> <span class="n">LOSRef</span> <span class="o">=</span> <span class="n">_GDetect_set_Defaults</span><span class="p">(</span><span class="n">LDetect</span><span class="o">=</span><span class="n">LDetect</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="n">Exp</span><span class="p">,</span> <span class="n">Diag</span><span class="o">=</span><span class="n">Diag</span><span class="p">,</span> <span class="n">Sino_RefPt</span><span class="o">=</span><span class="n">Sino_RefPt</span><span class="p">,</span> <span class="n">LOSRef</span><span class="o">=</span><span class="n">LOSRef</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_LOSRef</span> <span class="o">=</span> <span class="n">LOSRef</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_Id</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="n">Type</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="n">Exp</span><span class="p">,</span> <span class="n">Diag</span><span class="o">=</span><span class="n">Diag</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="n">shot</span><span class="p">,</span> <span class="n">dtime</span><span class="o">=</span><span class="n">dtime</span><span class="p">,</span> <span class="n">dtimeIn</span><span class="o">=</span><span class="n">dtimeIn</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="n">SavePath</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_LDetect</span><span class="p">(</span><span class="n">LDetect</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reset_Res</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Done</span> <span class="o">=</span> <span class="k">True</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; the associated tfpf.ID object &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Id</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">LDetect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the list of :class:`~tofu.geom.Detect` instances the GDetect object comprises &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_LDetect</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nDetect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the number of :class:`~tofu.geom.Detect` instances the GDetect object comprises &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nDetect</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Optics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the list of optics the GDetect object comprises (either :class:`~tofu.geom.Lens` or :class:`~tofu.geom.Apert`) &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Optics</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Ves</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the :class:`~tofu.geom.Ves` instance associated to the GDetect object &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Ves</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Sino_RefPt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the coordinates (R,Z) or (Y,Z) for Ves of Type &#39;Tor&#39; or (Y,Z) for Ves of Type &#39;Lin&#39; of the reference point used to compute the sinogram &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Sino_RefPt</span>



    <span class="k">def</span> <span class="nf">_check_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Id</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">LDetect</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Sino_RefPt</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">LOSRef</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Diag</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="k">None</span><span class="p">,</span>
                      <span class="n">arrayorder</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Clock</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">dtime</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">dtimeIn</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
        <span class="n">_GDetect_check_inputs</span><span class="p">(</span><span class="n">Id</span><span class="o">=</span><span class="n">Id</span><span class="p">,</span> <span class="n">LDetect</span><span class="o">=</span><span class="n">LDetect</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="n">Type</span><span class="p">,</span> <span class="n">Sino_RefPt</span><span class="o">=</span><span class="n">Sino_RefPt</span><span class="p">,</span> <span class="n">LOSRef</span><span class="o">=</span><span class="n">LOSRef</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="n">Exp</span><span class="p">,</span> <span class="n">Diag</span><span class="o">=</span><span class="n">Diag</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="n">shot</span><span class="p">,</span>
                             <span class="n">arrayorder</span><span class="o">=</span><span class="n">arrayorder</span><span class="p">,</span> <span class="n">Clock</span><span class="o">=</span><span class="n">Clock</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="n">SavePath</span><span class="p">,</span> <span class="n">dtime</span><span class="o">=</span><span class="n">dtime</span><span class="p">,</span> <span class="n">dtimeIn</span><span class="o">=</span><span class="n">dtimeIn</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_Id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Val</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Diag</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">dtime</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">dtimeIn</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Done</span><span class="p">:</span>
            <span class="n">Out</span> <span class="o">=</span> <span class="n">tfpf</span><span class="o">.</span><span class="n">_get_FromItself</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;Type&#39;</span><span class="p">:</span><span class="n">Type</span><span class="p">,</span> <span class="s">&#39;Exp&#39;</span><span class="p">:</span><span class="n">Exp</span><span class="p">,</span> <span class="s">&#39;shot&#39;</span><span class="p">:</span><span class="n">shot</span><span class="p">,</span> <span class="s">&#39;Diag&#39;</span><span class="p">:</span><span class="n">Diag</span><span class="p">,</span> <span class="s">&#39;dtime&#39;</span><span class="p">:</span><span class="n">dtime</span><span class="p">,</span> <span class="s">&#39;_dtimeIn&#39;</span><span class="p">:</span><span class="n">dtimeIn</span><span class="p">,</span> <span class="s">&#39;SavePath&#39;</span><span class="p">:</span><span class="n">SavePath</span><span class="p">})</span>
            <span class="n">Type</span><span class="p">,</span> <span class="n">Exp</span><span class="p">,</span> <span class="n">shot</span><span class="p">,</span> <span class="n">Diag</span><span class="p">,</span> <span class="n">dtime</span><span class="p">,</span> <span class="n">dtimeIn</span><span class="p">,</span> <span class="n">SavePath</span> <span class="o">=</span> <span class="n">Out</span><span class="p">[</span><span class="s">&#39;Type&#39;</span><span class="p">],</span> <span class="n">Out</span><span class="p">[</span><span class="s">&#39;Exp&#39;</span><span class="p">],</span> <span class="n">Out</span><span class="p">[</span><span class="s">&#39;shot&#39;</span><span class="p">],</span> <span class="n">Out</span><span class="p">[</span><span class="s">&#39;Diag&#39;</span><span class="p">],</span> <span class="n">Out</span><span class="p">[</span><span class="s">&#39;dtime&#39;</span><span class="p">],</span> <span class="n">Out</span><span class="p">[</span><span class="s">&#39;dtimeIn&#39;</span><span class="p">],</span> <span class="n">Out</span><span class="p">[</span><span class="s">&#39;SavePath&#39;</span><span class="p">]</span>
        <span class="n">tfpf</span><span class="o">.</span><span class="n">_check_NotNone</span><span class="p">({</span><span class="s">&#39;Id&#39;</span><span class="p">:</span><span class="n">Val</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_inputs</span><span class="p">(</span><span class="n">Id</span><span class="o">=</span><span class="n">Val</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">Val</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">tfpf</span><span class="o">.</span><span class="n">_check_NotNone</span><span class="p">({</span><span class="s">&#39;Exp&#39;</span><span class="p">:</span><span class="n">Exp</span><span class="p">,</span> <span class="s">&#39;shot&#39;</span><span class="p">:</span><span class="n">shot</span><span class="p">,</span> <span class="s">&#39;Diag&#39;</span><span class="p">:</span><span class="n">Diag</span><span class="p">,</span> <span class="s">&#39;dtimeIn&#39;</span><span class="p">:</span><span class="n">dtimeIn</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_inputs</span><span class="p">(</span><span class="n">Type</span><span class="o">=</span><span class="n">Type</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="n">Exp</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="n">shot</span><span class="p">,</span> <span class="n">Diag</span><span class="o">=</span><span class="n">Diag</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="n">SavePath</span><span class="p">,</span> <span class="n">dtime</span><span class="o">=</span><span class="n">dtime</span><span class="p">,</span> <span class="n">dtimeIn</span><span class="o">=</span><span class="n">dtimeIn</span><span class="p">)</span>
            <span class="n">Val</span> <span class="o">=</span> <span class="n">tfpf</span><span class="o">.</span><span class="n">ID</span><span class="p">(</span><span class="s">&#39;GDetect&#39;</span><span class="p">,</span> <span class="n">Val</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="n">Type</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="n">Exp</span><span class="p">,</span> <span class="n">Diag</span><span class="o">=</span><span class="n">Diag</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="n">shot</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="n">SavePath</span><span class="p">,</span> <span class="n">dtime</span><span class="o">=</span><span class="n">dtime</span><span class="p">,</span> <span class="n">dtimeIn</span><span class="o">=</span><span class="n">dtimeIn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Id</span> <span class="o">=</span> <span class="n">Val</span>

    <span class="k">def</span> <span class="nf">_set_LDetect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">LDetect</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_inputs</span><span class="p">(</span><span class="n">LDetect</span><span class="o">=</span><span class="n">LDetect</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_LDetect</span> <span class="o">=</span> <span class="n">LDetect</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nDetect</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">LDetect</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Optics</span> <span class="o">=</span> <span class="n">_get_OpticsFromLDetect</span><span class="p">(</span><span class="n">LDetect</span><span class="p">)</span>

        <span class="n">LObj</span> <span class="o">=</span> <span class="p">[</span><span class="n">dd</span><span class="o">.</span><span class="n">Id</span> <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">LDetect</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">aa</span><span class="o">.</span><span class="n">Id</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Optics</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">LDetect</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Ves</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="n">LObj</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">LDetect</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">Id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">set_LObj</span><span class="p">(</span><span class="n">LObj</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Ves</span> <span class="o">=</span> <span class="n">LDetect</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Ves</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Sino_RefPt</span> <span class="o">=</span> <span class="n">LDetect</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Sino_RefPt</span>

    <span class="k">def</span> <span class="nf">_calc_All</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Sino_RefPt</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">CalcEtend</span><span class="o">=</span><span class="k">True</span><span class="p">,</span> <span class="n">CalcSpanImp</span><span class="o">=</span><span class="k">True</span><span class="p">,</span> <span class="n">CalcCone</span><span class="o">=</span><span class="k">True</span><span class="p">,</span> <span class="n">CalcPreComp</span><span class="o">=</span><span class="k">True</span><span class="p">,</span>
                  <span class="n">Etend_Method</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetEtendMethod</span><span class="p">,</span> <span class="n">Etend_RelErr</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetEtendepsrel</span><span class="p">,</span> <span class="n">Etend_dX12</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetEtenddX12</span><span class="p">,</span> <span class="n">Etend_dX12Mode</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetEtenddX12Mode</span><span class="p">,</span> <span class="n">Etend_Ratio</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetEtendRatio</span><span class="p">,</span> <span class="n">Colis</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetCalcEtendColis</span><span class="p">,</span> <span class="n">LOSRef</span><span class="o">=</span><span class="k">None</span><span class="p">,</span>
                  <span class="n">Cone_DRY</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetConeDRY</span><span class="p">,</span> <span class="n">Cone_DXTheta</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Cone_DZ</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetConeDZ</span><span class="p">,</span> <span class="n">Cone_NPsi</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">Cone_Nk</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">Verb</span><span class="o">=</span><span class="k">True</span><span class="p">):</span>
        <span class="n">LOSRef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_LOSRef</span> <span class="k">if</span> <span class="n">LOSRef</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">else</span> <span class="n">LOSRef</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">nDetect</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_LDetect</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">_calc_All</span><span class="p">(</span><span class="n">Sino_RefPt</span><span class="o">=</span><span class="n">Sino_RefPt</span><span class="p">,</span> <span class="n">CalcEtend</span><span class="o">=</span><span class="n">CalcEtend</span><span class="p">,</span> <span class="n">CalcSpanImp</span><span class="o">=</span><span class="n">CalcSpanImp</span><span class="p">,</span> <span class="n">CalcCone</span><span class="o">=</span><span class="n">CalcCone</span><span class="p">,</span> <span class="n">CalcPreComp</span><span class="o">=</span><span class="n">CalcPreComp</span><span class="p">,</span>
                                        <span class="n">Etend_Method</span><span class="o">=</span><span class="n">Etend_Method</span><span class="p">,</span> <span class="n">Etend_RelErr</span><span class="o">=</span><span class="n">Etend_RelErr</span><span class="p">,</span> <span class="n">Etend_dX12</span><span class="o">=</span><span class="n">Etend_dX12</span><span class="p">,</span> <span class="n">Etend_dX12Mode</span><span class="o">=</span><span class="n">Etend_dX12Mode</span><span class="p">,</span> <span class="n">Etend_Ratio</span><span class="o">=</span><span class="n">Etend_Ratio</span><span class="p">,</span> <span class="n">Colis</span><span class="o">=</span><span class="n">Colis</span><span class="p">,</span> <span class="n">LOSRef</span><span class="o">=</span><span class="n">LOSRef</span><span class="p">,</span>
                                        <span class="n">Cone_DRY</span><span class="o">=</span><span class="n">Cone_DRY</span><span class="p">,</span> <span class="n">Cone_DXTheta</span><span class="o">=</span><span class="n">Cone_DXTheta</span><span class="p">,</span> <span class="n">Cone_DZ</span><span class="o">=</span><span class="n">Cone_DZ</span><span class="p">,</span> <span class="n">Cone_NPsi</span><span class="o">=</span><span class="n">Cone_NPsi</span><span class="p">,</span> <span class="n">Cone_Nk</span><span class="o">=</span><span class="n">Cone_Nk</span><span class="p">,</span> <span class="n">Verb</span><span class="o">=</span><span class="n">Verb</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_Sino</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">RefPt</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_inputs</span><span class="p">(</span><span class="n">RefPt</span><span class="o">=</span><span class="n">RefPt</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Ves</span><span class="o">.</span><span class="n">_set_Sino</span><span class="p">(</span><span class="n">RefPt</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">nDetect</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_LDetect</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">_set_Sino</span><span class="p">(</span><span class="n">RefPt</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Sino_RefPt</span> <span class="o">=</span> <span class="n">RefPt</span>

<div class="viewcode-block" id="GDetect.select"><a class="viewcode-back" href="../../../Auto_tofu.geom.html#tofu.geom.GDetect.select">[docs]</a>    <span class="k">def</span> <span class="nf">select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Val</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Crit</span><span class="o">=</span><span class="s">&#39;Name&#39;</span><span class="p">,</span> <span class="n">PreExp</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">PostExp</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Log</span><span class="o">=</span><span class="s">&#39;any&#39;</span><span class="p">,</span> <span class="n">InOut</span><span class="o">=</span><span class="s">&#39;In&#39;</span><span class="p">,</span> <span class="n">Out</span><span class="o">=</span><span class="nb">bool</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the indices or instances of all instances matching the specified criterion.</span>

<span class="sd">        The selection can be done according to 2 different mechanism (1) and (2).</span>

<span class="sd">        For mechanism (1): the user provides the value (Val) that the specified criterion (Crit) should take for a :class:`tofu.geom.Detect` to be selected.</span>
<span class="sd">        The criteria are typically attributes of the self.Id attribute (i.e.: name of the instance, or user-defined attributes like the camera head...)</span>

<span class="sd">        For mechanism (2), used if Val=None: the user provides a str expression (or a list of such) to be fed to eval(), used to check on quantitative criteria, placed before the criterion value (e.g.: &#39;not &#39; or &#39;&lt;=&#39;).</span>
<span class="sd">        Another str or list of str expressions can be provided that will be placed after the criterion value.</span>

<span class="sd">        Other parameters are used to specify logical operators for the selection (match any or all the criterion...) and the type of output.</span>
<span class="sd">        See :meth:`~tofu.geom.GLOS.select` for examples</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        Crit :      str</span>
<span class="sd">            Flag indicating which criterion to use for discrimination</span>
<span class="sd">            Can be set to any attribute of the tofu.pathfile.ID class (e.g.: &#39;Name&#39;,&#39;SaveName&#39;,&#39;SavePath&#39;...) or any key of ID.USRdict (e.g.: &#39;Exp&#39;...)</span>
<span class="sd">        Val :       list, str or None</span>
<span class="sd">            The value to match for the chosen criterion, can be a list of different values</span>
<span class="sd">            Used for selection mechanism (1)</span>
<span class="sd">        PreExp :    list, str or None</span>
<span class="sd">            A str of list of str expressions to be fed to eval(), used to check on quantitative criteria, placed before the criterion value (e.g.: &#39;not &#39;)</span>
<span class="sd">            Used for selection mechanism (2)</span>
<span class="sd">        PostExp :   list, str or None</span>
<span class="sd">            A str of list of str expressions to be fed to eval(), used to check on quantitative criteria, placed after the criterion value (e.g.: &#39;&gt;=5.&#39;)</span>
<span class="sd">            Used for selection mechanism (2)</span>
<span class="sd">        Log :       str</span>
<span class="sd">            Flag indicating whether the criterion shall match all provided values or one of them (&#39;any&#39; or &#39;all&#39;)</span>
<span class="sd">        InOut :     str</span>
<span class="sd">            Flag indicating whether the returned indices are the ones matching the criterion (&#39;In&#39;) or the ones not matching it (&#39;Out&#39;)</span>
<span class="sd">        Out :       type / str</span>
<span class="sd">            Flag indicating in which form shall the result be returned, as an array of integer indices (int), an array of booleans (bool), a list of names (&#39;Names&#39;) or a list of instances (&#39;Detect&#39;)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ind :       list / np.ndarray</span>
<span class="sd">            The computed output (array of index, list of names or instances depending on parameter &#39;Out&#39;)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Out</span><span class="o">==</span><span class="s">&#39;Detect&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">tfpf</span><span class="o">.</span><span class="n">SelectFromListId</span><span class="p">([</span><span class="n">ll</span><span class="o">.</span><span class="n">Id</span> <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">LDetect</span><span class="p">],</span> <span class="n">Val</span><span class="o">=</span><span class="n">Val</span><span class="p">,</span> <span class="n">Crit</span><span class="o">=</span><span class="n">Crit</span><span class="p">,</span> <span class="n">PreExp</span><span class="o">=</span><span class="n">PreExp</span><span class="p">,</span> <span class="n">PostExp</span><span class="o">=</span><span class="n">PostExp</span><span class="p">,</span> <span class="n">Log</span><span class="o">=</span><span class="n">Log</span><span class="p">,</span> <span class="n">InOut</span><span class="o">=</span><span class="n">InOut</span><span class="p">,</span> <span class="n">Out</span><span class="o">=</span><span class="n">Out</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">tfpf</span><span class="o">.</span><span class="n">SelectFromListId</span><span class="p">([</span><span class="n">ll</span><span class="o">.</span><span class="n">Id</span> <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">LDetect</span><span class="p">],</span> <span class="n">Val</span><span class="o">=</span><span class="n">Val</span><span class="p">,</span> <span class="n">Crit</span><span class="o">=</span><span class="n">Crit</span><span class="p">,</span> <span class="n">PreExp</span><span class="o">=</span><span class="n">PreExp</span><span class="p">,</span> <span class="n">PostExp</span><span class="o">=</span><span class="n">PostExp</span><span class="p">,</span> <span class="n">Log</span><span class="o">=</span><span class="n">Log</span><span class="p">,</span> <span class="n">InOut</span><span class="o">=</span><span class="n">InOut</span><span class="p">,</span> <span class="n">Out</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">LDetect</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">ind</span><span class="p">]</span></div>


<div class="viewcode-block" id="GDetect.isInside"><a class="viewcode-back" href="../../../Auto_tofu.geom.html#tofu.geom.GDetect.isInside">[docs]</a>    <span class="k">def</span> <span class="nf">isInside</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Points</span><span class="p">,</span> <span class="n">In</span><span class="o">=</span><span class="s">&#39;(X,Y,Z)&#39;</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="k">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return an array of indices indicating whether each point lies both in the cross-section and horizontal porojections of the viewing cone of each :class:`~tofu.geom.Detect`</span>

<span class="sd">        see :meth:`~tofu.geom.Detect.isInside` for details</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        Points :    np.ndarray</span>
<span class="sd">            (2,N) or (3,N) array of coordinates of the N points to be tested</span>
<span class="sd">        In :        str</span>
<span class="sd">            Flag indicating in which coordinate system the Points are provided, must be in [&#39;(R,Z)&#39;,&#39;(Y,Z)&#39;,&#39;(X,Y)&#39;,&#39;(X,Y,Z)&#39;,&#39;(R,phi,Z)&#39;]</span>
<span class="sd">                * &#39;(R,Z)&#39;: All points are assumed to lie in the horizontal projection, for &#39;Tor&#39; vessel type only</span>
<span class="sd">                * &#39;(Y,Z)&#39;: All points are assumed to lie in the horizontal projection, for &#39;Lin&#39; vessel type only</span>
<span class="sd">                * &#39;(X,Y)&#39;: All points are assumed to lie in the cross-section projection</span>
<span class="sd">        Test :      bool</span>
<span class="sd">            Flag indicating whether the inputs should be tested for conformity</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ind :       np.ndarray</span>
<span class="sd">            (ND,N) array of booleans with True if a point lies inside both projections of the viewing cone, where ND is the number of Detect instances</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Points</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">),</span> <span class="s">&quot;Arg Points must be a np.ndarray !&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">dd</span><span class="o">.</span><span class="n">isInside</span><span class="p">(</span><span class="n">Points</span><span class="p">,</span> <span class="n">In</span><span class="o">=</span><span class="n">In</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="n">Test</span><span class="p">)</span> <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">LDetect</span><span class="p">])</span></div>

<div class="viewcode-block" id="GDetect.get_GLOS"><a class="viewcode-back" href="../../../Auto_tofu.geom.html#tofu.geom.GDetect.get_GLOS">[docs]</a>    <span class="k">def</span> <span class="nf">get_GLOS</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Name</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">LOSRef</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the :class:`~tofu.geom.GLOS` instance that can be built by grouping the :class:`~tofu.geom.LOS` of each :class:`~tofu.geom.Detect` instance</span>

<span class="sd">        Can be useful for handling a GLOS instead of a GDetect (heavier) instance</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        Name :      None / str</span>
<span class="sd">            Name to be given to the GLOS instance, if None a name is built from the name of the GDetect object by appending &#39;_GLOS&#39;</span>
<span class="sd">        LOSRef :    None / str</span>
<span class="sd">            Key indicating which LOS to be used, if None the default LOSRef is used</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        glos :      :class:`~tofu.geom.GLOS`</span>
<span class="sd">            The constructed :class:`~tofu.geom.GLOS` instance</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">LOSRef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_LOSRef</span> <span class="k">if</span> <span class="n">LOSRef</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">else</span> <span class="n">LOSRef</span>
        <span class="n">LLOS</span> <span class="o">=</span> <span class="p">[</span><span class="n">dd</span><span class="o">.</span><span class="n">LOS</span><span class="p">[</span><span class="n">LOSRef</span><span class="p">][</span><span class="s">&#39;LOS&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">LDetect</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">dd</span><span class="o">.</span><span class="n">LOS</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;Impossible !&#39;</span><span class="p">,</span><span class="k">None</span><span class="p">]]</span>
        <span class="k">if</span> <span class="n">Name</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="n">Name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Name</span><span class="o">+</span><span class="s">&#39;_GLOS&#39;</span>
        <span class="k">return</span> <span class="n">GLOS</span><span class="p">(</span><span class="n">Name</span><span class="p">,</span><span class="n">LLOS</span><span class="p">)</span></div>

<div class="viewcode-block" id="GDetect.set_SigPrecomp"><a class="viewcode-back" href="../../../Auto_tofu.geom.html#tofu.geom.GDetect.set_SigPrecomp">[docs]</a>    <span class="k">def</span> <span class="nf">set_SigPrecomp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">CalcPreComp</span><span class="o">=</span><span class="k">True</span><span class="p">,</span> <span class="n">dX12</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetSynthdX12</span><span class="p">,</span> <span class="n">dX12Mode</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetSynthdX12Mode</span><span class="p">,</span> <span class="n">ds</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetSynthds</span><span class="p">,</span> <span class="n">dsMode</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetSynthdsMode</span><span class="p">,</span> <span class="n">MarginS</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetSynthMarginS</span><span class="p">,</span> <span class="n">Colis</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetCalcSAngVectColis</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Applies :meth:`~tofu.geom.Detect.set_SigPrecomp` to all :class:`~tofu.geom.Detect` instances &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">nDetect</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_LDetect</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">set_SigPrecomp</span><span class="p">(</span><span class="n">CalcPreComp</span><span class="o">=</span><span class="n">CalcPreComp</span><span class="p">,</span> <span class="n">dX12</span><span class="o">=</span><span class="n">dX12</span><span class="p">,</span> <span class="n">dX12Mode</span><span class="o">=</span><span class="n">dX12Mode</span><span class="p">,</span> <span class="n">ds</span><span class="o">=</span><span class="n">ds</span><span class="p">,</span> <span class="n">dsMode</span><span class="o">=</span><span class="n">dsMode</span><span class="p">,</span> <span class="n">MarginS</span><span class="o">=</span><span class="n">MarginS</span><span class="p">,</span> <span class="n">Colis</span><span class="o">=</span><span class="n">Colis</span><span class="p">)</span></div>

<div class="viewcode-block" id="GDetect.calc_SAngVect"><a class="viewcode-back" href="../../../Auto_tofu.geom.html#tofu.geom.GDetect.calc_SAngVect">[docs]</a>    <span class="k">def</span> <span class="nf">calc_SAngVect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Pts</span><span class="p">,</span> <span class="n">In</span><span class="o">=</span><span class="s">&#39;(X,Y,Z)&#39;</span><span class="p">,</span> <span class="n">Colis</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetCalcSAngVectColis</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="k">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Applies :meth:`~tofu.geom.Detect.calc_SAngVect` to all :class:`~tofu.geom.Detect` instances</span>

<span class="sd">        Return the result as two 2D arrays where the first dimension is the number of :class:`~tofu.geom.Detect` instances</span>
<span class="sd">        see :meth:`~tofu.geom.Detect.calc_SAngVect` for details</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">SAng</span><span class="p">,</span> <span class="n">Vect</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nDetect</span><span class="p">,</span><span class="n">Pts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">nDetect</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">nDetect</span><span class="p">):</span>
            <span class="n">SAng</span><span class="p">[</span><span class="n">ii</span><span class="p">,:],</span> <span class="n">Vect</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LDetect</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">calc_SAngVect</span><span class="p">(</span><span class="n">Pts</span><span class="p">,</span> <span class="n">In</span><span class="o">=</span><span class="n">In</span><span class="p">,</span> <span class="n">Colis</span><span class="o">=</span><span class="n">Colis</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="n">Test</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">SAng</span><span class="p">,</span> <span class="n">Vect</span></div>

    <span class="k">def</span> <span class="nf">calc_SAngNb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Pts</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Proj</span><span class="o">=</span><span class="s">&#39;Cross&#39;</span><span class="p">,</span> <span class="n">Slice</span><span class="o">=</span><span class="s">&#39;Int&#39;</span><span class="p">,</span> <span class="n">DRY</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">DXTheta</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">DZ</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Colis</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetSAngColis</span><span class="p">,</span>
                    <span class="n">ind</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Val</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Crit</span><span class="o">=</span><span class="s">&#39;Name&#39;</span><span class="p">,</span> <span class="n">PreExp</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">PostExp</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Log</span><span class="o">=</span><span class="s">&#39;any&#39;</span><span class="p">,</span> <span class="n">InOut</span><span class="o">=</span><span class="s">&#39;In&#39;</span><span class="p">):</span>
        <span class="n">SA</span><span class="p">,</span> <span class="n">Nb</span><span class="p">,</span> <span class="n">Pts</span> <span class="o">=</span> <span class="n">_GDetect_Calc_SAngNb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Pts</span><span class="o">=</span><span class="n">Pts</span><span class="p">,</span> <span class="n">Proj</span><span class="o">=</span><span class="n">Proj</span><span class="p">,</span> <span class="n">Slice</span><span class="o">=</span><span class="n">Slice</span><span class="p">,</span> <span class="n">DRY</span><span class="o">=</span><span class="n">DRY</span><span class="p">,</span> <span class="n">DXTheta</span><span class="o">=</span><span class="n">DXTheta</span><span class="p">,</span> <span class="n">DZ</span><span class="o">=</span><span class="n">DZ</span><span class="p">,</span> <span class="n">Colis</span><span class="o">=</span><span class="n">Colis</span><span class="p">,</span>
                                           <span class="n">ind</span><span class="o">=</span><span class="n">ind</span><span class="p">,</span> <span class="n">Val</span><span class="o">=</span><span class="n">Val</span><span class="p">,</span> <span class="n">Crit</span><span class="o">=</span><span class="n">Crit</span><span class="p">,</span> <span class="n">PreExp</span><span class="o">=</span><span class="n">PreExp</span><span class="p">,</span> <span class="n">PostExp</span><span class="o">=</span><span class="n">PostExp</span><span class="p">,</span> <span class="n">Log</span><span class="o">=</span><span class="n">Log</span><span class="p">,</span> <span class="n">InOut</span><span class="o">=</span><span class="n">InOut</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot; Applies :meth:`~tofu.geom.Detect.calc_SAngNb` to all :class:`~tofu.geom.Detect` instances</span>

<span class="sd">        See :meth:`~tofu.geom.Detect.calc_SAngNb` for details</span>
<span class="sd">        Arguments ind, Val, Crit, PreExp, PostExp, Log and InOut are fed to :meth:`~tofu.geom.GDetect.select`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">SA</span><span class="p">,</span> <span class="n">Nb</span><span class="p">,</span> <span class="n">Pts</span>

<div class="viewcode-block" id="GDetect.calc_Sig"><a class="viewcode-back" href="../../../Auto_tofu.geom.html#tofu.geom.GDetect.calc_Sig">[docs]</a>    <span class="k">def</span> <span class="nf">calc_Sig</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ff</span><span class="p">,</span> <span class="n">extargs</span><span class="o">=</span><span class="p">{},</span> <span class="n">Method</span><span class="o">=</span><span class="s">&#39;Vol&#39;</span><span class="p">,</span> <span class="n">Mode</span><span class="o">=</span><span class="s">&#39;simps&#39;</span><span class="p">,</span> <span class="n">PreComp</span><span class="o">=</span><span class="k">True</span><span class="p">,</span>
                 <span class="n">epsrel</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetSynthEpsrel</span><span class="p">,</span> <span class="n">dX12</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetSynthdX12</span><span class="p">,</span> <span class="n">dX12Mode</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetSynthdX12Mode</span><span class="p">,</span> <span class="n">ds</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetSynthds</span><span class="p">,</span> <span class="n">dsMode</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetSynthdsMode</span><span class="p">,</span> <span class="n">MarginS</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetSynthMarginS</span><span class="p">,</span> <span class="n">Colis</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetCalcSAngVectColis</span><span class="p">,</span>  <span class="n">Test</span><span class="o">=</span><span class="k">True</span><span class="p">,</span>
                 <span class="n">ind</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Val</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Crit</span><span class="o">=</span><span class="s">&#39;Name&#39;</span><span class="p">,</span> <span class="n">PreExp</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">PostExp</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Log</span><span class="o">=</span><span class="s">&#39;any&#39;</span><span class="p">,</span> <span class="n">InOut</span><span class="o">=</span><span class="s">&#39;In&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Applies :meth:`~tofu.geom.Detect.calc_Sig` to all :class:`~tofu.geom.Detect` instances</span>

<span class="sd">        See :meth:`~tofu.geom.Detect.calc_Sig` for details</span>
<span class="sd">        Arguments ind, Val, Crit, PreExp, PostExp, Log and InOut are fed to :meth:`~tofu.geom.GDetect.select`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">GD</span><span class="p">,</span> <span class="n">Leg</span><span class="p">,</span> <span class="n">LOSRef</span> <span class="o">=</span> <span class="n">_tfg_p</span><span class="o">.</span><span class="n">_get_LD_Leg_LOSRef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">LOSRef</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_LOSRef</span><span class="p">,</span> <span class="n">ind</span><span class="o">=</span><span class="n">ind</span><span class="p">,</span> <span class="n">Val</span><span class="o">=</span><span class="n">Val</span><span class="p">,</span> <span class="n">Crit</span><span class="o">=</span><span class="n">Crit</span><span class="p">,</span> <span class="n">PreExp</span><span class="o">=</span><span class="n">PreExp</span><span class="p">,</span> <span class="n">PostExp</span><span class="o">=</span><span class="n">PostExp</span><span class="p">,</span> <span class="n">Log</span><span class="o">=</span><span class="n">Log</span><span class="p">,</span> <span class="n">InOut</span><span class="o">=</span><span class="n">InOut</span><span class="p">)</span>
        <span class="n">Sig</span> <span class="o">=</span> <span class="p">[</span><span class="n">dd</span><span class="o">.</span><span class="n">calc_Sig</span><span class="p">(</span><span class="n">ff</span><span class="p">,</span> <span class="n">extargs</span><span class="o">=</span><span class="n">extargs</span><span class="p">,</span> <span class="n">Method</span><span class="o">=</span><span class="n">Method</span><span class="p">,</span> <span class="n">Mode</span><span class="o">=</span><span class="n">Mode</span><span class="p">,</span> <span class="n">PreComp</span><span class="o">=</span><span class="n">PreComp</span><span class="p">,</span> <span class="n">epsrel</span><span class="o">=</span><span class="n">epsrel</span><span class="p">,</span> <span class="n">dX12</span><span class="o">=</span><span class="n">dX12</span><span class="p">,</span> <span class="n">dX12Mode</span><span class="o">=</span><span class="n">dX12Mode</span><span class="p">,</span> <span class="n">ds</span><span class="o">=</span><span class="n">ds</span><span class="p">,</span> <span class="n">dsMode</span><span class="o">=</span><span class="n">dsMode</span><span class="p">,</span> <span class="n">MarginS</span><span class="o">=</span><span class="n">MarginS</span><span class="p">,</span> <span class="n">Colis</span><span class="o">=</span><span class="n">Colis</span><span class="p">,</span><span class="n">Test</span><span class="o">=</span><span class="n">Test</span><span class="p">)</span> <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">GD</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">Sig</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">GD</span></div>


    <span class="k">def</span> <span class="nf">_calc_Res</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Pts</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">CrossMesh</span><span class="o">=</span><span class="p">[</span><span class="mf">0.01</span><span class="p">,</span><span class="mf">0.01</span><span class="p">],</span> <span class="n">CrossMeshMode</span><span class="o">=</span><span class="s">&#39;abs&#39;</span><span class="p">,</span> <span class="n">Mode</span><span class="o">=</span><span class="s">&#39;Iso&#39;</span><span class="p">,</span> <span class="n">Amp</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">Deg</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">Thres</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">ThresMode</span><span class="o">=</span><span class="s">&#39;rel&#39;</span><span class="p">,</span> <span class="n">ThresMin</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
                 <span class="n">IntResCross</span><span class="o">=</span><span class="p">[</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">0.1</span><span class="p">],</span> <span class="n">IntResCrossMode</span><span class="o">=</span><span class="s">&#39;rel&#39;</span><span class="p">,</span> <span class="n">IntResLong</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">IntResLongMode</span><span class="o">=</span><span class="s">&#39;rel&#39;</span><span class="p">,</span>
                 <span class="n">Eq</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">PlotDetail</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">Cdict</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetConed</span><span class="p">),</span> <span class="n">Ntt</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">SaveName</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="s">&#39;./&#39;</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="k">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Applies :meth:`~tofu.geom.Detect._calc_Res` to all :class:`~tofu.geom.Detect` instances</span>

<span class="sd">        See :meth:`~tofu.geom.Detect._calc_Res` for details</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">Res</span><span class="p">,</span> <span class="n">Pts</span><span class="p">,</span> <span class="n">LDetLim</span><span class="p">,</span> <span class="n">Mode</span><span class="p">,</span> <span class="n">steps</span><span class="p">,</span> <span class="n">Thres</span><span class="p">,</span> <span class="n">ThresMode</span><span class="p">,</span> <span class="n">ThresMin</span><span class="p">,</span> <span class="n">IntResCross</span><span class="p">,</span> <span class="n">IntResCrossMode</span><span class="p">,</span> <span class="n">IntResLong</span><span class="p">,</span> <span class="n">IntResLongMode</span> \
                <span class="o">=</span> <span class="n">_Calc_Resolution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Pts</span><span class="o">=</span><span class="n">Pts</span><span class="p">,</span> <span class="n">CrossMesh</span><span class="o">=</span><span class="n">CrossMesh</span><span class="p">,</span> <span class="n">CrossMeshMode</span><span class="o">=</span><span class="n">CrossMeshMode</span><span class="p">,</span> <span class="n">Mode</span><span class="o">=</span><span class="n">Mode</span><span class="p">,</span> <span class="n">Amp</span><span class="o">=</span><span class="n">Amp</span><span class="p">,</span> <span class="n">Deg</span><span class="o">=</span><span class="n">Deg</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="n">steps</span><span class="p">,</span> <span class="n">Thres</span><span class="o">=</span><span class="n">Thres</span><span class="p">,</span> <span class="n">ThresMode</span><span class="o">=</span><span class="n">ThresMode</span><span class="p">,</span> <span class="n">ThresMin</span><span class="o">=</span><span class="n">ThresMin</span><span class="p">,</span>
                                  <span class="n">IntResCross</span><span class="o">=</span><span class="n">IntResCross</span><span class="p">,</span> <span class="n">IntResCrossMode</span><span class="o">=</span><span class="n">IntResCrossMode</span><span class="p">,</span> <span class="n">IntResLong</span><span class="o">=</span><span class="n">IntResLong</span><span class="p">,</span> <span class="n">IntResLongMode</span><span class="o">=</span><span class="n">IntResLongMode</span><span class="p">,</span>
                                  <span class="n">Eq</span><span class="o">=</span><span class="n">Eq</span><span class="p">,</span> <span class="n">PlotDetail</span><span class="o">=</span><span class="n">PlotDetail</span><span class="p">,</span> <span class="n">Cdict</span><span class="o">=</span><span class="n">Cdict</span><span class="p">,</span> <span class="n">Ntt</span><span class="o">=</span><span class="n">Ntt</span><span class="p">,</span> <span class="n">SaveName</span><span class="o">=</span><span class="n">SaveName</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="n">SavePath</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="n">save</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="n">Test</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Res</span><span class="p">,</span> <span class="n">Pts</span><span class="p">,</span> <span class="n">LDetLim</span><span class="p">,</span> <span class="n">Mode</span><span class="p">,</span> <span class="n">steps</span><span class="p">,</span> <span class="n">Thres</span><span class="p">,</span> <span class="n">ThresMode</span><span class="p">,</span> <span class="n">ThresMin</span><span class="p">,</span> <span class="n">IntResCross</span><span class="p">,</span> <span class="n">IntResCrossMode</span><span class="p">,</span> <span class="n">IntResLong</span><span class="p">,</span> <span class="n">IntResLongMode</span>



    <span class="k">def</span> <span class="nf">_set_Res</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">CrossMesh</span><span class="o">=</span><span class="p">[</span><span class="mf">0.05</span><span class="p">,</span><span class="mf">0.02</span><span class="p">],</span> <span class="n">CrossMeshMode</span><span class="o">=</span><span class="s">&#39;rel&#39;</span><span class="p">,</span> <span class="n">Mode</span><span class="o">=</span><span class="s">&#39;Iso&#39;</span><span class="p">,</span> <span class="n">Amp</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">Deg</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">Thres</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">ThresMode</span><span class="o">=</span><span class="s">&#39;rel&#39;</span><span class="p">,</span> <span class="n">ThresMin</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
                 <span class="n">IntResCross</span><span class="o">=</span><span class="p">[</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">0.1</span><span class="p">],</span> <span class="n">IntResCrossMode</span><span class="o">=</span><span class="s">&#39;rel&#39;</span><span class="p">,</span> <span class="n">IntResLong</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">IntResLongMode</span><span class="o">=</span><span class="s">&#39;rel&#39;</span><span class="p">,</span> <span class="n">Eq</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Ntt</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">EqName</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="k">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Compute the resolution of the Detect instance on a mesh grid of the Cross section, with specified parameters</span>

<span class="sd">        See :meth:`~tofu.geom.Detect._set_Res` for details</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Res</span><span class="p">,</span> <span class="n">Pts</span><span class="p">,</span> <span class="n">LDetLim</span><span class="p">,</span> <span class="n">Mode</span><span class="p">,</span> <span class="n">steps</span><span class="p">,</span> <span class="n">Thres</span><span class="p">,</span> <span class="n">ThresMode</span><span class="p">,</span> <span class="n">ThresMin</span><span class="p">,</span> <span class="n">IntResCross</span><span class="p">,</span> <span class="n">IntResCrossMode</span><span class="p">,</span> <span class="n">IntResLong</span><span class="p">,</span> <span class="n">IntResLongMode</span> \
                <span class="o">=</span> <span class="n">_Calc_Resolution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Pts</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">CrossMesh</span><span class="o">=</span><span class="n">CrossMesh</span><span class="p">,</span> <span class="n">CrossMeshMode</span><span class="o">=</span><span class="n">CrossMeshMode</span><span class="p">,</span> <span class="n">Mode</span><span class="o">=</span><span class="n">Mode</span><span class="p">,</span> <span class="n">Amp</span><span class="o">=</span><span class="n">Amp</span><span class="p">,</span> <span class="n">Deg</span><span class="o">=</span><span class="n">Deg</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="n">steps</span><span class="p">,</span> <span class="n">Thres</span><span class="o">=</span><span class="n">Thres</span><span class="p">,</span> <span class="n">ThresMode</span><span class="o">=</span><span class="n">ThresMode</span><span class="p">,</span> <span class="n">ThresMin</span><span class="o">=</span><span class="n">ThresMin</span><span class="p">,</span>
                                  <span class="n">IntResCross</span><span class="o">=</span><span class="n">IntResCross</span><span class="p">,</span> <span class="n">IntResCrossMode</span><span class="o">=</span><span class="n">IntResCrossMode</span><span class="p">,</span> <span class="n">IntResLong</span><span class="o">=</span><span class="n">IntResLong</span><span class="p">,</span> <span class="n">IntResLongMode</span><span class="o">=</span><span class="n">IntResLongMode</span><span class="p">,</span> <span class="n">Eq</span><span class="o">=</span><span class="n">Eq</span><span class="p">,</span> <span class="n">Ntt</span><span class="o">=</span><span class="n">Ntt</span><span class="p">,</span> <span class="n">PlotDetail</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="n">Test</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_Res_Mode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Res_Amp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Res_Deg</span> <span class="o">=</span> <span class="n">Mode</span><span class="p">,</span> <span class="n">Amp</span><span class="p">,</span> <span class="n">Deg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Res_Pts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Res_Res</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Res_DetLim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Res_CrossMesh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Res_CrossMeshMode</span> <span class="o">=</span> <span class="n">Pts</span><span class="p">,</span> <span class="n">Res</span><span class="p">,</span> <span class="n">LDetLim</span><span class="p">,</span> <span class="n">CrossMesh</span><span class="p">,</span> <span class="n">CrossMeshMode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Res_steps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Res_Thres</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Res_ThresMode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Res_ThresMin</span> <span class="o">=</span> <span class="n">steps</span><span class="p">,</span> <span class="n">Thres</span><span class="p">,</span> <span class="n">ThresMode</span><span class="p">,</span> <span class="n">ThresMin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Res_IntResCross</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Res_IntResCrossMode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Res_IntResLong</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Res_IntResLongMode</span> <span class="o">=</span> <span class="n">IntResCross</span><span class="p">,</span> <span class="n">IntResCrossMode</span><span class="p">,</span> <span class="n">IntResLong</span><span class="p">,</span> <span class="n">IntResLongMode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Res_EqName</span> <span class="o">=</span> <span class="n">EqName</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Res_Done</span> <span class="o">=</span> <span class="k">True</span>
        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_reset_Res</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Res_Mode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Res_Amp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Res_Deg</span> <span class="o">=</span> <span class="k">None</span><span class="p">,</span> <span class="k">None</span><span class="p">,</span> <span class="k">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Res_Pts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Res_Res</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Res_DetLim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Res_CrossMesh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Res_CrossMeshMode</span> <span class="o">=</span> <span class="k">None</span><span class="p">,</span> <span class="k">None</span><span class="p">,</span> <span class="k">None</span><span class="p">,</span> <span class="k">None</span><span class="p">,</span> <span class="k">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Res_steps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Res_Thres</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Res_ThresMode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Res_ThresMin</span> <span class="o">=</span> <span class="k">None</span><span class="p">,</span> <span class="k">None</span><span class="p">,</span> <span class="k">None</span><span class="p">,</span> <span class="k">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Res_IntResCross</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Res_IntResCrossMode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Res_IntResLong</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Res_IntResLongMode</span> <span class="o">=</span> <span class="k">None</span><span class="p">,</span> <span class="k">None</span><span class="p">,</span> <span class="k">None</span><span class="p">,</span> <span class="k">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Res_EqName</span> <span class="o">=</span> <span class="k">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Res_Done</span> <span class="o">=</span> <span class="k">False</span>


<div class="viewcode-block" id="GDetect.plot"><a class="viewcode-back" href="../../../Auto_tofu.geom.html#tofu.geom.GDetect.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Lax</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Proj</span><span class="o">=</span><span class="s">&#39;All&#39;</span><span class="p">,</span> <span class="n">Elt</span><span class="o">=</span><span class="s">&#39;PVC&#39;</span><span class="p">,</span> <span class="n">EltLOS</span><span class="o">=</span><span class="s">&#39;LDIORP&#39;</span><span class="p">,</span> <span class="n">EltOptics</span><span class="o">=</span><span class="s">&#39;P&#39;</span><span class="p">,</span> <span class="n">EltVes</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span>  <span class="n">Leg</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">LOSRef</span><span class="o">=</span><span class="k">None</span><span class="p">,</span>
             <span class="n">Pdict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">ApPd</span><span class="p">,</span> <span class="n">Vdict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">ApVd</span><span class="p">,</span> <span class="n">Cdict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetConed</span><span class="p">,</span> <span class="n">LVIn</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">ApLVin</span><span class="p">,</span>
             <span class="n">LOSdict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">LOSdict</span><span class="p">,</span> <span class="n">Opticsdict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">Apertdict</span><span class="p">,</span> <span class="n">Vesdict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">Vesdict</span><span class="p">,</span>
             <span class="n">LegDict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">TorLegd</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="k">True</span><span class="p">,</span> <span class="n">a4</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="k">True</span><span class="p">,</span>
             <span class="n">ind</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Val</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Crit</span><span class="o">=</span><span class="s">&#39;Name&#39;</span><span class="p">,</span> <span class="n">PreExp</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">PostExp</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Log</span><span class="o">=</span><span class="s">&#39;any&#39;</span><span class="p">,</span> <span class="n">InOut</span><span class="o">=</span><span class="s">&#39;In&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Plot all or a subset of the Detect instances in a projection or in 3D</span>

<span class="sd">        See :meth:`~tofu.geom.Detect.plot` for details</span>
<span class="sd">        Arguments ind, Val, Crit, PreExp, PostExp, Log and InOut are fed to :meth:`~tofu.geom.GDetect.select`</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        Lax :       None, plt.Axes or list</span>
<span class="sd">            Axes or list of axes to be used for plotting, if None a new figure and appropriate axes are created</span>
<span class="sd">        Proj :      str</span>
<span class="sd">            Flag indicating whether to plot the cross-section (&#39;Cross&#39;), the horizontal projection (&#39;Hor&#39;), both (&#39;All&#39;) or a 3D representation (&#39;3D&#39;)</span>
<span class="sd">        Elt :       str</span>
<span class="sd">            Flag indicating which elements of the Detect instance to plot, each capital letter stands for an element</span>
<span class="sd">                * &#39;P&#39;: polygon</span>
<span class="sd">                * &#39;V&#39;: perpendicular vector</span>
<span class="sd">                * &#39;C&#39;: viewing cone</span>
<span class="sd">        EltLOS :    None or str</span>
<span class="sd">            Flag indicating which elements of the LOS to plot, will be fed to LOS.plot(), if None uses the &#39;Elt&#39; arg of LOSdict instead</span>
<span class="sd">        EltOptics : None or str</span>
<span class="sd">            Flag indicating which elements of the Aperts to plot, will be fed to Apert.plot(), if None uses the &#39;Elt&#39; arg of Apertdict instead</span>
<span class="sd">        EltVes :    None or str</span>
<span class="sd">            Flag indicating which elements of the :class:`~tofu.geom.Ves` to plot, will be fed to :meth:`~tofu.geom.Ves.plot`, if None uses the &#39;Elt&#39; arg of Vesdict instead</span>
<span class="sd">        Leg :       str</span>
<span class="sd">            Legend to be used for the detector, if &#39;&#39; the Detect.iD.Name is used</span>
<span class="sd">        LOSRef :    None or str</span>
<span class="sd">            Flag indicating which LOS should be represented, if None Detect._LOSRef is used</span>
<span class="sd">        Pdict :     dict</span>
<span class="sd">            Dictionary of properties for the Polygon</span>
<span class="sd">        Vdict :     dict</span>
<span class="sd">            Dictionary of properties for the Vector</span>
<span class="sd">        Cdict :     dict</span>
<span class="sd">            Dictionary of properties for the Cone</span>
<span class="sd">        LVIn :      float</span>
<span class="sd">            Length of the Vector</span>
<span class="sd">        LOSdict :   dict</span>
<span class="sd">            Dictionary of properties for the LOS if EltLOS is not &#39;&#39;, fed to LOS.plot()</span>
<span class="sd">        Apertdict : dict</span>
<span class="sd">            Dictionary of properties for the Apert if EltOptics is not &#39;&#39;, fed to Apert.plot()</span>
<span class="sd">        Vesdict :   dict</span>
<span class="sd">            Dictionary of properties for the :class:`~tofu.geom.Ves` if EltVes is not &#39;&#39;, fed to :meth:`~tofu.geom.Ves.plot`</span>
<span class="sd">        LegDict :   dict</span>
<span class="sd">            Dictionary of properties for the legend, fed to plt.legend()</span>
<span class="sd">        draw :      bool</span>
<span class="sd">            Flag indicating whether to draw the figure</span>
<span class="sd">        a4 :        bool</span>
<span class="sd">            Flag indicating whether the default figure should be of size a4 paper</span>
<span class="sd">        Test :      bool</span>
<span class="sd">            Flag indicating whether the inputs should be tested for conformity</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Lax     plt.Axes or list</span>
<span class="sd">            Axes or list of axes used for plotting</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_tfg_p</span><span class="o">.</span><span class="n">GLDetect_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Lax</span><span class="o">=</span><span class="n">Lax</span><span class="p">,</span> <span class="n">Proj</span><span class="o">=</span><span class="n">Proj</span><span class="p">,</span> <span class="n">Elt</span><span class="o">=</span><span class="n">Elt</span><span class="p">,</span> <span class="n">EltOptics</span><span class="o">=</span><span class="n">EltOptics</span><span class="p">,</span> <span class="n">EltLOS</span><span class="o">=</span><span class="n">EltLOS</span><span class="p">,</span> <span class="n">EltVes</span><span class="o">=</span><span class="n">EltVes</span><span class="p">,</span> <span class="n">Leg</span><span class="o">=</span><span class="n">Leg</span><span class="p">,</span> <span class="n">LOSRef</span><span class="o">=</span><span class="n">LOSRef</span><span class="p">,</span>
                                   <span class="n">Pdict</span><span class="o">=</span><span class="n">Pdict</span><span class="p">,</span> <span class="n">Vdict</span><span class="o">=</span><span class="n">Vdict</span><span class="p">,</span> <span class="n">Cdict</span><span class="o">=</span><span class="n">Cdict</span><span class="p">,</span> <span class="n">LVIn</span><span class="o">=</span><span class="n">LVIn</span><span class="p">,</span>
                                   <span class="n">LOSdict</span><span class="o">=</span><span class="n">LOSdict</span><span class="p">,</span> <span class="n">Opticsdict</span><span class="o">=</span><span class="n">Opticsdict</span><span class="p">,</span> <span class="n">Vesdict</span><span class="o">=</span><span class="n">Vesdict</span><span class="p">,</span> <span class="n">LegDict</span><span class="o">=</span><span class="n">LegDict</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="n">draw</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="n">Test</span><span class="p">,</span>
                                   <span class="n">ind</span><span class="o">=</span><span class="n">ind</span><span class="p">,</span> <span class="n">Val</span><span class="o">=</span><span class="n">Val</span><span class="p">,</span> <span class="n">Crit</span><span class="o">=</span><span class="n">Crit</span><span class="p">,</span> <span class="n">PreExp</span><span class="o">=</span><span class="n">PreExp</span><span class="p">,</span> <span class="n">PostExp</span><span class="o">=</span><span class="n">PostExp</span><span class="p">,</span> <span class="n">Log</span><span class="o">=</span><span class="n">Log</span><span class="p">,</span> <span class="n">InOut</span><span class="o">=</span><span class="n">InOut</span><span class="p">)</span></div>


<div class="viewcode-block" id="GDetect.plot_SAngNb"><a class="viewcode-back" href="../../../Auto_tofu.geom.html#tofu.geom.GDetect.plot_SAngNb">[docs]</a>    <span class="k">def</span> <span class="nf">plot_SAngNb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Lax</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Proj</span><span class="o">=</span><span class="s">&#39;Cross&#39;</span><span class="p">,</span> <span class="n">Slice</span><span class="o">=</span><span class="s">&#39;Int&#39;</span><span class="p">,</span> <span class="n">Pts</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">plotfunc</span><span class="o">=</span><span class="s">&#39;scatter&#39;</span><span class="p">,</span> <span class="n">DRY</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">DXTheta</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">DZ</span><span class="o">=</span><span class="k">None</span><span class="p">,</span>
            <span class="n">Elt</span><span class="o">=</span><span class="s">&#39;P&#39;</span><span class="p">,</span> <span class="n">EltVes</span><span class="o">=</span><span class="s">&#39;P&#39;</span><span class="p">,</span> <span class="n">EltLOS</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">EltOptics</span><span class="o">=</span><span class="s">&#39;P&#39;</span><span class="p">,</span>
            <span class="n">Pdict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">ApPd</span><span class="p">,</span> <span class="n">Vdict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">ApVd</span><span class="p">,</span> <span class="n">Cdict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetConed</span><span class="p">,</span> <span class="n">LVIn</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">ApLVin</span><span class="p">,</span>
            <span class="n">LOSdict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">LOSdict</span><span class="p">,</span> <span class="n">Opticsdict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">Apertdict</span><span class="p">,</span> <span class="n">Vesdict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">Vesdict</span><span class="p">,</span>
            <span class="n">CDictSA</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">CDictNb</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Colis</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetSAngColis</span><span class="p">,</span> <span class="n">a4</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="k">True</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="k">True</span><span class="p">,</span>
            <span class="n">ind</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Val</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Crit</span><span class="o">=</span><span class="s">&#39;Name&#39;</span><span class="p">,</span> <span class="n">PreExp</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">PostExp</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Log</span><span class="o">=</span><span class="s">&#39;any&#39;</span><span class="p">,</span> <span class="n">InOut</span><span class="o">=</span><span class="s">&#39;In&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Plot the solid angle projections (integrated &#39;Int&#39; or maximum &#39;Max&#39;) as well as the number of detectors visible from each point in the plasma</span>

<span class="sd">        See :meth:`~tofu.geom.Detect.plot_SAngNb` for details</span>
<span class="sd">        Arguments ind, Val, Crit, PreExp, PostExp, Log and InOut are fed to :meth:`~tofu.geom.GDetect.select`</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        Lax :       None or list or plt.Axes</span>
<span class="sd">            Axes or list of Axes to be used for plotting, if None a new figure and appropriate axes are created</span>
<span class="sd">        Proj :      str</span>
<span class="sd">            Flag indicating whether to plot the cross-section (&#39;Cross&#39;) or the horizontal projection (&#39;Hor&#39;)</span>
<span class="sd">        Mode :      str, None or float</span>
<span class="sd">            Flag indicating whether to plot:</span>
<span class="sd">                * &#39;Int&#39;: the integrated value along the projected coordinates</span>
<span class="sd">                * &#39;Max&#39;: the maximum value along the projected coordinates</span>
<span class="sd">                * float: the projected coordinate at which to plot the slice (Theta or X if Proj=&#39;Cross&#39;, Z if Proj=&#39;Hor&#39;)</span>
<span class="sd">                * None: the slice is done in the middle of the viewing volume</span>
<span class="sd">        plotfunc :  str</span>
<span class="sd">            Flag indicating which plotting method to use (&#39;scatter&#39;, &#39;contour&#39;, &#39;contourf&#39; or &#39;imshow&#39;)</span>
<span class="sd">        DCross :    float</span>
<span class="sd">            Resolution along the 1st cross-section coordinate (R for Type=&#39;Tor&#39;, Y for Type=&#39;Lin&#39;)</span>
<span class="sd">        DXTheta :   float</span>
<span class="sd">            Resolution along the ignorable coordinate (Theta for Type=&#39;Tor&#39;, X for Type=&#39;Lin&#39;)</span>
<span class="sd">        DZ :        float</span>
<span class="sd">            Vertical resolution (for both Types)</span>
<span class="sd">        CDictSA :   dict</span>
<span class="sd">            Properties of the solid angle plot, to be fed to the function chosen by plotfunc</span>
<span class="sd">        CDictNb :   dict</span>
<span class="sd">            Properties of the Nb plot, to be fed to ...</span>
<span class="sd">        Colis :     bool</span>
<span class="sd">            Flag indicating whether collision detection should be used</span>
<span class="sd">        a4 :        bool</span>
<span class="sd">            Flag indicating whether to use a4 dimensions to create a new figure if Lax=None</span>
<span class="sd">        draw :      bool</span>
<span class="sd">            Flag indicating whether to draw the figure</span>
<span class="sd">        Test :      bool</span>
<span class="sd">            Flag indicating whether the inputs should be tested for conformity</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Lax         plt.Axes or list            List of the axes used for plotting</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">SA</span><span class="p">,</span> <span class="n">Nb</span><span class="p">,</span> <span class="n">Pts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_SAngNb</span><span class="p">(</span><span class="n">Pts</span><span class="o">=</span><span class="n">Pts</span><span class="p">,</span> <span class="n">Proj</span><span class="o">=</span><span class="n">Proj</span><span class="p">,</span> <span class="n">Slice</span><span class="o">=</span><span class="n">Slice</span><span class="p">,</span> <span class="n">DRY</span><span class="o">=</span><span class="n">DRY</span><span class="p">,</span> <span class="n">DXTheta</span><span class="o">=</span><span class="n">DXTheta</span><span class="p">,</span> <span class="n">DZ</span><span class="o">=</span><span class="n">DZ</span><span class="p">,</span> <span class="n">Colis</span><span class="o">=</span><span class="n">Colis</span><span class="p">,</span> <span class="n">ind</span><span class="o">=</span><span class="n">ind</span><span class="p">,</span> <span class="n">Val</span><span class="o">=</span><span class="n">Val</span><span class="p">,</span> <span class="n">Crit</span><span class="o">=</span><span class="n">Crit</span><span class="p">,</span> <span class="n">PreExp</span><span class="o">=</span><span class="n">PreExp</span><span class="p">,</span> <span class="n">PostExp</span><span class="o">=</span><span class="n">PostExp</span><span class="p">,</span> <span class="n">Log</span><span class="o">=</span><span class="n">Log</span><span class="p">,</span> <span class="n">InOut</span><span class="o">=</span><span class="n">InOut</span><span class="p">)</span>
        <span class="n">Lax</span> <span class="o">=</span> <span class="n">_tfg_p</span><span class="o">.</span><span class="n">_GLDetect_plot_SAngNb</span><span class="p">(</span><span class="n">Leg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">SA</span><span class="o">=</span><span class="n">SA</span><span class="p">,</span> <span class="n">Nb</span><span class="o">=</span><span class="n">Nb</span><span class="p">,</span> <span class="n">Pts</span><span class="o">=</span><span class="n">Pts</span><span class="p">,</span> <span class="n">Lax</span><span class="o">=</span><span class="n">Lax</span><span class="p">,</span> <span class="n">Proj</span><span class="o">=</span><span class="n">Proj</span><span class="p">,</span> <span class="n">Slice</span><span class="o">=</span><span class="n">Slice</span><span class="p">,</span> <span class="n">plotfunc</span><span class="o">=</span><span class="n">plotfunc</span><span class="p">,</span> <span class="n">CDictSA</span><span class="o">=</span><span class="n">CDictSA</span><span class="p">,</span> <span class="n">CDictNb</span><span class="o">=</span><span class="n">CDictNb</span><span class="p">,</span> <span class="n">Colis</span><span class="o">=</span><span class="n">Colis</span><span class="p">,</span>
                                        <span class="n">DRY</span><span class="o">=</span><span class="n">DRY</span><span class="p">,</span> <span class="n">DXTheta</span><span class="o">=</span><span class="n">DXTheta</span><span class="p">,</span> <span class="n">VType</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">Type</span><span class="p">,</span> <span class="n">a4</span><span class="o">=</span><span class="n">a4</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="n">Test</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="ow">not</span> <span class="n">ss</span><span class="o">==</span><span class="s">&#39;&#39;</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Elt</span><span class="p">,</span><span class="n">EltVes</span><span class="p">,</span> <span class="n">EltLOS</span><span class="p">,</span> <span class="n">EltOptics</span><span class="p">]]):</span>
            <span class="n">Lax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Proj</span><span class="o">=</span><span class="n">Proj</span><span class="p">,</span> <span class="n">Lax</span><span class="o">=</span><span class="n">Lax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Elt</span><span class="o">=</span><span class="n">Elt</span><span class="p">,</span> <span class="n">EltVes</span><span class="o">=</span><span class="n">EltVes</span><span class="p">,</span> <span class="n">EltLOS</span><span class="o">=</span><span class="n">EltLOS</span><span class="p">,</span> <span class="n">EltOptics</span><span class="o">=</span><span class="n">EltOptics</span><span class="p">,</span> <span class="n">Pdict</span><span class="o">=</span><span class="n">Pdict</span><span class="p">,</span> <span class="n">Vdict</span><span class="o">=</span><span class="n">Vdict</span><span class="p">,</span> <span class="n">Cdict</span><span class="o">=</span><span class="n">Cdict</span><span class="p">,</span> <span class="n">LVIn</span><span class="o">=</span><span class="n">LVIn</span><span class="p">,</span>
                    <span class="n">LOSdict</span><span class="o">=</span><span class="n">LOSdict</span><span class="p">,</span> <span class="n">Opticsdict</span><span class="o">=</span><span class="n">Opticsdict</span><span class="p">,</span> <span class="n">Vesdict</span><span class="o">=</span><span class="n">Vesdict</span><span class="p">,</span> <span class="n">LegDict</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">a4</span><span class="o">=</span><span class="n">a4</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="n">Test</span><span class="p">,</span>
                    <span class="n">ind</span><span class="o">=</span><span class="n">ind</span><span class="p">,</span> <span class="n">Val</span><span class="o">=</span><span class="n">Val</span><span class="p">,</span> <span class="n">Crit</span><span class="o">=</span><span class="n">Crit</span><span class="p">,</span> <span class="n">PreExp</span><span class="o">=</span><span class="n">PreExp</span><span class="p">,</span> <span class="n">PostExp</span><span class="o">=</span><span class="n">PostExp</span><span class="p">,</span> <span class="n">Log</span><span class="o">=</span><span class="n">Log</span><span class="p">,</span> <span class="n">InOut</span><span class="o">=</span><span class="n">InOut</span><span class="p">)</span>
            <span class="n">Lax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Proj</span><span class="o">=</span><span class="n">Proj</span><span class="p">,</span> <span class="n">Lax</span><span class="o">=</span><span class="n">Lax</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">Elt</span><span class="o">=</span><span class="n">Elt</span><span class="p">,</span> <span class="n">EltVes</span><span class="o">=</span><span class="n">EltVes</span><span class="p">,</span> <span class="n">EltLOS</span><span class="o">=</span><span class="n">EltLOS</span><span class="p">,</span> <span class="n">EltOptics</span><span class="o">=</span><span class="n">EltOptics</span><span class="p">,</span> <span class="n">Pdict</span><span class="o">=</span><span class="n">Pdict</span><span class="p">,</span> <span class="n">Vdict</span><span class="o">=</span><span class="n">Vdict</span><span class="p">,</span> <span class="n">Cdict</span><span class="o">=</span><span class="n">Cdict</span><span class="p">,</span> <span class="n">LVIn</span><span class="o">=</span><span class="n">LVIn</span><span class="p">,</span>
                    <span class="n">LOSdict</span><span class="o">=</span><span class="n">LOSdict</span><span class="p">,</span> <span class="n">Opticsdict</span><span class="o">=</span><span class="n">Opticsdict</span><span class="p">,</span> <span class="n">Vesdict</span><span class="o">=</span><span class="n">Vesdict</span><span class="p">,</span> <span class="n">LegDict</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">a4</span><span class="o">=</span><span class="n">a4</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="n">Test</span><span class="p">,</span>
                    <span class="n">ind</span><span class="o">=</span><span class="n">ind</span><span class="p">,</span> <span class="n">Val</span><span class="o">=</span><span class="n">Val</span><span class="p">,</span> <span class="n">Crit</span><span class="o">=</span><span class="n">Crit</span><span class="p">,</span> <span class="n">PreExp</span><span class="o">=</span><span class="n">PreExp</span><span class="p">,</span> <span class="n">PostExp</span><span class="o">=</span><span class="n">PostExp</span><span class="p">,</span> <span class="n">Log</span><span class="o">=</span><span class="n">Log</span><span class="p">,</span> <span class="n">InOut</span><span class="o">=</span><span class="n">InOut</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">draw</span><span class="p">:</span>
            <span class="n">Lax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">Lax</span></div>


<div class="viewcode-block" id="GDetect.plot_Etend_AlongLOS"><a class="viewcode-back" href="../../../Auto_tofu.geom.html#tofu.geom.GDetect.plot_Etend_AlongLOS">[docs]</a>    <span class="k">def</span> <span class="nf">plot_Etend_AlongLOS</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">NP</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetEtendOnLOSNP</span><span class="p">,</span> <span class="n">kMode</span><span class="o">=</span><span class="s">&#39;rel&#39;</span><span class="p">,</span> <span class="n">Modes</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;trapz&#39;</span><span class="p">],</span> <span class="n">RelErr</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">dX12</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">dX12Mode</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Ratio</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">LOSRef</span><span class="o">=</span><span class="k">None</span><span class="p">,</span>
                            <span class="n">LOSPts</span><span class="o">=</span><span class="k">True</span><span class="p">,</span> <span class="n">Ldict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetEtendOnLOSLd</span><span class="p">,</span> <span class="n">LegDict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">TorLegd</span><span class="p">,</span> <span class="n">Colis</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetSAngColis</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="k">True</span><span class="p">,</span> <span class="n">a4</span><span class="o">=</span><span class="k">True</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="k">True</span><span class="p">,</span>
                            <span class="n">ind</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Val</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Crit</span><span class="o">=</span><span class="s">&#39;Name&#39;</span><span class="p">,</span> <span class="n">PreExp</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">PostExp</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Log</span><span class="o">=</span><span class="s">&#39;any&#39;</span><span class="p">,</span> <span class="n">InOut</span><span class="o">=</span><span class="s">&#39;In&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Plot the etendue of the selected LOS along it, with or without collision detection</span>

<span class="sd">        The number of points along the LOS where the etendue is computed can be specified via arguments, as well as the numerical integration method.</span>
<span class="sd">        See :meth:`~tofu.geom.Detect.plot_Etendue_AlongLOS` for details</span>
<span class="sd">        Arguments Length, NP, Modes, RelErr, dX12, dX12Mode, Ratio, Colis, LOSRef are fed to :meth:`~tofu.geom.Detect.calc_Etendue_AlongLOS`</span>
<span class="sd">        Arguments ind, Val, Crit, PreExp, PostExp, Log and InOut are fed to :meth:`~tofu.geom.GDetect.select`</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ax :        None or plt.Axes</span>
<span class="sd">            Axes to be used for plotting, if None a new figure and appropriate axes are created</span>
<span class="sd">        NP :        int</span>
<span class="sd">            Number of points along the LOS at which the Etendue should be computed</span>
<span class="sd">        kMode :     str</span>
<span class="sd">            Flag indicating whether the distance on the line should be plotted as abolute distance (&#39;abs&#39;) or relative to the total length (&#39;rel&#39;)</span>
<span class="sd">        Modes :     str or list</span>
<span class="sd">            Flag or list of flags indicating which integration method should be used</span>
<span class="sd">        Colis :     bool</span>
<span class="sd">            Flag indicating whether collision detection should be used</span>
<span class="sd">        LOSRef :    None or str</span>
<span class="sd">            Flag indicating which LOS should be used</span>
<span class="sd">        Ldict :     dict</span>
<span class="sd">            Dictionary of properties for plotting the result</span>
<span class="sd">        LegDict :   None / dict</span>
<span class="sd">            If None, no legend is plotted, else LegDict is fed to :meth:&#39;~matplotlib.pyplot.Axes.legend&#39;</span>
<span class="sd">        draw :      bool</span>
<span class="sd">            Flag indicating whether to draw the figure</span>
<span class="sd">        a4 :        bool</span>
<span class="sd">            Flag indicating whether the created figure should have a4 dimensions (useful for printing)</span>
<span class="sd">        Test :      bool</span>
<span class="sd">            Flag indicating whether the inputs should be tested for conformity</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ax :        plt.Axes</span>
<span class="sd">            The axes used for plotting</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">ind</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">Val</span><span class="o">=</span><span class="n">Val</span><span class="p">,</span><span class="n">Crit</span><span class="o">=</span><span class="n">Crit</span><span class="p">,</span><span class="n">InOut</span><span class="o">=</span><span class="n">InOut</span><span class="p">,</span><span class="n">Out</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">ind</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">name</span><span class="o">==</span><span class="s">&#39;bool&#39;</span><span class="p">:</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">ind</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">LD</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">LDetect</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">ind</span><span class="p">]</span>
        <span class="n">nD</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">LD</span><span class="p">)</span>
        <span class="n">LOSRef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_LOSRef</span> <span class="k">if</span> <span class="n">LOSRef</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">else</span> <span class="n">LOSRef</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nD</span><span class="p">):</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">LD</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">plot_Etend_AlongLOS</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">NP</span><span class="o">=</span><span class="n">NP</span><span class="p">,</span> <span class="n">kMode</span><span class="o">=</span><span class="n">kMode</span><span class="p">,</span> <span class="n">Modes</span><span class="o">=</span><span class="n">Modes</span><span class="p">,</span> <span class="n">RelErr</span><span class="o">=</span><span class="n">RelErr</span><span class="p">,</span> <span class="n">dX12</span><span class="o">=</span><span class="n">dX12</span><span class="p">,</span> <span class="n">dX12Mode</span><span class="o">=</span><span class="n">dX12Mode</span><span class="p">,</span> <span class="n">Ratio</span><span class="o">=</span><span class="n">Ratio</span><span class="p">,</span> <span class="n">LOSRef</span><span class="o">=</span><span class="n">LOSRef</span><span class="p">,</span>
                                     <span class="n">LOSPts</span><span class="o">=</span><span class="n">LOSPts</span><span class="p">,</span> <span class="n">Ldict</span><span class="o">=</span><span class="n">Ldict</span><span class="p">,</span> <span class="n">LegDict</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Colis</span><span class="o">=</span><span class="n">Colis</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">a4</span><span class="o">=</span><span class="n">a4</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="n">Test</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">LegDict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="o">**</span><span class="n">LegDict</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">draw</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">ax</span></div>

<div class="viewcode-block" id="GDetect.plot_Sinogram"><a class="viewcode-back" href="../../../Auto_tofu.geom.html#tofu.geom.GDetect.plot_Sinogram">[docs]</a>    <span class="k">def</span> <span class="nf">plot_Sinogram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Proj</span><span class="o">=</span><span class="s">&#39;Cross&#39;</span><span class="p">,</span> <span class="n">Elt</span><span class="o">=</span><span class="s">&#39;DLV&#39;</span><span class="p">,</span> <span class="n">Ang</span><span class="o">=</span><span class="s">&#39;theta&#39;</span><span class="p">,</span> <span class="n">AngUnit</span><span class="o">=</span><span class="s">&#39;rad&#39;</span><span class="p">,</span> <span class="n">Sketch</span><span class="o">=</span><span class="k">True</span><span class="p">,</span> <span class="n">Ddict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetImpd</span><span class="p">,</span> <span class="n">Ldict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">LOSMImpd</span><span class="p">,</span> <span class="n">Vdict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">TorPFilld</span><span class="p">,</span> <span class="n">LegDict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">TorLegd</span><span class="p">,</span> <span class="n">LOSRef</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="k">True</span><span class="p">,</span> <span class="n">a4</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="k">True</span><span class="p">,</span>
            <span class="n">ind</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Val</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Crit</span><span class="o">=</span><span class="s">&#39;Name&#39;</span><span class="p">,</span> <span class="n">PreExp</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">PostExp</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Log</span><span class="o">=</span><span class="s">&#39;any&#39;</span><span class="p">,</span> <span class="n">InOut</span><span class="o">=</span><span class="s">&#39;In&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Plot the VOS of all or of a subset of the :class:`~tofu.geom.Detect` instances in projection space, optionally also the associated :class:`~tofu.geom.Ves` object and reference :class:`~tofu.geom.LOS`</span>

<span class="sd">        See :meth:`~tofu.geom.Detect.plot_Sinogram` for details</span>
<span class="sd">        Arguments ind, Val, Crit, PreExp, PostExp, Log and InOut are fed to :meth:`~tofu.geom.GDetect.select`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">_tfg_p</span><span class="o">.</span><span class="n">GLDetect_plot_Sinogram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Proj</span><span class="o">=</span><span class="n">Proj</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">Elt</span><span class="o">=</span><span class="n">Elt</span><span class="p">,</span> <span class="n">Sketch</span><span class="o">=</span><span class="n">Sketch</span><span class="p">,</span> <span class="n">Ang</span><span class="o">=</span><span class="n">Ang</span><span class="p">,</span> <span class="n">AngUnit</span><span class="o">=</span><span class="n">AngUnit</span><span class="p">,</span> <span class="n">Ddict</span><span class="o">=</span><span class="n">Ddict</span><span class="p">,</span> <span class="n">Ldict</span><span class="o">=</span><span class="n">Ldict</span><span class="p">,</span> <span class="n">Vdict</span><span class="o">=</span><span class="n">Vdict</span><span class="p">,</span> <span class="n">LegDict</span><span class="o">=</span><span class="n">LegDict</span><span class="p">,</span> <span class="n">LOSRef</span><span class="o">=</span><span class="n">LOSRef</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="n">draw</span><span class="p">,</span> <span class="n">a4</span><span class="o">=</span><span class="n">a4</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="n">Test</span><span class="p">,</span>
                                          <span class="n">ind</span><span class="o">=</span><span class="n">ind</span><span class="p">,</span> <span class="n">Val</span><span class="o">=</span><span class="n">Val</span><span class="p">,</span> <span class="n">Crit</span><span class="o">=</span><span class="n">Crit</span><span class="p">,</span> <span class="n">PreExp</span><span class="o">=</span><span class="n">PreExp</span><span class="p">,</span> <span class="n">PostExp</span><span class="o">=</span><span class="n">PostExp</span><span class="p">,</span> <span class="n">Log</span><span class="o">=</span><span class="n">Log</span><span class="p">,</span> <span class="n">InOut</span><span class="o">=</span><span class="n">InOut</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></div>

<div class="viewcode-block" id="GDetect.plot_Etendues"><a class="viewcode-back" href="../../../Auto_tofu.geom.html#tofu.geom.GDetect.plot_Etendues">[docs]</a>    <span class="k">def</span> <span class="nf">plot_Etendues</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Mode</span><span class="o">=</span><span class="s">&#39;Etend&#39;</span><span class="p">,</span> <span class="n">Elt</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Adict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">GDetEtendMdA</span><span class="p">,</span> <span class="n">Rdict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">GDetEtendMdR</span><span class="p">,</span> <span class="n">Edict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">GDetEtendMdS</span><span class="p">,</span> <span class="n">LegDict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">TorLegd</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="k">True</span><span class="p">,</span> <span class="n">a4</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="k">True</span><span class="p">,</span>
                      <span class="n">ind</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Val</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Crit</span><span class="o">=</span><span class="s">&#39;Name&#39;</span><span class="p">,</span> <span class="n">PreExp</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">PostExp</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Log</span><span class="o">=</span><span class="s">&#39;any&#39;</span><span class="p">,</span> <span class="n">InOut</span><span class="o">=</span><span class="s">&#39;In&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Plot the etendues of all or a subset of the :class:`~tofu.geom.Detect` instances for the chosen :class:`~tofu.geom.LOS`</span>

<span class="sd">        A given Detect+Optics system has a VOS, under proper conditions, this VOS can be approximated by a LOS, but the choice of the LOS is not unique, there is an infinite number of possible LOS in a single VOS.</span>
<span class="sd">        The LOS automatically computed by tofu os the &#39;natural&#39; option : goes from the midlle of the Detect area throught the middle of the optics.</span>
<span class="sd">        Then tofu automatically computes the associated etendue.</span>
<span class="sd">        This methods plots all the etendues of all the chosen :class:`~tofu.geom.Detect` instances for the chosen :class:`~tofu.geom.LOS`, which is by default the &#39;natural&#39; LOS computed by tofu</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        Mode :      str</span>
<span class="sd">            Flasg indicating whether to plot the etendue (&#39;Etend&#39;) or a geometrical calibration factor (&#39;Calib&#39;) computed as the 4pi/etendue</span>
<span class="sd">        Elt :       str</span>
<span class="sd">            Flag indicating whether to plot, in addition to the etendue, also the direct (&#39;A&#39;) and reverse (&#39;R&#39;) 0-order approximation of the etendue</span>
<span class="sd">        ax :        None or plt.Axes</span>
<span class="sd">            Axes to be used for plotting, if None a new figure and appropriate axes are created</span>
<span class="sd">        Adict :     dict</span>
<span class="sd">            Dictionary of properties for plotting the direct 0-order approximation of the etendue (if &#39;A&#39; in Elt), fed to :meth:`~matplotlib.pyplot.Axes.plot`</span>
<span class="sd">        Rdict :     dict</span>
<span class="sd">            Dictionary of properties for plotting the reverse 0-order approximation of the etendue (if &#39;R&#39; in Elt), fed to :meth:`~matplotlib.pyplot.Axes.plot`</span>
<span class="sd">        Edict :     dict</span>
<span class="sd">            Dictionary of properties for plotting the etendue, fed to :meth:`~matplotlib.pyplot.Axes.plot`</span>
<span class="sd">        LegDict :   dict</span>
<span class="sd">            If None, no legend is plotted, else LegDict is fed to :meth:&#39;~matplotlib.pyplot.Axes.legend&#39;</span>
<span class="sd">        draw :      bool</span>
<span class="sd">            Flag indicating whether to draw the figure</span>
<span class="sd">        a4 :        bool</span>
<span class="sd">            Flag indicating whether the created figure should have a4 dimensions (useful for printing)</span>
<span class="sd">        Test :      bool</span>
<span class="sd">            Flag indicating whether the inputs should be tested for conformity</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ax :        plt.Axes</span>
<span class="sd">            The axes used for plotting</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">_tfg_p</span><span class="o">.</span><span class="n">Plot_Etendues_GDetect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">Mode</span><span class="o">=</span><span class="n">Mode</span><span class="p">,</span> <span class="n">Elt</span><span class="o">=</span><span class="n">Elt</span><span class="p">,</span> <span class="n">Adict</span><span class="o">=</span><span class="n">Adict</span><span class="p">,</span> <span class="n">Rdict</span><span class="o">=</span><span class="n">Rdict</span><span class="p">,</span> <span class="n">Edict</span><span class="o">=</span><span class="n">Edict</span><span class="p">,</span> <span class="n">LegDict</span><span class="o">=</span><span class="n">LegDict</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="n">draw</span><span class="p">,</span> <span class="n">a4</span><span class="o">=</span><span class="n">a4</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="n">Test</span><span class="p">,</span>
                                         <span class="n">ind</span><span class="o">=</span><span class="n">ind</span><span class="p">,</span> <span class="n">Val</span><span class="o">=</span><span class="n">Val</span><span class="p">,</span> <span class="n">Crit</span><span class="o">=</span><span class="n">Crit</span><span class="p">,</span> <span class="n">PreExp</span><span class="o">=</span><span class="n">PreExp</span><span class="p">,</span> <span class="n">PostExp</span><span class="o">=</span><span class="n">PostExp</span><span class="p">,</span> <span class="n">Log</span><span class="o">=</span><span class="n">Log</span><span class="p">,</span> <span class="n">InOut</span><span class="o">=</span><span class="n">InOut</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="GDetect.plot_Sig"><a class="viewcode-back" href="../../../Auto_tofu.geom.html#tofu.geom.GDetect.plot_Sig">[docs]</a>    <span class="k">def</span> <span class="nf">plot_Sig</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ffSig</span><span class="p">,</span> <span class="n">extargs</span><span class="o">=</span><span class="p">{},</span> <span class="n">Method</span><span class="o">=</span><span class="s">&#39;Vol&#39;</span><span class="p">,</span> <span class="n">Mode</span><span class="o">=</span><span class="s">&#39;simps&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Leg</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">Sdict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">GDetSigd</span><span class="p">,</span> <span class="n">LegDict</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">TorLegd</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="k">True</span><span class="p">,</span> <span class="n">a4</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="k">True</span><span class="p">,</span>
                 <span class="n">PreComp</span><span class="o">=</span><span class="k">True</span><span class="p">,</span> <span class="n">epsrel</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetSynthEpsrel</span><span class="p">,</span> <span class="n">dX12</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetSynthdX12</span><span class="p">,</span> <span class="n">dX12Mode</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetSynthdX12Mode</span><span class="p">,</span> <span class="n">ds</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetSynthds</span><span class="p">,</span> <span class="n">dsMode</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetSynthdsMode</span><span class="p">,</span> <span class="n">MarginS</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetSynthMarginS</span><span class="p">,</span> <span class="n">Colis</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetCalcSAngVectColis</span><span class="p">,</span>
                 <span class="n">ind</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Val</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Crit</span><span class="o">=</span><span class="s">&#39;Name&#39;</span><span class="p">,</span> <span class="n">PreExp</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">PostExp</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Log</span><span class="o">=</span><span class="s">&#39;any&#39;</span><span class="p">,</span> <span class="n">InOut</span><span class="o">=</span><span class="s">&#39;In&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Plot the ignal computed for each or a subset of the :class:`~tofu.geom.Detect` instances</span>

<span class="sd">        If the signal is not directly provided as an array, it is computed from a function.</span>
<span class="sd">        If ffSig is a callable function, arguments ffSig, extargs, Method, Mode, PreComp, epsrel, dX12, dX12Mode, ds, dsMode, MarginS, Colis and Test are fed to :meth:`~tofu.geom.GDetect.calc_Sig`</span>
<span class="sd">        Arguments ind, Val, Crit, PreExp, PostExp, Log and InOut are fed to :meth:`~tofu.geom.GDetect.select`</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ffSig       np.ndarray or callable</span>
<span class="sd">            Either a np.ndarray containing the signal to be plotted (of shape (ND,) or (N,ND) where ND is the number of detectors to be plotted) or a callable to be fed to for computing the signal</span>
<span class="sd">        ax :        None or plt.Axes</span>
<span class="sd">            Axes to be used for plotting, if None a new figure and appropriate axes are created</span>
<span class="sd">        Sdict :     dict</span>
<span class="sd">            Dictionary of properties for plotting the signal, fed to :meth:`~matplotlib.pyplot.Axes.plot`</span>
<span class="sd">        Leg :       str</span>
<span class="sd">            Label to be used for the plot</span>
<span class="sd">        LegDict :   dict</span>
<span class="sd">            If None, no legend is plotted, else LegDict is fed to :meth:&#39;~matplotlib.pyplot.Axes.legend&#39;</span>
<span class="sd">        draw :      bool</span>
<span class="sd">            Flag indicating whether to draw the figure</span>
<span class="sd">        a4 :        bool</span>
<span class="sd">            Flag indicating whether the created figure should have a4 dimensions (useful for printing)</span>
<span class="sd">        Test :      bool</span>
<span class="sd">            Flag indicating whether the inputs should be tested for conformity</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ax :        plt.Axes</span>
<span class="sd">            The axes used for plotting</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">ffSig</span><span class="p">)</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ffSig</span><span class="p">,</span><span class="s">&#39;__call__&#39;</span><span class="p">),</span> <span class="s">&quot;Arg ffSig must be either pre-computed np.ndarray of signals or a callable function for computing it (fed to GDetect.calc_Sig()) !&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">ffSig</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
            <span class="n">ffSig</span><span class="p">,</span> <span class="n">GD</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_Sig</span><span class="p">(</span><span class="n">ffSig</span><span class="p">,</span> <span class="n">extargs</span><span class="o">=</span><span class="n">extargs</span><span class="p">,</span> <span class="n">Method</span><span class="o">=</span><span class="n">Method</span><span class="p">,</span> <span class="n">Mode</span><span class="o">=</span><span class="n">Mode</span><span class="p">,</span> <span class="n">PreComp</span><span class="o">=</span><span class="n">PreComp</span><span class="p">,</span> <span class="n">epsrel</span><span class="o">=</span><span class="n">epsrel</span><span class="p">,</span> <span class="n">dX12</span><span class="o">=</span><span class="n">dX12</span><span class="p">,</span> <span class="n">dX12Mode</span><span class="o">=</span><span class="n">dX12Mode</span><span class="p">,</span> <span class="n">ds</span><span class="o">=</span><span class="n">ds</span><span class="p">,</span> <span class="n">dsMode</span><span class="o">=</span><span class="n">dsMode</span><span class="p">,</span> <span class="n">MarginS</span><span class="o">=</span><span class="n">MarginS</span><span class="p">,</span> <span class="n">Colis</span><span class="o">=</span><span class="n">Colis</span><span class="p">,</span>  <span class="n">Test</span><span class="o">=</span><span class="n">Test</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">GD</span><span class="p">,</span> <span class="n">Leg</span><span class="p">,</span> <span class="n">LOSRef</span> <span class="o">=</span> <span class="n">_tfg_p</span><span class="o">.</span><span class="n">_get_LD_Leg_LOSRef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Leg</span><span class="o">=</span><span class="n">Leg</span><span class="p">,</span> <span class="n">LOSRef</span><span class="o">=</span><span class="n">LOSRef</span><span class="p">,</span> <span class="n">ind</span><span class="o">=</span><span class="n">ind</span><span class="p">,</span> <span class="n">Val</span><span class="o">=</span><span class="n">Val</span><span class="p">,</span> <span class="n">Crit</span><span class="o">=</span><span class="n">Crit</span><span class="p">,</span> <span class="n">PreExp</span><span class="o">=</span><span class="n">PreExp</span><span class="p">,</span> <span class="n">PostExp</span><span class="o">=</span><span class="n">PostExp</span><span class="p">,</span> <span class="n">Log</span><span class="o">=</span><span class="n">Log</span><span class="p">,</span> <span class="n">InOut</span><span class="o">=</span><span class="n">InOut</span><span class="p">)</span>
            <span class="k">assert</span> <span class="p">(</span><span class="n">ffSig</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">ffSig</span><span class="o">.</span><span class="n">size</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">GD</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="n">ffSig</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">2</span> <span class="ow">and</span> <span class="n">ffSig</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">GD</span><span class="p">)),</span> <span class="s">&quot;Arg ffSig does not have the good shape !&quot;</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">_tfg_p</span><span class="o">.</span><span class="n">Plot_Sig_GDetect</span><span class="p">(</span><span class="n">GD</span><span class="p">,</span> <span class="n">ffSig</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">Leg</span><span class="o">=</span><span class="n">Leg</span><span class="p">,</span> <span class="n">Sdict</span><span class="o">=</span><span class="n">Sdict</span><span class="p">,</span> <span class="n">LegDict</span><span class="o">=</span><span class="n">LegDict</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="n">draw</span><span class="p">,</span> <span class="n">a4</span><span class="o">=</span><span class="n">a4</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="n">Test</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></div>


    <span class="k">def</span> <span class="nf">_plot_Res</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">plotfunc</span><span class="o">=</span><span class="s">&#39;scatter&#39;</span><span class="p">,</span> <span class="n">NC</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">CDict</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="k">True</span><span class="p">,</span> <span class="n">a4</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="k">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; see :meth:`~tofu.geom.Detect._plot_Res` for details</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Res_Done</span><span class="p">,</span> <span class="s">&quot;Cannot plot the resolution before it has been computed on a mesh grid with self.set_Res() !&quot;</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">_tfg_p</span><span class="o">.</span><span class="n">_Resolution_Plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_Res_Pts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Res_Res</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Res_DetLim</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">plotfunc</span><span class="o">=</span><span class="n">plotfunc</span><span class="p">,</span> <span class="n">NC</span><span class="o">=</span><span class="n">NC</span><span class="p">,</span> <span class="n">CDict</span><span class="o">=</span><span class="n">CDict</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="n">draw</span><span class="p">,</span> <span class="n">a4</span><span class="o">=</span><span class="n">a4</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="n">Test</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span>


<div class="viewcode-block" id="GDetect.save"><a class="viewcode-back" href="../../../Auto_tofu.geom.html#tofu.geom.GDetect.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">SaveName</span><span class="o">=</span><span class="k">None</span><span class="p">,</span><span class="n">Path</span><span class="o">=</span><span class="k">None</span><span class="p">,</span><span class="n">Mode</span><span class="o">=</span><span class="s">&#39;npz&#39;</span><span class="p">,</span> <span class="n">compressed</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">SynthDiag</span><span class="o">=</span><span class="k">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Save the object in folder Name, under file name SaveName, using specified mode</span>

<span class="sd">        Most tofu objects can be saved automatically as numpy arrays (.npz, recommended) at the default location (recommended) by simply calling self.save()</span>
<span class="sd">        In the case of Detect and GDetect instances, there is an additional keyword argument &#39;SynthDiag&#39; which allows to **not** save the pre-computed 3D mesh of the VOS for synthetic diagnostic.</span>
<span class="sd">        Indeed, this pre-computed data is often large and results in big files. Not saving it results in significantly smaller files, and it can be re-computed when loading the instance.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        SaveName :      None / str</span>
<span class="sd">            The name to be used for the saved file, if None (recommended) uses self.Id.SaveName</span>
<span class="sd">        Path :          None / str</span>
<span class="sd">            Path specifying where to save the file, if None (recommended) uses self.Id.SavePath</span>
<span class="sd">        Mode :          str</span>
<span class="sd">            Flag specifying whether to save the object as a numpy array file (&#39;.npz&#39;, recommended) or an object using cPickle (not recommended, heavier and may cause retro-compatibility issues)</span>
<span class="sd">        compressed :    bool</span>
<span class="sd">            Flag, used when Mode=&#39;npz&#39;, indicating whether to use np.savez or np.savez_compressed (slower saving and loading but smaller files)</span>
<span class="sd">        SynthDiag :     bool</span>
<span class="sd">            Flag indicating whether the pre-computed mesh for synthetic diagnostics calculations shall be saved too (can be heavy, if False, it will be re-computed when opening the saved object)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">SynthDiag</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">nDetect</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">LDetect</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">_reset_SynthDiag</span><span class="p">()</span>
        <span class="n">tfpf</span><span class="o">.</span><span class="n">Save_Generic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">SaveName</span><span class="o">=</span><span class="n">SaveName</span><span class="p">,</span> <span class="n">Path</span><span class="o">=</span><span class="n">Path</span><span class="p">,</span> <span class="n">Mode</span><span class="o">=</span><span class="n">Mode</span><span class="p">,</span> <span class="n">compressed</span><span class="o">=</span><span class="n">compressed</span><span class="p">)</span></div></div>





<span class="k">def</span> <span class="nf">_get_OpticsFromLDetect</span><span class="p">(</span><span class="n">LD</span><span class="p">):</span>
        <span class="n">LO</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">LD</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">ii</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">LO</span> <span class="o">+=</span> <span class="n">LD</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">Optics</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">LD</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">Optics</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="n">tfpf</span><span class="o">.</span><span class="n">CheckSameObj</span><span class="p">(</span><span class="n">aa</span><span class="p">,</span> <span class="n">LD</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">Optics</span><span class="p">[</span><span class="n">jj</span><span class="p">],</span> <span class="p">[</span><span class="s">&#39;Poly&#39;</span><span class="p">,</span><span class="s">&#39;Name&#39;</span><span class="p">,</span><span class="s">&#39;SaveName&#39;</span><span class="p">,</span><span class="s">&#39;Type&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">LO</span><span class="p">]):</span>
                        <span class="n">LO</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">LD</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">Optics</span><span class="p">[</span><span class="n">jj</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">LO</span>


<span class="k">def</span> <span class="nf">_GDetect_set_Defaults</span><span class="p">(</span><span class="n">LDetect</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Diag</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Sino_RefPt</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">LOSRef</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">LDetect</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">LDetect</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">Diag</span> <span class="o">=</span> <span class="n">Diag</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">Diag</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">else</span> <span class="n">LDetect</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Diag</span>
            <span class="n">Exp</span> <span class="o">=</span> <span class="n">Exp</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">Exp</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">else</span> <span class="n">LDetect</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Exp</span>
            <span class="n">Sino_RefPt</span> <span class="o">=</span> <span class="n">Sino_RefPt</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">Sino_RefPt</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">else</span> <span class="n">LDetect</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Sino_RefPt</span>
            <span class="n">LOSRef</span> <span class="o">=</span> <span class="n">LOSRef</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">LOSRef</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">else</span> <span class="n">LDetect</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">_LOSRef</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Diag</span> <span class="o">=</span> <span class="n">Diag</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">Diag</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">else</span> <span class="n">LDetect</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Diag</span>
            <span class="n">Exp</span> <span class="o">=</span> <span class="n">Exp</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">Exp</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">else</span> <span class="n">LDetect</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Exp</span>
            <span class="n">Sino_RefPt</span> <span class="o">=</span> <span class="n">Sino_RefPt</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">Sino_RefPt</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">else</span> <span class="n">LDetect</span><span class="o">.</span><span class="n">Sino_RefPt</span>
            <span class="n">LOSRef</span> <span class="o">=</span> <span class="n">LOSRef</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">LOSRef</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">else</span> <span class="n">LDetect</span><span class="o">.</span><span class="n">_LOSRef</span>
            <span class="n">LDetect</span> <span class="o">=</span> <span class="p">[</span><span class="n">LDetect</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">LDetect</span><span class="p">,</span> <span class="n">Exp</span><span class="p">,</span> <span class="n">Diag</span><span class="p">,</span> <span class="n">Sino_RefPt</span><span class="p">,</span> <span class="n">LOSRef</span>





<span class="k">def</span> <span class="nf">_GDetect_check_inputs</span><span class="p">(</span><span class="n">Id</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">LDetect</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Optics</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Vess</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Sino_RefPt</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Diag</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">CalcEtend</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">CalcSpanImp</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">CalcCone</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">CalcPreComp</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Calc</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Verb</span><span class="o">=</span><span class="k">None</span><span class="p">,</span>
        <span class="n">Etend_RelErr</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Etend_dX12</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Etend_dX12Mode</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Etend_Ratio</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Colis</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">LOSRef</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Etend_Method</span><span class="o">=</span><span class="k">None</span><span class="p">,</span>
        <span class="n">MarginRMin</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">NEdge</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">NRad</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Nk</span><span class="o">=</span><span class="k">None</span><span class="p">,</span>
        <span class="n">Cone_DRY</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Cone_DXTheta</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Cone_DZ</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Cone_NPsi</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Cone_Nk</span><span class="o">=</span><span class="k">None</span><span class="p">,</span>
        <span class="n">arrayorder</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Clock</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">dtime</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">dtimeIn</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">Id</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">Id</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">tfpf</span><span class="o">.</span><span class="n">ID</span><span class="p">],</span> <span class="s">&quot;Arg Id must be a str or a tfpf.ID object !&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">LDetect</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">LDetect</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">([</span><span class="nb">type</span><span class="p">(</span><span class="n">dd</span><span class="p">)</span> <span class="ow">is</span> <span class="n">Detect</span> <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">LDetect</span><span class="p">]),</span> <span class="s">&quot;Arg LDetect must be a list of Detect instances !&quot;</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">tfpf</span><span class="o">.</span><span class="n">CheckSameObj</span><span class="p">(</span><span class="n">LDetect</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Ves</span><span class="p">,</span><span class="n">dd</span><span class="o">.</span><span class="n">Ves</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;Poly&#39;</span><span class="p">,</span><span class="s">&#39;Name&#39;</span><span class="p">,</span><span class="s">&#39;SaveName&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">LDetect</span><span class="p">]),</span> <span class="s">&quot;All Detect objects must have the same :class:`~tofu.geom.Ves` object !&quot;</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">dd</span><span class="o">.</span><span class="n">Sino_RefPt</span><span class="o">==</span><span class="n">LDetect</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Sino_RefPt</span><span class="p">)</span> <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">LDetect</span><span class="p">])</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">dd</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Exp</span><span class="o">==</span><span class="n">LDetect</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Exp</span> <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">LDetect</span><span class="p">]),</span> <span class="s">&quot;All Detect instances in LDetect must belong to the same Exp !&quot;</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">dd</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Diag</span><span class="o">==</span><span class="n">LDetect</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Diag</span> <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">LDetect</span><span class="p">]),</span> <span class="s">&quot;All Detect instances in LDetect must belong to the same Diag !&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Exp</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">Exp</span><span class="o">==</span><span class="n">LDetect</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Exp</span><span class="p">,</span> <span class="s">&quot;Arg Exp must be identical to the LDetect Exp !&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Diag</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">Diag</span><span class="o">==</span><span class="n">LDetect</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Diag</span><span class="p">,</span> <span class="s">&quot;Arg Diag must be identical to the LDetect Diag !&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">arrayorder</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">arrayorder</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;C&#39;</span><span class="p">,</span><span class="s">&#39;F&#39;</span><span class="p">],</span> <span class="s">&quot;Arg arrayorder must be in [&#39;C&#39;,&#39;F&#39;] !&quot;</span>
    <span class="n">bools</span> <span class="o">=</span> <span class="p">[</span><span class="n">Clock</span><span class="p">,</span><span class="n">dtimeIn</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="ow">not</span> <span class="n">aa</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">bools</span><span class="p">]):</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">aa</span> <span class="ow">is</span> <span class="k">None</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">aa</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">bool</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">bools</span><span class="p">]),</span> <span class="s">&quot; Args [CalcEtend,CalcSpanImp,CalcCone,CalcPreComp,Calc,Verb,Colis,Clock,dtimeIn] must all be bool !&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">Exp</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">Exp</span> <span class="ow">in</span> <span class="n">tfd</span><span class="o">.</span><span class="n">AllowedExp</span><span class="p">,</span> <span class="s">&quot;Arg Exp must be in &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">AllowedExp</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; !&quot;</span>
    <span class="k">assert</span> <span class="n">Type</span> <span class="ow">is</span> <span class="k">None</span><span class="p">,</span> <span class="s">&quot;Arg Type must be None for GDetect objects !&quot;</span>
    <span class="n">Iter2</span> <span class="o">=</span> <span class="p">[</span><span class="n">Sino_RefPt</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="ow">not</span> <span class="n">aa</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">Iter2</span><span class="p">]):</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">aa</span> <span class="ow">is</span> <span class="k">None</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">aa</span><span class="p">,</span><span class="s">&#39;__iter__&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">aa</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="o">==</span><span class="p">(</span><span class="mi">2</span><span class="p">,))</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">Iter2</span><span class="p">]),</span> <span class="s">&quot;Args [Sino_RefPt] must be an iterable with len()=2 !&quot;</span>
    <span class="n">strs</span> <span class="o">=</span> <span class="p">[</span><span class="n">Diag</span><span class="p">,</span><span class="n">SavePath</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="ow">not</span> <span class="n">aa</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">strs</span><span class="p">]):</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">aa</span> <span class="ow">is</span> <span class="k">None</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">aa</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">strs</span><span class="p">]),</span> <span class="s">&quot;Args [dX12Mode,LOSRef,Method,Diag,SavePath] must all be str !&quot;</span>
    <span class="n">ints</span> <span class="o">=</span> <span class="p">[</span><span class="n">shot</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="ow">not</span> <span class="n">aa</span> <span class="ow">is</span> <span class="k">None</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">ints</span><span class="p">]):</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">aa</span> <span class="ow">is</span> <span class="k">None</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">aa</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">ints</span><span class="p">]),</span> <span class="s">&quot;Args [shot,NEdge,NRad] must be int !&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">dtime</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">dtime</span><span class="p">)</span> <span class="ow">is</span> <span class="n">dtm</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="s">&quot;Arg dtime must be a dtm.datetime !&quot;</span>




<span class="k">def</span> <span class="nf">_GDetect_Calc_SAngNb</span><span class="p">(</span><span class="n">GD</span><span class="p">,</span> <span class="n">Pts</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Proj</span><span class="o">=</span><span class="s">&#39;Cross&#39;</span><span class="p">,</span> <span class="n">Slice</span><span class="o">=</span><span class="s">&#39;Int&#39;</span><span class="p">,</span> <span class="n">DRY</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">DXTheta</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">DZ</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Colis</span><span class="o">=</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetSAngColis</span><span class="p">,</span>
                         <span class="n">ind</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Val</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Crit</span><span class="o">=</span><span class="s">&#39;Name&#39;</span><span class="p">,</span> <span class="n">PreExp</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">PostExp</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Log</span><span class="o">=</span><span class="s">&#39;any&#39;</span><span class="p">,</span> <span class="n">InOut</span><span class="o">=</span><span class="s">&#39;In&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ind</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">GD</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">Val</span><span class="o">=</span><span class="n">Val</span><span class="p">,</span><span class="n">Crit</span><span class="o">=</span><span class="n">Crit</span><span class="p">,</span><span class="n">InOut</span><span class="o">=</span><span class="n">InOut</span><span class="p">,</span><span class="n">Out</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">ind</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">name</span><span class="o">==</span><span class="s">&#39;bool&#39;</span><span class="p">:</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">ind</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">LD</span> <span class="o">=</span> <span class="p">[</span><span class="n">GD</span><span class="o">.</span><span class="n">LDetect</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">ind</span><span class="p">]</span>
        <span class="n">nD</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">LD</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">DRY</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="n">DRY</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">dd</span><span class="o">.</span><span class="n">_Cone_Poly_DR</span> <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">LD</span><span class="p">])</span> <span class="k">if</span> <span class="n">GD</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">Type</span><span class="o">==</span><span class="s">&#39;Tor&#39;</span> <span class="k">else</span> <span class="nb">min</span><span class="p">([</span><span class="n">dd</span><span class="o">.</span><span class="n">_Cone_Poly_DY</span> <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">LD</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">DXTheta</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="n">DXTheta</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">dd</span><span class="o">.</span><span class="n">_Cone_Poly_DTheta</span> <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">LD</span><span class="p">])</span> <span class="k">if</span> <span class="n">GD</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">Type</span><span class="o">==</span><span class="s">&#39;Tor&#39;</span> <span class="k">else</span> <span class="nb">min</span><span class="p">([</span><span class="n">dd</span><span class="o">.</span><span class="n">_Cone_Poly_DX</span> <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">LD</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">DZ</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="n">DZ</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">dd</span><span class="o">.</span><span class="n">_Cone_Poly_DZ</span> <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">LD</span><span class="p">])</span>
        <span class="c"># Get the mesh if Pts not provided</span>
        <span class="k">if</span> <span class="n">Pts</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="n">LLOS</span> <span class="o">=</span> <span class="n">GD</span><span class="o">.</span><span class="n">get_GLOS</span><span class="p">()</span><span class="o">.</span><span class="n">LLOS</span>
            <span class="n">LLOS</span> <span class="o">=</span> <span class="p">[</span><span class="n">LLOS</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">ind</span><span class="p">]</span>
            <span class="n">SingPts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="nb">tuple</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">ll</span><span class="o">.</span><span class="n">PIn</span><span class="p">,</span> <span class="n">ll</span><span class="o">.</span><span class="n">PIn</span><span class="o">+</span><span class="mf">0.002</span><span class="o">*</span><span class="n">ll</span><span class="o">.</span><span class="n">u</span><span class="p">,</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">ll</span><span class="o">.</span><span class="n">POut</span><span class="o">+</span><span class="n">ll</span><span class="o">.</span><span class="n">PIn</span><span class="p">),</span> <span class="n">ll</span><span class="o">.</span><span class="n">POut</span><span class="o">-</span><span class="mf">0.002</span><span class="o">*</span><span class="n">ll</span><span class="o">.</span><span class="n">u</span> <span class="p">,</span> <span class="n">ll</span><span class="o">.</span><span class="n">POut</span><span class="p">))</span> <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="n">LLOS</span><span class="p">]))</span><span class="o">.</span><span class="n">T</span>
            <span class="n">LSpan_Z</span> <span class="o">=</span> <span class="p">[</span><span class="n">dd</span><span class="o">.</span><span class="n">_Span_Z</span> <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">LD</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">GD</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">Type</span><span class="o">==</span><span class="s">&#39;Tor&#39;</span><span class="p">:</span>
                <span class="n">LSpan_R</span> <span class="o">=</span> <span class="p">[</span><span class="n">dd</span><span class="o">.</span><span class="n">_Span_R</span> <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">LD</span><span class="p">]</span>
                <span class="n">LSpan_Theta</span> <span class="o">=</span> <span class="p">[</span><span class="n">dd</span><span class="o">.</span><span class="n">_Span_Theta</span> <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">LD</span><span class="p">]</span>
                <span class="n">LSpan_Z</span> <span class="o">=</span> <span class="p">[</span><span class="n">dd</span><span class="o">.</span><span class="n">_Span_Z</span> <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">LD</span><span class="p">]</span>
                <span class="n">X1</span><span class="p">,</span> <span class="n">XIgn</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">NX1</span><span class="p">,</span> <span class="n">NIgn</span><span class="p">,</span> <span class="n">NZ</span><span class="p">,</span> <span class="n">Pts</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">_tfg_c</span><span class="o">.</span><span class="n">_get_CrossHorMesh</span><span class="p">(</span><span class="n">SingPoints</span><span class="o">=</span><span class="n">SingPts</span><span class="p">,</span> <span class="n">LSpan_R</span><span class="o">=</span><span class="n">LSpan_R</span><span class="p">,</span> <span class="n">LSpan_Theta</span><span class="o">=</span><span class="n">LSpan_Theta</span><span class="p">,</span> <span class="n">LSpan_Z</span><span class="o">=</span><span class="n">LSpan_Z</span><span class="p">,</span> <span class="n">DR</span><span class="o">=</span><span class="n">DRY</span><span class="p">,</span> <span class="n">DTheta</span><span class="o">=</span><span class="n">DXTheta</span><span class="p">,</span> <span class="n">DZ</span><span class="o">=</span><span class="n">DZ</span><span class="p">,</span>
                        <span class="n">VType</span><span class="o">=</span><span class="n">GD</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">Type</span><span class="p">,</span> <span class="n">Proj</span><span class="o">=</span><span class="n">Proj</span><span class="p">,</span> <span class="n">ReturnPts</span><span class="o">=</span><span class="k">True</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">GD</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">Type</span><span class="o">==</span><span class="s">&#39;Lin&#39;</span><span class="p">:</span>
                <span class="n">LSpan_X</span> <span class="o">=</span> <span class="p">[</span><span class="n">dd</span><span class="o">.</span><span class="n">_Span_X</span> <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">LD</span><span class="p">]</span>
                <span class="n">LSpan_Y</span> <span class="o">=</span> <span class="p">[</span><span class="n">dd</span><span class="o">.</span><span class="n">_Span_Y</span> <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">LD</span><span class="p">]</span>
                <span class="n">XIgn</span><span class="p">,</span> <span class="n">X1</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">NIgn</span><span class="p">,</span> <span class="n">NX1</span><span class="p">,</span> <span class="n">NZ</span><span class="p">,</span> <span class="n">Pts</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">_tfg_c</span><span class="o">.</span><span class="n">_get_CrossHorMesh</span><span class="p">(</span><span class="n">SingPoints</span><span class="o">=</span><span class="n">SingPts</span><span class="p">,</span> <span class="n">LSpan_X</span><span class="o">=</span><span class="n">LSpan_X</span><span class="p">,</span> <span class="n">LSpan_Y</span><span class="o">=</span><span class="n">LSpan_Y</span><span class="p">,</span> <span class="n">LSpan_Z</span><span class="o">=</span><span class="n">LSpan_Z</span><span class="p">,</span> <span class="n">DX</span><span class="o">=</span><span class="n">DXTheta</span><span class="p">,</span> <span class="n">DY</span><span class="o">=</span><span class="n">DRY</span><span class="p">,</span> <span class="n">DZ</span><span class="o">=</span><span class="n">DZ</span><span class="p">,</span> <span class="n">VType</span><span class="o">=</span><span class="n">GD</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">Type</span><span class="p">,</span> <span class="n">Proj</span><span class="o">=</span><span class="n">Proj</span><span class="p">,</span> <span class="n">ReturnPts</span><span class="o">=</span><span class="k">True</span><span class="p">)</span>

        <span class="c"># Get the Solid angle (itself, or Int or Max)</span>
        <span class="n">SA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nD</span><span class="p">,</span><span class="n">Pts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">Slice</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;Int&#39;</span><span class="p">,</span><span class="s">&#39;Max&#39;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nD</span><span class="p">):</span>
                <span class="n">FF</span> <span class="o">=</span> <span class="n">LD</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">_get_SAngIntMax</span><span class="p">(</span><span class="n">Proj</span><span class="o">=</span><span class="n">Proj</span><span class="p">,</span> <span class="n">SAng</span><span class="o">=</span><span class="n">Slice</span><span class="p">)</span>
                <span class="n">SA</span><span class="p">[</span><span class="n">ii</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">FF</span><span class="p">(</span><span class="n">Pts</span><span class="p">,</span> <span class="n">In</span><span class="o">=</span><span class="n">out</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">SA</span><span class="p">[</span><span class="n">ii</span><span class="p">,:]</span><span class="o">&lt;</span><span class="mf">0.</span><span class="p">):</span>
                    <span class="nb">print</span> <span class="s">&quot;    SAngNb : &quot;</span><span class="p">,</span> <span class="n">LD</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="s">&quot; has negative SAng values !&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">Proj</span><span class="o">==</span><span class="s">&#39;Hor&#39;</span><span class="p">:</span>
                <span class="n">Span</span> <span class="o">=</span> <span class="p">[</span><span class="nb">min</span><span class="p">([</span><span class="n">oo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">oo</span> <span class="ow">in</span> <span class="n">LSpan_Z</span><span class="p">]),</span> <span class="nb">max</span><span class="p">([</span><span class="n">oo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">oo</span> <span class="ow">in</span> <span class="n">LSpan_Z</span><span class="p">])]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Span</span> <span class="o">=</span> <span class="p">[</span><span class="nb">min</span><span class="p">([</span><span class="n">oo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">oo</span> <span class="ow">in</span> <span class="n">LSpan_Theta</span><span class="p">]),</span> <span class="nb">max</span><span class="p">([</span><span class="n">oo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">oo</span> <span class="ow">in</span> <span class="n">LSpan_Theta</span><span class="p">])]</span> <span class="k">if</span> <span class="n">GD</span><span class="o">.</span><span class="n">Ves</span><span class="o">.</span><span class="n">Type</span><span class="o">==</span><span class="s">&#39;Tor&#39;</span> <span class="k">else</span> <span class="p">[</span><span class="nb">min</span><span class="p">([</span><span class="n">oo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">oo</span> <span class="ow">in</span> <span class="n">LSpan_X</span><span class="p">]),</span> <span class="nb">max</span><span class="p">([</span><span class="n">oo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">oo</span> <span class="ow">in</span> <span class="n">LSpan_X</span><span class="p">])]</span>
            <span class="k">assert</span> <span class="n">Slice</span><span class="o">&gt;=</span><span class="n">Span</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">Slice</span><span class="o">&lt;=</span><span class="n">Span</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&quot;Arg Slice is outside of the interval were non-zeros values can be found !&quot;</span>
            <span class="n">Ptsint</span> <span class="o">=</span> <span class="n">_tfg_gg</span><span class="o">.</span><span class="n">CoordShift</span><span class="p">(</span><span class="n">Pts</span><span class="p">,</span> <span class="n">In</span><span class="o">=</span><span class="n">out</span><span class="p">,</span> <span class="n">Out</span><span class="o">=</span><span class="s">&#39;(X,Y,Z)&#39;</span><span class="p">,</span> <span class="n">CrossRef</span><span class="o">=</span><span class="n">Slice</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nD</span><span class="p">):</span>
                <span class="n">SA</span><span class="p">[</span><span class="n">ii</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">LD</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">calc_SAngVect</span><span class="p">(</span><span class="n">Ptsint</span><span class="p">,</span> <span class="n">In</span><span class="o">=</span><span class="s">&#39;(X,Y,Z)&#39;</span><span class="p">,</span> <span class="n">Colis</span><span class="o">=</span><span class="n">Colis</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="k">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">SA</span><span class="p">[</span><span class="n">ii</span><span class="p">,:]</span><span class="o">&lt;</span><span class="mf">0.</span><span class="p">):</span>
                    <span class="nb">print</span> <span class="s">&quot;    SAngNb : &quot;</span><span class="p">,</span> <span class="n">LD</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="s">&quot; has negative SAng values !&quot;</span>
        <span class="n">Nb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">SA</span><span class="o">&gt;</span><span class="mf">0.</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">SA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">SA</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">SA</span><span class="p">,</span> <span class="n">Nb</span><span class="p">,</span> <span class="n">Pts</span>




























<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">###############################################################################</span>
<span class="sd">###############################################################################</span>
<span class="sd">                   Special high-level functions</span>
<span class="sd">###############################################################################</span>
<span class="sd">&quot;&quot;&quot;</span>



<span class="k">def</span> <span class="nf">_Calc_Resolution</span><span class="p">(</span><span class="n">GLD</span><span class="p">,</span> <span class="n">Pts</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">CrossMesh</span><span class="o">=</span><span class="p">[</span><span class="mf">0.01</span><span class="p">,</span><span class="mf">0.01</span><span class="p">],</span> <span class="n">CrossMeshMode</span><span class="o">=</span><span class="s">&#39;abs&#39;</span><span class="p">,</span> <span class="n">Mode</span><span class="o">=</span><span class="s">&#39;Iso&#39;</span><span class="p">,</span> <span class="n">Amp</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">Deg</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">Thres</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">ThresMode</span><span class="o">=</span><span class="s">&#39;rel&#39;</span><span class="p">,</span> <span class="n">ThresMin</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
                    <span class="n">IntResCross</span><span class="o">=</span><span class="p">[</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">0.1</span><span class="p">],</span> <span class="n">IntResCrossMode</span><span class="o">=</span><span class="s">&#39;rel&#39;</span><span class="p">,</span> <span class="n">IntResLong</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">IntResLongMode</span><span class="o">=</span><span class="s">&#39;rel&#39;</span><span class="p">,</span>
                    <span class="n">Eq</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">PlotDetail</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">Cdict</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetConed</span><span class="p">),</span> <span class="n">Ntt</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                    <span class="n">ind</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Val</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Crit</span><span class="o">=</span><span class="s">&#39;Name&#39;</span><span class="p">,</span> <span class="n">PreExp</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">PostExp</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Log</span><span class="o">=</span><span class="s">&#39;any&#39;</span><span class="p">,</span> <span class="n">InOut</span><span class="o">=</span><span class="s">&#39;In&#39;</span><span class="p">,</span> <span class="n">SaveName</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="s">&#39;./&#39;</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="k">True</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">Test</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">GLD</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">list</span><span class="p">,</span><span class="n">Detect</span><span class="p">,</span><span class="n">GDetect</span><span class="p">],</span> <span class="s">&quot;Arg GLD must be a Detect or list of such or a GDetect instance !&quot;</span>
        <span class="k">assert</span> <span class="n">Pts</span> <span class="ow">is</span> <span class="k">None</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">Pts</span><span class="p">,</span><span class="s">&#39;__iter__&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">Pts</span><span class="p">)</span><span class="o">.</span><span class="n">ndim</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]),</span> <span class="s">&quot;Arg Pts must be an iterable with Points coordinates !&quot;</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">CrossMesh</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;Arg CrossMesh must be a len()==2 iterable with the desired mesh resolution in the two directions !&quot;</span>
        <span class="k">assert</span> <span class="n">CrossMeshMode</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;abs&#39;</span><span class="p">,</span><span class="s">&#39;rel&#39;</span><span class="p">],</span> <span class="s">&quot;Arg CrossMeshMode must be in [&#39;abs&#39;,&#39;rel&#39;] !&quot;</span>
        <span class="k">assert</span> <span class="n">Mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;Iso&#39;</span><span class="p">,</span><span class="s">&#39;HorVert&#39;</span><span class="p">,</span><span class="s">&#39;Equi&#39;</span><span class="p">],</span> <span class="s">&quot;Arg Mode must be in [&#39;Iso&#39;,&#39;HorVert&#39;,&#39;Equi&#39;] !&quot;</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">Amp</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">float</span><span class="p">,</span> <span class="s">&quot;Arg Amp must be a float (amplitude of the emissivity) !&quot;</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">Deg</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">,</span> <span class="s">&quot;Arg Deg must be a int (degree of the bivariate b-splines) !&quot;</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">steps</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">float</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">steps</span><span class="p">,</span><span class="s">&#39;__iter__&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">steps</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">),</span> <span class="s">&quot;Arg steps must be a float or an iterable of 2 floats (incremental increase of emissivity size, in absolute value, meters or rad) !&quot;</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">Thres</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">float</span> <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">Thres</span><span class="p">,</span><span class="s">&#39;__iter__&#39;</span><span class="p">),</span> <span class="s">&quot;Arg Thres must be a float or an iterable (fraction of the initial signal above which a change can be considered visible) !&quot;</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">IntResCross</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;Arg IntResCross must be an iterable of len()==2 with absolute resolution to be used for signal integration ([DRY,DZ]) !&quot;</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">IntResLong</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">float</span><span class="p">,</span> <span class="s">&quot;Arg IntResLong must be a float with the absolute resolution to be used for signal integration (DXTheta) !&quot;</span>
        <span class="k">assert</span> <span class="n">Eq</span> <span class="ow">is</span> <span class="k">None</span> <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">Eq</span><span class="p">,</span><span class="s">&#39;__call__&#39;</span><span class="p">),</span> <span class="s">&quot;Arg Eq must be None or a callable function (delivering etheta tangent to flux surface for each point in cross-section) !&quot;</span>

    <span class="c"># Convert to list of Detect, with common legend if GDetect</span>
    <span class="n">GLD</span><span class="p">,</span> <span class="n">Leg</span><span class="p">,</span> <span class="n">LOSRef</span> <span class="o">=</span> <span class="n">_tfg_p</span><span class="o">.</span><span class="n">_get_LD_Leg_LOSRef</span><span class="p">(</span><span class="n">GLD</span><span class="p">,</span> <span class="n">Leg</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">LOSRef</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">ind</span><span class="o">=</span><span class="n">ind</span><span class="p">,</span> <span class="n">Val</span><span class="o">=</span><span class="n">Val</span><span class="p">,</span> <span class="n">Crit</span><span class="o">=</span><span class="n">Crit</span><span class="p">,</span> <span class="n">PreExp</span><span class="o">=</span><span class="n">PreExp</span><span class="p">,</span> <span class="n">PostExp</span><span class="o">=</span><span class="n">PostExp</span><span class="p">,</span> <span class="n">Log</span><span class="o">=</span><span class="n">Log</span><span class="p">,</span> <span class="n">InOut</span><span class="o">=</span><span class="n">InOut</span><span class="p">)</span>
    <span class="n">ND</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">GLD</span><span class="p">)</span>
    <span class="n">Ves</span> <span class="o">=</span> <span class="n">GLD</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Ves</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">Thres</span><span class="p">,</span><span class="s">&#39;__iter__&#39;</span><span class="p">):</span>
        <span class="n">Thres</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">Thres</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">Thres</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">Thres</span><span class="o">.</span><span class="n">size</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">GLD</span><span class="p">),</span> <span class="s">&quot;If an iterable, arg Thres must be the same len() as the input list of Detect !&quot;</span>

    <span class="n">DXTheta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dd</span><span class="o">.</span><span class="n">_Span_Theta</span> <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">GLD</span><span class="p">])</span> <span class="k">if</span> <span class="n">Ves</span><span class="o">.</span><span class="n">Type</span><span class="o">==</span><span class="s">&#39;Tor&#39;</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dd</span><span class="o">.</span><span class="n">_Span_X</span> <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">GLD</span><span class="p">])</span>
    <span class="n">DXTheta</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">DXTheta</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">DXTheta</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])]</span>

    <span class="c"># Build name if save</span>
    <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">SaveName</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="n">Thresstr</span> <span class="o">=</span> <span class="s">&quot;Thres{0:02.0f}-{1:02.0f}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mf">100.</span><span class="o">*</span><span class="n">ThresMin</span><span class="p">,</span><span class="mf">100.</span><span class="o">*</span><span class="n">Thres</span><span class="p">)</span>
            <span class="n">Thresstr</span> <span class="o">=</span> <span class="n">Thresstr</span><span class="o">+</span><span class="s">&quot;Rel&quot;</span> <span class="k">if</span> <span class="n">ThresMode</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="s">&#39;rel&#39;</span> <span class="k">else</span> <span class="n">Thresstr</span><span class="o">+</span><span class="s">&quot;Abs&quot;</span>
            <span class="n">Stepstr</span> <span class="o">=</span> <span class="s">&quot;Step{0:03.1f}mm&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mf">1000.</span><span class="o">*</span><span class="n">steps</span><span class="p">)</span>
            <span class="n">Intstr</span> <span class="o">=</span> <span class="s">&quot;IntCross{0:02.0f}-{1:02.0f}mm&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mf">1000.</span><span class="o">*</span><span class="n">IntResCross</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mf">1000.</span><span class="o">*</span><span class="n">IntResCross</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">if</span> <span class="n">IntResCrossMode</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="s">&#39;abs&#39;</span> <span class="k">else</span> <span class="s">&quot;IntCross{0:4.2f}-{1:4.2f}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">IntResCross</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">IntResCross</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">Intstr</span> <span class="o">=</span> <span class="n">Intstr</span><span class="o">+</span><span class="s">&quot;_IntLong{0:02.0f}mm&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mf">1000.</span><span class="o">*</span><span class="n">IntResLong</span><span class="p">)</span> <span class="k">if</span> <span class="n">IntResLongMode</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="s">&#39;abs&#39;</span> <span class="k">else</span> <span class="n">Intstr</span><span class="o">+</span><span class="s">&quot;_IntLong{0:4.2f}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">IntResLong</span><span class="p">)</span>
            <span class="n">SaveName</span> <span class="o">=</span> <span class="s">&#39;Res_&#39;</span><span class="o">+</span><span class="n">GLD</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Exp</span><span class="o">+</span><span class="s">&#39;_Diag&#39;</span><span class="o">+</span><span class="n">GLD</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Diag</span><span class="o">+</span><span class="s">&#39;_&#39;</span><span class="o">+</span><span class="n">Mode</span><span class="o">+</span><span class="s">&#39;_&#39;</span><span class="o">+</span><span class="n">Thresstr</span><span class="o">+</span><span class="s">&#39;_&#39;</span><span class="o">+</span><span class="n">Stepstr</span><span class="o">+</span><span class="s">&#39;_&#39;</span><span class="o">+</span><span class="n">Intstr</span>
            <span class="nb">print</span> <span class="n">SaveName</span>

    <span class="c"># Prepare mesh</span>
    <span class="k">if</span> <span class="n">Pts</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
        <span class="n">Pts</span><span class="p">,</span> <span class="n">X1</span><span class="p">,</span> <span class="n">X2</span><span class="p">,</span> <span class="n">NumX1</span><span class="p">,</span> <span class="n">NumX2</span> <span class="o">=</span> <span class="n">Ves</span><span class="o">.</span><span class="n">get_MeshCrossSection</span><span class="p">(</span><span class="n">CrossMesh</span><span class="o">=</span><span class="n">CrossMesh</span><span class="p">,</span> <span class="n">CrossMeshMode</span><span class="o">=</span><span class="n">CrossMeshMode</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="k">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">Pts</span><span class="p">)</span>
        <span class="n">Pts</span> <span class="o">=</span> <span class="n">Pts</span> <span class="k">if</span> <span class="n">Pts</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">2</span> <span class="k">else</span> <span class="n">Pts</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">Pts</span><span class="o">.</span><span class="n">size</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">assert</span> <span class="n">Pts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;Arg Pts must be provided in (R,Z) or (Y,Z) coordinates (for Ves.Type=Tor or Ves.Type=Lin) !&quot;</span>
    <span class="n">In</span> <span class="o">=</span> <span class="s">&#39;(R,Z)&#39;</span> <span class="k">if</span> <span class="n">Ves</span><span class="o">.</span><span class="n">Type</span><span class="o">==</span><span class="s">&#39;Tor&#39;</span> <span class="k">else</span> <span class="s">&#39;(Y,Z)&#39;</span>

    <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">dd</span><span class="o">.</span><span class="n">isInside</span><span class="p">(</span><span class="n">Pts</span><span class="p">,</span> <span class="n">In</span><span class="o">=</span><span class="n">In</span><span class="p">)</span> <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">GLD</span><span class="p">])</span>

    <span class="c"># Prepare THR fraction</span>
    <span class="n">Thres</span> <span class="o">=</span> <span class="n">Thres</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">ND</span><span class="p">,),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">Thres</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">float</span> <span class="k">else</span> <span class="n">Thres</span>
    <span class="k">if</span> <span class="n">ThresMode</span><span class="o">==</span><span class="s">&#39;abs&#39;</span><span class="p">:</span>
        <span class="n">THR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">Thres</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c"># Restrict to points initially detected by at least one detector</span>
        <span class="n">Pts</span> <span class="o">=</span> <span class="n">Pts</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)]</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">ind</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)]</span>
    <span class="n">NP</span> <span class="o">=</span> <span class="n">Pts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">LDetLim</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">Mode</span><span class="o">==</span><span class="s">&#39;Iso&#39;</span><span class="p">:</span>
        <span class="n">tt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="n">Ntt</span><span class="p">)</span>
        <span class="n">Res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">NP</span><span class="p">,))</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">NP</span><span class="p">):</span>
            <span class="nb">print</span> <span class="s">&quot;    Resolution : Point&quot;</span><span class="p">,</span> <span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;/&quot;</span><span class="p">,</span> <span class="n">NP</span>
            <span class="n">size</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="n">InitSigs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ND</span><span class="p">,),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">ind</span><span class="p">[:,</span><span class="n">ii</span><span class="p">]):</span>
                <span class="n">Ind</span> <span class="o">=</span> <span class="n">ind</span><span class="p">[:,</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">pp</span><span class="p">,</span> <span class="n">Emiss</span><span class="p">,</span> <span class="n">dV</span> <span class="o">=</span> <span class="n">_Resolution_PpsEmissdV_Iso</span><span class="p">(</span><span class="n">Pts</span><span class="p">[:,</span><span class="n">ii</span><span class="p">],</span> <span class="n">DXTheta</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">Deg</span><span class="o">=</span><span class="n">Deg</span><span class="p">,</span> <span class="n">Amp</span><span class="o">=</span><span class="n">Amp</span><span class="p">,</span> <span class="n">IntResCross</span><span class="o">=</span><span class="n">IntResCross</span><span class="p">,</span> <span class="n">IntResCrossMode</span><span class="o">=</span><span class="n">IntResCrossMode</span><span class="p">,</span>
                                                           <span class="n">IntResLong</span><span class="o">=</span><span class="n">IntResLong</span><span class="p">,</span> <span class="n">IntResLongMode</span><span class="o">=</span><span class="n">IntResLongMode</span><span class="p">,</span> <span class="n">VType</span><span class="o">=</span><span class="n">Ves</span><span class="o">.</span><span class="n">Type</span><span class="p">)</span>
                <span class="n">InitSigs</span><span class="p">[</span><span class="n">ind</span><span class="p">[:,</span><span class="n">ii</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Emiss</span> <span class="o">*</span> <span class="n">dV</span> <span class="o">*</span> <span class="n">GLD</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span><span class="o">.</span><span class="n">calc_SAngVect</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="n">In</span><span class="o">=</span><span class="s">&#39;(X,Y,Z)&#39;</span><span class="p">,</span> <span class="n">Colis</span><span class="o">=</span><span class="k">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="n">Ind</span><span class="p">])</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">InitSigs</span><span class="p">[</span><span class="n">ind</span><span class="p">[:,</span><span class="n">ii</span><span class="p">]]</span><span class="o">&gt;</span><span class="mf">0.</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">ThresMode</span><span class="o">==</span><span class="s">&#39;rel&#39;</span><span class="p">:</span>
                    <span class="n">THR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">Thres</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">InitSigs</span><span class="p">[</span><span class="n">ind</span><span class="p">[:,</span><span class="n">ii</span><span class="p">]])</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">ND</span><span class="p">,))</span>
                    <span class="n">THR</span><span class="p">[</span><span class="n">ind</span><span class="p">[:,</span><span class="n">ii</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Thres</span><span class="p">[</span><span class="n">ind</span><span class="p">[:,</span><span class="n">ii</span><span class="p">]]</span><span class="o">*</span><span class="n">InitSigs</span><span class="p">[</span><span class="n">ind</span><span class="p">[:,</span><span class="n">ii</span><span class="p">]]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">ThresMin</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
                        <span class="n">THRmin</span> <span class="o">=</span> <span class="n">ThresMin</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">InitSigs</span><span class="p">[</span><span class="n">ind</span><span class="p">[:,</span><span class="n">ii</span><span class="p">]])</span>
                        <span class="n">THR</span><span class="p">[</span><span class="n">THR</span><span class="o">&lt;</span><span class="n">THRmin</span><span class="p">]</span> <span class="o">=</span> <span class="n">THRmin</span>

            <span class="n">Lsigs</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">InitSigs</span><span class="p">)]</span>
            <span class="n">Lsize</span> <span class="o">=</span> <span class="p">[</span><span class="n">size</span><span class="p">]</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Lsigs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">InitSigs</span><span class="p">)</span><span class="o">&gt;</span><span class="n">THR</span><span class="p">):</span>
                <span class="n">Lsize</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Lsize</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">steps</span><span class="p">)</span>
                <span class="n">pp</span><span class="p">,</span> <span class="n">Emiss</span><span class="p">,</span> <span class="n">dV</span> <span class="o">=</span> <span class="n">_Resolution_PpsEmissdV_Iso</span><span class="p">(</span><span class="n">Pts</span><span class="p">[:,</span><span class="n">ii</span><span class="p">],</span> <span class="n">DXTheta</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">Lsize</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">Deg</span><span class="o">=</span><span class="n">Deg</span><span class="p">,</span> <span class="n">Amp</span><span class="o">=</span><span class="n">Amp</span><span class="p">,</span> <span class="n">IntResCross</span><span class="o">=</span><span class="n">IntResCross</span><span class="p">,</span> <span class="n">IntResCrossMode</span><span class="o">=</span><span class="n">IntResCrossMode</span><span class="p">,</span>
                                                           <span class="n">IntResLong</span><span class="o">=</span><span class="n">IntResLong</span><span class="p">,</span> <span class="n">IntResLongMode</span><span class="o">=</span><span class="n">IntResLongMode</span><span class="p">,</span> <span class="n">VType</span><span class="o">=</span><span class="n">Ves</span><span class="o">.</span><span class="n">Type</span><span class="p">)</span>
                <span class="n">Lsigs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Emiss</span> <span class="o">*</span> <span class="n">dV</span> <span class="o">*</span> <span class="n">dd</span><span class="o">.</span><span class="n">calc_SAngVect</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="n">In</span><span class="o">=</span><span class="s">&#39;(X,Y,Z)&#39;</span><span class="p">,</span> <span class="n">Colis</span><span class="o">=</span><span class="k">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">GLD</span><span class="p">]))</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Lsize</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="c">#print &quot;    ...Refining...&quot;</span>
                <span class="n">Lsigs</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">InitSigs</span><span class="p">)]</span>
                <span class="n">Lsize</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">]</span>
                <span class="n">stepsbis</span> <span class="o">=</span> <span class="n">steps</span><span class="o">/</span><span class="mf">5.</span>
                <span class="k">while</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Lsigs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">InitSigs</span><span class="p">)</span><span class="o">&gt;</span><span class="n">THR</span><span class="p">):</span>
                    <span class="n">Lsize</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Lsize</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">stepsbis</span><span class="p">)</span>
                    <span class="n">pp</span><span class="p">,</span> <span class="n">Emiss</span><span class="p">,</span> <span class="n">dV</span> <span class="o">=</span> <span class="n">_Resolution_PpsEmissdV_Iso</span><span class="p">(</span><span class="n">Pts</span><span class="p">[:,</span><span class="n">ii</span><span class="p">],</span> <span class="n">DXTheta</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">Lsize</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">Deg</span><span class="o">=</span><span class="n">Deg</span><span class="p">,</span> <span class="n">Amp</span><span class="o">=</span><span class="n">Amp</span><span class="p">,</span> <span class="n">IntResCross</span><span class="o">=</span><span class="n">IntResCross</span><span class="p">,</span> <span class="n">IntResCrossMode</span><span class="o">=</span><span class="n">IntResCrossMode</span><span class="p">,</span>
                                                               <span class="n">IntResLong</span><span class="o">=</span><span class="n">IntResLong</span><span class="p">,</span> <span class="n">IntResLongMode</span><span class="o">=</span><span class="n">IntResLongMode</span><span class="p">,</span> <span class="n">VType</span><span class="o">=</span><span class="n">Ves</span><span class="o">.</span><span class="n">Type</span><span class="p">)</span>
                    <span class="n">Lsigs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Emiss</span> <span class="o">*</span> <span class="n">dV</span> <span class="o">*</span> <span class="n">dd</span><span class="o">.</span><span class="n">calc_SAngVect</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="n">In</span><span class="o">=</span><span class="s">&#39;(X,Y,Z)&#39;</span><span class="p">,</span> <span class="n">Colis</span><span class="o">=</span><span class="k">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">GLD</span><span class="p">]))</span>

            <span class="c"># Identify the Detect that passed the threshold and interpolate an accurate value of Res from Lsize</span>
            <span class="n">indDet</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Lsigs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">InitSigs</span><span class="p">)</span><span class="o">&gt;</span><span class="n">THR</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">ss</span> <span class="o">=</span> <span class="p">[</span><span class="n">Lsigs</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="n">indDet</span><span class="p">],</span><span class="n">Lsigs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">indDet</span><span class="p">]]</span>
            <span class="n">crit</span> <span class="o">=</span> <span class="n">InitSigs</span><span class="p">[</span><span class="n">indDet</span><span class="p">]</span><span class="o">+</span><span class="n">THR</span><span class="p">[</span><span class="n">indDet</span><span class="p">]</span> <span class="k">if</span> <span class="n">Lsigs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">indDet</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">InitSigs</span><span class="p">[</span><span class="n">indDet</span><span class="p">]</span><span class="o">+</span><span class="n">THR</span><span class="p">[</span><span class="n">indDet</span><span class="p">]</span> <span class="k">else</span> <span class="n">InitSigs</span><span class="p">[</span><span class="n">indDet</span><span class="p">]</span><span class="o">-</span><span class="n">THR</span><span class="p">[</span><span class="n">indDet</span><span class="p">]</span>
            <span class="n">Res</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">Lsize</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]))</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">ss</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">crit</span><span class="o">-</span><span class="n">Lsigs</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="n">indDet</span><span class="p">])</span> <span class="o">+</span> <span class="n">Lsize</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">LDetLim</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">GLD</span><span class="p">[</span><span class="n">indDet</span><span class="p">]</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">PlotDetail</span><span class="p">:</span>
                <span class="nb">print</span> <span class="s">&#39;InitSigs[ind[:,ii]]&#39;</span><span class="p">,</span> <span class="n">InitSigs</span><span class="p">[</span><span class="n">ind</span><span class="p">[:,</span><span class="n">ii</span><span class="p">]]</span>
                <span class="nb">print</span> <span class="s">&#39;THR[ind[:,ii]]&#39;</span><span class="p">,</span> <span class="n">THR</span><span class="p">[</span><span class="n">ind</span><span class="p">[:,</span><span class="n">ii</span><span class="p">]]</span>
                <span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">ax3</span> <span class="o">=</span> <span class="n">_tfg_p</span><span class="o">.</span><span class="n">_Resolution_PlotDetails</span><span class="p">(</span><span class="n">GLD</span><span class="p">,</span> <span class="n">ND</span><span class="p">,</span> <span class="n">Pts</span><span class="p">[:,</span><span class="n">ii</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Lsize</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">Lsigs</span><span class="p">),</span> <span class="n">InitSigs</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">Lsigs</span><span class="p">),</span> <span class="n">indDet</span><span class="p">,</span> <span class="n">Ind</span><span class="p">,</span> <span class="n">Res</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">Ves</span><span class="p">,</span> <span class="n">THR</span><span class="p">,</span> <span class="n">tt</span><span class="o">=</span><span class="n">tt</span><span class="p">,</span> <span class="n">Cdict</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">Cdict</span><span class="p">),</span> <span class="n">draw</span><span class="o">=</span><span class="k">True</span><span class="p">)</span>
            <span class="c">#print &quot;    &quot;, GLD[indDet].Id.Name, Res[ii]</span>

        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="n">SavePath</span><span class="o">+</span><span class="n">SaveName</span><span class="o">+</span><span class="s">&#39;.npz&#39;</span><span class="p">,</span> <span class="n">Res</span><span class="o">=</span><span class="n">Res</span><span class="p">,</span> <span class="n">LDetLim</span><span class="o">=</span><span class="n">LDetLim</span><span class="p">,</span> <span class="n">Pts</span><span class="o">=</span><span class="n">Pts</span><span class="p">,</span> <span class="n">Mode</span><span class="o">=</span><span class="n">Mode</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="n">steps</span><span class="p">,</span> <span class="n">Thres</span><span class="o">=</span><span class="n">Thres</span><span class="p">,</span> <span class="n">ThresMode</span><span class="o">=</span><span class="n">ThresMode</span><span class="p">,</span> <span class="n">ThresMin</span><span class="o">=</span><span class="n">ThresMin</span><span class="p">,</span>
                     <span class="n">IntResCross</span><span class="o">=</span><span class="n">IntResCross</span><span class="p">,</span> <span class="n">IntResCrossMode</span><span class="o">=</span><span class="n">IntResCrossMode</span><span class="p">,</span> <span class="n">IntResLong</span><span class="o">=</span><span class="n">IntResLong</span><span class="p">,</span> <span class="n">IntResLongMode</span><span class="o">=</span><span class="n">IntResLongMode</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Res</span><span class="p">,</span> <span class="n">Pts</span><span class="p">,</span> <span class="n">LDetLim</span><span class="p">,</span> <span class="n">Mode</span><span class="p">,</span> <span class="n">steps</span><span class="p">,</span> <span class="n">Thres</span><span class="p">,</span> <span class="n">ThresMode</span><span class="p">,</span> <span class="n">ThresMin</span><span class="p">,</span> <span class="n">IntResCross</span><span class="p">,</span> <span class="n">IntResCrossMode</span><span class="p">,</span> <span class="n">IntResLong</span><span class="p">,</span> <span class="n">IntResLongMode</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Res0</span><span class="p">,</span> <span class="n">Res1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">NP</span><span class="p">,)),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">NP</span><span class="p">,))</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">NP</span><span class="p">):</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="p">[</span><span class="n">dd</span><span class="o">.</span><span class="n">isInside</span><span class="p">(</span><span class="n">Pts</span><span class="p">[:,</span><span class="n">ii</span><span class="p">:</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">In</span><span class="o">=</span><span class="n">In</span><span class="p">)</span> <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">GLD</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="n">SavePath</span><span class="o">+</span><span class="n">SaveName</span><span class="o">+</span><span class="s">&#39;.npz&#39;</span><span class="p">,</span> <span class="n">Res0</span><span class="o">=</span><span class="n">Res0</span><span class="p">,</span> <span class="n">Res1</span><span class="o">=</span><span class="n">Res1</span><span class="p">,</span> <span class="n">LDetLim</span><span class="o">=</span><span class="n">LDetLim</span><span class="p">,</span> <span class="n">Pts</span><span class="o">=</span><span class="n">Pts</span><span class="p">,</span> <span class="n">Mode</span><span class="o">=</span><span class="n">Mode</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="n">steps</span><span class="p">,</span> <span class="n">Thres</span><span class="o">=</span><span class="n">Thres</span><span class="p">,</span> <span class="n">ThresMode</span><span class="o">=</span><span class="n">ThresMode</span><span class="p">,</span> <span class="n">ThresMin</span><span class="o">=</span><span class="n">ThresMin</span><span class="p">,</span>
                     <span class="n">IntResCross</span><span class="o">=</span><span class="n">IntResCross</span><span class="p">,</span> <span class="n">IntResCrossMode</span><span class="o">=</span><span class="n">IntResCrossMode</span><span class="p">,</span> <span class="n">IntResLong</span><span class="o">=</span><span class="n">IntResLong</span><span class="p">,</span> <span class="n">IntResLongMode</span><span class="o">=</span><span class="n">IntResLongMode</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">Res0</span><span class="p">,</span><span class="n">Res1</span><span class="p">],</span> <span class="n">Pts</span><span class="p">,</span> <span class="n">LDetLim</span><span class="p">,</span> <span class="n">Mode</span><span class="p">,</span> <span class="n">steps</span><span class="p">,</span> <span class="n">Thres</span><span class="p">,</span> <span class="n">ThresMode</span><span class="p">,</span> <span class="n">ThresMin</span><span class="p">,</span> <span class="n">IntResCross</span><span class="p">,</span> <span class="n">IntResCrossMode</span><span class="p">,</span> <span class="n">IntResLong</span><span class="p">,</span> <span class="n">IntResLongMode</span>



<span class="k">def</span> <span class="nf">_Resolution_PpsEmissdV_Iso</span><span class="p">(</span><span class="n">Pt</span><span class="p">,</span> <span class="n">DXTheta</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">Deg</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">Amp</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">IntResCross</span><span class="o">=</span><span class="p">[</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">0.1</span><span class="p">],</span> <span class="n">IntResCrossMode</span><span class="o">=</span><span class="s">&#39;rel&#39;</span><span class="p">,</span> <span class="n">IntResLong</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">IntResLongMode</span><span class="o">=</span><span class="s">&#39;rel&#39;</span><span class="p">,</span> <span class="n">VType</span><span class="o">=</span><span class="s">&#39;Tor&#39;</span><span class="p">):</span>
    <span class="n">Nxtheta</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">DXTheta</span><span class="p">)</span><span class="o">/</span><span class="n">IntResLong</span><span class="p">)</span> <span class="k">if</span> <span class="n">IntResLongMode</span><span class="o">==</span><span class="s">&#39;abs&#39;</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">IntResLong</span><span class="p">)</span>
    <span class="n">xtheta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">DXTheta</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">DXTheta</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">Nxtheta</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">size</span><span class="o">==</span><span class="mf">0.</span><span class="p">:</span>
        <span class="n">pp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">Pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">xtheta</span><span class="p">),</span> <span class="n">Pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">xtheta</span><span class="p">),</span> <span class="n">Pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">Nxtheta</span><span class="p">,))])</span> <span class="k">if</span> <span class="n">VType</span><span class="o">==</span><span class="s">&#39;Tor&#39;</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xtheta</span><span class="p">,</span> <span class="n">Pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">Nxtheta</span><span class="p">,)),</span> <span class="n">Pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">Nxtheta</span><span class="p">,))])</span>
        <span class="n">Emiss</span> <span class="o">=</span> <span class="n">Amp</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">pp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],))</span>
        <span class="n">dV</span> <span class="o">=</span> <span class="n">IntResLong</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c"># Get Number of points, make sure it is odd (to get the center)</span>
        <span class="n">NRY</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">size</span><span class="o">/</span><span class="n">IntResCross</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span> <span class="k">if</span> <span class="n">IntResCrossMode</span><span class="o">==</span><span class="s">&#39;abs&#39;</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">IntResCross</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">NZ</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">size</span><span class="o">/</span><span class="n">IntResCross</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span> <span class="k">if</span> <span class="n">IntResCrossMode</span><span class="o">==</span><span class="s">&#39;abs&#39;</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">IntResCross</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">NRY</span> <span class="o">=</span> <span class="n">NRY</span><span class="o">+</span><span class="mi">1</span> <span class="k">if</span> <span class="n">NRY</span><span class="o">%</span><span class="mi">2</span><span class="o">==</span><span class="mi">0</span> <span class="k">else</span> <span class="n">NRY</span>
        <span class="n">NZ</span> <span class="o">=</span> <span class="n">NZ</span><span class="o">+</span><span class="mi">1</span> <span class="k">if</span> <span class="n">NZ</span><span class="o">%</span><span class="mi">2</span><span class="o">==</span><span class="mi">0</span> <span class="k">else</span> <span class="n">NZ</span>

        <span class="n">RY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">Pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">size</span><span class="p">,</span><span class="n">Pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mf">0.5</span><span class="o">*</span><span class="n">size</span><span class="p">,</span><span class="n">NRY</span><span class="p">)</span>
        <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">Pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">size</span><span class="p">,</span><span class="n">Pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mf">0.5</span><span class="o">*</span><span class="n">size</span><span class="p">,</span><span class="n">NZ</span><span class="p">)</span>
        <span class="n">RRYY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">RY</span><span class="p">,(</span><span class="n">NZ</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">ZZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">Z</span><span class="p">,(</span><span class="n">NRY</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">RRYY</span><span class="o">-</span><span class="n">Pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ZZ</span><span class="o">-</span><span class="n">Pt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">r</span><span class="o">&lt;=</span><span class="n">size</span><span class="o">/</span><span class="mf">2.</span>

        <span class="n">ds</span> <span class="o">=</span> <span class="n">IntResCross</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="p">((</span><span class="n">RRYY</span><span class="o">+</span><span class="n">IntResCross</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="p">(</span><span class="n">RRYY</span><span class="o">-</span><span class="n">IntResCross</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span> <span class="k">if</span> <span class="n">VType</span><span class="o">==</span><span class="s">&#39;Tor&#39;</span> <span class="k">else</span> <span class="n">IntResCross</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">IntResCross</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">RRYY</span><span class="o">.</span><span class="n">size</span><span class="p">,))</span>
        <span class="n">dS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">VType</span><span class="o">==</span><span class="s">&#39;Tor&#39;</span><span class="p">:</span>
            <span class="n">RRRYYY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">RRYY</span><span class="p">[</span><span class="n">ind</span><span class="p">],(</span><span class="n">Nxtheta</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">ZZZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">ZZ</span><span class="p">[</span><span class="n">ind</span><span class="p">],(</span><span class="n">Nxtheta</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">TTT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">xtheta</span><span class="p">,(</span><span class="n">ind</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">pp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">RRRYYY</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">TTT</span><span class="p">),</span> <span class="n">RRRYYY</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">TTT</span><span class="p">),</span> <span class="n">ZZZ</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">xtheta</span><span class="p">,(</span><span class="n">ind</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">RRYY</span><span class="p">[</span><span class="n">ind</span><span class="p">],(</span><span class="n">Nxtheta</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">ZZ</span><span class="p">[</span><span class="n">ind</span><span class="p">],(</span><span class="n">Nxtheta</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()])</span>
        <span class="n">dV</span> <span class="o">=</span> <span class="n">IntResLong</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="n">ind</span><span class="p">],(</span><span class="n">Nxtheta</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">Deg</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">Emiss</span> <span class="o">=</span> <span class="n">Amp</span><span class="o">/</span><span class="n">dS</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">ind</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">*</span><span class="n">Nxtheta</span><span class="p">,))</span>

    <span class="k">return</span> <span class="n">pp</span><span class="p">,</span> <span class="n">Emiss</span><span class="p">,</span> <span class="n">dV</span>




<span class="k">def</span> <span class="nf">_Plot_Resolution</span><span class="p">(</span><span class="n">GLD</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Pts</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Res</span><span class="o">=</span><span class="p">[</span><span class="mf">0.01</span><span class="p">,</span><span class="mf">0.01</span><span class="p">],</span> <span class="n">ResMode</span><span class="o">=</span><span class="s">&#39;abs&#39;</span><span class="p">,</span> <span class="n">Mode</span><span class="o">=</span><span class="s">&#39;Iso&#39;</span><span class="p">,</span> <span class="n">Amp</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">Deg</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">Thres</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">ThresMode</span><span class="o">=</span><span class="s">&#39;rel&#39;</span><span class="p">,</span> <span class="n">ThresMin</span><span class="o">=</span><span class="k">None</span><span class="p">,</span>
                    <span class="n">IntResCross</span><span class="o">=</span><span class="p">[</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">0.1</span><span class="p">],</span> <span class="n">IntResCrossMode</span><span class="o">=</span><span class="s">&#39;rel&#39;</span><span class="p">,</span> <span class="n">IntResLong</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">IntResLongMode</span><span class="o">=</span><span class="s">&#39;rel&#39;</span><span class="p">,</span>
                    <span class="n">Eq</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Cdict</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">DetConed</span><span class="p">),</span> <span class="n">tt</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="mi">100</span><span class="p">),</span>
                    <span class="n">plotfunc</span><span class="o">=</span><span class="s">&#39;scatter&#39;</span><span class="p">,</span> <span class="n">NC</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">CDictRes</span><span class="o">=</span><span class="k">None</span><span class="p">,</span>
                    <span class="n">ind</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Val</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Crit</span><span class="o">=</span><span class="s">&#39;Name&#39;</span><span class="p">,</span> <span class="n">PreExp</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">PostExp</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">Log</span><span class="o">=</span><span class="s">&#39;any&#39;</span><span class="p">,</span> <span class="n">InOut</span><span class="o">=</span><span class="s">&#39;In&#39;</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="k">True</span><span class="p">):</span>

    <span class="n">Res</span><span class="p">,</span> <span class="n">LDetLim</span><span class="p">,</span> <span class="n">Pts</span> <span class="o">=</span> <span class="n">_Calc_Resolution</span><span class="p">(</span><span class="n">GLD</span><span class="p">,</span> <span class="n">Pts</span><span class="o">=</span><span class="n">Pts</span><span class="p">,</span> <span class="n">Res</span><span class="o">=</span><span class="n">Res</span><span class="p">,</span> <span class="n">ResMode</span><span class="o">=</span><span class="n">ResMode</span><span class="p">,</span> <span class="n">Mode</span><span class="o">=</span><span class="n">Mode</span><span class="p">,</span> <span class="n">Amp</span><span class="o">=</span><span class="n">Amp</span><span class="p">,</span> <span class="n">Deg</span><span class="o">=</span><span class="n">Deg</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="n">steps</span><span class="p">,</span> <span class="n">Thres</span><span class="o">=</span><span class="n">Thres</span><span class="p">,</span> <span class="n">ThresMode</span><span class="o">=</span><span class="n">ThresMode</span><span class="p">,</span> <span class="n">ThresMin</span><span class="o">=</span><span class="n">ThresMin</span><span class="p">,</span>
                                        <span class="n">IntResCross</span><span class="o">=</span><span class="n">IntResCross</span><span class="p">,</span> <span class="n">IntResCrossMode</span><span class="o">=</span><span class="n">IntResCrossMode</span><span class="p">,</span> <span class="n">IntResLong</span><span class="o">=</span><span class="n">IntResLong</span><span class="p">,</span> <span class="n">IntResLongMode</span><span class="o">=</span><span class="n">IntResLongMode</span><span class="p">,</span>
                                        <span class="n">Eq</span><span class="o">=</span><span class="n">Eq</span><span class="p">,</span> <span class="n">PlotDetail</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">Cdict</span><span class="o">=</span><span class="n">Cdict</span><span class="p">,</span> <span class="n">tt</span><span class="o">=</span><span class="n">tt</span><span class="p">,</span>
                                        <span class="n">ind</span><span class="o">=</span><span class="n">ind</span><span class="p">,</span> <span class="n">Val</span><span class="o">=</span><span class="n">Val</span><span class="p">,</span> <span class="n">Crit</span><span class="o">=</span><span class="n">Crit</span><span class="p">,</span> <span class="n">PreExp</span><span class="o">=</span><span class="n">PreExp</span><span class="p">,</span> <span class="n">PostExp</span><span class="o">=</span><span class="n">PostExp</span><span class="p">,</span> <span class="n">Log</span><span class="o">=</span><span class="n">Log</span><span class="p">,</span> <span class="n">InOut</span><span class="o">=</span><span class="n">InOut</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="n">Test</span><span class="p">)</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">_tfg_p</span><span class="o">.</span><span class="n">_Resolution_Plot</span><span class="p">(</span><span class="n">Pts</span><span class="p">,</span> <span class="n">Res</span><span class="p">,</span> <span class="n">GLD</span><span class="p">,</span> <span class="n">LDetLim</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">plotfunc</span><span class="o">=</span><span class="n">plotfunc</span><span class="p">,</span> <span class="n">NC</span><span class="o">=</span><span class="n">NC</span><span class="p">,</span> <span class="n">CDictRes</span><span class="o">=</span><span class="n">CDictRes</span><span class="p">,</span>
                                <span class="n">ind</span><span class="o">=</span><span class="n">ind</span><span class="p">,</span> <span class="n">Val</span><span class="o">=</span><span class="n">Val</span><span class="p">,</span> <span class="n">Crit</span><span class="o">=</span><span class="n">Crit</span><span class="p">,</span> <span class="n">PreExp</span><span class="o">=</span><span class="n">PreExp</span><span class="p">,</span> <span class="n">PostExp</span><span class="o">=</span><span class="n">PostExp</span><span class="p">,</span> <span class="n">Log</span><span class="o">=</span><span class="n">Log</span><span class="p">,</span> <span class="n">InOut</span><span class="o">=</span><span class="n">InOut</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="n">Test</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ax</span>




</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">tofu v1.1</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2016, Didier VEZINET.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.5.
    </div>
  </body>
</html>