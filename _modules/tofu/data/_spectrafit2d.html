<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>tofu.data._spectrafit2d &#8212; Tofu 1.4.9</title>
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/custom.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/gallery.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/gallery-rendered-html.css" />
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../../../_static/js/jquery-1.11.0.min.js "></script>
<script type="text/javascript" src="../../../_static/js/jquery-fix.js "></script>
<script type="text/javascript" src="../../../_static/bootstrap-3.3.7/js/bootstrap.min.js "></script>
<script type="text/javascript" src="../../../_static/bootstrap-sphinx.js "></script>

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../../index.html">
          tofu</a>
        <span class="navbar-text navbar-version pull-left"><b>1.4.9</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="../../../installation.html">Installation</a></li>
                <li><a href="../../../contributing.html">Contributing</a></li>
                <li><a href="../../../auto_examples/index.html">Gallery</a></li>
                <li><a href="../../../aboutus.html">About</a></li>
                <li><a href="../../../releases.html">Releases</a></li>
                <li><a href="../../../tofu.html">API</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">How to install tofu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing.html">A guide to contributing to tofu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../auto_examples/tutorials/tuto_plot_gallery_fusion_machines.html">A list of all different device configurations available (ITER, WEST, JET, ...)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../auto_examples/index.html">Tutorials and examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tofu_from_bash.html">Using tofu from a bash terminal</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../tofu.html">tofu package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tofu.geom.html">tofu.geom package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tofu.dumpro.html">tofu.dumpro package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tofu.data.html">tofu.data package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tofu.dust.html">tofu.dust package</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"></ul>
</li>
              
            
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">
      
  <h1>Source code for tofu.data._spectrafit2d</h1><div class="highlight"><pre>
<span></span>
<span class="c1"># Built-in</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="c1"># Common</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.optimize</span> <span class="k">as</span> <span class="nn">scpopt</span>
<span class="kn">import</span> <span class="nn">scipy.constants</span> <span class="k">as</span> <span class="nn">scpct</span>
<span class="kn">import</span> <span class="nn">scipy.sparse</span> <span class="k">as</span> <span class="nn">sparse</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">BSpline</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>


<span class="c1">#                   --------------</span>
<span class="c1">#       TO BE MOVED TO tofu.data WHEN FINISHED !!!!</span>
<span class="c1">#                   --------------</span>


<span class="n">_NPEAKMAX</span> <span class="o">=</span> <span class="mi">12</span>

<span class="c1">###########################################################</span>
<span class="c1">###########################################################</span>
<span class="c1">#</span>
<span class="c1">#           Preliminary</span>
<span class="c1">#       utility tools for 1d spectral fitting</span>
<span class="c1">#</span>
<span class="c1">###########################################################</span>
<span class="c1">###########################################################</span>


<div class="viewcode-block" id="remove_bck"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._spectrafit2d.remove_bck">[docs]</a><span class="k">def</span> <span class="nf">remove_bck</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="c1"># opt = np.polyfit(x, y, deg=0)</span>
    <span class="n">opt</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">y</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">y</span><span class="o">-</span><span class="n">opt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">opt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>


<div class="viewcode-block" id="get_peaks"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._spectrafit2d.get_peaks">[docs]</a><span class="k">def</span> <span class="nf">get_peaks</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">nmax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">nmax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nmax</span> <span class="o">=</span> <span class="n">_NPEAKMAX</span>

    <span class="c1"># Prepare</span>
    <span class="n">ybis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nmax</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">y</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nmax</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nmax</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">y</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">gauss</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span> <span class="k">return</span> <span class="n">A</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">xx</span><span class="o">-</span><span class="n">x0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">gauss_jac</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
        <span class="n">jac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">xx</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">jac</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">xx</span><span class="o">-</span><span class="n">x0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">jac</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">xx</span><span class="o">-</span><span class="n">x0</span><span class="p">)</span><span class="o">/</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">xx</span><span class="o">-</span><span class="n">x0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">jac</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">xx</span><span class="o">-</span><span class="n">x0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">sigma</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">xx</span><span class="o">-</span><span class="n">x0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">jac</span>

    <span class="n">dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

    <span class="c1"># Loop</span>
    <span class="n">nn</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">nn</span> <span class="o">&lt;</span> <span class="n">nmax</span><span class="p">:</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanargmax</span><span class="p">(</span><span class="n">ybis</span><span class="p">)</span>
        <span class="n">x00</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">ybis</span><span class="p">[</span><span class="n">ind</span><span class="p">:],</span> <span class="n">n</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mf">0.</span><span class="p">):</span>
            <span class="n">wp</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                     <span class="n">ind</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">ybis</span><span class="p">[</span><span class="n">ind</span><span class="p">:],</span><span class="n">n</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">&gt;=</span><span class="mf">0.</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wp</span> <span class="o">=</span> <span class="n">ybis</span><span class="o">.</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">ybis</span><span class="p">[:</span><span class="n">ind</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">n</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mf">0.</span><span class="p">):</span>
            <span class="n">wn</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">ybis</span><span class="p">[:</span><span class="n">ind</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">n</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">&gt;=</span><span class="mf">0.</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wn</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">width</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">wp</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="n">wn</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">width</span><span class="o">&gt;</span><span class="mf">0.</span>
        <span class="n">indl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">wn</span><span class="p">,</span> <span class="n">wp</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">indl</span><span class="o">.</span><span class="n">size</span><span class="p">,))</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">ybis</span><span class="p">[</span><span class="n">ind</span><span class="p">:</span><span class="n">wp</span><span class="o">+</span><span class="mi">1</span><span class="p">])))</span>
            <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">ybis</span><span class="p">[</span><span class="n">wn</span><span class="p">:</span><span class="n">ind</span><span class="o">+</span><span class="mi">1</span><span class="p">])))):</span>
            <span class="n">sig</span><span class="p">[</span><span class="n">indl</span> <span class="o">&lt;</span> <span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.5</span>
            <span class="n">sig</span><span class="p">[</span><span class="n">indl</span> <span class="o">&gt;</span> <span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sig</span><span class="p">[</span><span class="n">indl</span> <span class="o">&lt;</span> <span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>
            <span class="n">sig</span><span class="p">[</span><span class="n">indl</span> <span class="o">&gt;</span> <span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.5</span>
        <span class="n">p0</span> <span class="o">=</span> <span class="p">(</span><span class="n">ybis</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span> <span class="n">x00</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span><span class="c1">#,0.)</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">wn</span><span class="p">],</span> <span class="n">dx</span><span class="o">/</span><span class="mf">2.</span><span class="p">],</span>
                  <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="mf">5.</span><span class="o">*</span><span class="n">ybis</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="n">wp</span><span class="p">],</span> <span class="mf">5.</span><span class="o">*</span><span class="n">width</span><span class="p">])</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="p">(</span><span class="n">Ai</span><span class="p">,</span> <span class="n">x0i</span><span class="p">,</span> <span class="n">sigi</span><span class="p">)</span> <span class="o">=</span> <span class="n">scpopt</span><span class="o">.</span><span class="n">curve_fit</span><span class="p">(</span><span class="n">gauss</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">indl</span><span class="p">],</span> <span class="n">ybis</span><span class="p">[</span><span class="n">indl</span><span class="p">],</span>
                                               <span class="n">p0</span><span class="o">=</span><span class="n">p0</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span> <span class="n">jac</span><span class="o">=</span><span class="n">gauss_jac</span><span class="p">,</span>
                                               <span class="n">sigma</span><span class="o">=</span><span class="n">sig</span><span class="p">,</span> <span class="n">x_scale</span><span class="o">=</span><span class="s1">&#39;jac&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="kn">import</span> <span class="nn">ipdb</span>
            <span class="n">ipdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>
            <span class="k">pass</span>

        <span class="n">ybis</span> <span class="o">=</span> <span class="n">ybis</span> <span class="o">-</span> <span class="n">gauss</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Ai</span><span class="p">,</span> <span class="n">x0i</span><span class="p">,</span> <span class="n">sigi</span><span class="p">)</span>
        <span class="n">A</span><span class="p">[</span><span class="n">nn</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ai</span>
        <span class="n">x0</span><span class="p">[</span><span class="n">nn</span><span class="p">]</span> <span class="o">=</span> <span class="n">x0i</span>
        <span class="n">sigma</span><span class="p">[</span><span class="n">nn</span><span class="p">]</span> <span class="o">=</span> <span class="n">sigi</span>


        <span class="n">nn</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">A</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">sigma</span></div>

<div class="viewcode-block" id="get_p0bounds_all"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._spectrafit2d.get_p0bounds_all">[docs]</a><span class="k">def</span> <span class="nf">get_p0bounds_all</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">nmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lamb0</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="n">yflat</span><span class="p">,</span> <span class="n">bck</span> <span class="o">=</span> <span class="n">remove_bck</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">amp</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="n">get_peaks</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">yflat</span><span class="p">,</span> <span class="n">nmax</span><span class="o">=</span><span class="n">nmax</span><span class="p">)</span>
    <span class="n">lamb0</span> <span class="o">=</span> <span class="n">x0</span>
    <span class="n">nmax</span> <span class="o">=</span> <span class="n">lamb0</span><span class="o">.</span><span class="n">size</span>

    <span class="n">p0</span> <span class="o">=</span> <span class="n">amp</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmax</span><span class="p">)]</span> <span class="o">+</span> <span class="n">sigma</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">+</span> <span class="p">[</span><span class="n">bck</span><span class="p">]</span>

    <span class="n">lx</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span>
    <span class="n">Dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">lx</span><span class="p">)</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

    <span class="n">bamp</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nmax</span><span class="p">,),</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">nmax</span><span class="p">,),</span><span class="mf">3.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">y</span><span class="p">)))</span>
    <span class="n">bdlamb</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">nmax</span><span class="p">,),</span> <span class="o">-</span><span class="n">Dx</span><span class="o">/</span><span class="mf">2.</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">nmax</span><span class="p">,),</span> <span class="n">Dx</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span>
    <span class="n">bsigma</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">nmax</span><span class="p">,),</span> <span class="n">dx</span><span class="o">/</span><span class="mf">2.</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">nmax</span><span class="p">,),</span> <span class="n">Dx</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span>
    <span class="n">bbck0</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>

    <span class="n">bounds</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">bamp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bdlamb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bsigma</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bbck0</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
              <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">bamp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">bdlamb</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">bsigma</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">bbck0</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Lower bounds must be &lt; upper bounds !</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    lower :  </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    upper :  </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p0</span><span class="p">,</span> <span class="n">bounds</span><span class="p">,</span> <span class="n">lamb0</span></div>

<div class="viewcode-block" id="get_p0bounds_lambfix"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._spectrafit2d.get_p0bounds_lambfix">[docs]</a><span class="k">def</span> <span class="nf">get_p0bounds_lambfix</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">nmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lamb0</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="n">nmax</span> <span class="o">=</span> <span class="n">lamb0</span><span class="o">.</span><span class="n">size</span>
    <span class="c1"># get typical x units</span>
    <span class="n">Dx</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">nanmax</span><span class="p">()</span><span class="o">-</span><span class="n">x</span><span class="o">.</span><span class="n">nanmin</span><span class="p">()</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

    <span class="c1"># Get background and background-subtracted y</span>
    <span class="n">yflat</span><span class="p">,</span> <span class="n">bck</span> <span class="o">=</span> <span class="n">remove_bck</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

    <span class="c1"># get initial guesses</span>
    <span class="n">amp</span> <span class="o">=</span> <span class="p">[</span><span class="n">yflat</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nanargmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">lamb</span><span class="p">))]</span> <span class="k">for</span> <span class="n">lamb</span> <span class="ow">in</span> <span class="n">lamb0</span><span class="p">]</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="p">[</span><span class="n">Dx</span><span class="o">/</span><span class="n">nmax</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmax</span><span class="p">)]</span>
    <span class="n">p0</span> <span class="o">=</span> <span class="n">amp</span> <span class="o">+</span> <span class="n">sigma</span> <span class="o">+</span> <span class="p">[</span><span class="n">bck</span><span class="p">]</span>

    <span class="c1"># Get bounding boxes</span>
    <span class="n">bamp</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nmax</span><span class="p">,),</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">nmax</span><span class="p">,),</span><span class="mf">3.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">y</span><span class="p">)))</span>
    <span class="n">bsigma</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">nmax</span><span class="p">,),</span> <span class="n">dx</span><span class="o">/</span><span class="mf">2.</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">nmax</span><span class="p">,),</span> <span class="n">Dx</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span>
    <span class="n">bbck0</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>

    <span class="n">bounds</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">bamp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bsigma</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bbck0</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
              <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">bamp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">bsigma</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">bbck0</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Lower bounds must be &lt; upper bounds !</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    lower :  </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    upper :  </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p0</span><span class="p">,</span> <span class="n">bounds</span><span class="p">,</span> <span class="n">lamb0</span></div>


<div class="viewcode-block" id="get_func1d_all"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._spectrafit2d.get_func1d_all">[docs]</a><span class="k">def</span> <span class="nf">get_func1d_all</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">lamb0</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">lamb0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">lamb0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">lamb0</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">n</span>

    <span class="k">def</span> <span class="nf">func_vect</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">amp</span><span class="p">,</span> <span class="n">dlamb</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">bck0</span><span class="p">,</span> <span class="n">lamb0</span><span class="o">=</span><span class="n">lamb0</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">):</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">y</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">amp</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span><span class="o">-</span><span class="p">(</span><span class="n">lamb0</span><span class="o">+</span><span class="n">dlamb</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
                                        <span class="o">/</span><span class="n">sigma</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">bck0</span>
        <span class="k">return</span> <span class="n">y</span>

    <span class="k">def</span> <span class="nf">func_sca</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">lamb0</span><span class="o">=</span><span class="n">lamb0</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">):</span>
        <span class="n">amp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">n</span><span class="p">]][:,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">dlamb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="n">n</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">]][:,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">n</span><span class="p">]][:,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">bck0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">n</span><span class="p">]]</span>
        <span class="n">gaus</span> <span class="o">=</span> <span class="n">amp</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span><span class="o">-</span><span class="p">(</span><span class="n">lamb0</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">+</span> <span class="n">dlamb</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">back</span> <span class="o">=</span> <span class="n">bck0</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">gaus</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">back</span>

    <span class="k">def</span> <span class="nf">func_sca_jac</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">lamb0</span><span class="o">=</span><span class="n">lamb0</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">):</span>
        <span class="n">amp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">n</span><span class="p">]][</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">dlamb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="n">n</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">]][</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">n</span><span class="p">]][</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">bck0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">n</span><span class="p">]]</span>
        <span class="n">lamb0</span> <span class="o">=</span> <span class="n">lamb0</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">jac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">,),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">jac</span><span class="p">[:,</span> <span class="p">:</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="p">(</span><span class="n">lamb0</span><span class="o">+</span><span class="n">dlamb</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">jac</span><span class="p">[:,</span> <span class="n">n</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">amp</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="p">(</span><span class="n">lamb0</span><span class="o">+</span><span class="n">dlamb</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                               <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="p">(</span><span class="n">lamb0</span><span class="o">+</span><span class="n">dlamb</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">jac</span><span class="p">[:,</span> <span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">amp</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="p">(</span><span class="n">lamb0</span><span class="o">+</span><span class="n">dlamb</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">sigma</span><span class="o">**</span><span class="mi">3</span>
                                 <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="p">(</span><span class="n">lamb0</span><span class="o">+</span><span class="n">dlamb</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">jac</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
        <span class="k">return</span> <span class="n">jac</span>

    <span class="k">return</span> <span class="n">func_vect</span><span class="p">,</span> <span class="n">func_sca</span><span class="p">,</span> <span class="n">func_sca_jac</span></div>


<div class="viewcode-block" id="get_func1d_lamb0fix"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._spectrafit2d.get_func1d_lamb0fix">[docs]</a><span class="k">def</span> <span class="nf">get_func1d_lamb0fix</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">lamb0</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">lamb0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">lamb0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">lamb0</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">n</span>

    <span class="k">def</span> <span class="nf">func_vect</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">amp</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">bck0</span><span class="p">,</span> <span class="n">lamb0</span><span class="o">=</span><span class="n">lamb0</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">):</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">y</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">amp</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">lamb0</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">sigma</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">bck0</span>
        <span class="k">return</span> <span class="n">y</span>

    <span class="k">def</span> <span class="nf">func_sca</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">lamb0</span><span class="o">=</span><span class="n">lamb0</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">):</span>
        <span class="n">amp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">n</span><span class="p">]][:,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">n</span><span class="p">]][:,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">bck0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">n</span><span class="p">]]</span>
        <span class="n">gaus</span> <span class="o">=</span> <span class="n">amp</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span><span class="o">-</span><span class="n">lamb0</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">back</span> <span class="o">=</span> <span class="n">bck0</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">gaus</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">back</span>

    <span class="k">def</span> <span class="nf">func_sca_jac</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">lamb0</span><span class="o">=</span><span class="n">lamb0</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">):</span>
        <span class="n">amp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">n</span><span class="p">]][</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">n</span><span class="p">]][</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">bck0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">n</span><span class="p">]]</span>
        <span class="n">lamb0</span> <span class="o">=</span> <span class="n">lamb0</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">jac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">,),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">jac</span><span class="p">[:,</span> <span class="p">:</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">lamb0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">jac</span><span class="p">[:,</span> <span class="n">n</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">amp</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">lamb0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">sigma</span><span class="o">**</span><span class="mi">3</span>
                                 <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">lamb0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">jac</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
        <span class="k">return</span> <span class="n">jac</span>

    <span class="k">return</span> <span class="n">func_vect</span><span class="p">,</span> <span class="n">func_sca</span><span class="p">,</span> <span class="n">func_sca_jac</span></div>


<div class="viewcode-block" id="multiplegaussianfit1d"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._spectrafit2d.multiplegaussianfit1d">[docs]</a><span class="k">def</span> <span class="nf">multiplegaussianfit1d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">spectra</span><span class="p">,</span> <span class="n">nmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">lamb0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">forcelamb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">p0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">max_nfev</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xtol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                          <span class="n">percent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot_debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="c1"># Check inputs</span>
    <span class="k">if</span> <span class="n">xtol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">xtol</span> <span class="o">=</span> <span class="mf">1.e-8</span>
    <span class="k">if</span> <span class="n">percent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">percent</span> <span class="o">=</span> <span class="mi">20</span>


    <span class="c1"># Prepare</span>
    <span class="k">if</span> <span class="n">spectra</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">spectra</span> <span class="o">=</span> <span class="n">spectra</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">spectra</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
    <span class="n">nt</span> <span class="o">=</span> <span class="n">spectra</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Prepare info</span>
    <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;----- Fitting spectra with </span><span class="si">{0}</span><span class="s2"> gaussians -----&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nmax</span><span class="p">))</span>
    <span class="n">nspect</span> <span class="o">=</span> <span class="n">spectra</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">nstr</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">nspect</span><span class="o">//</span><span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mi">100</span><span class="o">/</span><span class="n">percent</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># get initial guess function</span>
    <span class="k">if</span> <span class="n">forcelamb</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">get_p0bounds</span> <span class="o">=</span> <span class="n">get_p0bounds_lambfix</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">get_p0bounds</span> <span class="o">=</span> <span class="n">get_p0bounds_all</span>

    <span class="c1"># lamb0</span>
    <span class="k">if</span> <span class="n">p0</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">bounds</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">lamb0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">p00</span><span class="p">,</span> <span class="n">bounds0</span><span class="p">,</span> <span class="n">lamb00</span> <span class="o">=</span> <span class="n">get_p0bounds_all</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">spectra</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span>
                                              <span class="n">nmax</span><span class="o">=</span><span class="n">nmax</span><span class="p">,</span> <span class="n">lamb0</span><span class="o">=</span><span class="n">lamb0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lamb0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lamb0</span> <span class="o">=</span> <span class="n">lamb00</span>
        <span class="k">assert</span> <span class="n">lamb0</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">forcelamb</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">p00</span> <span class="o">=</span> <span class="n">p00</span><span class="p">[:</span><span class="n">nmax</span><span class="p">]</span> <span class="o">+</span> <span class="n">p00</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">nmax</span><span class="p">:]</span>
            <span class="n">bounds0</span> <span class="o">=</span> <span class="n">bounds0</span><span class="p">[:</span><span class="n">nmax</span><span class="p">]</span> <span class="o">+</span> <span class="n">bounds0</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">nmax</span><span class="p">:]</span>
        <span class="k">if</span> <span class="n">p0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">p0</span> <span class="o">=</span> <span class="n">p00</span>
        <span class="k">if</span> <span class="n">bounds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="n">bounds0</span>
    <span class="k">if</span> <span class="n">nmax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nmax</span> <span class="o">=</span> <span class="n">lamb0</span><span class="o">.</span><span class="n">size</span>
    <span class="k">assert</span> <span class="n">nmax</span> <span class="o">==</span> <span class="n">lamb0</span><span class="o">.</span><span class="n">size</span>

    <span class="c1"># Get fit vector, scalar and jacobian functions</span>
    <span class="k">if</span> <span class="n">forcelamb</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">func_vect</span><span class="p">,</span> <span class="n">func_sca</span><span class="p">,</span> <span class="n">func_sca_jac</span> <span class="o">=</span> <span class="n">get_func1d_lamb0fix</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nmax</span><span class="p">,</span>
                                                                <span class="n">lamb0</span><span class="o">=</span><span class="n">lamb0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">func_vect</span><span class="p">,</span> <span class="n">func_sca</span><span class="p">,</span> <span class="n">func_sca_jac</span> <span class="o">=</span> <span class="n">get_func1d_all</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nmax</span><span class="p">,</span>
                                                           <span class="n">lamb0</span><span class="o">=</span><span class="n">lamb0</span><span class="p">)</span>

    <span class="c1"># Prepare index for splitting p0</span>
    <span class="k">if</span> <span class="n">forcelamb</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">indsplit</span> <span class="o">=</span> <span class="n">nmax</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">indsplit</span> <span class="o">=</span> <span class="n">nmax</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>

    <span class="c1"># Prepare output</span>
    <span class="n">fit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">spectra</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="n">amp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">nt</span><span class="p">,</span> <span class="n">nmax</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">nt</span><span class="p">,</span> <span class="n">nmax</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="n">bck</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">nt</span><span class="p">,),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="n">ampstd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">nt</span><span class="p">,</span> <span class="n">nmax</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="n">sigmastd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">nt</span><span class="p">,</span> <span class="n">nmax</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="n">bckstd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">nt</span><span class="p">,),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">forcelamb</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">dlamb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">nt</span><span class="p">,</span> <span class="n">nmax</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">dlambstd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">nt</span><span class="p">,</span> <span class="n">nmax</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dlamb</span><span class="p">,</span> <span class="n">dlambstd</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="c1"># Loop on spectra</span>
    <span class="n">lch</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nspect</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ii</span><span class="o">%</span><span class="n">nstr</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&gt; spectrum </span><span class="si">{0}</span><span class="s2"> / </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">nspect</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="n">scpopt</span><span class="o">.</span><span class="n">curve_fit</span><span class="p">(</span><span class="n">func_sca</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">spectra</span><span class="p">[</span><span class="n">ii</span><span class="p">,:],</span>
                                          <span class="n">jac</span><span class="o">=</span><span class="n">func_sca_jac</span><span class="p">,</span>
                                          <span class="n">p0</span><span class="o">=</span><span class="n">p0</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
                                          <span class="n">max_nfev</span><span class="o">=</span><span class="n">max_nfev</span><span class="p">,</span> <span class="n">xtol</span><span class="o">=</span><span class="n">xtol</span><span class="p">,</span>
                                          <span class="n">x_scale</span><span class="o">=</span><span class="s1">&#39;jac&#39;</span><span class="p">,</span>
                                          <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;    Convergence issue for </span><span class="si">{0}</span><span class="s2"> / </span><span class="si">{1}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">nspect</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    =&gt; </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    =&gt; Resetting initial guess and bounds...&quot;</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">p0</span><span class="p">,</span> <span class="n">bounds</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_p0bounds</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">spectra</span><span class="p">[</span><span class="n">ii</span><span class="p">,:],</span>
                                             <span class="n">nmax</span><span class="o">=</span><span class="n">nmax</span><span class="p">,</span> <span class="n">lamb0</span><span class="o">=</span><span class="n">lamb0</span><span class="p">)</span>
                <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="n">scpopt</span><span class="o">.</span><span class="n">curve_fit</span><span class="p">(</span><span class="n">func_sca</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">spectra</span><span class="p">[</span><span class="n">ii</span><span class="p">,:],</span>
                                              <span class="n">jac</span><span class="o">=</span><span class="n">func_sca_jac</span><span class="p">,</span>
                                              <span class="n">p0</span><span class="o">=</span><span class="n">p0</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
                                              <span class="n">max_nfev</span><span class="o">=</span><span class="n">max_nfev</span><span class="p">,</span> <span class="n">xtol</span><span class="o">=</span><span class="n">xtol</span><span class="p">,</span>
                                              <span class="n">x_scale</span><span class="o">=</span><span class="s1">&#39;jac&#39;</span><span class="p">,</span>
                                              <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
                <span class="n">p0</span> <span class="o">=</span> <span class="n">popt</span>
                <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="n">scpopt</span><span class="o">.</span><span class="n">curve_fit</span><span class="p">(</span><span class="n">func_sca</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">spectra</span><span class="p">[</span><span class="n">ii</span><span class="p">,:],</span>
                                              <span class="n">jac</span><span class="o">=</span><span class="n">func_sca_jac</span><span class="p">,</span>
                                              <span class="n">p0</span><span class="o">=</span><span class="n">p0</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
                                              <span class="n">max_nfev</span><span class="o">=</span><span class="n">max_nfev</span><span class="p">,</span> <span class="n">xtol</span><span class="o">=</span><span class="n">xtol</span><span class="p">,</span>
                                              <span class="n">x_scale</span><span class="o">=</span><span class="s1">&#39;jac&#39;</span><span class="p">,</span>
                                              <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
                <span class="n">lch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
                <span class="kn">import</span> <span class="nn">ipdb</span>
                <span class="n">ipdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>
                <span class="k">raise</span> <span class="n">err</span>

        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">popt</span><span class="p">,</span> <span class="n">indsplit</span><span class="p">)</span>
        <span class="n">outstd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">pcov</span><span class="p">)),</span> <span class="n">indsplit</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">forcelamb</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">amp</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:],</span> <span class="n">sigma</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:],</span> <span class="n">bck</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span>
            <span class="n">ampstd</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:],</span> <span class="n">sigmastd</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:],</span> <span class="n">bckstd</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">outstd</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">amp</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:],</span> <span class="n">dlamb</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:],</span> <span class="n">sigma</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:],</span> <span class="n">bck</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span>
            <span class="n">ampstd</span><span class="p">[</span><span class="n">ii</span><span class="p">,:],</span> <span class="n">dlambstd</span><span class="p">[</span><span class="n">ii</span><span class="p">,:],</span> <span class="n">sigmastd</span><span class="p">[</span><span class="n">ii</span><span class="p">,:],</span> <span class="n">bckstd</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">outstd</span>
        <span class="n">fit</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">func_sca</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">popt</span><span class="p">)</span>
        <span class="n">p0</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">popt</span><span class="p">[:]</span>

        <span class="k">if</span> <span class="n">plot_debug</span> <span class="ow">and</span> <span class="n">ii</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">fit</span> <span class="o">=</span> <span class="n">func_vect</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">amp</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:],</span> <span class="n">p0</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:],</span> <span class="n">sigma</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:],</span> <span class="n">bck</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">ax0</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="n">ax0</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="n">ax0</span><span class="p">)</span>
            <span class="n">ax0</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">spectra</span><span class="p">[</span><span class="n">ii</span><span class="p">,:],</span> <span class="s1">&#39;.k&#39;</span><span class="p">,</span>
                     <span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">fit</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;-r&#39;</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fit</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">spectra</span><span class="o">-</span><span class="n">fit</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

    <span class="n">dout</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fit&#39;</span><span class="p">:</span> <span class="n">fit</span><span class="p">,</span> <span class="s1">&#39;lamb0&#39;</span><span class="p">:</span> <span class="n">lamb0</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">:</span> <span class="n">std</span><span class="p">,</span> <span class="s1">&#39;lch&#39;</span><span class="p">:</span> <span class="n">lch</span><span class="p">,</span>
            <span class="s1">&#39;amp&#39;</span><span class="p">:</span> <span class="n">amp</span><span class="p">,</span> <span class="s1">&#39;ampstd&#39;</span><span class="p">:</span> <span class="n">ampstd</span><span class="p">,</span>
            <span class="s1">&#39;sigma&#39;</span><span class="p">:</span> <span class="n">sigma</span><span class="p">,</span> <span class="s1">&#39;sigmastd&#39;</span><span class="p">:</span> <span class="n">sigmastd</span><span class="p">,</span>
            <span class="s1">&#39;bck&#39;</span><span class="p">:</span> <span class="n">bck</span><span class="p">,</span> <span class="s1">&#39;bckstd&#39;</span><span class="p">:</span> <span class="n">bckstd</span><span class="p">,</span>
            <span class="s1">&#39;dlamb&#39;</span><span class="p">:</span> <span class="n">dlamb</span><span class="p">,</span> <span class="s1">&#39;dlambstd&#39;</span><span class="p">:</span> <span class="n">dlambstd</span><span class="p">}</span>

    <span class="k">return</span> <span class="n">dout</span></div>



<span class="c1">###########################################################</span>
<span class="c1">###########################################################</span>
<span class="c1">#</span>
<span class="c1">#           1d spectral fitting with physics parameters</span>
<span class="c1">#</span>
<span class="c1">###########################################################</span>
<span class="c1">###########################################################</span>


<div class="viewcode-block" id="get_lamb0_from_dlines"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._spectrafit2d.get_lamb0_from_dlines">[docs]</a><span class="k">def</span> <span class="nf">get_lamb0_from_dlines</span><span class="p">(</span><span class="n">dlines</span><span class="p">):</span>
    <span class="n">lamb0</span><span class="p">,</span> <span class="n">ions</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[(</span><span class="n">vv</span><span class="p">[</span><span class="s1">&#39;lamb0&#39;</span><span class="p">],</span>
                         <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">vv</span><span class="p">[</span><span class="s1">&#39;lamb0&#39;</span><span class="p">]),),</span> <span class="n">kk</span><span class="p">))</span>
                       <span class="k">for</span> <span class="n">kk</span><span class="p">,</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">dlines</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
    <span class="n">lamb0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">lamb0</span><span class="p">]</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">lamb0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">lamb0</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">ions</span><span class="p">)[</span><span class="n">ind</span><span class="p">]</span></div>


<div class="viewcode-block" id="get_dindx"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._spectrafit2d.get_dindx">[docs]</a><span class="k">def</span> <span class="nf">get_dindx</span><span class="p">(</span><span class="n">bckdeg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dlines</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nbs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="n">nbck</span> <span class="o">=</span> <span class="n">bckdeg</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">nbs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># 1d spectral fit</span>
        <span class="n">nbs</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">i0</span> <span class="o">=</span> <span class="n">nbck</span>
    <span class="n">lk</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">,</span> <span class="s1">&#39;dlamb&#39;</span><span class="p">,</span> <span class="s1">&#39;amp&#39;</span><span class="p">,</span> <span class="s1">&#39;ntot&#39;</span><span class="p">,</span> <span class="s1">&#39;nlamb&#39;</span><span class="p">]</span>
    <span class="n">dindx</span><span class="o">=</span> <span class="p">{</span><span class="s1">&#39;bck&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[:</span><span class="n">nbck</span><span class="p">],</span>
            <span class="s1">&#39;ions&#39;</span><span class="p">:</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">dlines</span><span class="o">.</span><span class="n">keys</span><span class="p">())),</span>
            <span class="s1">&#39;nbs&#39;</span><span class="p">:</span> <span class="n">nbs</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="n">dindx</span><span class="p">[</span><span class="s1">&#39;ions&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">dindx</span><span class="p">[</span><span class="s1">&#39;ions&#39;</span><span class="p">][</span><span class="n">kk</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">lk</span><span class="p">)</span>
        <span class="n">dindx</span><span class="p">[</span><span class="s1">&#39;ions&#39;</span><span class="p">][</span><span class="n">kk</span><span class="p">][</span><span class="s1">&#39;sigma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i0</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[:</span><span class="n">nbs</span><span class="p">]</span>
        <span class="n">dindx</span><span class="p">[</span><span class="s1">&#39;ions&#39;</span><span class="p">][</span><span class="n">kk</span><span class="p">][</span><span class="s1">&#39;dlamb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i0</span><span class="o">+</span><span class="n">nbs</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[:</span><span class="n">nbs</span><span class="p">]</span>
        <span class="n">nlamb</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dlines</span><span class="p">[</span><span class="n">kk</span><span class="p">][</span><span class="s1">&#39;lamb0&#39;</span><span class="p">])</span>
        <span class="n">dindx</span><span class="p">[</span><span class="s1">&#39;ions&#39;</span><span class="p">][</span><span class="n">kk</span><span class="p">][</span><span class="s1">&#39;amp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i0</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">nbs</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[:</span><span class="n">nlamb</span><span class="o">*</span><span class="n">nbs</span><span class="p">]</span>
        <span class="n">dindx</span><span class="p">[</span><span class="s1">&#39;ions&#39;</span><span class="p">][</span><span class="n">kk</span><span class="p">][</span><span class="s1">&#39;nlamb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nlamb</span>
        <span class="n">dindx</span><span class="p">[</span><span class="s1">&#39;ions&#39;</span><span class="p">][</span><span class="n">kk</span><span class="p">][</span><span class="s1">&#39;ntot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="n">nlamb</span><span class="p">)</span><span class="o">*</span><span class="n">nbs</span>
        <span class="n">i0</span> <span class="o">+=</span> <span class="n">dindx</span><span class="p">[</span><span class="s1">&#39;ions&#39;</span><span class="p">][</span><span class="n">kk</span><span class="p">][</span><span class="s1">&#39;ntot&#39;</span><span class="p">]</span>
    <span class="n">dindx</span><span class="p">[</span><span class="s1">&#39;nall&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i0</span>
    <span class="k">return</span> <span class="n">dindx</span></div>


<div class="viewcode-block" id="get_x0_bounds"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._spectrafit2d.get_x0_bounds">[docs]</a><span class="k">def</span> <span class="nf">get_x0_bounds</span><span class="p">(</span><span class="n">x01d</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dlines</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dindx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">lamb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">dindx</span><span class="p">[</span><span class="s1">&#39;nall&#39;</span><span class="p">],),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">x01d</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Get average spectral width and separation</span>
        <span class="n">lamb0_Delta</span> <span class="o">=</span> <span class="n">lamb</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">lamb</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">nlamb0</span> <span class="o">=</span> <span class="n">lamb</span><span class="o">.</span><span class="n">size</span>
        <span class="n">lamb0_delta</span> <span class="o">=</span> <span class="n">lamb0_Delta</span> <span class="o">/</span> <span class="n">nlamb0</span>

        <span class="n">nbs</span> <span class="o">=</span> <span class="n">dindx</span><span class="p">[</span><span class="s1">&#39;nbs&#39;</span><span class="p">]</span>

        <span class="n">x0</span><span class="p">[</span><span class="n">dindx</span><span class="p">[</span><span class="s1">&#39;bck&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">dindx</span><span class="p">[</span><span class="s1">&#39;bck&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">,))</span>
        <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="n">dindx</span><span class="p">[</span><span class="s1">&#39;ions&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1"># sigma</span>
            <span class="n">x0</span><span class="p">[</span><span class="n">dindx</span><span class="p">[</span><span class="n">kk</span><span class="p">][</span><span class="s1">&#39;sigma&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">lamb0_delta</span>
            <span class="c1"># dlamb</span>
            <span class="n">x0</span><span class="p">[</span><span class="n">dindx</span><span class="p">[</span><span class="n">kk</span><span class="p">][</span><span class="s1">&#39;dlamb&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="c1"># amp</span>
            <span class="n">x0</span><span class="p">[</span><span class="n">dindx</span><span class="p">[</span><span class="n">kk</span><span class="p">][</span><span class="s1">&#39;amp&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">ampmean</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">x0</span><span class="p">[</span><span class="n">dindx</span><span class="p">[</span><span class="s1">&#39;bck&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">x01d</span><span class="p">[</span><span class="n">dindx</span><span class="p">[</span><span class="s1">&#39;bck&#39;</span><span class="p">]]</span>
        <span class="n">i0</span> <span class="o">=</span> <span class="n">dindx</span><span class="p">[</span><span class="s1">&#39;bck&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span>
        <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="n">dindx</span><span class="p">[</span><span class="s1">&#39;ions&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1"># TBF</span>
            <span class="c1"># x0[dindx[kk][&#39;sigma&#39;]] = x01d[]</span>
            <span class="k">pass</span>

    <span class="c1"># Get bounds</span>
    <span class="n">lamb_delta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">lamb</span><span class="p">))))</span>
    <span class="n">datamax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">bampup</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">datamax</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>

    <span class="n">bounds0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">dindx</span><span class="p">[</span><span class="s1">&#39;nall&#39;</span><span class="p">],),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">bounds1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">dindx</span><span class="p">[</span><span class="s1">&#39;nall&#39;</span><span class="p">],),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dindx</span><span class="p">[</span><span class="s1">&#39;bck&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">bounds0</span><span class="p">[</span><span class="n">dindx</span><span class="p">[</span><span class="s1">&#39;bck&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">bounds1</span><span class="p">[</span><span class="n">dindx</span><span class="p">[</span><span class="s1">&#39;bck&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">bampup</span>
    <span class="k">elif</span> <span class="n">dindx</span><span class="p">[</span><span class="s1">&#39;bck&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">bounds0</span><span class="p">[</span><span class="n">dindx</span><span class="p">[</span><span class="s1">&#39;bck&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">bounds1</span><span class="p">[</span><span class="n">dindx</span><span class="p">[</span><span class="s1">&#39;bck&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">bampup</span>
        <span class="n">bounds0</span><span class="p">[</span><span class="n">dindx</span><span class="p">[</span><span class="s1">&#39;bck&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">0.</span>           <span class="c1"># TBC</span>
        <span class="n">bounds1</span><span class="p">[</span><span class="n">dindx</span><span class="p">[</span><span class="s1">&#39;bck&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">bampup</span>       <span class="c1"># TBC</span>
    <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="n">dindx</span><span class="p">[</span><span class="s1">&#39;ions&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">bounds0</span><span class="p">[</span><span class="n">dindx</span><span class="p">[</span><span class="n">kk</span><span class="p">][</span><span class="s1">&#39;sigma&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">lamb_delta</span>
        <span class="n">bounds1</span><span class="p">[</span><span class="n">dindx</span><span class="p">[</span><span class="n">kk</span><span class="p">][</span><span class="s1">&#39;sigma&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">lamb0_delta</span><span class="o">*</span><span class="mf">5.</span>
        <span class="n">bounds0</span><span class="p">[</span><span class="n">dindx</span><span class="p">[</span><span class="n">kk</span><span class="p">][</span><span class="s1">&#39;dlamb&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">3.</span><span class="o">*</span><span class="n">lamb0_delta</span>
        <span class="n">bounds1</span><span class="p">[</span><span class="n">dindx</span><span class="p">[</span><span class="n">kk</span><span class="p">][</span><span class="s1">&#39;dlamb&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">3.</span><span class="o">*</span><span class="n">lamb0_delta</span>
        <span class="n">bounds0</span><span class="p">[</span><span class="n">dindx</span><span class="p">[</span><span class="n">kk</span><span class="p">][</span><span class="s1">&#39;amp&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">bounds1</span><span class="p">[</span><span class="n">dindx</span><span class="p">[</span><span class="n">kk</span><span class="p">][</span><span class="s1">&#39;amp&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">datamax</span>

    <span class="k">return</span> <span class="n">x0</span><span class="p">,</span> <span class="n">bounds</span></div>




<div class="viewcode-block" id="get_funccostjac"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._spectrafit2d.get_funccostjac">[docs]</a><span class="k">def</span> <span class="nf">get_funccostjac</span><span class="p">():</span>

    <span class="k">def</span> <span class="nf">func</span><span class="p">():</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">cost</span><span class="p">():</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">jac</span><span class="p">():</span>
        <span class="k">pass</span>

    <span class="k">return</span> <span class="n">func</span><span class="p">,</span> <span class="n">cost</span><span class="p">,</span> <span class="n">jac</span></div>










<span class="c1">###########################################################</span>
<span class="c1">###########################################################</span>
<span class="c1">#</span>
<span class="c1">#           2d spectral fitting</span>
<span class="c1">#</span>
<span class="c1">###########################################################</span>
<span class="c1">###########################################################</span>

<div class="viewcode-block" id="get_knots_nbs_for_bsplines"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._spectrafit2d.get_knots_nbs_for_bsplines">[docs]</a><span class="k">def</span> <span class="nf">get_knots_nbs_for_bsplines</span><span class="p">(</span><span class="n">knots_unique</span><span class="p">,</span> <span class="n">deg</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">deg</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">knots</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[[</span><span class="n">knots_unique</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">*</span><span class="n">deg</span><span class="p">,</span> <span class="n">knots_unique</span><span class="p">,</span>
                      <span class="p">[</span><span class="n">knots_unique</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span><span class="o">*</span><span class="n">deg</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">knots</span> <span class="o">=</span> <span class="n">knots_unique</span>
    <span class="n">nbknotsperbs</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">deg</span>
    <span class="n">nbs</span> <span class="o">=</span> <span class="n">knots_unique</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">deg</span>
    <span class="k">assert</span> <span class="n">nbs</span> <span class="o">==</span> <span class="n">knots</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">deg</span>
    <span class="k">return</span> <span class="n">knots</span><span class="p">,</span> <span class="n">nbknotsperbs</span><span class="p">,</span> <span class="n">nbs</span></div>


<div class="viewcode-block" id="get_2dspectralfit_func"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._spectrafit2d.get_2dspectralfit_func">[docs]</a><span class="k">def</span> <span class="nf">get_2dspectralfit_func</span><span class="p">(</span><span class="n">lamb0</span><span class="p">,</span> <span class="n">forcelamb</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                           <span class="n">deg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">knots</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="n">lamb0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">lamb0</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="n">nlamb</span> <span class="o">=</span> <span class="n">lamb0</span><span class="o">.</span><span class="n">size</span>
    <span class="n">knots</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">knots</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="n">nknots</span> <span class="o">=</span> <span class="n">knots</span><span class="o">.</span><span class="n">size</span>
    <span class="n">nbsplines</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">knots</span><span class="p">)</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">deg</span>

    <span class="c1"># Define function</span>
    <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">lamb</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span>
             <span class="n">camp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cwidth</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cshift</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">lamb0</span><span class="o">=</span><span class="n">lamb0</span><span class="p">,</span> <span class="n">nlamb</span><span class="o">=</span><span class="n">nlamb</span><span class="p">,</span>
             <span class="n">knots</span><span class="o">=</span><span class="n">knots</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="n">deg</span><span class="p">,</span> <span class="n">forcelamb</span><span class="o">=</span><span class="n">forcelamb</span><span class="p">,</span>
             <span class="n">nbsplines</span><span class="o">=</span><span class="n">nbsplines</span><span class="p">,</span> <span class="n">mesh</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">phi</span><span class="o">.</span><span class="n">ndim</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">camp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">camp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">nbsplines</span>
            <span class="n">bsamp</span> <span class="o">=</span> <span class="n">BSpline</span><span class="p">(</span><span class="n">knots</span><span class="p">,</span> <span class="n">camp</span><span class="p">,</span> <span class="n">deg</span><span class="p">,</span>
                            <span class="n">extrapolate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">csigma</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">csigma</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">nbsplines</span>
            <span class="n">bssigma</span> <span class="o">=</span> <span class="n">BSpline</span><span class="p">(</span><span class="n">knots</span><span class="p">,</span> <span class="n">csigma</span><span class="p">,</span> <span class="n">deg</span><span class="p">,</span>
                              <span class="n">extrapolate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mesh</span> <span class="ow">or</span> <span class="n">phi</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">lamb0</span> <span class="o">=</span> <span class="n">lamb0</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lamb0</span> <span class="o">=</span> <span class="n">lamb0</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">if</span> <span class="n">forcelamb</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mesh</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">angle</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="n">lamb</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span>
                <span class="c1"># shape (lamb, angle, lines)</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">bsamp</span><span class="p">(</span><span class="n">phi</span><span class="p">)[</span><span class="kc">None</span><span class="p">,:,:]</span>
                              <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">lamb</span><span class="p">[:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span>
                                         <span class="o">-</span> <span class="n">lamb0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
                                       <span class="o">/</span><span class="p">(</span><span class="n">bssigma</span><span class="p">(</span><span class="n">phi</span><span class="p">)[</span><span class="kc">None</span><span class="p">,:,:]</span><span class="o">**</span><span class="mi">2</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">phi</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">lamb</span><span class="o">.</span><span class="n">shape</span>
                <span class="n">lamb</span> <span class="o">=</span> <span class="n">lamb</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
                <span class="c1"># shape (lamb/angle, lines)</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">bsamp</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
                              <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">lamb</span>
                                         <span class="o">-</span> <span class="n">lamb0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
                                       <span class="o">/</span><span class="p">(</span><span class="n">bssigma</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cdlamb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">cdlamb</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">nbsplines</span>
                <span class="n">bsdlamb</span> <span class="o">=</span> <span class="n">BSpline</span><span class="p">(</span><span class="n">knots</span><span class="p">,</span> <span class="n">cdlamb</span><span class="p">,</span> <span class="n">deg</span><span class="p">,</span>
                                  <span class="n">extrapolate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">func</span></div>


<div class="viewcode-block" id="get_multigaussianfit2d_costfunc"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._spectrafit2d.get_multigaussianfit2d_costfunc">[docs]</a><span class="k">def</span> <span class="nf">get_multigaussianfit2d_costfunc</span><span class="p">(</span><span class="n">lamb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">phi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                    <span class="n">lamb0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">forcelamb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                    <span class="n">deg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">knots</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                    <span class="n">nlamb0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nkperbs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nbs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                    <span class="n">nc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">lamb</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">phi</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">assert</span> <span class="n">lamb</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">nc</span> <span class="o">==</span> <span class="n">nbs</span><span class="o">*</span><span class="n">nlamb0</span>

    <span class="k">if</span> <span class="n">forcelamb</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">forcelamb</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">debug</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Define func assuming all inpus properly formatted</span>
    <span class="k">if</span> <span class="n">forcelamb</span><span class="p">:</span>
        <span class="c1"># x = [camp[1-nbs,...,nbs*(nlamb0-1)-nc}, csigma[1-nc]]</span>
        <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">x</span><span class="p">,</span>
                 <span class="n">lamb</span><span class="o">=</span><span class="n">lamb</span><span class="p">,</span> <span class="n">phi</span><span class="o">=</span><span class="n">phi</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="n">std</span><span class="p">,</span>
                 <span class="n">lamb0</span><span class="o">=</span><span class="n">lamb0</span><span class="p">,</span> <span class="n">knots</span><span class="o">=</span><span class="n">knots</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="n">deg</span><span class="p">,</span> <span class="n">nc</span><span class="o">=</span><span class="n">nc</span><span class="p">):</span>
            <span class="n">amp</span> <span class="o">=</span> <span class="n">BSpline</span><span class="p">(</span><span class="n">knots</span><span class="p">,</span> <span class="n">x</span><span class="p">[:</span><span class="n">nc</span><span class="p">],</span> <span class="n">deg</span><span class="p">,</span>
                          <span class="n">extrapolate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)(</span><span class="n">phi</span><span class="p">)</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="n">BSpline</span><span class="p">(</span><span class="n">knots</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">nc</span><span class="p">:],</span> <span class="n">deg</span><span class="p">,</span>
                            <span class="n">extrapolate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)(</span><span class="n">phi</span><span class="p">)</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">amp</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
                         <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">lamb</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">-</span> <span class="n">lamb0</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:])</span><span class="o">**</span><span class="mi">2</span>
                                  <span class="o">/</span><span class="p">(</span><span class="n">sigma</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">val</span><span class="o">-</span><span class="n">data</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">std</span><span class="o">*</span><span class="n">data</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">jac</span><span class="p">(</span><span class="n">x</span><span class="p">,</span>
                <span class="n">lamb</span><span class="o">=</span><span class="n">lamb</span><span class="p">,</span> <span class="n">phi</span><span class="o">=</span><span class="n">phi</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="n">std</span><span class="p">,</span>
                <span class="n">lamb0</span><span class="o">=</span><span class="n">lamb0</span><span class="p">,</span> <span class="n">knots</span><span class="o">=</span><span class="n">knots</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="n">deg</span><span class="p">,</span>
                <span class="n">nlamb0</span><span class="o">=</span><span class="n">nlamb0</span><span class="p">,</span> <span class="n">nkperbs</span><span class="o">=</span><span class="n">nkperbs</span><span class="p">,</span> <span class="n">nbs</span><span class="o">=</span><span class="n">nbs</span><span class="p">,</span> <span class="n">nc</span><span class="o">=</span><span class="n">nc</span><span class="p">):</span>
            <span class="n">amp</span> <span class="o">=</span> <span class="n">BSpline</span><span class="p">(</span><span class="n">knots</span><span class="p">,</span> <span class="n">x</span><span class="p">[:</span><span class="n">nc</span><span class="p">],</span> <span class="n">deg</span><span class="p">,</span>
                          <span class="n">extrapolate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)(</span><span class="n">phi</span><span class="p">)</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="n">BSpline</span><span class="p">(</span><span class="n">knots</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">nc</span><span class="p">:],</span> <span class="n">deg</span><span class="p">,</span>
                            <span class="n">extrapolate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)(</span><span class="n">phi</span><span class="p">)</span>
            <span class="n">jacx</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">((</span><span class="n">phi</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">nc</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="c1">#jacx = np.zeros((phi.size, 2*nc), dtype=float)</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlamb0</span><span class="p">):</span>
                <span class="n">expi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">lamb</span><span class="o">-</span><span class="n">lamb0</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nbs</span><span class="p">):</span>
                    <span class="n">ind</span> <span class="o">=</span> <span class="n">ii</span><span class="o">*</span><span class="n">nbs</span> <span class="o">+</span> <span class="n">jj</span>
                    <span class="n">indk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">jj</span><span class="o">*</span><span class="n">nkperbs</span><span class="p">:(</span><span class="n">jj</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">nkperbs</span><span class="p">]</span>
                    <span class="c1"># all bsplines are the same, only coefs (x) are changing</span>
                    <span class="n">bj</span> <span class="o">=</span> <span class="n">BSpline</span><span class="o">.</span><span class="n">basis_element</span><span class="p">(</span><span class="n">knots</span><span class="p">[</span><span class="n">indk</span><span class="p">],</span>
                                               <span class="n">extrapolate</span><span class="o">=</span><span class="kc">False</span><span class="p">)(</span><span class="n">phi</span><span class="p">)</span>
                    <span class="c1">#bj[np.isnan(bj)] = 0.</span>
                    <span class="n">indok</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">bj</span><span class="p">)</span>
                    <span class="c1"># Differentiate wrt camp</span>
                    <span class="n">jacx</span><span class="p">[</span><span class="n">indok</span><span class="p">,</span> <span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">bj</span> <span class="o">*</span> <span class="n">expi</span><span class="p">)[</span><span class="n">indok</span><span class="p">]</span>
                    <span class="c1"># Differentiate wrt csigma</span>
                    <span class="n">jacx</span><span class="p">[</span><span class="n">indok</span><span class="p">,</span> <span class="n">nc</span><span class="o">+</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">amp</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">lamb</span><span class="o">-</span><span class="n">lamb0</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">bj</span><span class="o">/</span><span class="n">sigma</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">expi</span>
                    <span class="p">)[</span><span class="n">indok</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">jacx</span><span class="o">/</span><span class="p">(</span><span class="n">std</span><span class="o">*</span><span class="n">phi</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># x = [camp1-nbs*nlamb, csigma1-nbs*nlamb, cdlamb1-nbs*nlamb]</span>
        <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">x</span><span class="p">,</span>
                 <span class="n">lamb</span><span class="o">=</span><span class="n">lamb</span><span class="p">,</span> <span class="n">phi</span><span class="o">=</span><span class="n">phi</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="n">std</span><span class="p">,</span>
                 <span class="n">lamb0</span><span class="o">=</span><span class="n">lamb0</span><span class="p">,</span> <span class="n">knots</span><span class="o">=</span><span class="n">knots</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="n">deg</span><span class="p">,</span>
                 <span class="n">nbs</span><span class="o">=</span><span class="n">nbs</span><span class="p">,</span> <span class="n">nlamb0</span><span class="o">=</span><span class="n">nlamb0</span><span class="p">,</span> <span class="n">nc</span><span class="o">=</span><span class="n">nc</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">):</span>
            <span class="n">amp</span> <span class="o">=</span> <span class="n">BSpline</span><span class="p">(</span><span class="n">knots</span><span class="p">,</span> <span class="n">x</span><span class="p">[:</span><span class="n">nc</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nbs</span><span class="p">,</span> <span class="n">nlamb0</span><span class="p">),</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">),</span>
                          <span class="n">deg</span><span class="p">,</span> <span class="n">extrapolate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)(</span><span class="n">phi</span><span class="p">)</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="n">BSpline</span><span class="p">(</span><span class="n">knots</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">nc</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="n">nc</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nbs</span><span class="p">,</span> <span class="n">nlamb0</span><span class="p">),</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">),</span>
                            <span class="n">deg</span><span class="p">,</span> <span class="n">extrapolate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)(</span><span class="n">phi</span><span class="p">)</span>
            <span class="n">dlamb</span> <span class="o">=</span> <span class="n">BSpline</span><span class="p">(</span><span class="n">knots</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">nc</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nbs</span><span class="p">,</span> <span class="n">nlamb0</span><span class="p">),</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">),</span>
                            <span class="n">deg</span><span class="p">,</span> <span class="n">extrapolate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)(</span><span class="n">phi</span><span class="p">)</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">amp</span>
                            <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">lamb</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">lamb0</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span><span class="o">+</span><span class="n">dlamb</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span>
                                  <span class="o">/</span> <span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span>
                            <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">10</span><span class="p">));</span>
                <span class="n">ax0</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.05</span><span class="p">,</span><span class="mf">0.55</span><span class="p">,</span><span class="mf">0.25</span><span class="p">,</span><span class="mf">0.4</span><span class="p">])</span>
                <span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.35</span><span class="p">,</span><span class="mf">0.55</span><span class="p">,</span><span class="mf">0.25</span><span class="p">,</span><span class="mf">0.4</span><span class="p">],</span> <span class="n">sharex</span><span class="o">=</span><span class="n">ax0</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="n">ax0</span><span class="p">)</span>
                <span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.65</span><span class="p">,</span><span class="mf">0.55</span><span class="p">,</span><span class="mf">0.25</span><span class="p">,</span><span class="mf">0.4</span><span class="p">],</span> <span class="n">sharex</span><span class="o">=</span><span class="n">ax0</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="n">ax0</span><span class="p">)</span>
                <span class="n">ax3</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.05</span><span class="p">,</span><span class="mf">0.05</span><span class="p">,</span><span class="mf">0.25</span><span class="p">,</span><span class="mf">0.4</span><span class="p">],</span> <span class="n">sharex</span><span class="o">=</span><span class="n">ax0</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="n">ax0</span><span class="p">)</span>
                <span class="n">ax4</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.35</span><span class="p">,</span><span class="mf">0.05</span><span class="p">,</span><span class="mf">0.25</span><span class="p">,</span><span class="mf">0.4</span><span class="p">],</span> <span class="n">sharex</span><span class="o">=</span><span class="n">ax0</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="n">ax0</span><span class="p">)</span>
                <span class="n">ax5</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.65</span><span class="p">,</span><span class="mf">0.05</span><span class="p">,</span><span class="mf">0.25</span><span class="p">,</span><span class="mf">0.4</span><span class="p">],</span> <span class="n">sharex</span><span class="o">=</span><span class="n">ax0</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="n">ax0</span><span class="p">)</span>
                <span class="n">ax0</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">lamb</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span>
                           <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>  <span class="c1"># DB</span>
                <span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">lamb</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">val</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span>  <span class="c1"># DB</span>
                           <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>  <span class="c1"># DB</span>
                <span class="n">errmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">val</span><span class="o">-</span><span class="n">data</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">std</span><span class="o">*</span><span class="n">data</span><span class="o">.</span><span class="n">size</span><span class="p">)))</span>
                <span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">lamb</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="p">(</span><span class="n">val</span><span class="o">-</span><span class="n">data</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">std</span><span class="o">*</span><span class="n">data</span><span class="o">.</span><span class="n">size</span><span class="p">),</span>
                            <span class="n">s</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span>  <span class="c1"># DB</span>
                            <span class="n">vmin</span><span class="o">=-</span><span class="n">errmax</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">errmax</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">seismic</span><span class="p">)</span>  <span class="c1"># DB</span>
                <span class="n">dlamb0_amp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">lamb0</span><span class="p">))</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">amp</span><span class="p">))</span>
                <span class="n">dlamb0_sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">lamb0</span><span class="p">))</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sigma</span><span class="p">))</span>
                <span class="n">dlamb0_dlamb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">lamb0</span><span class="p">))</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dlamb</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlamb0</span><span class="p">):</span>
                    <span class="n">ax3</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">lamb0</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
                    <span class="n">ax4</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">lamb0</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
                    <span class="n">ax5</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">lamb0</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
                    <span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lamb0</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">+</span> <span class="n">dlamb0_amp</span><span class="o">*</span><span class="n">amp</span><span class="p">[:,</span> <span class="n">ii</span><span class="p">],</span> <span class="n">phi</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
                    <span class="n">ax4</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lamb0</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">+</span> <span class="n">dlamb0_sigma</span><span class="o">*</span><span class="n">sigma</span><span class="p">[:,</span> <span class="n">ii</span><span class="p">],</span> <span class="n">phi</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
                    <span class="n">ax5</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lamb0</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">+</span> <span class="n">dlamb0_dlamb</span><span class="o">*</span><span class="n">dlamb</span><span class="p">[:,</span> <span class="n">ii</span><span class="p">],</span> <span class="n">phi</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
                <span class="kn">import</span> <span class="nn">ipdb</span>         <span class="c1"># DB</span>
                <span class="n">ipdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>    <span class="c1"># DB</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">val</span><span class="o">-</span><span class="n">data</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">std</span><span class="o">*</span><span class="n">data</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">jac</span><span class="p">(</span><span class="n">x</span><span class="p">,</span>
                <span class="n">lamb</span><span class="o">=</span><span class="n">lamb</span><span class="p">,</span> <span class="n">phi</span><span class="o">=</span><span class="n">phi</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="n">std</span><span class="p">,</span>
                <span class="n">lamb0</span><span class="o">=</span><span class="n">lamb0</span><span class="p">,</span> <span class="n">knots</span><span class="o">=</span><span class="n">knots</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="n">deg</span><span class="p">,</span>
                <span class="n">nlamb0</span><span class="o">=</span><span class="n">nlamb0</span><span class="p">,</span> <span class="n">nkperbs</span><span class="o">=</span><span class="n">nkperbs</span><span class="p">,</span> <span class="n">nbs</span><span class="o">=</span><span class="n">nbs</span><span class="p">,</span> <span class="n">nc</span><span class="o">=</span><span class="n">nc</span><span class="p">):</span>
            <span class="n">amp</span> <span class="o">=</span> <span class="n">BSpline</span><span class="p">(</span><span class="n">knots</span><span class="p">,</span> <span class="n">x</span><span class="p">[:</span><span class="n">nc</span><span class="p">],</span> <span class="n">deg</span><span class="p">,</span>
                          <span class="n">extrapolate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)(</span><span class="n">phi</span><span class="p">)</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="n">BSpline</span><span class="p">(</span><span class="n">knots</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">nc</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="n">nc</span><span class="p">],</span> <span class="n">deg</span><span class="p">,</span>
                            <span class="n">extrapolate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)(</span><span class="n">phi</span><span class="p">)</span>
            <span class="n">dlamb</span> <span class="o">=</span> <span class="n">BSpline</span><span class="p">(</span><span class="n">knots</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">nc</span><span class="p">:],</span> <span class="n">deg</span><span class="p">,</span>
                            <span class="n">extrapolate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)(</span><span class="n">phi</span><span class="p">)</span>
            <span class="c1">#jacx = sparse.csr_matrix((phi.size, 2*nc), dtype=float)</span>
            <span class="n">jacx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">phi</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="n">nc</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlamb0</span><span class="p">):</span>
                <span class="n">expi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">lamb</span><span class="o">-</span><span class="p">(</span><span class="n">lamb0</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">+</span><span class="n">dlamb</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">indlamb</span> <span class="o">=</span> <span class="n">expi</span> <span class="o">&gt;</span> <span class="mf">0.001</span>
                <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nbs</span><span class="p">):</span>
                    <span class="n">kk</span> <span class="o">=</span> <span class="n">ii</span><span class="o">*</span><span class="n">nbs</span> <span class="o">+</span> <span class="n">jj</span>
                    <span class="n">indk</span> <span class="o">=</span> <span class="n">jj</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[:</span><span class="n">nkperbs</span><span class="p">]</span>
                    <span class="c1"># all bsplines are the same, only coefs (x) are changing</span>
                    <span class="n">bj</span> <span class="o">=</span> <span class="n">BSpline</span><span class="o">.</span><span class="n">basis_element</span><span class="p">(</span><span class="n">knots</span><span class="p">[</span><span class="n">indk</span><span class="p">],</span>
                                               <span class="n">extrapolate</span><span class="o">=</span><span class="kc">False</span><span class="p">)(</span><span class="n">phi</span><span class="p">)</span>
                    <span class="c1"># bj[np.isnan(bj)] = 0.</span>
                    <span class="n">indok</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">bj</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">indlamb</span>
                    <span class="c1"># Differentiate wrt camp</span>
                    <span class="n">jacx</span><span class="p">[</span><span class="n">indok</span><span class="p">,</span> <span class="n">kk</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">bj</span><span class="p">[</span><span class="n">indok</span><span class="p">]</span> <span class="o">*</span> <span class="n">expi</span><span class="p">[</span><span class="n">indok</span><span class="p">])</span>
                    <span class="c1"># Differentiate wrt csigma</span>
                    <span class="n">jacx</span><span class="p">[</span><span class="n">indok</span><span class="p">,</span> <span class="n">nc</span><span class="o">+</span><span class="n">kk</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">amp</span> <span class="o">*</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">lamb</span><span class="o">-</span><span class="p">(</span><span class="n">lamb0</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">+</span><span class="n">dlamb</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">bj</span><span class="o">/</span><span class="n">sigma</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="n">expi</span>
                    <span class="p">)[</span><span class="n">indok</span><span class="p">]</span>
                    <span class="c1"># Differentiate wrt dlamb</span>
                    <span class="n">jacx</span><span class="p">[</span><span class="n">indok</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">nc</span><span class="o">+</span><span class="n">kk</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                         <span class="n">amp</span> <span class="o">*</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">lamb</span><span class="o">-</span><span class="p">(</span><span class="n">lamb0</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">+</span><span class="n">dlamb</span><span class="p">))</span><span class="o">*</span><span class="n">bj</span><span class="o">/</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">expi</span>
                    <span class="p">)[</span><span class="n">indok</span><span class="p">]</span>
            <span class="n">jacx</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
            <span class="k">return</span> <span class="n">jacx</span><span class="o">/</span><span class="p">(</span><span class="n">std</span><span class="o">*</span><span class="n">phi</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">func</span><span class="p">,</span> <span class="n">jac</span></div>

<div class="viewcode-block" id="multigaussianfit2d"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._spectrafit2d.multigaussianfit2d">[docs]</a><span class="k">def</span> <span class="nf">multigaussianfit2d</span><span class="p">(</span><span class="n">lamb</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">lamb0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">forcelamb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">knots</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nbsplines</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">x0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_nfev</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">xtol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ftol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gtol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">loss</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="c1"># Check inputs</span>
    <span class="k">if</span> <span class="n">deg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">deg</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="k">if</span> <span class="n">nbsplines</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nbsplines</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="k">if</span> <span class="n">method</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;trf&#39;</span>
    <span class="c1"># Only 2 method for pb. with bounds</span>
    <span class="k">assert</span> <span class="n">method</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;trf&#39;</span><span class="p">,</span> <span class="s1">&#39;dogbox&#39;</span><span class="p">],</span> <span class="n">method</span>
    <span class="k">if</span> <span class="n">xtol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">xtol</span> <span class="o">=</span> <span class="mf">1.e-6</span>
    <span class="k">if</span> <span class="n">ftol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ftol</span> <span class="o">=</span> <span class="mf">1.e-6</span>
    <span class="k">if</span> <span class="n">gtol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">gtol</span> <span class="o">=</span> <span class="mf">1.e-8</span>
    <span class="k">if</span> <span class="n">loss</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="s1">&#39;linear&#39;</span>
    <span class="k">if</span> <span class="n">max_nfev</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">max_nfev</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">std</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">std</span> <span class="o">=</span> <span class="mf">0.1</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">lamb0</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="c1"># Get knots</span>
    <span class="k">if</span> <span class="n">knots</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">phimin</span><span class="p">,</span> <span class="n">phimax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
        <span class="n">knots</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">phimin</span><span class="p">,</span> <span class="n">phimax</span><span class="p">,</span> <span class="n">nbsplines</span><span class="o">+</span><span class="mi">1</span><span class="o">-</span><span class="n">deg</span><span class="p">)</span>
    <span class="n">knots</span><span class="p">,</span> <span class="n">nkperbs</span><span class="p">,</span> <span class="n">nbs</span> <span class="o">=</span> <span class="n">get_knots_nbs_for_bsplines</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">knots</span><span class="p">),</span> <span class="n">deg</span><span class="p">)</span>

    <span class="c1"># Scaling</span>
    <span class="n">lambmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">lamb</span><span class="p">)</span>
    <span class="n">lamb0Delta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">lamb0</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">lamb0</span><span class="p">)</span>
    <span class="n">nlamb0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">lamb0</span><span class="p">)</span>
    <span class="n">nc</span> <span class="o">=</span> <span class="n">nbs</span><span class="o">*</span><span class="n">nlamb0</span>

    <span class="n">dlambscale</span> <span class="o">=</span> <span class="n">lamb0Delta</span> <span class="o">/</span> <span class="n">nlamb0</span>
    <span class="n">ampscale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="n">datascale</span> <span class="o">=</span> <span class="n">data</span> <span class="o">/</span> <span class="n">ampscale</span>
    <span class="n">lambscale</span> <span class="o">=</span> <span class="n">lamb</span> <span class="o">/</span> <span class="n">dlambscale</span>
    <span class="n">lamb0scale</span> <span class="o">=</span> <span class="n">lamb0</span> <span class="o">/</span> <span class="n">dlambscale</span>
    <span class="n">stdscale</span> <span class="o">=</span> <span class="n">std</span> <span class="o">/</span> <span class="n">ampscale</span>

    <span class="c1"># Get cost function and jacobian</span>
    <span class="n">func</span><span class="p">,</span> <span class="n">jac</span> <span class="o">=</span> <span class="n">get_multigaussianfit2d_costfunc</span><span class="p">(</span><span class="n">lamb</span><span class="o">=</span><span class="n">lambscale</span><span class="p">,</span>
                                                <span class="n">phi</span><span class="o">=</span><span class="n">phi</span><span class="p">,</span>
                                                <span class="n">data</span><span class="o">=</span><span class="n">datascale</span><span class="p">,</span>
                                                <span class="n">std</span><span class="o">=</span><span class="n">stdscale</span><span class="p">,</span>
                                                <span class="n">lamb0</span><span class="o">=</span><span class="n">lamb0scale</span><span class="p">,</span>
                                                <span class="n">forcelamb</span><span class="o">=</span><span class="n">forcelamb</span><span class="p">,</span>
                                                <span class="n">deg</span><span class="o">=</span><span class="n">deg</span><span class="p">,</span> <span class="n">knots</span><span class="o">=</span><span class="n">knots</span><span class="p">,</span>
                                                <span class="n">nlamb0</span><span class="o">=</span><span class="n">nlamb0</span><span class="p">,</span> <span class="n">nbs</span><span class="o">=</span><span class="n">nbs</span><span class="p">,</span>
                                                <span class="n">nkperbs</span><span class="o">=</span><span class="n">nkperbs</span><span class="p">,</span> <span class="n">nc</span><span class="o">=</span><span class="n">nc</span><span class="p">,</span>
                                                <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">)</span>

    <span class="c1"># Get initial guess</span>
    <span class="k">if</span> <span class="n">x0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">nc</span><span class="p">,)),</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">nc</span><span class="p">,))]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">forcelamb</span><span class="p">:</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">x0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nc</span><span class="p">,))]</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">x0</span><span class="p">,</span> <span class="mf">0.</span><span class="p">]</span>

    <span class="c1"># Get bounds</span>
    <span class="k">if</span> <span class="n">bounds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nc</span><span class="p">,)),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">nc</span><span class="p">,),</span> <span class="n">nlamb0</span><span class="o">/</span><span class="mi">100</span><span class="p">)],</span>
                  <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">nc</span><span class="p">,),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">/</span><span class="n">ampscale</span><span class="p">),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">nc</span><span class="p">,),</span> <span class="mf">3.</span><span class="p">)])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">forcelamb</span><span class="p">:</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">nc</span><span class="p">,),</span> <span class="mf">2.</span><span class="p">)],</span>
                      <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">nc</span><span class="p">,),</span> <span class="mf">2.</span><span class="p">)])</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mf">0.</span><span class="p">],</span>
                  <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mf">0.1</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">/</span><span class="n">ampscale</span><span class="p">])</span>

    <span class="c1"># Minimize</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">scpopt</span><span class="o">.</span><span class="n">least_squares</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">jac</span><span class="o">=</span><span class="n">jac</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
                               <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">ftol</span><span class="o">=</span><span class="n">ftol</span><span class="p">,</span> <span class="n">xtol</span><span class="o">=</span><span class="n">xtol</span><span class="p">,</span>
                               <span class="n">gtol</span><span class="o">=</span><span class="n">gtol</span><span class="p">,</span> <span class="n">x_scale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">f_scale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">loss</span><span class="o">=</span><span class="n">loss</span><span class="p">,</span>
                               <span class="n">diff_step</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tr_solver</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                               <span class="n">tr_options</span><span class="o">=</span><span class="p">{},</span> <span class="n">jac_sparsity</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                               <span class="n">max_nfev</span><span class="o">=</span><span class="n">max_nfev</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
                               <span class="n">args</span><span class="o">=</span><span class="p">(),</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{})</span>

    <span class="c1"># Separate and reshape output</span>
    <span class="n">camp</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">[:</span><span class="n">nc</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nlamb0</span><span class="p">,</span> <span class="n">nbs</span><span class="p">))</span> <span class="o">*</span> <span class="n">ampscale</span>
    <span class="n">csigma</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">nc</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="n">nc</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nlamb0</span><span class="p">,</span> <span class="n">nbs</span><span class="p">))</span> <span class="o">*</span> <span class="n">dlambscale</span>
    <span class="k">if</span> <span class="n">forcelamb</span><span class="p">:</span>
        <span class="n">cdlamb</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cdlamb</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">nc</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">nc</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nlamb0</span><span class="p">,</span> <span class="n">nbs</span><span class="p">))</span> <span class="o">*</span> <span class="n">dlambscale</span>

    <span class="c1"># Create output dict</span>
    <span class="n">dout</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;camp&#39;</span><span class="p">:</span> <span class="n">camp</span><span class="p">,</span> <span class="s1">&#39;csigma&#39;</span><span class="p">:</span> <span class="n">csigma</span><span class="p">,</span> <span class="s1">&#39;cdlamb&#39;</span><span class="p">:</span> <span class="n">cdlamb</span><span class="p">,</span> <span class="s1">&#39;bck&#39;</span><span class="p">:</span><span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
            <span class="s1">&#39;fit&#39;</span><span class="p">:(</span><span class="n">func</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="n">stdscale</span><span class="o">*</span><span class="n">data</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="n">datascale</span><span class="p">)</span> <span class="o">*</span> <span class="n">ampscale</span><span class="p">,</span>
            <span class="s1">&#39;lamb0&#39;</span><span class="p">:</span><span class="n">lamb0</span><span class="p">,</span> <span class="s1">&#39;knots&#39;</span><span class="p">:</span> <span class="n">knots</span><span class="p">,</span> <span class="s1">&#39;deg&#39;</span><span class="p">:</span><span class="n">deg</span><span class="p">,</span> <span class="s1">&#39;nbsplines&#39;</span><span class="p">:</span> <span class="n">nbsplines</span><span class="p">,</span>
            <span class="s1">&#39;cost&#39;</span><span class="p">:</span> <span class="n">res</span><span class="o">.</span><span class="n">cost</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="n">res</span><span class="o">.</span><span class="n">fun</span><span class="p">,</span> <span class="s1">&#39;active_mask&#39;</span><span class="p">:</span> <span class="n">res</span><span class="o">.</span><span class="n">active_mask</span><span class="p">,</span>
            <span class="s1">&#39;nfev&#39;</span><span class="p">:</span> <span class="n">res</span><span class="o">.</span><span class="n">nfev</span><span class="p">,</span> <span class="s1">&#39;njev&#39;</span><span class="p">:</span> <span class="n">res</span><span class="o">.</span><span class="n">njev</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="n">res</span><span class="o">.</span><span class="n">status</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">dout</span></div>




<span class="c1">###########################################################</span>
<span class="c1">#</span>
<span class="c1">#           From DataCam2D</span>
<span class="c1">#</span>
<span class="c1">###########################################################</span>
<span class="c1">###########################################################</span>


<span class="c1"># DEPRECATED</span>
<div class="viewcode-block" id="fit_spectra2d_x0_per_row"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._spectrafit2d.fit_spectra2d_x0_per_row">[docs]</a><span class="k">def</span> <span class="nf">fit_spectra2d_x0_per_row</span><span class="p">():</span>

    <span class="c1"># Loop from centre to edges</span>
    <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ny</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">multiplegaussianfit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">datat</span><span class="p">[</span><span class="n">jj</span><span class="p">,:],</span> <span class="n">nmax</span><span class="o">=</span><span class="n">nmax</span><span class="p">,</span> <span class="n">p0</span><span class="o">=</span><span class="n">p0u</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                  <span class="n">max_nfev</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xtol</span><span class="o">=</span><span class="mf">1.e-8</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                  <span class="n">percent</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">plot_debug</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">x0</span><span class="p">[</span><span class="n">jj</span><span class="p">,:],</span> <span class="n">x0_std</span><span class="p">[</span><span class="n">jj</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nybis</span><span class="p">):</span>
            <span class="c1"># Upper half</span>
            <span class="n">ju</span> <span class="o">=</span> <span class="n">indy1</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">multiplegaussianfit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">spect</span><span class="p">,</span> <span class="n">nmax</span><span class="o">=</span><span class="n">nmax</span><span class="p">,</span> <span class="n">p0</span><span class="o">=</span><span class="n">p0u</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                      <span class="n">max_nfev</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xtol</span><span class="o">=</span><span class="mf">1.e-8</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                      <span class="n">percent</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">plot_debug</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">x0</span><span class="p">[</span><span class="n">ju</span><span class="p">,:],</span> <span class="n">x0_std</span><span class="p">[</span><span class="n">ju</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">p0u</span><span class="p">[:</span><span class="n">nmax</span><span class="p">],</span> <span class="n">p0u</span><span class="p">[</span><span class="n">nmax</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="n">nmax</span><span class="p">],</span> <span class="o">=</span> <span class="n">amp</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="n">ju</span><span class="p">,:],</span> <span class="n">x0</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="n">ju</span><span class="p">,:]</span>
            <span class="n">p0u</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">nmax</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">nmax</span><span class="p">],</span> <span class="n">p0u</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">nmax</span><span class="p">:]</span> <span class="o">=</span> <span class="n">sigma</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="n">ju</span><span class="p">,:],</span> <span class="n">bck0</span>

            <span class="c1"># Lower half</span>
            <span class="n">jl</span> <span class="o">=</span> <span class="n">indy2</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">x0</span></div>



<div class="viewcode-block" id="get_func2d"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._spectrafit2d.get_func2d">[docs]</a><span class="k">def</span> <span class="nf">get_func2d</span><span class="p">(</span><span class="n">y0</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x0_y</span><span class="p">,</span> <span class="n">bspl_n</span><span class="p">,</span> <span class="n">bspl_deg</span><span class="p">):</span>
    <span class="n">knots</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">y0</span><span class="p">,</span><span class="n">y1</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
    <span class="n">bspliney</span> <span class="o">=</span> <span class="n">scpinterp</span><span class="o">.</span><span class="n">LSQUnivariateSpline</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">ampy_coefs</span><span class="p">,</span> <span class="n">sigy_coefs</span><span class="p">,</span> <span class="n">bcky_coefs</span><span class="p">):</span>
        <span class="n">amp_bs</span> <span class="o">=</span> <span class="n">BSpline</span><span class="p">(</span><span class="n">knots</span><span class="p">,</span> <span class="n">ampy_coefs</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">bspl_deg</span><span class="p">,</span>
                         <span class="n">extrapolate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">amp</span> <span class="o">=</span> <span class="n">amp_bs</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">x0y</span> <span class="o">=</span> <span class="n">x0_y</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">amp</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="n">x</span><span class="o">-</span><span class="n">xoy</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">sig</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">bck0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">func</span></div>



<div class="viewcode-block" id="fit_spectra_2d"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._spectrafit2d.fit_spectra_2d">[docs]</a><span class="k">def</span> <span class="nf">fit_spectra_2d</span><span class="p">(</span><span class="n">data2d</span><span class="p">,</span> <span class="n">indt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nbin_init</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">nmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bck</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nbsplines</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Return fitted spectra</span>

<span class="sd">    Can handle unique or multiple time</span>
<span class="sd">    Takes already formatted 2d data:</span>
<span class="sd">        - (nx, ny)</span>
<span class="sd">        - (nt, nx, ny)</span>
<span class="sd">    x being the horizontal / spectral direction (lambda)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#####################</span>
    <span class="c1"># Check / format input</span>
    <span class="c1">#####################</span>

    <span class="c1"># Check data</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">indt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">indt</span><span class="p">,</span><span class="o">...</span><span class="p">]</span>

    <span class="c1"># Set bck type</span>
    <span class="k">if</span> <span class="n">bck</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">bck</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">bck</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">bck</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">nbck</span> <span class="o">=</span> <span class="n">bck</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">bck</span> <span class="o">==</span> <span class="s1">&#39;exp&#39;</span><span class="p">:</span>
        <span class="n">nbck</span> <span class="o">=</span> <span class="mi">3</span>

    <span class="c1"># Extract shape</span>
    <span class="n">nt</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">nlamb</span><span class="p">,</span> <span class="n">ny</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nlamb</span><span class="p">)</span>

    <span class="c1"># max number of spectral lines (gaussians)</span>
    <span class="k">if</span> <span class="n">nmax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nmax</span> <span class="o">=</span> <span class="mi">10</span>

    <span class="c1"># Check nbin_init vs ny</span>
    <span class="k">if</span> <span class="n">nbin_init</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nbin_init</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="k">if</span> <span class="n">ny</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="n">nbin_init</span> <span class="o">%</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">nbin_init</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># get indybin</span>
    <span class="n">indybin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nbin_init</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ny</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">indybin</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ny</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="n">nbin_init</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">indybin</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">((</span><span class="n">ny</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="p">(</span><span class="n">nbin_init</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># get indybis</span>
    <span class="k">if</span> <span class="n">ny</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">indy1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ny</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">indy2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ny</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">indy1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">((</span><span class="n">ny</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">indy2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">((</span><span class="n">ny</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">nybis</span> <span class="o">=</span> <span class="n">indy1</span><span class="o">.</span><span class="n">size</span>
    <span class="k">assert</span> <span class="n">nybis</span> <span class="o">==</span> <span class="n">indy2</span><span class="o">.</span><span class="n">size</span>

    <span class="c1">#####################</span>
    <span class="c1"># initialize output</span>
    <span class="c1">#####################</span>

    <span class="c1"># results</span>
    <span class="n">amp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">nt</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nmax</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">ny</span><span class="p">,</span> <span class="n">nmax</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">nt</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nmax</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="n">bck0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">nt</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nbck</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="n">p0u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">nmax</span><span class="o">*</span><span class="mi">3</span> <span class="o">+</span> <span class="n">nbck</span><span class="p">,),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="n">p0l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">nmax</span><span class="o">*</span><span class="mi">3</span> <span class="o">+</span> <span class="n">nbck</span><span class="p">,),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

    <span class="c1"># results std</span>
    <span class="n">amp_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">nt</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nmax</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="n">x0_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">nt</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nmax</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="n">sigma_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">nt</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nmax</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="n">bck0_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">nt</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nbck</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">nt</span><span class="p">,),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>


    <span class="c1">#####################</span>
    <span class="c1"># Determine x0 for each row</span>
    <span class="c1">#####################</span>

    <span class="n">datat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Start with central binned (initial guess)</span>

    <span class="c1"># if ny is odd =&gt; use binned result for central line</span>


    <span class="n">x0</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Deduce ellipses</span>

    <span class="c1"># Derive x0_func(y, x0)</span>


    <span class="c1">#####################</span>
    <span class="c1"># Define 2d multi-gaussian</span>
    <span class="c1">#####################</span>

    <span class="c1"># Define x0(y) law</span>




    <span class="c1">#####################</span>
    <span class="c1"># compute fits, with fixed x0</span>
    <span class="c1">#####################</span>

    <span class="c1"># Get binned spectra to deduce initial guess</span>
    <span class="n">databin</span> <span class="o">=</span>  <span class="kc">None</span>

    <span class="c1"># loop over y to fit spectra, start from middle, extent to edges</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nt</span><span class="p">):</span>

            <span class="n">out</span> <span class="o">=</span> <span class="n">fit2dspectra</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">ii</span><span class="p">,:,:])</span>

            <span class="n">p0u</span><span class="p">[:</span><span class="n">nmax</span><span class="p">]</span> <span class="o">=</span> <span class="n">amp</span><span class="p">[</span><span class="n">ii</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">indy1</span><span class="p">[</span><span class="mi">0</span><span class="p">],:]</span>
            <span class="n">p0u</span><span class="p">[</span><span class="n">nmax</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="n">nmax</span><span class="p">]</span> <span class="o">=</span> <span class="n">x0</span><span class="p">[</span><span class="n">ii</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">indy1</span><span class="p">[</span><span class="mi">0</span><span class="p">],:]</span>
            <span class="n">p0u</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">nmax</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">nmax</span><span class="p">]</span> <span class="o">=</span> <span class="n">sigma</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="n">indy1</span><span class="p">[</span><span class="mi">0</span><span class="p">],:]</span>
            <span class="n">p0u</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">nmax</span><span class="p">:]</span> <span class="o">=</span> <span class="n">bck0</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="n">indy1</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

            <span class="n">p0l</span><span class="p">[:</span><span class="n">nmax</span><span class="p">]</span> <span class="o">=</span> <span class="n">amp</span><span class="p">[</span><span class="n">ii</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">indy2</span><span class="p">[</span><span class="mi">0</span><span class="p">],:]</span>
            <span class="n">p0l</span><span class="p">[</span><span class="n">nmax</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="n">nmax</span><span class="p">]</span> <span class="o">=</span> <span class="n">x0</span><span class="p">[</span><span class="n">ii</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">indy2</span><span class="p">[</span><span class="mi">0</span><span class="p">],:]</span>
            <span class="n">p0l</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">nmax</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">nmax</span><span class="p">]</span> <span class="o">=</span> <span class="n">sigma</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="n">indy2</span><span class="p">[</span><span class="mi">0</span><span class="p">],:]</span>
            <span class="n">p0l</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">nmax</span><span class="p">:]</span> <span class="o">=</span> <span class="n">bck0</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="n">indy2</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>


    <span class="k">return</span> <span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">x0_std</span><span class="p">),</span> <span class="p">(</span> <span class="p">)</span></div>


<span class="c1">###########################################################</span>
<span class="c1">###########################################################</span>
<span class="c1">#</span>
<span class="c1">#           For inspiration</span>
<span class="c1">#</span>
<span class="c1">###########################################################</span>
<span class="c1">###########################################################</span>



<span class="c1"># _indymod = {0: np.arange(0,195),</span>
            <span class="c1"># 1: np.arange(212,407),</span>
            <span class="c1"># 2: np.arange(424,619),</span>
            <span class="c1"># 3: np.arange(636,831),</span>
            <span class="c1"># 4: np.arange(848,1043),</span>
            <span class="c1"># 5: np.arange(1060,1255),</span>
            <span class="c1"># 6: np.arange(1272,1467)}</span>

<span class="c1"># def get_binnedspectra(imp=&#39;FeXXV&#39;, mod=3, path=&#39;./&#39;,</span>
                      <span class="c1"># dshots=_dshots, indymod=_indymod, save=True):</span>

    <span class="c1"># # Prepare</span>
    <span class="c1"># indy = indymod[mod]</span>
    <span class="c1"># dimp = dict(dshots[imp])</span>

    <span class="c1"># # Loop on shots</span>
    <span class="c1"># lextra = [&#39;Te0&#39;,&#39;ne0&#39;,&#39;dg16&#39;]</span>
    <span class="c1"># ls = sorted(dimp.keys())</span>
    <span class="c1"># for shot in ls:</span>

        <span class="c1"># # Load data</span>
        <span class="c1"># if &#39;tlim&#39; in dimp[shot].keys():</span>
            <span class="c1"># tlim = dimp[shot][&#39;tlim&#39;]</span>
        <span class="c1"># else:</span>
            <span class="c1"># tlim = None</span>
        <span class="c1"># try:</span>
            <span class="c1"># xics, kh = tfw.SpectroX2D.load_data(shot,</span>
                                                <span class="c1"># tlim=tlim, plot=False)</span>
        <span class="c1"># except Exception as err:</span>
            <span class="c1"># dimp[shot][&#39;err&#39;] = str(err)</span>
            <span class="c1"># continue</span>

        <span class="c1"># # Bin data</span>
        <span class="c1"># data, t = xics._Ref[&#39;data&#39;], xics._Ref[&#39;t&#39;]</span>
        <span class="c1"># dimp[shot][&#39;nt&#39;] = t.size</span>
        <span class="c1"># spectra = np.empty((dimp[shot][&#39;nt&#39;], 487), dtype=float)</span>
        <span class="c1"># for ii in range(0,dimp[shot][&#39;nt&#39;]):</span>
            <span class="c1"># spectra[ii,:] = np.nanmean(data[ii,:].reshape(1467,487)[indy,:],</span>
                                       <span class="c1"># axis=0)</span>
        <span class="c1"># dimp[shot][&#39;spectra&#39;] = spectra</span>
        <span class="c1"># dimp[shot][&#39;t&#39;] = t</span>
        <span class="c1"># #dimp[shot][&#39;date&#39;] = IRFMtb.</span>

        <span class="c1"># # Dextra</span>
        <span class="c1"># for ss in lextra:</span>
            <span class="c1"># try:</span>
                <span class="c1"># indt = np.digitize(xics.dextra[ss][&#39;t&#39;], 0.5*(t[1:]+t[:-1]))</span>
                <span class="c1"># val = np.empty((dimp[shot][&#39;nt&#39;],),dtype=float)</span>
                <span class="c1"># std = np.empty((dimp[shot][&#39;nt&#39;],),dtype=float)</span>
                <span class="c1"># ssum = np.empty((dimp[shot][&#39;nt&#39;],),dtype=float)</span>
                <span class="c1"># for ii in range(0,dimp[shot][&#39;nt&#39;]):</span>
                    <span class="c1"># val[ii] = np.nanmean(xics.dextra[ss][&#39;data&#39;][indt==ii])</span>
                    <span class="c1"># std[ii] = np.nanstd(xics.dextra[ss][&#39;data&#39;][indt==ii])</span>
                    <span class="c1"># ssum[ii] = np.nansum(xics.dextra[ss][&#39;data&#39;][indt==ii])</span>
                <span class="c1"># dimp[shot][ss] = {&#39;mean&#39;:val, &#39;std&#39;:std, &#39;sum&#39;:ssum}</span>
            <span class="c1"># except Exception as err:</span>
                <span class="c1"># dimp[shot][ss] = {&#39;mean&#39;:np.nan, &#39;std&#39;:np.nan, &#39;sum&#39;:np.nan}</span>

    <span class="c1"># # Reshape dict for np.savez and pandas DataFrame</span>
    <span class="c1"># nt = np.array([dimp[shot][&#39;nt&#39;] for shot in ls])</span>
    <span class="c1"># nttot = np.sum(nt)</span>
    <span class="c1"># ntcum = np.cumsum(nt)</span>
    <span class="c1"># lk = [&#39;shot&#39;,&#39;angle&#39;,&#39;spectra&#39;,&#39;t&#39;,</span>
          <span class="c1"># &#39;Te0-mean&#39;,&#39;Te0-std&#39;,&#39;ne0-mean&#39;,&#39;ne0-std&#39;,</span>
          <span class="c1"># &#39;dg16-sum&#39;]</span>
    <span class="c1"># dk = {}</span>
    <span class="c1"># for k in lk:</span>
        <span class="c1"># shape = (nttot,487) if k==&#39;spectra&#39; else (nttot,)</span>
        <span class="c1"># dk[k] = np.full(shape, np.nan)</span>

    <span class="c1"># i0 = 0</span>
    <span class="c1"># for ii in range(0,len(ls)):</span>
        <span class="c1"># ind = np.arange(i0,i0+nt[ii])</span>
        <span class="c1"># dk[&#39;shot&#39;][ind] = ls[ii]</span>
        <span class="c1"># dk[&#39;angle&#39;][ind] = dimp[ls[ii]][&#39;ang&#39;]</span>
        <span class="c1"># dk[&#39;spectra&#39;][ind,:] = dimp[ls[ii]][&#39;spectra&#39;]</span>
        <span class="c1"># dk[&#39;t&#39;][ind] = dimp[ls[ii]][&#39;t&#39;]</span>
        <span class="c1"># dk[&#39;Te0-mean&#39;][ind] = dimp[ls[ii]][&#39;Te0&#39;][&#39;mean&#39;]</span>
        <span class="c1"># dk[&#39;Te0-std&#39;][ind] = dimp[ls[ii]][&#39;Te0&#39;][&#39;std&#39;]</span>
        <span class="c1"># dk[&#39;ne0-mean&#39;][ind] = dimp[ls[ii]][&#39;ne0&#39;][&#39;mean&#39;]</span>
        <span class="c1"># dk[&#39;ne0-std&#39;][ind] = dimp[ls[ii]][&#39;ne0&#39;][&#39;std&#39;]</span>
        <span class="c1"># dk[&#39;dg16-sum&#39;][ind] = dimp[ls[ii]][&#39;dg16&#39;][&#39;sum&#39;]</span>
        <span class="c1"># i0 = ntcum[ii]</span>

    <span class="c1"># # Saving</span>
    <span class="c1"># if save:</span>
        <span class="c1"># name = &#39;%s_spectra&#39;%imp</span>
        <span class="c1"># path = os.path.abspath(path)</span>
        <span class="c1"># pfe = os.path.join(path,name+&#39;.npz&#39;)</span>
        <span class="c1"># try:</span>
            <span class="c1"># np.savez(pfe, **dk)</span>
            <span class="c1"># print(&quot;Saved in :&quot;, pfe)</span>
        <span class="c1"># except:</span>
            <span class="c1"># import ipdb</span>
            <span class="c1"># ipdb.set_trace()</span>
            <span class="c1"># pass</span>
    <span class="c1"># return dk</span>



<span class="c1"># ####################################################################</span>
<span class="c1"># #       spectral fit</span>
<span class="c1"># ####################################################################</span>


<span class="c1"># def remove_bck(x, y):</span>
    <span class="c1"># #opt = np.polyfit(x, y, deg=0)</span>
    <span class="c1"># opt = [np.nanmin(y)]</span>
    <span class="c1"># ybis = y - opt[0]</span>
    <span class="c1"># return ybis, opt[0]</span>


<span class="c1"># def get_peaks(x, y, nmax=10):</span>

    <span class="c1"># # Prepare</span>
    <span class="c1"># ybis = np.copy(y)</span>
    <span class="c1"># A = np.empty((nmax,),dtype=y.dtype)</span>
    <span class="c1"># x0 = np.empty((nmax,),dtype=x.dtype)</span>
    <span class="c1"># sigma = np.empty((nmax,),dtype=y.dtype)</span>
    <span class="c1"># gauss = lambda xx, A, x0, sigma: A*np.exp(-(xx-x0)**2/sigma**2)</span>
    <span class="c1"># def gauss_jac(xx, A, x0, sigma):</span>
        <span class="c1"># jac = np.empty((xx.size,3),dtype=float)</span>
        <span class="c1"># jac[:,0] = np.exp(-(xx-x0)**2/sigma**2)</span>
        <span class="c1"># jac[:,1] = A*2*(xx-x0)/sigma**2 * np.exp(-(xx-x0)**2/sigma**2)</span>
        <span class="c1"># jac[:,2] = A*2*(xx-x0)**2/sigma**3 * np.exp(-(xx-x0)**2/sigma**2)</span>
        <span class="c1"># return jac</span>

    <span class="c1"># dx = np.nanmin(np.diff(x))</span>

    <span class="c1"># # Loop</span>
    <span class="c1"># nn = 0</span>
    <span class="c1"># while nn&lt;nmax:</span>
        <span class="c1"># ind = np.nanargmax(ybis)</span>
        <span class="c1"># x00 = x[ind]</span>
        <span class="c1"># if np.any(np.diff(ybis[ind:],n=2)&gt;=0.):</span>
            <span class="c1"># wp = min(x.size-1,</span>
                     <span class="c1"># ind + np.nonzero(np.diff(ybis[ind:],n=2)&gt;=0.)[0][0] + 1)</span>
        <span class="c1"># else:</span>
            <span class="c1"># wp = ybis.size-1</span>
        <span class="c1"># if np.any(np.diff(ybis[:ind+1],n=2)&gt;=0.):</span>
            <span class="c1"># wn = max(0, np.nonzero(np.diff(ybis[:ind+1],n=2)&gt;=0.)[0][-1] - 1)</span>
        <span class="c1"># else:</span>
            <span class="c1"># wn = 0</span>
        <span class="c1"># width = x[wp]-x[wn]</span>
        <span class="c1"># assert width&gt;0.</span>
        <span class="c1"># indl = np.arange(wn,wp+1)</span>
        <span class="c1"># sig = np.ones((indl.size,))</span>
        <span class="c1"># if (np.abs(np.mean(np.diff(ybis[ind:wp+1])))</span>
            <span class="c1"># &gt; np.abs(np.mean(np.diff(ybis[wn:ind+1])))):</span>
            <span class="c1"># sig[indl&lt;ind] = 1.5</span>
            <span class="c1"># sig[indl&gt;ind] = 0.5</span>
        <span class="c1"># else:</span>
            <span class="c1"># sig[indl&lt;ind] = 0.5</span>
            <span class="c1"># sig[indl&gt;ind] = 1.5</span>
        <span class="c1"># p0 = (ybis[ind],x00,width)#,0.)</span>
        <span class="c1"># bounds = (np.r_[0.,x[wn],dx/2.],</span>
                  <span class="c1"># np.r_[5.*ybis[ind],x[wp],5.*width])</span>
        <span class="c1"># try:</span>
            <span class="c1"># (Ai, x0i, sigi) = scpopt.curve_fit(gauss, x[indl], ybis[indl],</span>
                                               <span class="c1"># p0=p0, bounds=bounds, jac=gauss_jac,</span>
                                               <span class="c1"># sigma=sig, x_scale=&#39;jac&#39;)[0]</span>
        <span class="c1"># except Exception as err:</span>
            <span class="c1"># print(str(err))</span>
            <span class="c1"># import ipdb</span>
            <span class="c1"># ipdb.set_trace()</span>
            <span class="c1"># pass</span>

        <span class="c1"># ybis = ybis - gauss(x, Ai, x0i, sigi)</span>
        <span class="c1"># A[nn] = Ai</span>
        <span class="c1"># x0[nn] = x0i</span>
        <span class="c1"># sigma[nn] = sigi</span>


        <span class="c1"># nn += 1</span>
    <span class="c1"># return A, x0, sigma</span>

<span class="c1"># def get_p0bounds(x, y, nmax=10):</span>

    <span class="c1"># yflat, bck = remove_bck(x,y)</span>
    <span class="c1"># A, x0, sigma = get_peaks(x, yflat, nmax=nmax)</span>

    <span class="c1"># p0 = A.tolist() + x0.tolist() + sigma.tolist() + [bck]</span>

    <span class="c1"># lx = [np.nanmin(x), np.nanmax(x)]</span>
    <span class="c1"># Dx = np.diff(lx)</span>
    <span class="c1"># dx = np.nanmin(np.diff(x))</span>

    <span class="c1"># bA = (np.zeros(nmax,), np.full((nmax,),3.*np.nanmax(y)))</span>
    <span class="c1"># bx0 = (np.full((nmax,),lx[0]-Dx/2.), np.full((nmax,),lx[1]+Dx/2.))</span>
    <span class="c1"># bsigma = (np.full((nmax,),dx/2.), np.full((nmax,),Dx/2.))</span>
    <span class="c1"># bbck0 = (0., np.nanmax(y))</span>

    <span class="c1"># bounds = (np.r_[bA[0],bx0[0],bsigma[0], bbck0[0]],</span>
              <span class="c1"># np.r_[bA[1],bx0[1],bsigma[1], bbck0[1]])</span>
    <span class="c1"># if not np.all(bounds[0]&lt;bounds[1]):</span>
        <span class="c1"># msg = &quot;Lower bounds must be &lt; upper bounds !\n&quot;</span>
        <span class="c1"># msg += &quot;    lower :  %s\n&quot;+str(bounds[0])</span>
        <span class="c1"># msg += &quot;    upper :  %s\n&quot;+str(bounds[1])</span>
        <span class="c1"># raise Exception(msg)</span>
    <span class="c1"># return p0, bounds</span>


<span class="c1"># def get_func(n=5):</span>
    <span class="c1"># def func_vect(x, A, x0, sigma, bck0):</span>
        <span class="c1"># y = np.full((A.size+1, x.size), np.nan)</span>
        <span class="c1"># for ii in range(A.size):</span>
            <span class="c1"># y[ii,:] = A[ii]*np.exp(-(x-x0[ii])**2/sigma[ii]**2)</span>
        <span class="c1"># y[-1,:] = bck0</span>
        <span class="c1"># return y</span>

    <span class="c1"># def func_sca(x, *args, n=n):</span>
        <span class="c1"># A = np.r_[args[0:n]]</span>
        <span class="c1"># x0 = np.r_[args[n:2*n]]</span>
        <span class="c1"># sigma = np.r_[args[2*n:3*n]]</span>
        <span class="c1"># bck0 = np.r_[args[3*n]]</span>
        <span class="c1"># gaus = A[:,np.newaxis]*np.exp(-(x[np.newaxis,:]-x0[:,np.newaxis])**2/sigma[:,np.newaxis]**2)</span>
        <span class="c1"># back = bck0</span>
        <span class="c1"># return np.sum( gaus, axis=0) + back</span>

    <span class="c1"># def func_sca_jac(x, *args, n=n):</span>
        <span class="c1"># A = np.r_[args[0:n]][np.newaxis,:]</span>
        <span class="c1"># x0 = np.r_[args[n:2*n]][np.newaxis,:]</span>
        <span class="c1"># sigma = np.r_[args[2*n:3*n]][np.newaxis,:]</span>
        <span class="c1"># bck0 = np.r_[args[3*n]]</span>
        <span class="c1"># jac = np.full((x.size,3*n+1,), np.nan)</span>
        <span class="c1"># jac[:,:n] = np.exp(-(x[:,np.newaxis]-x0)**2/sigma**2)</span>
        <span class="c1"># jac[:,n:2*n] = A*2*(x[:,np.newaxis]-x0)/(sigma**2) * np.exp(-(x[:,np.newaxis]-x0)**2/sigma**2)</span>
        <span class="c1"># jac[:,2*n:3*n] = A*2*(x[:,np.newaxis]-x0)**2/sigma**3 * np.exp(-(x[:,np.newaxis]-x0)**2/sigma**2)</span>
        <span class="c1"># jac[:,-1] = 1.</span>
        <span class="c1"># return jac</span>

    <span class="c1"># return func_vect, func_sca, func_sca_jac</span>


<span class="c1"># def multiplegaussianfit(x, spectra, nmax=10, p0=None, bounds=None,</span>
                        <span class="c1"># max_nfev=None, xtol=1.e-8, verbose=0,</span>
                        <span class="c1"># percent=20, plot_debug=False):</span>

    <span class="c1"># # Prepare</span>
    <span class="c1"># if spectra.ndim==1:</span>
        <span class="c1"># spectra = spectra.reshape((1,spectra.size))</span>
    <span class="c1"># nt = spectra.shape[0]</span>

    <span class="c1"># A = np.full((nt,nmax),np.nan)</span>
    <span class="c1"># x0 = np.full((nt,nmax),np.nan)</span>
    <span class="c1"># sigma = np.full((nt,nmax),np.nan)</span>
    <span class="c1"># bck0 = np.full((nt,),np.nan)</span>
    <span class="c1"># Astd = np.full((nt,nmax),np.nan)</span>
    <span class="c1"># x0std = np.full((nt,nmax),np.nan)</span>
    <span class="c1"># sigmastd = np.full((nt,nmax),np.nan)</span>
    <span class="c1"># bck0std = np.full((nt,),np.nan)</span>
    <span class="c1"># std = np.full((nt,),np.nan)</span>

    <span class="c1"># # Prepare info</span>
    <span class="c1"># if verbose is not None:</span>
        <span class="c1"># print(&quot;----- Fitting spectra with {0} gaussians -----&quot;.format(nmax))</span>
    <span class="c1"># nspect = spectra.shape[0]</span>
    <span class="c1"># nstr = max(nspect//max(int(100/percent),1),1)</span>

    <span class="c1"># # bounds and initial guess</span>
    <span class="c1"># if p0 is None or bounds is None:</span>
        <span class="c1"># p00, bounds0 = get_p0bounds(x, spectra[0,:], nmax=nmax)</span>
    <span class="c1"># if p0 is None:</span>
        <span class="c1"># p0 = p00</span>
    <span class="c1"># if bounds is None:</span>
        <span class="c1"># bounds = bounds0</span>

    <span class="c1"># # Get fit</span>
    <span class="c1"># func_vect, func_sca, func_sca_jac = get_func(nmax)</span>
    <span class="c1"># lch = []</span>
    <span class="c1"># for ii in range(0,nspect):</span>

        <span class="c1"># if verbose is not None and ii%nstr==0:</span>
            <span class="c1"># print(&quot;=&gt; spectrum {0} / {1}&quot;.format(ii,nspect))</span>

        <span class="c1"># try:</span>
            <span class="c1"># popt, pcov = scpopt.curve_fit(func_sca, x, spectra[ii,:],</span>
                                          <span class="c1"># jac=func_sca_jac,</span>
                                          <span class="c1"># p0=p0, bounds=bounds,</span>
                                          <span class="c1"># max_nfev=max_nfev, xtol=xtol,</span>
                                          <span class="c1"># x_scale=&#39;jac&#39;,</span>
                                          <span class="c1"># verbose=verbose)</span>
        <span class="c1"># except Exception as err:</span>
            <span class="c1"># msg = &quot;    Convergence issue for {0} / {1}\n&quot;.format(ii,nspect)</span>
            <span class="c1"># msg += &quot;    =&gt; %s\n&quot;%str(err)</span>
            <span class="c1"># msg += &quot;    =&gt; Resetting initial guess and bounds...&quot;</span>
            <span class="c1"># print(msg)</span>
            <span class="c1"># try:</span>
                <span class="c1"># p0, bounds = get_p0bounds(x, spectra[ii,:], nmax=nmax)</span>
                <span class="c1"># popt, pcov = scpopt.curve_fit(func_sca, x, spectra[ii,:],</span>
                                              <span class="c1"># jac=func_sca_jac,</span>
                                              <span class="c1"># p0=p0, bounds=bounds,</span>
                                              <span class="c1"># max_nfev=max_nfev, xtol=xtol,</span>
                                              <span class="c1"># x_scale=&#39;jac&#39;,</span>
                                              <span class="c1"># verbose=verbose)</span>
                <span class="c1"># p0 = popt</span>
                <span class="c1"># popt, pcov = scpopt.curve_fit(func_sca, x, spectra[ii,:],</span>
                                              <span class="c1"># jac=func_sca_jac,</span>
                                              <span class="c1"># p0=p0, bounds=bounds,</span>
                                              <span class="c1"># max_nfev=max_nfev, xtol=xtol,</span>
                                              <span class="c1"># x_scale=&#39;jac&#39;,</span>
                                              <span class="c1"># verbose=verbose)</span>
                <span class="c1"># lch.append(ii)</span>
            <span class="c1"># except Exception as err:</span>
                <span class="c1"># print(str(err))</span>
                <span class="c1"># import ipdb</span>
                <span class="c1"># ipdb.set_trace()</span>
                <span class="c1"># continue</span>


        <span class="c1"># A[ii,:] = popt[:nmax]</span>
        <span class="c1"># x0[ii,:] = popt[nmax:2*nmax]</span>
        <span class="c1"># sigma[ii,:] = popt[2*nmax:3*nmax]</span>
        <span class="c1"># bck0[ii] = popt[3*nmax]</span>

        <span class="c1"># stdi = np.sqrt(np.diag(pcov))</span>
        <span class="c1"># Astd[ii,:] = stdi[:nmax]</span>
        <span class="c1"># x0std[ii,:] = stdi[nmax:2*nmax]</span>
        <span class="c1"># sigmastd[ii,:] = stdi[2*nmax:3*nmax]</span>
        <span class="c1"># bck0std[ii] = stdi[3*nmax]</span>
        <span class="c1"># std[ii] = np.sqrt(np.sum((spectra[ii,:]-func_sca(x,*popt))**2))</span>

        <span class="c1"># p0[:] = popt[:]</span>

        <span class="c1"># if plot_debug and ii in [0,1]:</span>
            <span class="c1"># fit = func_vect(x, A[ii,:], x0[ii,:], sigma[ii,:], bck0[ii])</span>

            <span class="c1"># plt.figure()</span>
            <span class="c1"># ax0 = plt.subplot(2,1,1)</span>
            <span class="c1"># ax1 = plt.subplot(2,1,2, sharex=ax0, sharey=ax0)</span>
            <span class="c1"># ax0.plot(x,spectra[ii,:], &#39;.k&#39;,</span>
                     <span class="c1"># x, np.sum(fit,axis=0), &#39;-r&#39;)</span>
            <span class="c1"># ax1.plot(x, fit.T)</span>

    <span class="c1"># return (A,Astd), (x0,x0std), (sigma,sigmastd), (bck0,bck0std), std, lch</span>



<span class="c1"># def add_gaussianfits(dimp, nmax=10, verbose=0, percent=20,</span>
                     <span class="c1"># path=&#39;./&#39;, save=False):</span>
    <span class="c1"># assert type(dimp) in [str,dict]</span>

    <span class="c1"># # Prepare</span>
    <span class="c1"># if type(dimp) is str:</span>
        <span class="c1"># imp = str(dimp)</span>
        <span class="c1"># if &#39;_&#39; in imp:</span>
            <span class="c1"># imp = imp.split(&#39;_&#39;)[0]</span>
        <span class="c1"># dimp = dict(np.load(dimp+&#39;_spectra.npz&#39;))</span>
        <span class="c1"># inds = np.argsort(dimp[&#39;angle&#39;])</span>
        <span class="c1"># for k in dimp.keys():</span>
            <span class="c1"># if inds.size in dimp[k].shape:</span>
                <span class="c1"># dimp[k] = dimp[k][inds] if dimp[k].ndim==1 else dimp[k][inds,:]</span>
    <span class="c1"># else:</span>
        <span class="c1"># imp = None</span>
        <span class="c1"># save = False</span>


    <span class="c1"># # Compute</span>
    <span class="c1"># ind = np.arange(3,437)</span>
    <span class="c1"># x = np.arange(0,dimp[&#39;spectra&#39;].shape[1])</span>
    <span class="c1"># spectra = dimp[&#39;spectra&#39;][:,ind]</span>
    <span class="c1"># A, x0, sigma, bck0, std, lch = multiplegaussianfit(x[ind], spectra,</span>
                                                       <span class="c1"># nmax=nmax, percent=percent,</span>
                                                       <span class="c1"># verbose=verbose)</span>
    <span class="c1"># # Store</span>
    <span class="c1"># dimp[&#39;nmax&#39;] = nmax</span>
    <span class="c1"># dimp[&#39;indch&#39;] = np.r_[lch]</span>
    <span class="c1"># dimp[&#39;x&#39;] = x</span>
    <span class="c1"># dimp[&#39;ind&#39;] = ind</span>
    <span class="c1"># dimp[&#39;A&#39;] = A[0]</span>
    <span class="c1"># dimp[&#39;A-std&#39;] = A[1]</span>
    <span class="c1"># dimp[&#39;x0&#39;] = x0[0]</span>
    <span class="c1"># dimp[&#39;x0-std&#39;] = x0[1]</span>
    <span class="c1"># dimp[&#39;sigma&#39;] = sigma[0]</span>
    <span class="c1"># dimp[&#39;sigma-std&#39;] = sigma[1]</span>
    <span class="c1"># dimp[&#39;bck0&#39;] = bck0[0]</span>
    <span class="c1"># dimp[&#39;bck0-std&#39;] = bck0[1]</span>
    <span class="c1"># dimp[&#39;std&#39;] = std</span>
    <span class="c1"># if imp is not None:</span>
        <span class="c1"># dimp[&#39;imp&#39;] = imp</span>

    <span class="c1"># if save:</span>
        <span class="c1"># name = &#39;{0}_fitted{1}&#39;.format(imp,nmax)</span>
        <span class="c1"># path = os.path.abspath(path)</span>
        <span class="c1"># pfe = os.path.join(path,name+&#39;.npz&#39;)</span>
        <span class="c1"># np.savez(pfe, **dimp)</span>
        <span class="c1"># print(&quot;Saved in :&quot;, pfe)</span>

    <span class="c1"># return dimp</span>



<span class="c1"># def plot_gaussianfits(dimp, ind):</span>

    <span class="c1"># # Prepare</span>
    <span class="c1"># x = dimp[&#39;x&#39;]</span>
    <span class="c1"># spectra = dimp[&#39;spectra&#39;][ind,:]</span>
    <span class="c1"># func_vect, func_sca, func_sca_jac = get_func(dimp[&#39;nmax&#39;])</span>
    <span class="c1"># fit = func_vect(x, dimp[&#39;A&#39;][ind,:], dimp[&#39;x0&#39;][ind,:],</span>
                    <span class="c1"># dimp[&#39;sigma&#39;][ind,:], dimp[&#39;bck0&#39;][ind])</span>

    <span class="c1"># # Plot</span>
    <span class="c1"># plt.figure();</span>
    <span class="c1"># ax0 = plt.subplot(2,1,1)</span>
    <span class="c1"># ax1 = plt.subplot(2,1,2, sharex=ax0, sharey=ax0)</span>

    <span class="c1"># ax0.plot(x, spectra, &#39;.k&#39;, label=&#39;spectrum&#39;)</span>
    <span class="c1"># ax0.plot(x, np.sum(fit,axis=0), &#39;-r&#39;, label=&#39;fit&#39;)</span>
    <span class="c1"># ax1.plot(x, fit.T)</span>

    <span class="c1"># ax1.set_xlabel(r&#39;x&#39;)</span>
    <span class="c1"># ax0.set_ylabel(r&#39;data&#39;)</span>
    <span class="c1"># ax1.set_ylabel(r&#39;data&#39;)</span>


<span class="c1"># def plot_allraw(dimp):</span>

    <span class="c1"># # Prepare</span>
    <span class="c1"># x = dimp[&#39;x&#39;]</span>
    <span class="c1"># spectra = dimp[&#39;spectra&#39;]</span>
    <span class="c1"># nspect = spectra.shape[0]</span>
    <span class="c1"># spectranorm = spectra / np.nanmax(spectra,axis=1)[:,np.newaxis]</span>

    <span class="c1"># # Plot</span>
    <span class="c1"># plt.figure();</span>
    <span class="c1"># ax0 = plt.subplot(2,1,1)</span>
    <span class="c1"># ax1 = plt.subplot(2,1,2, sharex=ax0)</span>

    <span class="c1"># ax0.imshow(spectranorm, cmap=plt.cm.viridis,</span>
               <span class="c1"># extent=(x.min(),x.max(),0,nspect),</span>
               <span class="c1"># origin=&#39;lower&#39;,</span>
               <span class="c1"># interpolation=&#39;bilinear&#39;)</span>


<span class="c1"># def extract_lines(dimp):</span>

    <span class="c1"># nspect, nx = dimp[&#39;spectra&#39;].shape</span>
    <span class="c1"># if dimp[&#39;imp&#39;] == &#39;ArXVII&#39;:</span>
        <span class="c1"># dlines = {&#39;w&#39;: {&#39;range&#39;:np.arange(280,nx)},</span>
                  <span class="c1"># &#39;z&#39;: {&#39;range&#39;:np.arange(0,200)}}</span>
        <span class="c1"># for k in dlines.keys():</span>
            <span class="c1"># spect = np.copy(dimp[&#39;spectra&#39;])</span>
            <span class="c1"># spect[:,dlines[k][&#39;range&#39;]] = 0.</span>
            <span class="c1"># dlines[k].update({&#39;x&#39;:np.full((nspect,),np.nan),</span>
                              <span class="c1"># &#39;x0&#39;:np.full((nspect,),np.nan),</span>
                              <span class="c1"># &#39;A&#39;:np.full((nspect,),np.nan),</span>
                              <span class="c1"># &#39;sigma&#39;:np.full((nspect,),np.nan)})</span>
            <span class="c1"># for ii in range(0,dimp[&#39;spectra&#39;].shape[0]):</span>
                <span class="c1"># xl = dimp[&#39;x&#39;][np.argmax(spect[ii,:])]</span>
                <span class="c1"># ind = np.argmin(np.abs(dimp[&#39;x0&#39;][ii,:]-xl))</span>
                <span class="c1"># dlines[k][&#39;x&#39;][ii] = xl</span>
                <span class="c1"># dlines[k][&#39;x0&#39;][ii] = dimp[&#39;x0&#39;][ii,ind]</span>
                <span class="c1"># dlines[k][&#39;A&#39;][ii] = dimp[&#39;A&#39;][ii,ind]</span>
                <span class="c1"># dlines[k][&#39;sigma&#39;][ii] = dimp[&#39;sigma&#39;][ii,ind]</span>

    <span class="c1"># dimp.update(**dlines)</span>
    <span class="c1"># return dimp</span>
</pre></div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
        <br/>
        
      
    </p>
    <p>
        &copy; Copyright 2016-2021, Tofu contributors.<br/>
      Last updated on Mar 04, 2021.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 3.4.3.<br/>
    </p>
  </div>
</footer>
  </body>
</html>